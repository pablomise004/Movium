--- add_amigo.php ---

<?php
// ---- backend/api/add_amigo.php ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else { 
    http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: Obtener ID a a√±adir ---
$data = json_decode(file_get_contents("php://input"));
if (empty($data->amigo_a_anadir_id)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos. Se requiere 'amigo_a_anadir_id'."));
    die();
}

$mi_id = $usuario_id;
$otro_id = (int)$data->amigo_a_anadir_id;
$solicitante_id = $mi_id; // Yo soy el que inicia la amistad

// No puedes a√±adirte a ti mismo
if ($mi_id === $otro_id) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No puedes a√±adirte a ti mismo como amigo."));
    die();
}

// --- PASO 3: L√≥gica de Inserci√≥n (Transacci√≥n) ---
$database = new Database();
$db = $database->getConnection();

try {
    $db->beginTransaction();

    // 1. Insertar mi fila (Yo soy amigo de 'otro_id')
    $query1 = "INSERT INTO amistades (usuario_id, amigo_id, solicitante_id) 
               VALUES (:mi_id, :otro_id, :solicitante_id)";
    $stmt1 = $db->prepare($query1);
    $stmt1->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt1->bindParam(":otro_id", $otro_id, PDO::PARAM_INT);
    $stmt1->bindParam(":solicitante_id", $solicitante_id, PDO::PARAM_INT);
    $stmt1->execute();

    // 2. Insertar su fila ('otro_id' es amigo m√≠o)
    $query2 = "INSERT INTO amistades (usuario_id, amigo_id, solicitante_id) 
               VALUES (:otro_id, :mi_id, :solicitante_id)";
    $stmt2 = $db->prepare($query2);
    $stmt2->bindParam(":otro_id", $otro_id, PDO::PARAM_INT);
    $stmt2->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt2->bindParam(":solicitante_id", $solicitante_id, PDO::PARAM_INT);
    $stmt2->execute();

    $db->commit();
    http_response_code(201); // 201 Created
    echo json_encode(array("mensaje" => "Amigo a√±adido con √©xito."));

} catch (Exception $e) {
    $db->rollBack();
    // Error 1062 es 'Duplicate entry'.
    if ($e->errorInfo[1] == 1062) {
        http_response_code(409); // 409 Conflict
        echo json_encode(array("mensaje" => "Ya sois amigos."));
    } else {
        http_response_code(500);
        echo json_encode(array(
            "mensaje" => "Error al a√±adir al amigo.",
            "error" => $e->getMessage()
        ));
    }
}
?>

--- add_ejercicio_a_rutina.php ---

<?php
// ---- backend/api/add_ejercicio_a_rutina.php (REESCRITO V6.0) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die(); }
} else { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die(); }

// --- PASO 2: Obtener Datos (Sin cambios) ---
$data = json_decode(file_get_contents("php://input"));
if (
    empty($data->rutina_id) ||
    empty($data->ejercicio_id) ||
    !isset($data->objetivos) || 
    !is_array($data->objetivos)
) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos. Se requiere 'rutina_id', 'ejercicio_id' y un array 'objetivos'."));
    die();
}

$rutina_id = $data->rutina_id;
$ejercicio_id = $data->ejercicio_id;
$objetivos = $data->objetivos; 

// --- PASO 3: L√≥gica de Inserci√≥n (Transacci√≥n) ---
$database = new Database();
$db = $database->getConnection();

try {
    $db->beginTransaction();

    // 1. Comprobaci√≥n de due√±o (Sin cambios)
    $check_query = "SELECT usuario_id FROM rutinas WHERE id = :rutina_id LIMIT 1";
    $stmt_check = $db->prepare($check_query);
    $stmt_check->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_check->execute();
    $rutina_owner = $stmt_check->fetch(PDO::FETCH_ASSOC);
    if (!$rutina_owner || $rutina_owner['usuario_id'] != $usuario_id) {
        throw new Exception("Acci√≥n no permitida. No eres el due√±o de esta rutina.", 403);
    }
    
    // 2. Calcular 'orden' (Sin cambios)
    $query_orden = "SELECT MAX(orden) as max_orden FROM rutina_ejercicios WHERE rutina_id = :rutina_id";
    $stmt_orden = $db->prepare($query_orden);
    $stmt_orden->bindParam(":rutina_id", $rutina_id);
    $stmt_orden->execute();
    $resultado_orden = $stmt_orden->fetch(PDO::FETCH_ASSOC);
    $orden = ($resultado_orden['max_orden'] ?? 0) + 1;

    // 3. INSERTAR en `rutina_ejercicios` (Sin cambios)
    $query_padre = "INSERT INTO rutina_ejercicios (rutina_id, ejercicio_id, orden) 
                    VALUES (:rutina_id, :ejercicio_id, :orden)";
    $stmt_padre = $db->prepare($query_padre);
    $stmt_padre->bindParam(":rutina_id", $rutina_id);
    $stmt_padre->bindParam(":ejercicio_id", $ejercicio_id);
    $stmt_padre->bindParam(":orden", $orden);
    $stmt_padre->execute();

    // 4. Obtener ID (Sin cambios)
    $rutina_ejercicio_id = $db->lastInsertId();

    // 5. INSERTAR objetivos en `rutina_objetivos` (¬°¬°CAMBIOS V6.0 AQU√ç!!)
    if (count($objetivos) > 0) {
        
        // ¬°Consulta actualizada a V6.0!
        $query_hijo = "INSERT INTO rutina_objetivos 
                        (rutina_ejercicio_id, num_serie, 
                         /* --- CAMPOS V6.0 --- */
                         tipo_rep_objetivo, reps_min_objetivo, reps_max_objetivo, 
                         /* ----------------- */
                         peso_kg_objetivo, 
                         tiempo_min_objetivo, distancia_km_objetivo,
                         descanso_seg_post) 
                       VALUES 
                        (:re_id, :num_serie, 
                         /* --- PARAMS V6.0 --- */
                         :tipo_rep, :reps_min, :reps_max, 
                         /* ----------------- */
                         :peso, :tiempo, :dist, :desc)";
        
        $stmt_hijo = $db->prepare($query_hijo);

        // 6. Iteramos sobre el array de objetivos
        foreach ($objetivos as $obj) {
            
            // --- ¬°CAMBIOS V6.0 AQU√ç! ---
            // Asumimos que React env√≠a $obj->tipo_rep_objetivo, $obj->reps_min_objetivo, etc.
            
            $stmt_hijo->bindValue(":re_id", $rutina_ejercicio_id);
            $stmt_hijo->bindValue(":num_serie", $obj->num_serie ?? 1);
            
            // Campos V6.0 (Fuerza)
            $stmt_hijo->bindValue(":tipo_rep", $obj->tipo_rep_objetivo ?? 'fijo');
            $stmt_hijo->bindValue(":reps_min", $obj->reps_min_objetivo ?? null);
            $stmt_hijo->bindValue(":reps_max", $obj->reps_max_objetivo ?? null);
            
            // Campo Peso (Sin cambio)
            $stmt_hijo->bindValue(":peso", $obj->peso_kg_objetivo ?? null);

            // Campos Cardio (Sin cambio)
            $stmt_hijo->bindValue(":tiempo", $obj->tiempo_min_objetivo ?? null);
            $stmt_hijo->bindValue(":dist", $obj->distancia_km_objetivo ?? null);
            
            // Campo Descanso (Sin cambio)
            $stmt_hijo->bindValue(":desc", $obj->descanso_seg_post ?? null);
            
            $stmt_hijo->execute();
        }
    }
    
    // 7. Commit (Sin cambios)
    $db->commit();

    // 8. Devolver el objeto reci√©n creado (Sin cambios)
    $query_nuevo = "SELECT 
                        re.id, re.ejercicio_id, re.orden,
                        ej.nombre as nombre_ejercicio, ej.grupo_muscular, ej.tipo
           
                     FROM rutina_ejercicios re
                    JOIN ejercicios ej ON re.ejercicio_id = ej.id
                    WHERE re.id = :nuevo_id LIMIT 1";
    
    $stmt_nuevo = $db->prepare($query_nuevo);
    $stmt_nuevo->bindParam(":nuevo_id", $rutina_ejercicio_id);
    $stmt_nuevo->execute();
    $ejercicio_agregado = $stmt_nuevo->fetch(PDO::FETCH_ASSOC);
    
    // Convertimos el array de stdClass (de json_decode) a array asociativo
    $ejercicio_agregado['objetivos'] = json_decode(json_encode($objetivos), true);

    http_response_code(201);
    echo json_encode(array(
        "mensaje" => "Ejercicio a√±adido a la rutina exitosamente.",
        "ejercicio_agregado" => $ejercicio_agregado
    ));

} catch (Exception $e) {
    // 9. Rollback (Sin cambios)
    $db->rollBack();
    $codigo = $e->getCode() == 403 ? 403 : 500;
    http_response_code($codigo);
    echo json_encode(array(
        "mensaje" => "Error al a√±adir el ejercicio.",
        "error" => $e->getMessage()
    ));
}
?>

--- AmigoPRsModal.css ---

/* ---- frontend/src/components/AmigoPRsModal.css (ACTUALIZADO) ---- */

/* Estilos gen√©ricos de modal (sin cambios) */
.modal-backdrop-prs {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background-color: rgba(0, 0, 0, 0.7); display: flex;
  align-items: center; justify-content: center; z-index: 1000;
  animation: fadeIn 0.3s ease;
}
.modal-content-prs {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px; width: 90%; max-width: 600px; /* Un poco m√°s ancho */
  max-height: 80vh; box-shadow: var(--box-shadow);
  display: flex; flex-direction: column;
  animation: slideIn 0.3s ease-out; overflow: hidden;
}
.modal-header-prs {
  display: flex; justify-content: space-between; align-items: center;
  padding: 1rem 1.5rem; border-bottom: 1px solid var(--input-border-color);
  flex-shrink: 0;
}
.modal-header-prs h3 { margin: 0; font-size: 1.25rem; color: var(--text-color); }
.modal-close-btn-prs {
  background: none; border: none; font-size: 2rem;
  color: var(--text-secondary-color); cursor: pointer;
  line-height: 1; padding: 0; flex-shrink: 0;
}

/* --- NUEVO: Filtro de B√∫squeda (como en SelectorEjerciciosModal) --- */
.modal-filters-prs {
  display: flex;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--input-border-color);
  flex-shrink: 0;
}
.modal-search-prs {
  flex: 1; /* Ocupa todo */
  height: 48px; padding: 0 1rem; font-size: 1rem;
  font-family: var(--font-family); color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color); border-radius: 8px;
  box-sizing: border-box; transition: all 0.3s;
}
.modal-search-prs:focus {
  outline: none; border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}

/* --- NUEVO: Contenedor de la lista scrollable --- */
.modal-list-prs {
  overflow-y: auto;
  flex-grow: 1;
  padding: 1rem 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

/* --- NUEVO: Tarjeta para cada PR --- */
.pr-item-card {
  background-color: var(--input-bg-color); /* Fondo m√°s oscuro */
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  padding: 1rem;
}
.pr-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--input-border-color);
  padding-bottom: 0.75rem;
}
.pr-item-header strong {
  font-size: 1.1rem;
  color: var(--text-color);
}
.pr-item-header span {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  background-color: var(--surface-color); /* Fondo m√°s oscuro */
  padding: 0.2rem 0.5rem;
  border-radius: 6px;
}


/* Reutilizamos los estilos de las tarjetas de r√©cords */
.records-grid-modal {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
.record-item-modal {
  text-align: center;
  background-color: var(--surface-color); /* Fondo m√°s oscuro */
  padding: 1rem;
  border-radius: 8px;
}
.record-item-modal strong {
  display: block; font-size: 0.9rem;
  color: var(--text-secondary-color); margin-bottom: 0.5rem;
}
.record-item-modal span {
  display: block; font-size: 1.75rem;
  font-weight: 700; color: var(--text-color);
}

/* Reutilizamos .no-data-msg */
.no-data-msg-modal {
  text-align: center; color: var(--text-secondary-color);
  font-style: italic; padding: 2rem 0;
  background-color: var(--surface-color);
  border-radius: 12px;
}

--- AmigoPRsModal.js ---

// ---- frontend/src/components/AmigoPRsModal.js (REESCRITO) ----

import React, { useState, useEffect, useMemo } from 'react';
import './AmigoPRsModal.css'; // Usamos el CSS nuevo

function AmigoPRsModal({ isOpen, onClose, amigo, token }) {
  
  const [listaPRs, setListaPRs] = useState([]);
  const [filtroNombre, setFiltroNombre] = useState(""); // Estado para el filtro
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // EFECTO 1: Cargar TODOS los PRs del amigo (solo 1 vez)
  useEffect(() => {
    if (!isOpen || !amigo) return; // No cargar si no debe
    
    const cargarTodosPRs = async () => {
      setLoading(true);
      setError(null);
      setFiltroNombre(""); // Resetea el filtro
      try {
        // ¬°Usamos el nuevo endpoint!
        const res = await fetch(`http://localhost/programacion/TFG/movium/backend/api/get_todos_prs_amigo.php?id_amigo=${amigo.id}`, {
           headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.mensaje || "Error al cargar PRs.");
        setListaPRs(data);
      } catch (err) { 
        setError(err.message); 
      } finally { 
        setLoading(false); 
      }
    };
    cargarTodosPRs();
  }, [isOpen, amigo, token]); // Se ejecuta cuando se abre el modal

  // L√≥gica de filtrado (como en SelectorEjerciciosModal)
  const listaFiltrada = useMemo(() => {
    if (!filtroNombre) return listaPRs; // Si no hay filtro, muestra todo

    return listaPRs.filter(pr => 
      pr.nombre.toLowerCase().includes(filtroNombre.toLowerCase()) ||
      pr.grupo_muscular.toLowerCase().includes(filtroNombre.toLowerCase())
    );
  }, [listaPRs, filtroNombre]);


  // Handler para resetear estado al cerrar
  const handleClose = () => {
    onClose();
    // No reseteamos los datos, se recargar√°n al abrir
  };

  if (!isOpen || !amigo) {
    return null;
  }

  // --- JSX de un PR (para no repetirlo) ---
  const renderPR = (pr) => {
    if (pr.tipo === 'cardio') {
      return (
        <div className="records-grid-modal">
          <div className="record-item-modal">
            <strong>Mayor Tiempo</strong>
            <span>{pr.max_tiempo || 0} min</span>
          </div>
          <div className="record-item-modal">
            <strong>Mayor Distancia</strong>
            <span>{pr.max_dist || 0} km</span>
          </div>
        </div>
      );
    } else { // fuerza o calistenia
      return (
         <div className="records-grid-modal">
          <div className="record-item-modal">
            <strong>Mayor Peso</strong>
            <span>{pr.max_peso || 0} kg</span>
          </div>
          <div className="record-item-modal">
            <strong>M√°ximas Reps</strong>
            <span>{pr.max_reps || 0}</span>
          </div>
        </div>
      );
    }
  };

  return (
    <div className="modal-backdrop-prs" onClick={handleClose}>
      <div className="modal-content-prs" onClick={(e) => e.stopPropagation()}>
        
        <div className="modal-header-prs">
          <h3>PRs de {amigo.nombre_usuario}</h3>
          <button className="modal-close-btn-prs" onClick={handleClose}>
            &times;
          </button>
        </div>
        
        {/* El Filtro de B√∫squeda (como en SelectorEjerciciosModal) */}
        <div className="modal-filters-prs">
          <input 
            type="search" 
            placeholder="Filtrar por nombre o grupo..." 
            className="modal-search-prs"
            value={filtroNombre}
            onChange={(e) => setFiltroNombre(e.target.value)}
          />
        </div>

        {/* La lista de PRs */}
        <div className="modal-body-prs modal-list-prs">
          
          {error && <div className="message" style={{marginBottom: '1.5rem'}}>{error}</div>}
          {loading && <p className="subtitle" style={{textAlign: 'center', marginTop: '2rem'}}>Cargando r√©cords...</p>}
          
          {!loading && !error && (
            listaFiltrada.length > 0 ? (
              listaFiltrada.map(pr => (
                <div key={pr.ejercicio_id} className="pr-item-card">
                  <div className="pr-item-header">
                    <strong>{pr.nombre}</strong>
                    <span>{pr.grupo_muscular}</span>
                  </div>
                  {renderPR(pr)}
                </div>
              ))
            ) : (
              <p className="no-data-msg-modal" style={{border: 'none', padding: '2rem 0'}}>
                {listaPRs.length === 0 
                  ? `${amigo.nombre_usuario} a√∫n no tiene PRs registrados.`
                  : "No se encontraron PRs con ese filtro."
                }
              </p>
            )
          )}
        </div>
      </div>
    </div>
  );
}

export default AmigoPRsModal;

--- App.js ---

// ---- frontend/src/App.js (MODIFICADO) ----
import React from 'react';
import { Routes, Route, Navigate } from 'react-router-dom';
import LoginPage from './LoginPage';
import AppLayout from './AppLayout';
import Dashboard from './Dashboard';
import RutinaDetalle from './RutinaDetalle';
import WorkoutSession from './WorkoutSession';
import RutinaProgreso from './RutinaProgreso';
import Perfil from './Perfil';
import Estadisticas from './Estadisticas';
import Comunidad from './Comunidad';
import Ayuda from './Ayuda';
import Historial from './Historial';
import FeedPage from './FeedPage';

// Componente RutaProtegida (sin cambios)
const RutaProtegida = ({ children }) => {
  const token = localStorage.getItem('movium_token');
  if (!token) {
    return <Navigate to="/login" replace />;
  }
  return children;
};

function App() {
  return (
    <Routes>
      {/* Ruta de Login (sin cambios) */}
      <Route path="/login" element={<LoginPage />} /> 

      {/* --- Rutas Protegidas --- */}
      <Route
        path="/"
        element={
          <RutaProtegida>
           <AppLayout />
          </RutaProtegida>
        }
      >
        <Route index element={<Dashboard />} />
        <Route path="rutina/:id" element={<RutinaDetalle />} />
        <Route path="sesion/:id" element={<WorkoutSession />} />
        <Route path="progreso/:id" element={<RutinaProgreso />} />
        <Route path="comunidad" element={<Comunidad />} />
        <Route path="ayuda" element={<Ayuda />} />
        <Route path="historial" element={<Historial />} />
        <Route path="perfil" element={<Perfil />} />
        <Route path="estadisticas" element={<Estadisticas />} />
        <Route path="/comunidad/feed" element={<FeedPage />} />
      </Route>

      <Route path="*" element={<Navigate to="/" replace />} />
    </Routes>
  );
}

export default App;

--- AppLayout.css ---

/* ---- frontend/src/AppLayout.css ---- */
.app-layout {
  display: grid;
  height: 100vh;
  grid-template-areas:
    "header header"
    "sidebar content";
  
  /* 1. ¬°A√±adimos la transici√≥n! Esto animar√° el cambio de columnas */
  transition: grid-template-columns 0.3s ease-in-out;
}

/* 2. Estado ABIERTO (el que ya ten√≠as) */
.app-layout.sidebar-open {
  grid-template-columns: 240px 1fr;
  grid-template-rows: 70px 1fr;
}

/* 3. Estado CERRADO */
.app-layout.sidebar-closed {
  /* El sidebar ahora ocupa 0px, el contenido (1fr) ocupa todo */
  grid-template-columns: 0px 1fr; 
  grid-template-rows: 70px 1fr;
}


/* ... (El resto de tus estilos .app-header, .app-sidebar, .app-content) ... */
.app-header { grid-area: header; }
.app-sidebar { grid-area: sidebar; }

.app-content {
  grid-area: content;
  background-color: var(--bg-color);
  padding: 0; 
  overflow-y: auto; 
}

/*
 * =========================================
 * ESTILOS RESPONSIVE (M√ìVIL / TABLET)
 * =========================================
 */
@media (max-width: 767px) {

  /* 1. Cambiamos el grid: El contenido ocupa todo.
     El sidebar ya NO forma parte del grid principal. */
  .app-layout {
    grid-template-areas:
      "header"
      "content";
    grid-template-columns: 1fr; /* Columna √∫nica */
  }

  /* 2. Anulamos las transiciones del grid de desktop */
  .app-layout.sidebar-open {
    grid-template-columns: 1fr;
  }
  .app-layout.sidebar-closed {
    grid-template-columns: 1fr;
  }

  /* 3. ¬°La clave! Convertimos el Sidebar en un "caj√≥n" (drawer) */
  .app-sidebar {
    /* Lo sacamos del flujo del grid */
    grid-area: unset;
    
    /* Lo posicionamos de forma fija sobre la pantalla */
    position: fixed;
    left: 0;
    z-index: 1000; /* Por encima de todo (menos del overlay) */
    
    /* Le a√±adimos una sombra para que destaque */
    box-shadow: 5px 0px 20px rgba(0, 0, 0, 0.3);
    
    /* La animaci√≥n de "slide" (deslizamiento) */
    transform: translateX(-100%); /* Oculto por defecto fuera de la pantalla */
    transition: transform 0.3s ease-in-out;

    /* --- ‚úÖ CAMBIOS AQU√ç --- */
    width: 240px;      /* (Era 260px) M√°s estrecho */
    top: 70px;         /* (Era 0) Empieza DEBAJO del header (altura 70px) */
    bottom: 0;         /* Llega hasta abajo */
    height: auto;      /* (Era 100vh) Altura autom√°tica */
  }
  
  /* 4. Estado ABIERTO en m√≥vil: lo deslizamos a la vista */
  .app-layout.sidebar-open .app-sidebar {
    transform: translateX(0);
  }
  
  /* 5. Estado CERRADO en m√≥vil: nos aseguramos que est√© oculto */
  .app-layout.sidebar-closed .app-sidebar {
    transform: translateX(-100%);
    
    /* Anulamos los estilos de "cerrado" de desktop */
    padding: 1rem;
    border-right: 1px solid var(--input-border-color);
  }
  
  /* 6. Estilos del Overlay (fondo oscuro) */
  .sidebar-overlay {
    display: block;
    position: fixed;
    left: 0;
    width: 100%;
    background: rgba(0, 0, 0, 0.5); /* Negro semitransparente */
    z-index: 999; /* Justo debajo del sidebar */
    
    /* Animaci√≥n de fade-in */
    animation: fadeInOverlay 0.3s ease;

    /* --- ‚úÖ CAMBIOS AQU√ç --- */
    top: 70px;         /* (Era 0) Empieza DEBAJO del header */
    bottom: 0;         /* Llega hasta abajo */
    height: auto;      /* (Era 100%) */
  }
  
  /* 7. Animaci√≥n simple de fade-in */
  @keyframes fadeInOverlay {
    from { opacity: 0; }
    to { opacity: 1; }
  }
}

--- AppLayout.js ---

// ---- frontend/src/AppLayout.js ----
import React, { useState } from 'react'; // 1. Importa useState
import { Outlet } from 'react-router-dom';
import Header from './components/Header';
import Sidebar from './components/Sidebar';
import './AppLayout.css';

function AppLayout() {
  // 2. MODIFICADO:
  // Comprobamos el ancho de la ventana UNA VEZ al cargar.
  // Si es < 768px (m√≥vil/tablet), empieza cerrado (false).
  // Si es > 768px (desktop), empieza abierto (true).
  const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth > 767);

  const toggleSidebar = () => {
    setIsSidebarOpen(!isSidebarOpen);
  };

  return (
    <div className={`app-layout ${isSidebarOpen ? 'sidebar-open' : 'sidebar-closed'}`}>
      
      {/* 3. NUEVO: Overlay para m√≥vil 
          Solo aparece si el sidebar est√° abierto.
          Al hacer clic en √©l, llama a toggleSidebar() para cerrarse. */}
      {isSidebarOpen && <div className="sidebar-overlay" onClick={toggleSidebar}></div>}

      <Header onToggleSidebar={toggleSidebar} />
      
      <Sidebar />

      <main className="app-content">
        <Outlet /> 
      </main>
    </div>
  );
}

export default AppLayout;

--- Ayuda.css ---

/* ---- frontend/src/Ayuda.css (ACTUALIZADO CON TAG DE GRUPO MUSCULAR) ---- */

.ayuda-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out; /* Reutilizamos la animaci√≥n global */
  max-width: 900px; /* Ajusta seg√∫n necesites */
  margin: 0 auto;
}

.ayuda-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
  text-align: center;
}

.ayuda-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 3rem; /* M√°s espacio despu√©s del subt√≠tulo */
  text-align: center;
}

.ayuda-seccion {
  background-color: var(--surface-color); /* Fondo ligeramente distinto */
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem 2rem; /* M√°s padding horizontal */
  margin-bottom: 2rem; /* Espacio entre secciones */
  box-shadow: var(--box-shadow); /* Sombra suave */
}

.ayuda-seccion h3 {
  font-size: 1.5rem;
  color: var(--primary-color); /* T√≠tulos de secci√≥n destacados */
  margin-top: 0;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--input-border-color);
}

.ayuda-seccion h4 { /* Estilo para subt√≠tulos dentro de secci√≥n */
  font-size: 1.2rem;
  color: var(--text-color);
  margin-top: 1.5rem;
  margin-bottom: 0.8rem;
}

.ayuda-seccion p,
.ayuda-seccion ul,
.ayuda-seccion dl {
  line-height: 1.7; /* Mayor interlineado para legibilidad */
  color: var(--text-color);
  margin-bottom: 1rem;
}

.ayuda-seccion ul {
  padding-left: 1.5rem; /* Indentaci√≥n est√°ndar */
}

.ayuda-seccion ul ul {
  margin-top: 0.5rem; /* Espacio antes de sub-listas */
  padding-left: 1rem;
}

.ayuda-seccion li {
  margin-bottom: 0.5rem; /* Espacio entre √≠tems de lista */
}

.ayuda-seccion strong,
.ayuda-seccion b { /* Incluimos <b> */
  font-weight: 700;
  color: var(--text-color); /* Asegura que resalte un poco m√°s */
}

/* Estilos para la lista de definiciones <dl> (Conceptos) */
.ayuda-seccion dl dt {
  font-weight: 700;
  color: var(--text-color);
  margin-top: 1rem; /* Espacio antes de cada t√©rmino */
}

.ayuda-seccion dl dd {
  margin-left: 1.5rem; /* Indentaci√≥n de la definici√≥n */
  color: var(--text-secondary-color);
  margin-bottom: 0.5rem;
}

/* Estilos para la lista de ejercicios y descripciones <dl> */
.lista-ejercicios-descripcion dt {
  font-weight: 700;
  color: var(--text-color);
  margin-top: 1.2rem; /* M√°s espacio antes de cada ejercicio */
  font-size: 1.1rem;
  display: flex; /* Para alinear el tag */
  align-items: baseline; /* Alinea texto base */
  flex-wrap: wrap; /* Permite que el tag baje si no cabe */
  gap: 0.5rem; /* Espacio entre nombre y tag */
}

/* --- NUEVO ESTILO PARA EL TAG DEL GRUPO MUSCULAR --- */
.ejercicio-grupo-tag {
  font-size: 0.8rem; /* M√°s peque√±o */
  font-weight: normal; /* No negrita */
  color: var(--text-secondary-color);
  background-color: var(--input-bg-color); /* Fondo sutil */
  padding: 0.15rem 0.5rem; /* Padding peque√±o */
  border-radius: 6px; /* Bordes redondeados */
  border: 1px solid var(--input-border-color); /* Borde sutil */
  white-space: nowrap; /* Evita que se parta */
  display: inline-block; /* Para que el padding funcione bien */
}
/* --- FIN NUEVO ESTILO --- */

.lista-ejercicios-descripcion dd {
  margin-left: 1.5rem; /* Indentaci√≥n de la descripci√≥n */
  color: var(--text-secondary-color);
  margin-bottom: 0.5rem;
  padding-bottom: 1.2rem; /* Espacio despu√©s de cada descripci√≥n */
  border-bottom: 1px dashed var(--input-border-color); /* Separador suave */
}

/* Evita borde inferior en el √∫ltimo elemento */
.lista-ejercicios-descripcion dd:last-of-type {
  border-bottom: none;
  padding-bottom: 0;
}

/* Estilo para las f√≥rmulas (e1RM, Volumen) */
.ayuda-seccion code {
  background-color: var(--input-bg-color);
  padding: 0.2em 0.4em;
  margin: 0;
  font-size: 0.9em;
  border-radius: 3px;
  font-family: monospace;
  color: var(--text-secondary-color);
  display: inline-block; /* Para que el fondo ocupe solo el texto */
  margin-top: 0.5rem; /* Separaci√≥n de la l√≠nea anterior */
}


/* Animaci√≥n */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* --- NUEVO: Estilo para la etiqueta "F" en la Ayuda --- */
.ayuda-fallo-tag {
  display: inline-block; /* Necesario para aplicar padding y background */
  background-color: var(--primary-color); /* El azul principal */
  color: #fff; /* Texto blanco */
  font-size: 0.8em; /* Un poco m√°s peque√±o que el texto normal */
  padding: 0.1em 0.4em; /* Peque√±o padding alrededor */
  border-radius: 4px; /* Bordes redondeados */
  font-weight: bold; /* Texto en negrita */
  margin-right: 0.3em; /* Un peque√±o espacio despu√©s de la F */
  vertical-align: baseline; /* Para que se alinee bien con el texto */
  line-height: 1; /* Evita que afecte mucho la altura de l√≠nea */
}
/* --- FIN NUEVO --- */

--- Ayuda.js ---

// ---- frontend/src/Ayuda.js (ACTUALIZADO CON CALENDARIO, COLORES Y FEED) ----

import React from 'react';
import './Ayuda.css';
import iconoAyuda from './assets/ayuda.png';
// Importa el icono de ayuda

function Ayuda() {
  return (
    <div className="ayuda-container">
      {/* --- DIV contenedor para Icono y T√≠tulo, CENTRADO --- */}
      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
        <img src={iconoAyuda} alt="" width="64" height="64" /> {/* Icono 64x64 y ARRIBA */}
        <h2>Gu√≠a de Uso y Ayuda</h2> {/* T√≠tulo CENTRADO */}
      </div>

      <p className="subtitle" style={{ textAlign: 'center' }}>
        Aqu√≠ encontrar√°s explicaciones sobre c√≥mo usar Movium y qu√© significan algunos t√©rminos.
      </p>

      {/* --- SECCI√ìN 1: Rutinas --- */}
      <section className="ayuda-seccion">
        <h3>Gesti√≥n de Rutinas</h3>
        <p>
          En la pantalla de <b>Inicio</b>, puedes ver todas tus rutinas. Haz clic en <b>"Crear Nueva Rutina"</b> para empezar una desde cero. Solo necesitas
          darle un nombre y opcionalmente indicar qu√© d√≠as la har√°s o alguna descripci√≥n √∫til.
        </p>
        
        {/* --- P√ÅRRAFO MODIFICADO (COLORES Y ORDEN) --- */}
        <p>
          Para <b>editar</b> una rutina existente, haz clic en el icono del l√°piz ‚úèÔ∏è en la tarjeta de la rutina en Inicio.
          Una vez dentro, podr√°s modificar su informaci√≥n:
        </p>
        <ul style={{ lineHeight: '1.7' }}>
            <li><b>Nombre/Descripci√≥n:</b> El nombre principal y su descripci√≥n (ej: "Lunes y Jueves").</li>
            <li><b>Orden en Inicio:</b> Un n√∫mero para priorizarla. La rutina con orden "1" saldr√° primero en la pantalla de Inicio.</li>
            <li><b>Color de Tarjeta:</b> ¬°Importante! Puedes asignarle un <strong>color personalizado</strong> (ej: rojo para pierna, azul para pecho). As√≠ puedes personalizar el Inicio y se usar√° en el <strong>Calendario del Historial</strong> para ver qu√© d√≠as has entrenado esa rutina de un vistazo.</li>
        </ul>
        <p>
          Desde esta vista tambi√©n podr√°s a√±adir o quitar ejercicios.
        </p>
        {/* --- FIN DE MODIFICACI√ìN --- */}

        <h4>¬øCu√°ndo entrenaste por √∫ltima vez?</h4>
        <p>
          En cada rutina en la pantalla de Inicio, ver√°s r√°pidamente cu√°ndo fue la √∫ltima vez que registraste un entrenamiento para ella.
          Las fechas recientes se mostrar√°n como <b>"Hoy"</b>, <b>"Ayer"</b> o el <b>d√≠a de la semana pasado</b> (ej: "Mi√©rcoles pasado").
          Si ha pasado una semana o m√°s, ver√°s la <b>fecha completa</b> (ej: 20/10/2025).
          Si una rutina nunca ha sido entrenada, indicar√° <b>"Nunca entrenada"</b>.
        </p>
      </section>

      {/* --- SECCI√ìN 2: Ejercicios y Series --- */}
      <section className="ayuda-seccion">
        <h3>A√±adir Ejercicios y Series</h3>
        <p>
          Dentro de la edici√≥n de una rutina, ver√°s un formulario para <b>"A√±adir Ejercicio"</b>.
          Primero, selecciona un ejercicio de la <b>lista completa de ejercicios</b> (puedes buscar por nombre o filtrar por grupo muscular).
        </p>
        <p>
          Luego, define el <b>objetivo</b> para ese ejercicio:
        </p>
        <ul>
          <li>
            <b>Fuerza/Calistenia:</b> A√±ade una o varias series.
            Para cada serie, puedes definir:
            <ul>
              <li><b>Tipo de Reps:</b> Fijo (un n√∫mero exacto), Rango (m√≠nimo-m√°ximo) o Al Fallo.</li>
              <li><b>Reps:</b> El n√∫mero o rango objetivo.</li>
              <li><b>Peso:</b> El peso en kg que planeas usar.</li>
              <li><b>Descanso (opcional):</b> El tiempo en
                segundos a descansar <i>despu√©s</i> de esa serie.</li>
            </ul>
            Haz clic en "A√±adir Serie" para agregarla a la lista temporal y luego en "Guardar Ejercicio".
          </li>
          <li>
            <b>Cardio:</b> Define un objetivo de Tiempo (minutos) y Distancia (km).
            Tambi√©n puedes a√±adir un descanso posterior. Aqu√≠ puedes a√±adir intervalos.
          </li>
        </ul>
        <p>
          Puedes <b>editar</b> o <b>borrar</b> ejercicios ya a√±adidos a la rutina usando los botones correspondientes en la tabla inferior.
          Al editar, podr√°s cambiar el orden del ejercicio en la rutina y modificar/a√±adir/borrar sus series objetivo.
        </p>
        <h4>¬øDudas sobre un ejercicio?</h4>
        <p>
          Si no est√°s seguro de c√≥mo se realiza un ejercicio o qu√© m√∫sculos trabaja, consulta la <b>"Lista de Ejercicios y Descripciones"</b> m√°s abajo en esta gu√≠a.
          ¬°Te ayudar√° a elegir correctamente!
        </p>
      </section>

      {/* --- SECCI√ìN 3: Entrenar --- */}
      <section className="ayuda-seccion">
        <h3>Registrar un Entrenamiento</h3>
        <p>
          Desde la pantalla de <b>Inicio</b>, haz clic en el bot√≥n <b>"Entrenar"</b> de la rutina que quieras realizar.
          Esto te llevar√° a la pantalla de sesi√≥n.
        </p>
        <p>
          Ver√°s la lista de ejercicios planificados.
          Para cada serie:
        </p>
        <ul>
          <li>Haz clic en el <b>c√≠rculo (‚úì)</b> para marcarla como completada con los valores objetivo.</li>
          <li>Haz clic en el <b>l√°piz (‚úèÔ∏è)</b> para abrir un modal donde puedes registrar los valores <i>reales</i> que hiciste (reps, peso, si fue al fallo, tiempo, distancia) y a√±adir notas espec√≠ficas para esa serie.</li>
        </ul>
        <p>
          Cuando termines todos los ejercicios (o los que vayas a hacer ese d√≠a), pulsa <b>"Finalizar Entrenamiento"</b>.
          Se mostrar√° un resumen. Puedes a√±adir notas generales para la sesi√≥n completa y luego confirmar para guardar tu progreso.
        </p>
      </section>

      {/* --- NUEVA SECCI√ìN: HISTORIAL (CALENDARIO) --- */}
      <section className="ayuda-seccion">
        <h3>Calendario</h3>
        <p>
          Accesible desde el <strong>icono de calendario</strong> en <b>Inicio</b>, esta pantalla te ofrece una vista de calendario de todos tus entrenamientos.
        </p>
        <h4>¬øC√≥mo funciona?</h4>
        <ul>
          <li>Cada d√≠a que hayas registrado un entrenamiento aparecer√° marcado con un punto de color.</li>
          <li>El color del punto corresponde al <strong>color que asignaste a la rutina</strong> que entrenaste ese d√≠a (puedes asignarlo al editar la rutina).</li>
          <li>Si entrenaste m√°s de una rutina (ej: ma√±ana y tarde), ver√°s ver√°s tantos puntos como rutinas hayas entrenado en ese d√≠a.</li>
          <li><strong>Importante:</strong> Si una rutina no tiene un color asignado, sus entrenamientos aparecer√°n en el calendario con un <strong>punto de color gris</strong>.</li>
          <li>Al <strong>hacer clic en un d√≠a marcado</strong>, se desplegar√° debajo un resumen detallado de todas las sesiones que completaste ese d√≠a, incluyendo cada ejercicio y serie registrada.</li>
        </ul>
      </section>
      {/* --- FIN NUEVA SECCI√ìN --- */}

      {/* --- SECCI√ìN 4: Progreso y Estad√≠sticas (REESCRITA) --- */}
      <section className="ayuda-seccion">
        <h3>Progreso (por Rutina) y Estad√≠sticas (PRs)</h3>

        <h4>Progreso por Rutina</h4>
        <p>
          En la pantalla de <b>Inicio</b>, haz clic en el bot√≥n <b>"Progreso"</b> de una rutina para acceder a su historial detallado (diferente del calendario general).
          Aqu√≠ encontrar√°s:
        </p>
        <ul>
            <li><b>Gr√°ficas de Evoluci√≥n:</b> Visualiza c√≥mo has progresado en volumen total, repeticiones, tiempo, etc., a lo largo de las √∫ltimas sesiones <b>para esa rutina espec√≠fica</b>.</li>
            <li><b>Historial Detallado de Sesiones:</b> Una lista de todas las sesiones que has completado para esa rutina, ordenadas de la m√°s reciente a la m√°s antigua.</li>
        </ul>

        <h4>Entendiendo el Historial de Sesiones (en "Progreso" y "Calendario")</h4>
        <p>
          En la cabecera de cada sesi√≥n registrada en el historial, ver√°s unos iconos con res√∫menes r√°pidos:
        </p>
        <ul>
          <li><b>üïí Tiempo Total:</b> Indica la duraci√≥n completa de la sesi√≥n de entrenamiento.</li>
          <li><b>üèãÔ∏è Volumen Total (Fuerza):</b> Representa el peso total levantado (Peso x Repeticiones de cada serie).</li>
          <li><b>Importante:</b> Si marcas una serie "Al Fallo" pero no indicas cu√°ntas repeticiones hiciste, esas repeticiones no se sumar√°n al volumen total. ¬°Es recomendable registrar las reps hechas!</li>
          <li><b>‚è±Ô∏è Tiempo Total (Cardio):</b> Suma de todos los minutos registrados en cardio.</li>
          <li><b>üìç Distancia Total (Cardio):</b> Suma de todos los kil√≥metros registrados en cardio.</li>
          <li><b>üìù Nota:</b> Este icono aparece si a√±adiste alg√∫n comentario a la sesi√≥n. Pulsa sobre √©l para ver la nota.</li>
          <li><b><span className="ayuda-fallo-tag">F</span> (Al Fallo):</b> Esta etiqueta azul aparece junto a una serie si la marcaste como realizada "Al Fallo".</li>
        </ul>

        <h4>Estad√≠sticas (PRs y Rankings)</h4>
        <p>
          La secci√≥n <b>"Estad√≠sticas"</b>, accesible desde el men√∫ lateral, centraliza tus mejores marcas y te permite compararte con amigos. Se divide en dos pesta√±as:
        </p>
        <ul>
            <li>
                <b>Mis PRs:</b> Aqu√≠ puedes ver <b>todos tus R√©cords Personales (PRs)</b> hist√≥ricos para cada ejercicio que has registrado alguna vez (Mayor Peso, M√°ximas Reps, etc.). Puedes usar los filtros para encontrar un ejercicio espec√≠fico.
            </li>
            <li>
                <b>Rankings de Amigos:</b> Esta pesta√±a te permite comparar tus r√©cords con los de tus amigos. Ver√°s rankings para ejercicios clave (Press de Banca, Sentadilla...) y un bot√≥n para seleccionar cualquier otro ejercicio y ver un ranking espec√≠fico.
            </li>
        </ul>
      </section>

      {/* --- SECCI√ìN: Comunidad y Amigos (MODIFICADA) --- */}
      <section className="ayuda-seccion">
        <h3>Comunidad y Amigos</h3>
        <p>
          La secci√≥n <b>"Comunidad"</b>, accesible desde el men√∫ lateral, te permite conectar con otros usuarios de Movium.
        </p>
        
        {/* --- NUEVA SUB-SECCI√ìN FEED --- */}
        <h4>Feed de Actividad</h4>
        <p>
          Al entrar en Comunidad, ver√°s un <strong>bot√≥n con el icono de 'feed'</strong> en la esquina superior derecha.
        </p>
        <p>
          Esta pantalla te muestra, en orden cronol√≥gico, las √∫ltimas sesiones de entrenamiento que <strong>tus amigos</strong> han completado. Es una forma fant√°stica de ver qu√© est√°n entrenando y mantener la motivaci√≥n.
        </p>
        <p>
          Puedes pulsar <strong>"Ver Detalles"</strong> en una actividad del feed para ver un desglose de los ejercicios y series que registraron.
        </p>
        {/* --- FIN NUEVA SUB-SECCI√ìN --- */}

        <h4>Mis Amigos</h4>
        <p>
          La pesta√±a <b>"Mis Amigos"</b> muestra una lista de todos los usuarios con los que has conectado.
          Desde aqu√≠ puedes:
        </p>
        <ul>
          <li>Ver r√°pidamente qui√©n te a√±adi√≥ a ti y a qui√©n a√±adiste t√∫.</li>
          <li>Hacer clic en <b>"Ver PRs"</b> para consultar los r√©cords personales de un amigo.</li>
          <li><b>Eliminar</b> a un amigo de tu lista (esta acci√≥n es mutua).</li>
        </ul>

        <h4>Buscar Usuarios</h4>
        <p>
          Usa la pesta√±a <b>"Buscar Usuarios"</b> para encontrar a otros miembros por su nombre de usuario.
        </p>
        {/* --- P√ÅRRAFO MODIFICADO (SIN EMOJI üîç) --- */}
        <p>
          Escribe al menos dos caracteres en la barra de b√∫squeda y pulsa Enter o haz clic en el <strong>icono de la lupa</strong>.
        </p>
        {/* --- FIN MODIFICACI√ìN --- */}
        <ul>
          <li>En los resultados, ver√°s si ya eres amigo de alguien.</li>
          <li>Puedes <b>"A√±adir Amigo"</b> si a√∫n no lo eres.</li>
          <li>Tambi√©n puedes <b>"Eliminar Amigo"</b> directamente desde los resultados.</li>
        </ul>
      </section>

      {/* --- SECCI√ìN: Perfil --- */}
      <section className="ayuda-seccion">
        <h3>Tu Perfil y Cuenta</h3>
        <p>
          Desde el men√∫ lateral, puedes acceder a la secci√≥n <b>"Perfil"</b> para ver y actualizar tu informaci√≥n personal (nombre, fecha de nacimiento, altura, peso, etc.).
        </p>
        <p>
          <b>¬°Importante!</b> Si a√±ades tu <b>correo electr√≥nico</b> en el perfil, podr√°s usarlo como alternativa a tu nombre de usuario para <b>iniciar sesi√≥n</b>.
          Esto es √∫til si alguna vez olvidas tu nombre de usuario exacto.
        </p>
        <p>
          Recuerda que tu nombre de usuario no se puede cambiar una vez registrado.
        </p>
      </section>

      {/* --- SECCI√ìN: Conceptos T√©cnicos --- */}
      <section className="ayuda-seccion">
        <h3>Conceptos Clave</h3>
        <dl>
          <dt>PR (Personal Record)</dt>
          <dd>Tu mejor marca personal registrada para un ejercicio espec√≠fico (ej: m√°ximo peso, m√°ximas repeticiones, mayor distancia).</dd>

          <dt>e1RM (estimated 1 Repetition Maximum)</dt>
          <dd>
            M√°ximo Estimado para 1 Repetici√≥n.
            Es una f√≥rmula que <i>estima</i> cu√°l ser√≠a el peso m√°ximo que podr√≠as levantar para una sola repetici√≥n, bas√°ndose en el peso y las repeticiones de una serie que ya hiciste.
            Utilizamos esta m√©trica en los rankings de amigos porque permite hacer una <b>comparaci√≥n de fuerza m√°s justa</b>.
            La f√≥rmula que usamos es la de Epley:
            <br />
            <code>e1RM = Peso * (1 + Repeticiones / 30)</code>
          </dd>

          <dt>Serie al Fallo</dt>
          <dd>Una serie llevada hasta el punto en que no puedes completar ni una repetici√≥n m√°s con buena forma.</dd>

          <dt>Volumen (en Fuerza)</dt>
          <dd>
            Es una medida del trabajo total realizado en un ejercicio o sesi√≥n.
            Generalmente se calcula multiplicando el peso levantado por las repeticiones realizadas y por el n√∫mero de series.
            <br />
            <code>Volumen = Peso * Repeticiones * Series</code>
          </dd>
        </dl>
      </section>
      
      {/* --- SECCI√ìN: Lista de Ejercicios CON GRUPO MUSCULAR (COMPLETA) --- */}
      <section className="ayuda-seccion">
        <h3>Lista de Ejercicios y Descripciones</h3>
        <p>Aqu√≠ tienes una lista de los ejercicios disponibles en la aplicaci√≥n, su grupo muscular principal y una breve descripci√≥n</p>
        <dl className="lista-ejercicios-descripcion">
          {/* PECHO */}
          <dt>Press de Banca con Barra <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>Acostado en un banco plano, bajar la barra al pecho y empujar hacia arriba.</dd>
          <dt>Press de Banca Inclinado con Barra <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>En un banco inclinado, bajar la barra a la parte superior del pecho y empujar.</dd>
          <dt>Press de Banca Declinado con Barra <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>En un banco declinado, bajar la barra a la parte inferior del pecho.</dd>
          <dt>Press de Banca con Mancuernas <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>Acostado en un banco plano, bajar las mancuernas a los lados del pecho.</dd>
          <dt>Press Inclinado con Mancuernas <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>En un banco inclinado, bajar las mancuernas a los lados del pecho.</dd>
          <dt>Aperturas con Mancuernas <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>Acostado en un banco plano, abrir y cerrar los brazos con una ligera flexi√≥n de codo.</dd>
          <dt>Aperturas en Cable (Cruce de Poleas) <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>De pie, cruzar las poleas por delante del pecho contrayendo los pectorales.</dd>
          <dt>Fondos en Paralelas (Dips) <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>Suspender el cuerpo en barras paralelas y bajar flexionando los codos. (Enfocado a pecho inclin√°ndose).</dd>
          <dt>Flexiones (Push-ups) <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>Tumbado boca abajo, empujar el suelo para levantar el cuerpo.</dd>
          <dt>Pullover con Mancuerna <span className="ejercicio-grupo-tag">Pecho</span></dt>
          <dd>Acostado transversalmente en un banco, bajar una mancuerna por detr√°s de la cabeza.</dd>

          {/* ESPALDA */}
          <dt>Dominadas (Pull-ups) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Colgado de una barra, subir el cuerpo hasta que la barbilla la supere (agarre prono).</dd>
          <dt>Dominadas Agarre Neutro/Supino (Chin-ups) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Colgado de una barra, subir el cuerpo (agarre neutro o supino, enfoca m√°s b√≠ceps).</dd>
          <dt>Jal√≥n al Pecho (Lat Pulldown) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Sentado, tirar de una barra hacia la parte superior del pecho, simulando una dominada.</dd>
          <dt>Remo con Barra (Barbell Row) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Inclinado con espalda recta, tirar de la barra hacia el abdomen.</dd>
          <dt>Remo con Mancuerna (Dumbbell Row) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Apoyado en un banco, remar con una mancuerna con un solo brazo.</dd>
          <dt>Remo en Punta (T-Bar Row) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Usando una barra T, tirar del peso hacia el pecho.</dd>
          <dt>Remo Sentado en M√°quina (Gironda) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Sentado con las piernas apoyadas, tirar de un agarre (V o ancho) hacia el abdomen.</dd>
          <dt>Peso Muerto (Deadlift) <span className="ejercicio-grupo-tag">Espalda</span></dt>
          <dd>Levantar la barra del suelo hasta estar erguido, con la espalda recta. (Implica pierna y espalda).</dd>
          <dt>Hiperextensiones (Back Extensions) <span className="ejercicio-grupo-tag">Lumbar</span></dt>
          <dd>En un banco de hiperextensiones, flexionar y extender la cadera.</dd>

          {/* PIERNA */}
          <dt>Sentadilla con Barra (Squat) <span className="ejercicio-grupo-tag">Pierna</span></dt>
          <dd>Con la barra en la espalda, bajar la cadera por debajo de las rodillas y subir.</dd>
          <dt>Sentadilla Frontal (Front Squat) <span className="ejercicio-grupo-tag">Pierna</span></dt>
          <dd>Con la barra en los hombros (delante), bajar la cadera. Enfoca m√°s cu√°driceps.</dd>
          <dt>Prensa de Piernas (Leg Press) <span className="ejercicio-grupo-tag">Pierna</span></dt>
          <dd>Sentado en la m√°quina, empujar la plataforma con las piernas.</dd>
          <dt>Zancadas (Lunges) con Mancuerna <span className="ejercicio-grupo-tag">Pierna</span></dt>
          <dd>Dar un paso adelante y flexionar ambas rodillas a 90 grados.</dd>
          <dt>Sentadilla B√∫lgara <span className="ejercicio-grupo-tag">Pierna</span></dt>
          <dd>Con un pie elevado detr√°s, hacer una sentadilla con la pierna delantera.</dd>
          <dt>Extensi√≥n de Cu√°driceps (Quad Extension) <span className="ejercicio-grupo-tag">Pierna</span></dt>
          <dd>Sentado, extender las piernas contra la resistencia de la m√°quina.</dd>
          <dt>Curl Femoral Tumbado <span className="ejercicio-grupo-tag">Femoral</span></dt>
          <dd>Tumbado boca abajo, flexionar las rodillas para llevar los talones al gl√∫teo.</dd>
          <dt>Curl Femoral Sentado <span className="ejercicio-grupo-tag">Femoral</span></dt>
          <dd>Sentado, flexionar las rodillas contra la resistencia.</dd>
          <dt>Peso Muerto Rumano (RDL) <span className="ejercicio-grupo-tag">Femoral</span></dt>
          <dd>Bajar la barra con las piernas casi rectas, enfocando el estiramiento del femoral.</dd>
          <dt>Hip Thrust <span className="ejercicio-grupo-tag">Gl√∫teo</span></dt>
          <dd>Con la espalda apoyada en un banco, levantar la cadera con una barra.</dd>
          <dt>Patada de Gl√∫teo en Polea <span className="ejercicio-grupo-tag">Gl√∫teo</span></dt>
          <dd>Dar una patada hacia atr√°s con una polea atada al tobillo.</dd>
          <dt>Elevaci√≥n de Gemelos de Pie <span className="ejercicio-grupo-tag">Gemelo</span></dt>
          <dd>Ponerse de puntillas contra una resistencia (m√°quina o peso).</dd>
          <dt>Elevaci√≥n de Gemelos Sentado <span className="ejercicio-grupo-tag">Gemelo</span></dt>
          <dd>Sentado, ponerse de puntillas contra la resistencia.</dd>

          {/* HOMBRO */}
          <dt>Press Militar con Barra (Overhead Press) <span className="ejercicio-grupo-tag">Hombro</span></dt>
          <dd>De pie o sentado, empujar la barra desde los hombros por encima de la cabeza.</dd>
          <dt>Press Militar con Mancuernas <span className="ejercicio-grupo-tag">Hombro</span></dt>
          <dd>Sentado, empujar las mancuernas desde los hombros por encima de la cabeza.</dd>
          <dt>Press Arnold <span className="ejercicio-grupo-tag">Hombro</span></dt>
          <dd>Un press con mancuernas que incluye una rotaci√≥n de mu√±eca.</dd>
          <dt>Elevaciones Laterales con Mancuerna <span className="ejercicio-grupo-tag">Hombro</span></dt>
          <dd>Levantar mancuernas hacia los lados hasta la altura de los hombros.</dd>
          <dt>Elevaciones Laterales en Polea <span className="ejercicio-grupo-tag">Hombro</span></dt>
          <dd>Usando una polea baja, elevar el brazo lateralmente.</dd>
          <dt>Elevaciones Frontales (Front Raises) <span className="ejercicio-grupo-tag">Hombro</span></dt>
          <dd>Levantar mancuernas o un disco hacia el frente.</dd>
          <dt>P√°jaros (Reverse Flyes) <span className="ejercicio-grupo-tag">Hombro</span></dt>
          <dd>Inclinado, abrir los brazos para trabajar la parte posterior del hombro.</dd>
          <dt>Encogimientos (Shrugs) con Barra <span className="ejercicio-grupo-tag">Trapecio</span></dt>
          <dd>Encoger los hombros hacia las orejas sosteniendo una barra pesada.</dd>

          {/* B√çCEPS */}
          <dt>Curl de B√≠ceps con Barra <span className="ejercicio-grupo-tag">B√≠ceps</span></dt>
          <dd>De pie, flexionar los codos para levantar la barra.</dd>
          <dt>Curl de B√≠ceps con Mancuernas (Alterno) <span className="ejercicio-grupo-tag">B√≠ceps</span></dt>
          <dd>De pie o sentado, flexionar los codos alternando los brazos.</dd>
          <dt>Curl Martillo (Hammer Curl) <span className="ejercicio-grupo-tag">B√≠ceps</span></dt>
          <dd>Curl con agarre neutro (palmas enfrentadas), trabaja m√°s el braquial.</dd>
          <dt>Curl Predicador (Scott Curl) <span className="ejercicio-grupo-tag">B√≠ceps</span></dt>
          <dd>Apoyando el brazo en un banco Scott, flexionar el codo.</dd>
          <dt>Curl de Concentraci√≥n <span className="ejercicio-grupo-tag">B√≠ceps</span></dt>
          <dd>Sentado, apoyar el codo en el muslo y flexionar.</dd>

          {/* TR√çCEPS */}
          <dt>Fondos de Tr√≠ceps (en banco) <span className="ejercicio-grupo-tag">Tr√≠ceps</span></dt>
          <dd>De espaldas a un banco, bajar y subir el cuerpo con las manos apoyadas.</dd>
          <dt>Press Franc√©s (Skullcrushers) <span className="ejercicio-grupo-tag">Tr√≠ceps</span></dt>
          <dd>Acostado, bajar una barra Z o mancuernas hacia la frente y extender.</dd>
          <dt>Extensi√≥n de Tr√≠ceps en Polea (Cuerda) <span className="ejercicio-grupo-tag">Tr√≠ceps</span></dt>
          <dd>En una polea alta, extender los codos hacia abajo usando una cuerda.</dd>
          <dt>Extensi√≥n de Tr√≠ceps en Polea (Barra V) <span className="ejercicio-grupo-tag">Tr√≠ceps</span></dt>
          <dd>En una polea alta, extender los codos hacia abajo usando una barra V.</dd>
          <dt>Patada de Tr√≠ceps (Tricep Kickback) <span className="ejercicio-grupo-tag">Tr√≠ceps</span></dt>
          <dd>Inclinado, extender el codo hacia atr√°s con una mancuerna.</dd>

          {/* ABDOMEN */}
          <dt>Crunch Abdominal <span className="ejercicio-grupo-tag">Abdomen</span></dt>
          <dd>Acostado, contraer el abdomen para levantar los hombros del suelo.</dd>
          <dt>Plancha (Plank) <span className="ejercicio-grupo-tag">Abdomen</span></dt>
          <dd>Mantener una posici√≥n recta apoyado en antebrazos y pies.</dd>
          <dt>Elevaci√≥n de Piernas Colgado <span className="ejercicio-grupo-tag">Abdomen</span></dt>
          <dd>Colgado de una barra, levantar las piernas (rectas o flexionadas).</dd>
          <dt>Rueda Abdominal (Ab Wheel) <span className="ejercicio-grupo-tag">Abdomen</span></dt>
          <dd>Arrodillado, deslizar una rueda hacia adelante y volver.</dd>
          <dt>Russian Twist <span className="ejercicio-grupo-tag">Abdomen</span></dt>
          <dd>Sentado en V, girar el torso de un lado a otro (con o sin peso).</dd>

          {/* CARDIO */}
          <dt>Cinta - Correr <span className="ejercicio-grupo-tag">Cardio</span></dt>
          <dd>Correr a una velocidad constante o en intervalos en la cinta.</dd>
          <dt>Cinta - Caminar Inclinado <span className="ejercicio-grupo-tag">Cardio</span></dt>
          <dd>Caminar a buen ritmo en la cinta con una inclinaci√≥n elevada.</dd>
          <dt>Bicicleta Est√°tica <span className="ejercicio-grupo-tag">Cardio</span></dt>
          <dd>Pedalear en una bicicleta est√°tica, ajustando resistencia y velocidad.</dd>
          <dt>El√≠ptica <span className="ejercicio-grupo-tag">Cardio</span></dt>
          <dd>Simular un movimiento de carrera/esqu√≠ en la m√°quina el√≠ptica.</dd>
          <dt>M√°quina de Remo (Rowing) <span className="ejercicio-grupo-tag">Cardio</span></dt>
          <dd>Simular el movimiento de remo, trabajando todo el cuerpo.</dd>
          <dt>Saltar a la Cuerda (Comba) <span className="ejercicio-grupo-tag">Cardio</span></dt>
          <dd>Saltar a la comba a diferentes ritmos.</dd>
        </dl>
      </section>

    </div>
  );
}

export default Ayuda;

--- CardioRankingCard.css ---

/* ---- frontend/src/components/CardioRankingCard.css (NUEVO ARCHIVO) ---- */

.cardio-ranking-card {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Cabecera (T√≠tulo General) */
.cardio-ranking-header {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--input-border-color);
  background-color: var(--input-bg-color);
}

.cardio-ranking-header strong {
  font-size: 1.1rem;
  color: var(--text-color);
}

/* Cuerpo (Contenedor de las 3 m√©tricas) */
.cardio-ranking-body {
  padding: 1rem 1.25rem 1.5rem; /* M√°s padding abajo */
  display: flex;
  flex-direction: column;
  gap: 1.5rem; /* Espacio entre m√©tricas */
}

/* Secci√≥n para cada m√©trica (Distancia, Tiempo, Velocidad) */
.metric-section h4 {
  margin-top: 0;
  margin-bottom: 0.75rem;
  font-size: 0.95rem;
  color: var(--text-secondary-color);
  border-bottom: 1px dashed var(--input-border-color);
  padding-bottom: 0.5rem;
}

/* Lista del Top 3 (reutiliza estilos de RankingCard con prefijo mini-) */
.mini-ranking-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem; /* Menos espacio entre puestos */
}

.mini-ranking-item {
  display: flex;
  align-items: center;
  gap: 0.75rem; /* Menos gap */
  padding: 0.2rem 0;
}

.mini-ranking-pos {
  font-size: 1.1rem; /* M√°s peque√±o */
  font-weight: 700;
  color: var(--text-secondary-color);
  width: 30px; /* M√°s estrecho */
  text-align: center;
  flex-shrink: 0;
}

.mini-ranking-user {
  flex-grow: 1;
  font-size: 1rem; /* M√°s peque√±o */
  color: var(--text-color);
  font-weight: normal; /* Normal */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.mini-ranking-value {
  font-size: 1.1rem; /* M√°s peque√±o */
  font-weight: 700;
  color: var(--text-color);
  flex-shrink: 0;
  text-align: right;
}

.mini-ranking-label {
  font-size: 0.8rem; /* M√°s peque√±o */
  color: var(--text-secondary-color);
  margin-left: 0.25rem;
}

/* Resaltado del usuario (igual que en RankingCard) */
.mini-ranking-item.is-me {
  background-color: var(--input-bg-color);
  margin: -0.2rem -0.5rem;
  padding: 0.2rem 0.5rem;
  border-radius: 6px;
}

.mini-ranking-item.is-me .mini-ranking-pos,
.mini-ranking-item.is-me .mini-ranking-user,
.mini-ranking-item.is-me .mini-ranking-value {
  color: var(--primary-color);
  font-weight: 700; /* Resaltamos el peso */
}
.mini-ranking-item.is-me .mini-ranking-label {
  color: var(--primary-color);
  opacity: 0.8;
}

/* Mensaje sin datos */
.no-ranking-data {
  font-size: 0.85rem;
  color: var(--text-secondary-color);
  text-align: center;
  font-style: italic;
  padding: 0.5rem 0;
  margin: 0;
}

--- CardioRankingCard.js ---

// ---- frontend/src/components/CardioRankingCard.js (NUEVO ARCHIVO) ----

import React from 'react';
import './CardioRankingCard.css'; // Crearemos este CSS

// Helper para renderizar una lista de ranking (Top 3)
const renderRankingList = (data, miUsuarioId, label) => {
  if (!data || data.length === 0) {
    return <p className="no-ranking-data">Sin datos</p>;
  }

  // Usamos los mismos emojis de medalla que en RankingCard
  const MEDALLAS = ['ü•á', 'ü•à', 'ü•â'];

  return (
    <ol className="mini-ranking-list">
      {data.map((item, index) => {
        const esUsuarioLogueado = item.usuario_id == miUsuarioId;
        return (
          <li key={item.usuario_id} className={`mini-ranking-item ${esUsuarioLogueado ? 'is-me' : ''}`}>
            <span className="mini-ranking-pos">{MEDALLAS[index] || `${index + 1}.`}</span>
            <span className="mini-ranking-user">
              {item.nombre_usuario} {esUsuarioLogueado && '(T√∫)'}
            </span>
            <span className="mini-ranking-value">
              {item.valor || 0}
              <span className="mini-ranking-label">{label}</span>
            </span>
          </li>
        );
      })}
    </ol>
  );
};

function CardioRankingCard({ title, rankings, miUsuarioId }) {
  // rankings = { max_dist: [...], max_tiempo: [...], max_velocidad_media: [...] }

  return (
    <div className="cardio-ranking-card">
      <div className="cardio-ranking-header">
        <strong>{title}</strong>
      </div>
      <div className="cardio-ranking-body">
        {/* Secci√≥n Max Distancia */}
        <div className="metric-section">
          <h4>üìç Mayor Distancia</h4>
          {renderRankingList(rankings?.max_distancia, miUsuarioId, 'km')}
        </div>

        {/* Secci√≥n Max Tiempo */}
        <div className="metric-section">
          <h4>‚è±Ô∏è Mayor Tiempo</h4>
          {renderRankingList(rankings?.max_tiempo, miUsuarioId, 'min')}
        </div>

        {/* Secci√≥n Max Velocidad */}
        <div className="metric-section">
          <h4>‚ö° Velocidad Media M√°x</h4>
          {renderRankingList(rankings?.max_velocidad_media, miUsuarioId, 'km/h')}
        </div>
      </div>
    </div>
  );
}

export default CardioRankingCard;

--- Comunidad.css ---

/* ---- frontend/src/Comunidad.css (Refactorizado con bot√≥n de Feed) ---- */

.comunidad-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 900px;
  margin: 0 auto;
  position: relative; /* <-- 1. A√ëADIDO: Para posicionar el bot√≥n de feed */
}

.comunidad-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
}

.comunidad-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 2rem;
}

/* Pesta√±as (Tabs) */
.comunidad-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  border-bottom: 1px solid var(--input-border-color);
}

.tab-btn {
  background: none;
  border: none;
  font-family: var(--font-family);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-secondary-color);
  padding: 0 0.5rem 1rem 0.5rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 3px solid transparent;
}

.tab-btn:hover {
  color: var(--text-color);
}

.tab-btn.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
}

/* Contenido de la pesta√±a (Grid) */
.comunidad-content {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
}

/* Formulario de B√∫squeda */
.search-form {
  margin-bottom: 1.5rem;
  display: flex;
}

/* Contenedor del input y el icono */
.search-input-container {
  position: relative; 
  flex-grow: 1; 
}

/* Input de B√∫squeda */
.search-input {
  width: 100%;
  height: 48px;
  padding: 0 1rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  box-sizing: border-box;
  transition: border-color 0.3s, box-shadow 0.3s;
  padding-right: 3.5rem; 
}

.search-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}

/* Ocultar la 'x' por defecto en input[type="search"] */
.search-input::-webkit-search-cancel-button {
  -webkit-appearance: none;
  appearance: none;
  display: none;
}
.search-input::-ms-clear {
  display: none;
  width: 0;
  height: 0;
}


/* Icono DENTRO del input */
.search-icon-inside {
  position: absolute;
  right: 1rem; 
  top: 0;
  bottom: 0;
  margin: auto 0; 
  width: 26px; 
  height: 26px; 
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.2s ease;
}

.search-icon-inside:hover {
  opacity: 1;
}

/* Contador de caracteres para la b√∫squeda */
.search-char-counter {
  position: absolute;
  bottom: 1rem; 
  right: 3.8rem; 
  font-size: 0.75rem;
  color: var(--text-secondary-color);
  user-select: none; 
  pointer-events: none;
}


/* --- 2. A√ëADIDO: Bot√≥n de Icono de Feed (copiado de Dashboard.css) --- */
.btn-feed-link {
  position: absolute;
  top: 2rem; /* Misma distancia que el padding */
  right: 2rem; /* Misma distancia que el padding */
  
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  color: var(--text-secondary-color);
  
  width: 48px; 
  height: 48px;
  border-radius: 50%; /* Bot√≥n redondo */
  
  display: flex;
  align-items: center;
  justify-content: center;
  
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10; /* Por si acaso */
}

.btn-feed-link:hover {
  border-color: var(--primary-color);
  background-color: var(--surface-color);
  transform: scale(1.1);
}

.btn-feed-link img {
  width: 24px; /* Tama√±o del icono */
  height: 24px;
  opacity: 0.8; 
}

.btn-feed-link:hover img {
  opacity: 1;
}

/* --- Media Query para el bot√≥n --- */
@media (max-width: 767px) {
  .btn-feed-link {
    top: 1.5rem; /* Ajuste al padding de m√≥vil */
    right: 1.5rem; /* Ajuste al padding de m√≥vil */
    width: 42px;
    height: 42px;
  }
  .btn-feed-link img {
    width: 20px;
    height: 20px;
  }
}

--- Comunidad.js ---

// ---- frontend/src/Comunidad.js (Refactorizado con bot√≥n de Feed) ----

import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom'; // <-- 1. IMPORTADO
import './Comunidad.css';
import UsuarioCard from './components/UsuarioCard';
import AmigoPRsModal from './components/AmigoPRsModal';
import iconoComunidad from './assets/amigos.png';
import iconoBusqueda from './assets/busqueda.png';
import iconoFeed from './assets/feed.png'; // <-- 2. IMPORTADO
import GuiaModal from './components/GuiaModal';
import ConfirmarAccionModal from './components/ConfirmarAccionModal';

// --- Constante de longitud ---
const MAX_QUERY_LENGTH = 18;

function Comunidad() {
  const [activeTab, setActiveTab] = useState('amigos'); // <-- 3. Renombrado
  const [misAmigos, setMisAmigos] = useState([]);
  const [resultadosBusqueda, setResultadosBusqueda] = useState([]);
  const [query, setQuery] = useState('');
  const [loadingAmigos, setLoadingAmigos] = useState(true);
  const [loadingBusqueda, setLoadingBusqueda] = useState(false);
  const [error, setError] = useState(null);
  const [amigoParaVerPRs, setAmigoParaVerPRs] = useState(null);
  const [showGuiaComunidad, setShowGuiaComunidad] = useState(false);

  const [isConfirmarAmigoOpen, setIsConfirmarAmigoOpen] = useState(false);
  const [amigoParaBorrar, setAmigoParaBorrar] = useState(null);
  const [isDeletingAmigo, setIsDeletingAmigo] = useState(false);

  const [haBuscado, setHaBuscado] = useState(false);
  
  const navigate = useNavigate(); // <-- 4. A√±adido

  // --- Helper para marcar gu√≠a (sin cambios) ---
  const marcarGuiaComoVista = async (nombreGuia) => {
    const token = localStorage.getItem('movium_token');
    if (!token) return;
    try {
      await fetch('http://localhost/programacion/TFG/movium/backend/api/marcar_guia_vista.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ guia_vista: nombreGuia })
      });
    } catch (error) {
      console.error("Error al marcar la gu√≠a como vista:", error);
    }
  };

  // --- useEffect para mostrar gu√≠a (sin cambios) ---
  useEffect(() => {
    try {
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      if (storedUser && !storedUser.ha_visto_guia_comunidad) {
        setShowGuiaComunidad(true);
      }
    } catch (e) {
      console.error("Error al leer datos de usuario para la gu√≠a de Comunidad:", e);
    }
  }, []);

  // --- Handler para cerrar gu√≠a (sin cambios) ---
  const handleCerrarGuiaComunidad = () => {
    try {
      marcarGuiaComoVista('comunidad');
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      if (storedUser) {
        const updatedUser = { ...storedUser, ha_visto_guia_comunidad: true };
        localStorage.setItem('movium_user', JSON.stringify(updatedUser));
      }
      setShowGuiaComunidad(false);
    } catch (e) {
      console.error("Error al cerrar la gu√≠a de Comunidad:", e);
      setShowGuiaComunidad(false);
    }
  };

  const token = localStorage.getItem('movium_token');

  // --- Funci√≥n para manejar el input de b√∫squeda (sin cambios) ---
  const handleQueryChange = (e) => {
    setQuery(e.target.value);
    setHaBuscado(false); 
    setResultadosBusqueda([]); 
    
    if (error === "Escribe al menos 2 caracteres para buscar.") {
      setError(null);
    }
  };

  // --- API: Cargar "Mis Amigos" (sin cambios) ---
  const cargarMisAmigos = useCallback(async () => {
    setLoadingAmigos(true);
    setError(null);
    try {
      const res = await fetch('http://localhost/programacion/TFG/movium/backend/api/get_mis_amigos.php', {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.mensaje || "Error al cargar amigos.");
      setMisAmigos(data);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoadingAmigos(false);
    }
  }, [token]);

  // --- 5. useEffect modificado para cargar seg√∫n la pesta√±a activa ---
  useEffect(() => {
    // Limpiamos errores al cambiar de pesta√±a
    setError(null);
    
    if (activeTab === 'amigos') {
      // Cargamos amigos solo si estamos en esa pesta√±a
      cargarMisAmigos();
    }
    // No es necesario 'else' porque 'buscar' se activa con el submit
  }, [activeTab, cargarMisAmigos]); // Se ejecuta si cambia la pesta√±a

  // --- API: Buscar Usuarios (sin cambios) ---
  const handleSearchSubmit = async (e) => {
    if (e && typeof e.preventDefault === 'function') {
      e.preventDefault();
    }
    if (query.trim().length < 2) {
      setError("Escribe al menos 2 caracteres para buscar.");
      setHaBuscado(false); 
      setResultadosBusqueda([]); 
      return;
    }

    setLoadingBusqueda(true);
    setError(null);
    setHaBuscado(false); 

    try {
      const res = await fetch(`http://localhost/programacion/TFG/movium/backend/api/search_usuarios.php?query=${query}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.mensaje || "Error al buscar.");
      setResultadosBusqueda(data);
    } catch (err) {
      setError(err.message);
    } finally {
      setLoadingBusqueda(false);
      setHaBuscado(true); 
    }
  };

  // --- API: A√±adir Amigo (sin cambios) ---
  const addAmigo = async (id) => {
    setError(null);
    try {
      const res = await fetch('http://localhost/programacion/TFG/movium/backend/api/add_amigo.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ amigo_a_anadir_id: id })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.mensaje || "Error al a√±adir.");
      
      setResultadosBusqueda(prev =>
        prev.map(user => user.id === id ? { ...user, son_amigos: true } : user)
      );
      // Recarga la lista de amigos en segundo plano
      cargarMisAmigos();
    } catch (err) {
      setError(err.message);
    }
  };

  // --- Funci√≥n deleteAmigo (sin cambios) ---
  const deleteAmigo = (id) => {
    setError(null);
    const amigo = misAmigos.find(a => a.id === id) || resultadosBusqueda.find(u => u.id === id);
    if (amigo) {
      setAmigoParaBorrar(amigo);
      setIsConfirmarAmigoOpen(true);
    } else {
      console.error("No se pudo encontrar al amigo para borrar.");
    }
  };

  // --- Funci√≥n handleConfirmDeleteAmigo (sin cambios) ---
  const handleConfirmDeleteAmigo = async () => {
    if (!amigoParaBorrar) return;
    setIsDeletingAmigo(true);
    setError(null);
    const id = amigoParaBorrar.id;

    try {
      const res = await fetch('http://localhost/programacion/TFG/movium/backend/api/delete_amigo.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ amigo_a_borrar_id: id })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.mensaje || "Error al eliminar.");
      
      setResultadosBusqueda(prev =>
        prev.map(user => user.id === id ? { ...user, son_amigos: false } : user)
      );
      setMisAmigos(prev => prev.filter(user => user.id !== id));

    } catch (err) {
      setError(err.message);
    } finally {
      setIsConfirmarAmigoOpen(false);
      setIsDeletingAmigo(false);
      setAmigoParaBorrar(null);
    }
  };

  // --- 6. NUEVA FUNCI√ìN para navegar al Feed ---
  const handleNavigateToFeed = () => {
    navigate('/comunidad/feed'); // Ajusta esta ruta si es diferente en tu App.js
  };

  // --- Renderizado ---
  return (
    <>
      <div className="comunidad-container">
        {/* --- T√≠tulo e icono principal (sin cambios) --- */}
        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
          <img src={iconoComunidad} alt="" width="64" height="64" />
          <h2>Comunidad</h2>
        </div>
        <p className="subtitle" style={{ textAlign: 'center' }}>
          Encuentra nuevos compa√±eros o revisa el progreso de tus amigos.
        </p>

        {/* --- 7. BOT√ìN DE FEED A√ëADIDO --- */}
        <button
          className="btn-feed-link" // Usar√° la nueva clase CSS
          onClick={handleNavigateToFeed}
          title="Ver Feed de Actividad"
        >
          <img src={iconoFeed} alt="Feed" />
        </button>

        {error && <div className="message" style={{ marginBottom: '1.5rem' }}>{error}</div>}

        {/* --- 8. Pesta√±as (actualizadas a activeTab) --- */}
        <div className="comunidad-tabs">
          <button className={`tab-btn ${activeTab === 'amigos' ? 'active' : ''}`} onClick={() => setActiveTab('amigos')}>
            Mis Amigos ({misAmigos.length})
          </button>
          <button className={`tab-btn ${activeTab === 'buscar' ? 'active' : ''}`} onClick={() => setActiveTab('buscar')}>
            Buscar Usuarios
          </button>
        </div>

        {/* --- Contenido Pesta√±a "Mis Amigos" (actualizado a activeTab) --- */}
        {activeTab === 'amigos' && (
          <div className="comunidad-content">
            {loadingAmigos && <p className="subtitle">Cargando amigos...</p>}
            {!loadingAmigos && misAmigos.length === 0 && (
              <p className="no-rutinas-msg" style={{ gridColumn: '1 / -1' }}>
                A√∫n no tienes amigos. ¬°Usa la pesta√±a "Buscar Usuarios" para a√±adir algunos!
              </p>
            )}
            {!loadingAmigos && misAmigos.map(amigo => (
              <UsuarioCard
                key={amigo.id}
                usuario={amigo}
                tipo="amigo"
                onDeleteAmigo={() => deleteAmigo(amigo.id)}
                onVerPRs={() => setAmigoParaVerPRs(amigo)}
              />
            ))}
          </div>
        )}

        {/* --- Contenido Pesta√±a "Buscar Usuarios" (actualizado a activeTab) --- */}
        {activeTab === 'buscar' && (
          <div>
            <form className="search-form" onSubmit={handleSearchSubmit}>
              <div className="search-input-container">
                <input
                  type="search"
                  className="search-input"
                  placeholder="Buscar por nombre de usuario..."
                  value={query}
                  onChange={handleQueryChange}
                  maxLength={MAX_QUERY_LENGTH}
                />
                <img
                  src={iconoBusqueda}
                  alt="Buscar"
                  className="search-icon-inside"
                  onClick={handleSearchSubmit}
                />
                <small className="search-char-counter">
                  {query.length} / {MAX_QUERY_LENGTH}
                </small>
              </div>
            </form>

            <div className="comunidad-content">
              {loadingBusqueda && <p className="subtitle">Buscando...</p>}
              
              {!loadingBusqueda && haBuscado && resultadosBusqueda.length === 0 && (
                <p className="no-rutinas-msg" style={{ gridColumn: '1 / -1' }}>
                  No se encontraron usuarios con ese nombre.
                </p>
              )}

              {!loadingBusqueda && resultadosBusqueda.map(user => (
                <UsuarioCard
                  key={user.id}
                  usuario={user}
                  tipo="busqueda"
                  onAddAmigo={() => addAmigo(user.id)}
                  onDeleteAmigo={() => deleteAmigo(user.id)}
                />
              ))}
            </div>
          </div>
        )}
      </div>

      {/* --- Modal PRs Amigo (Sin cambios) --- */}
      <AmigoPRsModal
        isOpen={amigoParaVerPRs !== null}
        onClose={() => setAmigoParaVerPRs(null)}
        amigo={amigoParaVerPRs}
        token={token}
      />

      {/* --- Modal Gu√≠a Comunidad (Sin cambios) --- */}
      <GuiaModal
          isOpen={showGuiaComunidad}
          onClose={handleCerrarGuiaComunidad}
          titulo="¬°Conecta y Compara!"
      >
          <p>¬°Bienvenido a la <strong>Comunidad</strong>!</p>
          <p>Conectar con otros es clave para mantener la motivaci√≥n. Esta secci√≥n tiene tres funciones principales:</p>
          <ul style={{ marginTop: '0.5rem', marginBottom: '1rem', paddingLeft: '1.2rem' }}>

              {/* --- L√çNEA CORREGIDA --- */}
              <li style={{ marginBottom: '0.5rem' }}>
                  <strong>Feed de Actividad:</strong> Pulsa el <strong>bot√≥n con el icono de 'feed'</strong> en la esquina superior derecha para ver un resumen de las √∫ltimas sesiones que han completado tus amigos.
              </li>
              {/* --- FIN CORRECCI√ìN --- */}

              <li style={{ marginBottom: '0.5rem' }}>
                  <strong>Mis Amigos (Pesta√±a):</strong> Aqu√≠ ver√°s tu lista de amigos. Desde aqu√≠ puedes hacer clic para ver todos sus R√©cords Personales (PRs).
              </li>
              <li>
                  <strong>Buscar Usuarios (Pesta√±a):</strong> Usa el buscador para encontrar a tus compa√±eros de gimnasio por su nombre de usuario y a√±adirlos.
              </li>
          </ul>
      </GuiaModal>

      {/* --- MODAL DE CONFIRMACI√ìN (Sin cambios) --- */}
      <ConfirmarAccionModal
        isOpen={isConfirmarAmigoOpen}
        onClose={() => {
          setIsConfirmarAmigoOpen(false);
          setAmigoParaBorrar(null);
        }}
        onConfirm={handleConfirmDeleteAmigo}
        titulo="Eliminar Amigo"
        mensaje={`¬øEst√°s seguro de que quieres eliminar a ${amigoParaBorrar?.nombre_usuario}? Esta acci√≥n es mutua y ambos ser√©is eliminados de vuestras listas.`}
        textoBotonConfirmar="S√≠, eliminar"
        isConfirmando={isDeletingAmigo}
      />
    </>
  );
}

export default Comunidad;

--- ConfirmarAccionModal.js ---

import React from 'react';
// Reutilizamos el CSS del modal de borrado para el estilo "danger"
import './ConfirmarBorradoModal.css';

/**
 * Un modal gen√©rico para confirmar acciones peligrosas (rojas).
 * Acepta props para personalizar el texto.
 */
function ConfirmarAccionModal({ 
  isOpen, 
  onClose, 
  onConfirm, 
  titulo, 
  mensaje, 
  textoBotonConfirmar = "Confirmar", // Texto por defecto
  isConfirmando = false // Para mostrar estado de carga
}) {
  
  if (!isOpen) {
    return null;
  }

  return (
    <div className="modal-backdrop-danger" onClick={onClose}>
      <div className="modal-content-danger" onClick={(e) => e.stopPropagation()}>
        
        <div className="modal-header-danger">
          <h3>{titulo}</h3>
          <button 
            className="modal-close-btn-danger" 
            onClick={onClose} 
            disabled={isConfirmando}
          >
            &times;
          </button>
        </div>
        
        <div className="modal-body-danger">
          {/* El mensaje se pasa como prop */}
          <p>{mensaje}</p>
        </div>
        
        <div className="modal-footer-danger">
          <button
            type="button"
            className="btn-cancel-danger"
            onClick={onClose}
            disabled={isConfirmando}
          >
            Cancelar
          </button>
          <button
            type="button"
            className="btn-confirm-danger"
            onClick={onConfirm} 
            disabled={isConfirmando}
          >
            {isConfirmando ? 'Cargando...' : textoBotonConfirmar}
          </button>
        </div>
      </div>
    </div>
  );
}

export default ConfirmarAccionModal;

--- ConfirmarBorradoModal.css ---

/* ---- frontend/src/components/ConfirmarBorradoModal.css ---- */

.modal-backdrop-danger {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000; 
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.modal-content-danger {
  background-color: var(--surface-color);
  
  /* --- CORRECCI√ìN AQU√ç --- 
     Quitamos el borde rojo y la sombra roja 
  */
  border: 1px solid var(--input-border-color); /* Borde normal */
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  box-shadow: var(--box-shadow); /* Sombra normal */
  display: flex;
  flex-direction: column;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header-danger {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  /* --- CORRECCI√ìN AQU√ç --- 
     Usamos el borde normal
  */
  border-bottom: 1px solid var(--input-border-color);
}

.modal-header-danger h3 {
  margin: 0;
  font-size: 1.25rem;
  /* --- CORRECCI√ìN AQU√ç --- 
     El t√≠tulo ya no es rojo, solo el bot√≥n de confirmar
  */
  color: var(--text-color); 
}

.modal-close-btn-danger {
  background: none;
  border: none;
  font-size: 2rem;
  color: var(--text-secondary-color);
  cursor: pointer;
  line-height: 1;
}

.modal-body-danger {
  padding: 1.5rem;
  line-height: 1.6;
}

.modal-body-danger p {
  color: var(--text-color);
  margin-top: 0;
  margin-bottom: 1rem;
}

.modal-body-danger strong {
  color: var(--primary-color);
  font-size: 1.1rem;
  display: block;
  text-align: center;
  margin-bottom: 1rem;
  background-color: var(--input-bg-color);
  padding: 0.5rem;
  border-radius: 6px;
}

/* --- ¬°NUEVO ESTILO! --- 
   Clase para el p√°rrafo de advertencia
*/
.text-danger-warning {
  color: #d93025; /* Texto rojo */
  background-color: rgba(217, 48, 37, 0.1);
  border: 1px solid #d93025;
  padding: 1rem;
  border-radius: 8px;
}
.text-danger-warning strong {
    color: #d93025; /* Hacemos el strong rojo tambi√©n */
    background: none;
    padding: 0;
    margin: 0;
    text-align: left;
    display: inline;
}


.modal-body-danger p:last-child {
  margin-bottom: 0;
  font-weight: bold;
}

.modal-footer-danger {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  padding: 1.5rem;
  border-top: 1px solid var(--input-border-color);
}

/* Botones del footer (Sin cambios) */
.btn-cancel-danger, .btn-confirm-danger {
  height: 48px;
  border-radius: 999px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
  padding: 0 1.8rem;
}

.btn-cancel-danger {
  background-color: var(--input-bg-color);
  color: var(--text-secondary-color);
}
.btn-cancel-danger:hover:not(:disabled) {
  background-color: var(--input-border-color);
  color: var(--text-color);
}

.btn-confirm-danger {
  background-color: #d93025;
  color: #fff;
}
.btn-confirm-danger:hover:not(:disabled) {
  opacity: 0.8;
}

.btn-cancel-danger:disabled,
.btn-confirm-danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

--- ConfirmarBorradoModal.js ---

import React from 'react';
import './ConfirmarBorradoModal.css'; 

function ConfirmarBorradoModal({ isOpen, onClose, onConfirm, rutinaNombre, isDeleting }) {
  if (!isOpen) {
    return null;
  }

  return (
    <div className="modal-backdrop-danger" onClick={onClose}>
      <div className="modal-content-danger" onClick={(e) => e.stopPropagation()}>
        
        <div className="modal-header-danger">
          <h3>Confirmar Eliminaci√≥n</h3>
          <button className="modal-close-btn-danger" onClick={onClose} disabled={isDeleting}>
            &times;
          </button>
        </div>
        
        <div className="modal-body-danger">
          <p>¬°Atenci√≥n! Est√°s a punto de borrar permanentemente la rutina:</p>
          <strong>{rutinaNombre}</strong>
          <p>Esta acci√≥n no se puede deshacer.</p>
          
          {/* --- CORRECCI√ìN AQU√ç --- 
              A√±adimos un <span> con la clase de peligro al texto clave
          */}
          <p className="text-danger-warning">
            Se borrar√°n todos los ejercicios de la rutina y, lo m√°s importante, 
            <strong> todo el historial de progreso de ella, los ejercios asociados desaparecer√°n del feed de tus amigos y de tu calendario</strong>, aunque no perder√°s tus PRs ni cualquier comparativa con tus amigos en los Rankings.
          </p>
          
          {/* --- CORRECCI√ìN AQU√ç --- 
              Eliminamos el punto que se hab√≠a colado
          */}
          
          <p>¬øEst√°s completamente seguro?</p>
        </div>

        <div className="modal-footer-danger">
          <button 
            type="button" 
            className="btn-cancel-danger" 
            onClick={onClose} 
            disabled={isDeleting}
          >
            Cancelar
          </button>
          <button 
            type="button" 
            className="btn-confirm-danger" 
            onClick={onConfirm} 
            disabled={isDeleting}
          >
            {isDeleting ? 'Eliminando...' : 'S√≠, eliminar todo'}
          </button>
        </div>

      </div>
    </div>
  );
}

export default ConfirmarBorradoModal;

--- ConfirmarBorrarEjercicioModal.js ---

// frontend/src/components/ConfirmarBorrarEjercicioModal.js
import React from 'react';
// Puedes crear un CSS espec√≠fico o reutilizar/adaptar el de ConfirmarBorradoModal
import './ConfirmarBorradoModal.css'; // O crea './ConfirmarBorrarEjercicioModal.css' si prefieres

function ConfirmarBorrarEjercicioModal({ isOpen, onClose, onConfirm, ejercicioNombre, isDeleting }) {
  if (!isOpen) {
    return null;
  }

  return (
    <div className="modal-backdrop-danger" onClick={onClose}>
      <div className="modal-content-danger" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header-danger">
          <h3>Confirmar Eliminaci√≥n</h3>
          <button className="modal-close-btn-danger" onClick={onClose} disabled={isDeleting}>
            &times;
          </button>
        </div>
        <div className="modal-body-danger">
          <p>¬øEst√°s seguro de que quieres eliminar permanentemente el ejercicio:</p>
          {/* Mostramos el nombre del ejercicio */}
          <strong>{ejercicioNombre}</strong>
          <p>de esta rutina?</p>
          {/* Aviso importante */}
          <p className="text-danger-warning">
            Esta acci√≥n <strong>no</strong> borrar√° tu historial o r√©cords pasados para este ejercicio en general, solo lo quitar√° de la rutina actual.
          </p>
        </div>
        <div className="modal-footer-danger">
          <button
            type="button"
            className="btn-cancel-danger"
            onClick={onClose}
            disabled={isDeleting}
          >
            Cancelar
          </button>
          <button
            type="button"
            className="btn-confirm-danger"
            onClick={onConfirm} // Llama a la funci√≥n que pasamos como prop
            disabled={isDeleting}
          >
            {isDeleting ? 'Eliminando...' : 'S√≠, eliminar'}
          </button>
        </div>
      </div>
    </div>
  );
}

export default ConfirmarBorrarEjercicioModal;

--- ConfirmarSalirModal.js ---

import React from 'react';
// Reutilizamos el CSS del modal de borrado, ya que es una acci√≥n "peligrosa" (p√©rdida de datos)
import './ConfirmarBorradoModal.css'; 

/**
 * Un modal gen√©rico para confirmar la salida, advirtiendo de la p√©rdida de progreso.
 */
function ConfirmarSalirModal({ isOpen, onClose, onConfirm }) {
  
  // No renderizar si no est√° abierto
  if (!isOpen) {
    return null;
  }

  return (
    // Usamos las clases de CSS del modal de borrado
    <div className="modal-backdrop-danger" onClick={onClose}>
      <div className="modal-content-danger" onClick={(e) => e.stopPropagation()}>
        
        <div className="modal-header-danger">
          <h3>Confirmar Salida</h3>
          <button className="modal-close-btn-danger" onClick={onClose}>
            &times;
          </button>
        </div>
        
        <div className="modal-body-danger">
          <p>¬øEst√°s seguro de que quieres salir?</p>
          
          {/* Reutilizamos el estilo de advertencia */}
          <p className="text-danger-warning">
            <strong>Se perder√° todo el progreso</strong> que has registrado en esta sesi√≥n.
          </p>
        </div>
        
        <div className="modal-footer-danger">
          <button
            type="button"
            className="btn-cancel-danger"
            onClick={onClose}
          >
            Cancelar
          </button>
          <button
            type="button"
            className="btn-confirm-danger" // Bot√≥n rojo
            onClick={onConfirm} 
          >
            S√≠, salir
          </button>
        </div>
      </div>
    </div>
  );
}

export default ConfirmarSalirModal;

--- crear_rutina.php ---

<?php
// ---- backend/api/crear_rutina.php (MODIFICADO para 'orden') ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// ... (Validaci√≥n de Token sin cambios) ...
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido o expirado.", "error" => $e->getMessage()));
        die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
    die();
}

define("MAX_NOMBRE_RUTINA_LENGTH", 38);
define("MAX_DIAS_SEMANA_LENGTH", 60);

$data = json_decode(file_get_contents("php://input"));
if (empty($data->nombre_rutina) || empty($usuario_id)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos. Se requiere nombre_rutina y un usuario v√°lido."));
    die();
}

$nombre = trim($data->nombre_rutina);
$dias_semana = isset($data->dias_semana) ? trim($data->dias_semana) : null;

// ... (Validaciones de longitud sin cambios) ...
if (mb_strlen($nombre, 'UTF-8') > MAX_NOMBRE_RUTINA_LENGTH) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "El nombre de la rutina no puede exceder los " . MAX_NOMBRE_RUTINA_LENGTH . " caracteres."));
    die();
}
if ($dias_semana !== null && mb_strlen($dias_semana, 'UTF-8') > MAX_DIAS_SEMANA_LENGTH) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "La descripci√≥n/d√≠as no puede exceder los " . MAX_DIAS_SEMANA_LENGTH . " caracteres."));
    die();
}

// 3. Preparar la conexi√≥n a la BBDD
try {
    $database = new Database();
    $db = $database->getConnection();

    // --- ¬°NUEVO! Obtener el orden m√°ximo actual para ESE usuario ---
    $query_orden = "SELECT MAX(orden) as max_orden FROM rutinas WHERE usuario_id = :usuario_id";
    $stmt_orden = $db->prepare($query_orden);
    $stmt_orden->bindParam(":usuario_id", $usuario_id);
    $stmt_orden->execute();
    $resultado = $stmt_orden->fetch(PDO::FETCH_ASSOC);
    // El nuevo orden ser√° 1 m√°s que el m√°ximo, o 1 si no tiene rutinas (max_orden ser√° NULL)
    $nuevo_orden = ($resultado['max_orden'] ?? 0) + 1;
    // --- FIN NUEVO ---

    // --- ¬°MODIFICADO! A√±adir 'orden' al INSERT ---
    $query = "INSERT INTO rutinas (usuario_id, nombre, dias_semana, orden)
              VALUES (:usuario_id, :nombre, :dias_semana, :orden)";
    
    $stmt = $db->prepare($query);

    $stmt->bindParam(":usuario_id", $usuario_id);
    $stmt->bindParam(":nombre", $nombre);
    $stmt->bindParam(":dias_semana", $dias_semana);
    $stmt->bindParam(":orden", $nuevo_orden); // <-- A√±adido
    // --- FIN MODIFICACI√ìN ---

    if ($stmt->execute()) {
        $nueva_rutina_id = $db->lastInsertId();
        http_response_code(201);
        echo json_encode(array(
            "mensaje" => "Rutina creada exitosamente.",
            "rutina" => [
                "id" => $nueva_rutina_id,
                "nombre" => $nombre,
                "dias" => $dias_semana
                // No necesitamos devolver el orden aqu√≠, pero podr√≠amos
            ]
        ));
    } else {
        http_response_code(500);
        echo json_encode(array("mensaje" => "No se pudo crear la rutina en la base de datos."));
    }
} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos.",
        "error" => $e->getMessage()
    ));
}

?>

--- Dashboard.css ---

/* ---- frontend/src/Dashboard.css (Refactorizado con bot√≥n de calendario en esquina) ---- */

.dashboard-container {
  position: relative; /* ¬°CLAVE! Para el bot√≥n de calendario */
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 1200px;
  margin: 0 auto;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.dashboard-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
}

.dashboard-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 2rem;
}

/* --- NUEVO: Bot√≥n de Icono de Calendario --- */
.btn-historial-calendario {
  position: absolute;
  top: 2rem;    /* Misma distancia que el padding */
  right: 2rem;   /* Misma distancia que el padding */
  
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  color: var(--text-secondary-color);
  
  width: 48px;   /* Bot√≥n cuadrado */
  height: 48px;
  border-radius: 50%; /* Bot√≥n redondo */
  
  display: flex;
  align-items: center;
  justify-content: center;
  
  cursor: pointer;
  transition: all 0.3s ease;
  z-index: 10; /* Por si acaso */
}

.btn-historial-calendario:hover {
  border-color: var(--primary-color);
  background-color: var(--surface-color);
  transform: scale(1.1);
}

.btn-historial-calendario img {
  width: 24px;  /* Tama√±o del icono dentro del bot√≥n */
  height: 24px;
  opacity: 0.8; /* Le da un tono m√°s suave al icono */
}

.btn-historial-calendario:hover img {
  opacity: 1;
}
/* --- FIN NUEVO --- */


/* Contenedor de Tarjetas (con Grid) */
.rutinas-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, 270px);
  justify-content: center;
  gap: 1.25rem;
  margin-top: 2rem;
}

/* Estilos de la Tarjeta de Rutina */
.rutina-card {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
  transition: all 0.3s ease;
  position: relative;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}

/* Icono de editar */
.btn-edit-icon {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: none;
  border: none;
  cursor: pointer;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  font-size: 1.2rem;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary-color);
  transition: all 0.2s ease;
}
.btn-edit-icon:hover {
  background-color: var(--input-bg-color);
  color: var(--primary-color);
}

/* Hover de la tarjeta */
.rutina-card:hover {
  transform: translateY(-5px);
}

/* T√≠tulo de la tarjeta */
.rutina-card h3 {
  font-size: 1.25rem; /* Tama√±o base */
  line-height: 1.3;
  color: var(--text-color);
  margin-top: 0;
  margin-bottom: 0.5rem;
  padding-right: 2rem;
  display: -webkit-box;
  -webkit-line-clamp: 2; /* M√°ximo 2 l√≠neas */
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: break-word; /* Evita desbordamiento */
  min-height: calc(1.25rem * 1.3 * 2);
}

/* Descripci√≥n (p√°rrafo gen√©rico dentro de la card) */
.rutina-card p {
  font-size: 0.9rem; /* Tama√±o base */
  line-height: 1.5; /* Interlineado */
  color: var(--text-secondary-color);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: break-word;
  min-height: calc(0.9rem * 1.5 * 2);
  margin: 0;
}

/* P√°rrafo espec√≠fico para la fecha */
.rutina-card p.ultima-sesion {
  font-size: 0.8rem; /* Tama√±o m√°s peque√±o */
  line-height: 1.5;
  color: var(--text-secondary-color);
  min-height: calc(0.8rem * 1.5);
  margin-top: 0.5rem; /* Espacio sobre la fecha */
  margin-bottom: 1rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  display: block;
  -webkit-line-clamp: unset;
  -webkit-box-orient: unset;
}


/* Contenedor de botones */
.card-actions {
  display: flex;
  gap: 1rem;
  margin-top: auto;
  padding-top: 1rem;
}

/* Botones dentro de la tarjeta */
.btn-start, .btn-edit {
  flex: 1;
  height: 40px;
  border-radius: 999px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
}

.btn-start {
  background: var(--gradient);
  color: #fff;
}

.btn-edit {
  background-color: var(--input-bg-color);
  color: var(--text-secondary-color);
}

.btn-edit:hover {
  background-color: var(--input-border-color);
  color: var(--text-color);
}

/* --- Formulario de Creaci√≥n (Sin cambios) --- */
.rutina-form {
  max-width: 600px;
  margin-top: 2rem;
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 2rem;
  box-shadow: var(--box-shadow);
  animation: fadeIn 0.5s ease;
  margin-left: auto;
  margin-right: auto;
}
.form-group { margin-bottom: 1.5rem; }
.form-group label { display: block; font-weight: 700; color: var(--text-secondary-color); margin-bottom: 0.5rem; }
.form-group input[type="text"] { width: 100%;
height: 48px; padding: 0 1rem; font-size: 1rem; font-family: var(--font-family); color: var(--text-color); background-color: var(--input-bg-color); border: 1px solid var(--input-border-color); border-radius: 8px;
box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; }
.form-group input[type="text"]:focus { outline: none; border-color: var(--primary-color);
box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2); }
.form-actions { display: flex; gap: 1rem; margin-top: 2rem;
}
.form-actions .btn-edit, .form-actions .btn-start { height: 48px; font-size: 1rem; flex: 1;
}

/* Mensaje si no hay rutinas */
.no-rutinas-msg { font-size: 1.1rem; color: var(--text-secondary-color); text-align: center; grid-column: 1 / -1; width: 100%;
margin-top: 2rem; }

/*
 * =========================================
 * DISE√ëO RESPONSIVO (M√ìVIL / TABLET PEQUE√ëA)
 * =========================================
 */
@media (max-width: 767px) {
  .dashboard-container { padding: 1.5rem 1rem; }
  
  /* --- NUEVO: Ajuste del bot√≥n de calendario --- */
  .btn-historial-calendario {
    top: 1.5rem;   /* Lo ajustamos al padding de m√≥vil */
    right: 1.5rem;  /* Lo ajustamos al padding de m√≥vil */
    width: 42px;
    height: 42px;
  }
  .btn-historial-calendario img {
    width: 20px;
    height: 20px;
  }
  /* --- FIN NUEVO --- */

  .rutinas-grid { gap: 1rem; grid-template-columns: repeat(2, 1fr); }
  .rutina-card { padding: 1rem; max-width: none; }

  /* Ajustes de tama√±o y min-height para m√≥vil */
  .rutina-card h3 {
    font-size: 1rem;
    padding-right: 1.5rem;
    min-height: calc(1rem * 1.3 * 2);
  }
  .rutina-card p { /* Descripci√≥n */
    font-size: 0.8rem;
    min-height: calc(0.8rem * 1.5 * 2);
  }
  .rutina-card p.ultima-sesion {
    font-size: 0.75rem;
    min-height: calc(0.75rem * 1.5); /* Recalculado */
    margin-bottom: 0.75rem;
  }
  .card-actions { padding-top: 0.75rem; gap: 0.5rem; }
  .btn-start, .btn-edit { font-size: 0.8rem; height: 36px; padding-left: 0.5rem; padding-right: 0.5rem; }
}

/*
 * =========================================
 * DISE√ëO RESPONSIVO (PANTALLAS MUY PEQUE√ëAS)
 * =========================================
 */
@media (max-width: 420px) {
  .rutinas-grid { gap: 1.25rem;
  grid-template-columns: 1fr; } /* 1 columna */
  .rutina-card { text-align: center; padding: 1.25rem; }
  .rutina-card h3 { font-size: 1.1rem; padding-right: 0; min-height: calc(1.1rem * 1.3 * 2); }
  .rutina-card p { font-size: 0.85rem; min-height: calc(0.85rem * 1.5 * 2); }
  .rutina-card p.ultima-sesion { font-size: 0.8rem; min-height: calc(0.8rem * 1.5); text-align: center; }
  .card-actions { justify-content: center; gap: 1rem; }
  .btn-start, .btn-edit { flex-grow: 0;
  flex-basis: auto; padding-left: 1.5rem; padding-right: 1.5rem; font-size: 0.9rem; }
}

--- Dashboard.js ---

// ---- frontend/src/Dashboard.js (Reescrito con bot√≥n-icono en esquina) ----

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import './Dashboard.css';
import iconoInicio from './assets/inicio.png';
import iconoCrear from './assets/crear-ejercicios.png';
import iconoCalendario from './assets/calendario.png'; // <-- 1. IMPORTAMOS EL ICONO
import GuiaModal from './components/GuiaModal';

// --- Funci√≥n para decodificar el token (sin cambios) ---
const decodeToken = (token) => {
  try {
    const payloadBase64 = token.split('.')[1];
    const base64 = payloadBase64.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
  } catch (e) {
    console.error("Error decodificando token:", e);
    return null;
  }
};

// --- Funci√≥n para Formatear Fechas Relativas (sin cambios) ---
const formatRelativeDate = (dateString) => {
  if (!dateString) { return 'Nunca entrenada'; }
  try {
    const sessionDate = new Date(dateString);
    sessionDate.setHours(0, 0, 0, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const diffTime = today - sessionDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays === 0) { return 'Hoy'; }
    else if (diffDays === 1) { return 'Ayer'; }
    else if (diffDays > 1 && diffDays < 7) {
      const dayName = sessionDate.toLocaleDateString('es-ES', { weekday: 'long' });
      const capitalizedDayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);
      return `${capitalizedDayName} pasado`;
    } else {
      return sessionDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }
  } catch (e) { console.error("Error formateando fecha relativa:", dateString, e); return 'Fecha inv√°lida'; }
};

// --- Helper para marcar la gu√≠a como vista (sin cambios) ---
const marcarGuiaComoVista = async (nombreGuia) => {
  const token = localStorage.getItem('movium_token');
  if (!token) return;
  try {
    await fetch('http://localhost/programacion/TFG/movium/backend/api/marcar_guia_vista.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ guia_vista: nombreGuia })
    });
  } catch (error) {
    console.error("Error al marcar la gu√≠a como vista:", error);
  }
};

function Dashboard() {
  // Estados (sin cambios)
  const [rutinas, setRutinas] = useState([]);
  const [isCreating, setIsCreating] = useState(false);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [nombreUsuario, setNombreUsuario] = useState('');
  const navigate = useNavigate();
  const [showGuiaInicio, setShowGuiaInicio] = useState(false);

  // useEffect para cargar rutinas (sin cambios)
  useEffect(() => {
    const token = localStorage.getItem('movium_token');
    if (token) {
      const decodedPayload = decodeToken(token);
      if (decodedPayload?.data?.nombre_usuario) { setNombreUsuario(decodedPayload.data.nombre_usuario); }
      else { console.error("Nombre de usuario no encontrado en el token."); }
    } else { setError("Error de autenticaci√≥n. No se encontr√≥ token."); }
        
    const cargarRutinas = async () => {
      try {
       if (!token) { throw new Error("Error de autenticaci√≥n. Por favor, inicia sesi√≥n de nuevo."); }
        const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/get_rutinas.php', { method: 'GET', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } });
        const data = await response.json();
    
        if (!response.ok) { throw new Error(data.mensaje || 'No se pudieron cargar las rutinas.'); }
        setRutinas(data);
      } catch (err) { setError(err.message); } finally { setLoading(false); }
    };
    if (token) { cargarRutinas(); } else { setLoading(false); }
  }, []);

  // useEffect para mostrar la gu√≠a (sin cambios)
  useEffect(() => {
    try {
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      if (storedUser && !storedUser.ha_visto_guia_inicio) {
        setShowGuiaInicio(true);
      }
    } catch (e) {
      console.error("Error al leer datos de usuario para la gu√≠a:", e);
    }
  }, []);

  // Handler para cerrar la gu√≠a (sin cambios)
  const handleCerrarGuiaInicio = () => {
    try {
      marcarGuiaComoVista('inicio');
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      if (storedUser) {
        const updatedUser = { ...storedUser, ha_visto_guia_inicio: true };
        localStorage.setItem('movium_user', JSON.stringify(updatedUser));
      }
      setShowGuiaInicio(false);
    } catch (e) {
      console.error("Error al cerrar la gu√≠a de inicio:", e);
      setShowGuiaInicio(false);
    }
  };

  // Navegaci√≥n (sin cambios)
  const handleNavigateToPath = (path) => { navigate(path); };

  // Handler para crear rutina (sin cambios)
  const handleCreateRutina = async (e) => {
    e.preventDefault();
    setError(null);
    const nombreRutina = e.target.nombre_rutina.value;
    const diasSemana = e.target.dias_semana.value;
    const token = localStorage.getItem('movium_token');
    if (!token) { 
      setError("Error de autenticaci√≥n. Por favor, inicia sesi√≥n de nuevo.");
      return;
    }

    try {
      const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/crear_rutina.php', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
        body: JSON.stringify({ nombre_rutina: nombreRutina, dias_semana: diasSemana }) 
      });
      const data = await response.json();
      
      if (!response.ok) { 
        throw new Error(data.mensaje || 'Error desconocido al crear la rutina.');
      }

      if (data.rutina && data.rutina.id) {
        navigate(`/rutina/${data.rutina.id}`);
      } else {
        setError("Rutina creada, pero no se pudo obtener el ID para redirigir.");
        setIsCreating(false);
        window.location.reload(); 
      }
    } catch (err) { 
      setError(err.message);
    }
  };

  // L√≠mites de caracteres (sin cambios)
  const MAX_TITULO_LENGTH = 38;
  const MAX_DIAS_LENGTH = 60;

  // --- RENDERIZADO ---
  return (
    <>
      <div className="dashboard-container">

        {/* --- 2. ¬°NUEVO BOT√ìN DE CALENDARIO EN LA ESQUINA! --- */}
        {/* Solo se muestra si NO estamos creando una rutina */}
        {!isCreating && (
          <button
            className="btn-historial-calendario" // Usar√° la nueva clase CSS
            onClick={() => navigate('/historial')}
            title="Ver historial de calendario"
          >
            <img src={iconoCalendario} alt="Ver historial" />
          </button>
        )}
        {/* --- FIN DEL NUEVO BOT√ìN --- */}


        {/* T√≠tulos (sin cambios) */}
        {isCreating ? (
          <>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
              <img src={iconoCrear} alt="" width="64" height="64" />
               <h2>Crear Nueva Rutina</h2>
            </div>
            <p className="subtitle" style={{ textAlign: 'center' }}>
               Define el nombre y los d√≠as para tu nueva rutina.
            </p>
          </>
        ) : (
          <>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
              <img src={iconoInicio} alt="" width="64" height="64" />
              <h2>Hola {nombreUsuario || 'Usuario'} ¬°Bienvenido de nuevo!</h2>
            </div>
            <p className="subtitle" style={{ textAlign: 'center' }}>
              Selecciona una rutina para empezar o crea una nueva.
            </p>
          </>
        )}

        {error && <div className="message">{error}</div>}

        {/* --- 3. BOT√ìN "Crear Nueva Rutina" (AHORA SOLO) --- */}
        {!isCreating && (
          <div className="button-group" style={{ justifyContent: 'center', marginBottom: '2rem' }}>
            <button 
              className="transparent-btn" 
              style={{ flex: 'none', width: 'auto', padding: '0 2rem' }} 
              onClick={() => setIsCreating(true)}
            >
              Crear Nueva Rutina
            </button>
            {/* El bot√≥n de calendario YA NO EST√Å AQU√ç */}
          </div>
        )}
        {/* --- FIN DE LA MODIFICACI√ìN --- */}


        {isCreating ?
        ( /* Formulario Crear (sin cambios) */
          <form className="rutina-form" onSubmit={handleCreateRutina}>
            <div className="form-group">
              <label htmlFor="nombre_rutina">Nombre de la Rutina (M√°x. {MAX_TITULO_LENGTH} caracteres)</label>
              <input type="text" id="nombre_rutina" name="nombre_rutina" placeholder="Ej: D√≠a de Pecho y Tr√≠ceps" required maxLength={MAX_TITULO_LENGTH} />
            </div>

            <div className="form-group">
              <label htmlFor="dias_semana">D√≠as / Descripci√≥n (M√°x. {MAX_DIAS_LENGTH} caracteres)</label>
              <input type="text" id="dias_semana" name="dias_semana" placeholder="Ej: Lunes, Jueves / Rutina enfocada en hipertrofia" maxLength={MAX_DIAS_LENGTH} />
            </div>
            <div className="form-actions">
              <button type="button" className="btn-edit" onClick={() => { setIsCreating(false); setError(null); }}>Cancelar</button>
               <button type="submit" className="btn-start">Guardar Rutina</button>
            </div>
          </form>
        ) : ( /* Lista Rutinas (sin cambios) */
          loading ?
          ( <div className="loading-container"><p className="no-rutinas-msg">Cargando tus rutinas...</p></div> )
          : ( <div className="rutinas-grid">
            {rutinas.length === 0 && !error ? ( <p className="no-rutinas-msg">A√∫n no tienes ninguna rutina...</p> )
            : (
              rutinas.map((rutina) => {
                const fechaRelativa = formatRelativeDate(rutina.ultima_sesion);
                const nuncaEntrenada = fechaRelativa === 'Nunca entrenada';
                const cardStyle = {};
                
                if (rutina.color_tag) {
                  cardStyle.boxShadow = `0 5px 15px ${rutina.color_tag}90`;
                }

                return (
                  <div className="rutina-card" key={rutina.id} style={cardStyle}>
                    <button className="btn-edit-icon" onClick={() => handleNavigateToPath(`/rutina/${rutina.id}`)} title="Editar rutina">‚úèÔ∏è</button>
                    
                     <h3>{rutina.nombre}</h3>
                    <p>{rutina.dias || rutina.dias_semana || ''}</p>

                    <p className="ultima-sesion" style={{fontStyle: nuncaEntrenada ? 'italic' : 'normal' }}>
                      { (fechaRelativa !== 'Nunca entrenada' &&
                         fechaRelativa !== 'Hoy' &&
                         fechaRelativa !== 'Ayer' &&
                         !fechaRelativa.includes(' pasado')) ?
                      `√öltima vez: ${fechaRelativa}` : fechaRelativa }
                    </p>

                    <div className="card-actions">
                      <button className="btn-edit" onClick={() => handleNavigateToPath(`/progreso/${rutina.id}`)}>Progreso</button>
                      <button className="btn-start" onClick={() => handleNavigateToPath(`/sesion/${rutina.id}`)}>Entrenar</button>
                    </div>
                  </div>
                );
              })
            )}
          </div>
          )
        )}
      </div>
      
      <GuiaModal
          isOpen={showGuiaInicio}
          onClose={handleCerrarGuiaInicio}
          titulo="¬°Bienvenido a Movium!"
      >
          <p>¬°Hola <strong>{nombreUsuario || 'Usuario'}</strong>! Parece que es tu primera vez aqu√≠.</p>
          <p>
              Esta es la pantalla de <strong>Inicio</strong>. Aqu√≠ puedes crear y ver todas tus <strong>Rutinas</strong>.
          </p>
          <p>
              Una <strong>Rutina</strong> es como un plan para un d√≠a de entreno (ej: "D√≠a de Pecho", "D√≠a de Pierna").
          </p>
          <p>
              Primero creas la rutina y luego, dentro de ella, a√±ades los ejercicios y series que quieres hacer.
          </p>
          <ul style={{ marginTop: '0.5rem', marginBottom: '1rem', paddingLeft: '1.2rem' }}>
              <li style={{ marginBottom: '0.5rem' }}>
                  Pulsa en <strong>"Entrenar"</strong> para iniciar una sesi√≥n basada en esa rutina.
              </li>
              <li style={{ marginBottom: '0.5rem' }}>
                  Pulsa en <strong>"Progreso"</strong> para ver gr√°ficas de c√≥mo has mejorado en esa rutina.
              </li>
              <li>
                  F√≠jate en el <strong>bot√≥n con el icono de calendario</strong> en la esquina superior derecha. Te llevar√° a un calendario en el que podr√°s ver qu√© d√≠as has entrenado.
              </li>

          </ul>
          <p>¬°Usa <strong>"Crear Nueva Rutina"</strong> para empezar!</p>
      </GuiaModal>
    </>
  );
}

export default Dashboard;

--- database.php ---

<?php
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, GET, OPTIONS");
header("Access-Control-Max-Age: 3600");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

class Database {
    private $host = "localhost";
    private $db_name = "movium_db";
    private $username = "root";
    private $password = ""; // Pon tu contrase√±a de XAMPP aqu√≠ si tienes una
    public $conn;

    public function getConnection() {
        $this->conn = null;
        try {
            $this->conn = new PDO("mysql:host=" . $this->host . ";dbname=" . $this->db_name, $this->username, $this->password);
            $this->conn->exec("set names utf8");
        } catch (PDOException $exception) {
            echo "Error de conexi√≥n: " . $exception->getMessage();
        }
        return $this->conn;
    }
}
?>

--- delete_amigo.php ---

<?php
// ---- backend/api/delete_amigo.php ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else { 
    http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: Obtener ID a borrar ---
$data = json_decode(file_get_contents("php://input"));
if (empty($data->amigo_a_borrar_id)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos. Se requiere 'amigo_a_borrar_id'."));
    die();
}

$mi_id = $usuario_id;
$otro_id = (int)$data->amigo_a_borrar_id;

// --- PASO 3: L√≥gica de Borrado (Transacci√≥n) ---
$database = new Database();
$db = $database->getConnection();

try {
    $db->beginTransaction();

    // 1. Borrar mi fila (Yo ya no soy amigo de 'otro_id')
    $query1 = "DELETE FROM amistades WHERE usuario_id = :mi_id AND amigo_id = :otro_id";
    $stmt1 = $db->prepare($query1);
    $stmt1->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt1->bindParam(":otro_id", $otro_id, PDO::PARAM_INT);
    $stmt1->execute();

    // 2. Borrar su fila ('otro_id' ya no es amigo m√≠o)
    $query2 = "DELETE FROM amistades WHERE usuario_id = :otro_id AND amigo_id = :mi_id";
    $stmt2 = $db->prepare($query2);
    $stmt2->bindParam(":otro_id", $otro_id, PDO::PARAM_INT);
    $stmt2->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt2->execute();
    
    $db->commit();
    http_response_code(200);
    echo json_encode(array("mensaje" => "Amistad eliminada."));

} catch (Exception $e) {
    $db->rollBack();
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al eliminar la amistad.",
        "error" => $e->getMessage()
    ));
}
?>

--- delete_ejercicio_de_rutina.php ---

<?php
// ---- backend/api/delete_ejercicio_de_rutina.php (REESCRITO V6.0) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS"); 
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null; 
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die(); }
} else { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die(); }

// --- PASO 2: Obtener ID a borrar (Sin cambios) ---
$data = json_decode(file_get_contents("php://input"));

if (empty($data->id)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No se especific√≥ el ID del ejercicio a borrar."));
    die();
}
$ejercicio_rutina_id = $data->id;

// --- PASO 3: L√≥gica de Borrado y Reordenaci√≥n (Sin cambios) ---
$database = new Database();
$db = $database->getConnection();

try {
    $db->beginTransaction();
    
    // 1. (SEGURIDAD) Verificar propiedad
    $query_info = "SELECT 
                     re.rutina_id, re.orden 
                   FROM rutina_ejercicios re
                   JOIN rutinas ru ON re.rutina_id = ru.id
                   WHERE re.id = :ejercicio_rutina_id AND ru.usuario_id = :usuario_id
                   LIMIT 1";
    $stmt_info = $db->prepare($query_info);
    $stmt_info->bindParam(":ejercicio_rutina_id", $ejercicio_rutina_id, PDO::PARAM_INT);
    $stmt_info->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_info->execute();
    $info = $stmt_info->fetch(PDO::FETCH_ASSOC);
    if (!$info) {
        throw new Exception("Ejercicio no encontrado o no te pertenece.", 404);
    }
    
    $rutina_id_afectada = $info['rutina_id'];
    $orden_borrado = $info['orden'];

    // 2. BORRAR el ejercicio padre (ON DELETE CASCADE borra hijos)
    $query_delete = "DELETE FROM rutina_ejercicios WHERE id = :ejercicio_rutina_id";
    $stmt_delete = $db->prepare($query_delete);
    $stmt_delete->bindParam(":ejercicio_rutina_id", $ejercicio_rutina_id, PDO::PARAM_INT);
    $stmt_delete->execute();
    
    // 3. REORDENAR ("pull")
    $query_reorder = "UPDATE rutina_ejercicios 
                      SET orden = orden - 1 
                      WHERE rutina_id = :rutina_id AND orden > :orden_borrado";
    $stmt_reorder = $db->prepare($query_reorder);
    $stmt_reorder->bindParam(":rutina_id", $rutina_id_afectada, PDO::PARAM_INT);
    $stmt_reorder->bindParam(":orden_borrado", $orden_borrado, PDO::PARAM_INT);
    $stmt_reorder->execute();

    // 4. Commit
    $db->commit();

    // 5. DEVOLVER LA LISTA ACTUALIZADA (¬°¬°CAMBIOS V6.0 AQU√ç!!)
    // (Usamos la misma l√≥gica V6.0 de `get_ejercicios_de_rutina.php`)

    // Consulta 1 (Padres)
    $query_ejercicios = "SELECT re.id, re.ejercicio_id, re.orden,
                                ej.nombre as nombre_ejercicio, ej.grupo_muscular, ej.tipo
                         FROM rutina_ejercicios re
                         JOIN ejercicios ej ON re.ejercicio_id = ej.id
                         WHERE re.rutina_id = :rutina_id
                         ORDER BY re.orden ASC";
    $stmt_ejercicios = $db->prepare($query_ejercicios);
    $stmt_ejercicios->bindParam(":rutina_id", $rutina_id_afectada, PDO::PARAM_INT);
    $stmt_ejercicios->execute();
    $ejercicios_actualizados = $stmt_ejercicios->fetchAll(PDO::FETCH_ASSOC);

    if (count($ejercicios_actualizados) > 0) {
        $rutina_ejercicio_ids = array_map(function($ej) { return $ej['id']; }, $ejercicios_actualizados);
        $placeholders = str_repeat('?,', count($rutina_ejercicio_ids) - 1) . '?';
        
        // Consulta 2 (Hijos) - ¬°Consulta V6.0!
        $query_objetivos = "SELECT id, rutina_ejercicio_id, num_serie, 
                                   tipo_rep_objetivo, reps_min_objetivo, reps_max_objetivo,
                                   peso_kg_objetivo, tiempo_min_objetivo, 
                                   distancia_km_objetivo
                                   descanso_seg_post
                            FROM rutina_objetivos
                            WHERE rutina_ejercicio_id IN ($placeholders)
                            ORDER BY num_serie ASC";
        
        $stmt_objetivos = $db->prepare($query_objetivos);
        $stmt_objetivos->execute($rutina_ejercicio_ids);
        $objetivos = $stmt_objetivos->fetchAll(PDO::FETCH_ASSOC);

        // Combinar (Sin cambios)
        $objetivos_map = [];
        foreach ($objetivos as $obj) {
            $objetivos_map[$obj['rutina_ejercicio_id']][] = $obj;
        }
        foreach ($ejercicios_actualizados as $i => $ej) {
            $ej_id = $ej['id'];
            $ejercicios_actualizados[$i]['objetivos'] = $objetivos_map[$ej_id] ?? [];
        }
    }

    http_response_code(200);
    echo json_encode(array(
        "mensaje" => "Ejercicio borrado y rutina reordenada.",
        "ejercicios_actualizados" => $ejercicios_actualizados
    ));

} catch (Exception $e) {
    $db->rollBack();
    $codigo = $e->getCode() == 404 ? 404 : 500;
    http_response_code($codigo);
    echo json_encode(array(
        "mensaje" => "Error al borrar el ejercicio.",
        "error" => $e->getMessage()
    ));
}
?>

--- delete_rutina.php ---

<?php
// ---- backend/api/delete_rutina.php ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS"); // Usamos POST para borrar
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401); 
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); 
        die();
    }
} else { 
    http_response_code(401); 
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); 
    die();
}

// --- PASO 2: Obtener ID a borrar ---
$data = json_decode(file_get_contents("php://input"));

if (empty($data->id)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No se especific√≥ el ID de la rutina a borrar."));
    die();
}
$rutina_id_a_borrar = $data->id;

// --- PASO 3: L√≥gica de Borrado ---
$database = new Database();
$db = $database->getConnection();

try {
    $db->beginTransaction();
    
    // 1. (SEGURIDAD) Verificar propiedad
    $check_query = "SELECT id FROM rutinas 
                    WHERE id = :rutina_id AND usuario_id = :usuario_id";
    $stmt_check = $db->prepare($check_query);
    $stmt_check->bindParam(":rutina_id", $rutina_id_a_borrar, PDO::PARAM_INT);
    $stmt_check->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_check->execute();
    
    if ($stmt_check->rowCount() == 0) {
        throw new Exception("Rutina no encontrada o no te pertenece.", 404);
    }
    
    // 2. BORRAR la rutina (CASCADE se encarga de lo dem√°s)
    $query_delete = "DELETE FROM rutinas WHERE id = :rutina_id";
    $stmt_delete = $db->prepare($query_delete);
    $stmt_delete->bindParam(":rutina_id", $rutina_id_a_borrar, PDO::PARAM_INT);
    $stmt_delete->execute();

    // 3. Commit
    $db->commit();
    
    http_response_code(200);
    echo json_encode(array("mensaje" => "Rutina eliminada exitosamente."));

} catch (Exception $e) {
    $db->rollBack();
    $codigo = $e->getCode() == 404 ? 404 : 500;
    http_response_code($codigo);
    echo json_encode(array(
        "mensaje" => "Error al eliminar la rutina.",
        "error" => $e->getMessage()
    ));
}
?>

--- EditarEjercicioModal.css ---

/* ---- frontend/src/components/EditarEjercicioModal.css (ACTUALIZADO V6.0) ---- */

/* =========================================
 * 1. ESTILOS GENERALES DEL MODAL (Sin cambios)
 * ========================================= */
.modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center;
  z-index: 1000; animation: fadeIn 0.3s ease; }
.modal-content { background-color: var(--surface-color); border: 1px solid var(--input-border-color); border-radius: 12px;
  width: 90%; max-width: 600px; max-height: 85vh; box-shadow: var(--box-shadow); display: flex; flex-direction: column; animation: slideIn 0.3s ease-out; overflow: hidden; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-header { display: flex; justify-content: space-between;
  align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--input-border-color); flex-shrink: 0; }
.modal-header h3 { margin: 0; font-size: 1.25rem; }
.modal-close-btn { background: none; border: none; font-size: 2rem; color: var(--text-secondary-color); cursor: pointer; line-height: 1;
  padding: 0; }
.modal-close-btn:hover { color: var(--text-color); }

/* =========================================
 * 2. ESTILOS DEL FORMULARIO PRINCIPAL (Sin cambios)
 * ========================================= */
.modal-form {
  padding: 1.5rem;
  overflow-y: auto;
  flex-grow: 1;
  scrollbar-width: thin; scrollbar-color: var(--input-border-color) var(--input-bg-color);
}
.modal-form::-webkit-scrollbar { width: 8px; }
.modal-form::-webkit-scrollbar-track { background: var(--input-bg-color); border-radius: 4px; }
.modal-form::-webkit-scrollbar-thumb { background-color: var(--input-border-color); border-radius: 4px; border: 2px solid var(--input-bg-color); }
.modal-form::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary-color); }

.edit-ejercicio-nombre { font-size: 1.2rem; font-weight: 700; color: var(--text-color); margin-top: 0; margin-bottom: 1.5rem; padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--input-border-color); text-align: center; }
.edit-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; }
.input-disabled { background-color: var(--input-border-color); color: var(--text-secondary-color); cursor: not-allowed; }

/* =========================================
 * 3. ESTILOS PREVIEW DE SERIES (Sin cambios)
 * ========================================= */
.lista-series-preview { display: flex;
  flex-direction: column; gap: 0; max-height: 180px; overflow-y: auto; padding: 0; background-color: transparent; border-radius: 0; border: none; margin-bottom: 1rem; scrollbar-width: thin;
  scrollbar-color: var(--input-border-color) var(--input-bg-color); }
.lista-series-preview::-webkit-scrollbar { width: 8px; }
.lista-series-preview::-webkit-scrollbar-track { background: var(--input-bg-color); border-radius: 4px; }
.lista-series-preview::-webkit-scrollbar-thumb { background-color: var(--input-border-color); border-radius: 4px; border: 2px solid var(--input-bg-color); }
.lista-series-preview::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary-color); }
.serie-preview-item { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; padding: 0.75rem 0.5rem; background-color: transparent; border-radius: 0;
  border-bottom: 1px solid var(--input-border-color); transition: background-color 0.2s ease; }
.serie-preview-item:last-child { border-bottom: none; }
.serie-info { color: var(--text-color);
  flex-grow: 1; margin-right: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.serie-info strong { color: var(--text-color); }
.serie-actions { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; }
.btn-icon-edit, .btn-icon-delete { background: none; border: none; cursor: pointer; padding: 0.2rem; font-size: 1.2rem; line-height: 1; border-radius: 4px;
  transition: background-color 0.2s ease, color 0.2s ease; }
.btn-icon-edit { color: var(--text-secondary-color); }
.btn-icon-edit:hover, .btn-icon-edit:disabled { background-color: var(--input-bg-color); color: var(--primary-color); }
.btn-icon-edit:disabled { cursor: default; opacity: 0.6; }
.btn-icon-delete { color: #d93025; }
.btn-icon-delete:hover { background-color: rgba(217, 48, 37, 0.1); }
.serie-preview-item.editing-serie { background-color: var(--input-bg-color); }
.add-new-serie-container { display: flex;
  justify-content: center; padding: 0.5rem 0; margin-top: 0.5rem; margin-bottom: 1rem; }
.btn-add-new-serie { background: transparent; border: 2px solid var(--input-border-color);
  color: var(--text-secondary-color); padding: 0.5rem 1.5rem; border-radius: 999px; font-size: 0.9rem; font-weight: 700; cursor: pointer; transition: all 0.2s ease; font-family: var(--font-family); }
.btn-add-new-serie:hover { border-color: var(--primary-color); color: var(--primary-color); }

/* --- ¬°NUEVA CLASE V6.0! (Copiada de RutinaDetalle.css) --- */
/* Grid para los 3 inputs de repeticiones */
.form-rep-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 0.5rem;
  align-items: flex-start;
}
/* ------------------------------- */

.edit-serie-form { animation: fadeIn 0.3s ease-out; }

/* =========================================
 * 4. BOTONES DE ACCI√ìN DE SERIES (Sin cambios)
 * ========================================= */
.form-actions-edit-serie {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.75rem;
  margin-top: 1rem;
  margin-bottom: 1.75rem;
  flex-wrap: wrap; 
}
.form-actions-edit-serie .btn-add-serie,
.form-actions-edit-serie .btn-update-serie,
.form-actions-edit-serie .btn-cancel-edit {
  height: 40px;
  border-radius: 999px; font-size: 0.9rem; font-weight: 700;
  cursor: pointer; transition: all 0.2s ease; font-family: var(--font-family);
  border: none; width: auto;
  padding: 0 1.5rem; flex-shrink: 0; white-space: nowrap;
}
.btn-add-serie { background: var(--gradient); color: #fff; }
.btn-add-serie:hover { transform: scale(1.03); opacity: 0.9; }
.btn-update-serie { background: var(--gradient); color: #fff; }
.btn-update-serie:hover { transform: scale(1.03); opacity: 0.9; }
.btn-cancel-edit { background-color: var(--input-bg-color); color: var(--text-secondary-color); }
.btn-cancel-edit:hover { background-color: var(--input-border-color); color: var(--text-color); }

/* =========================================
 * 5. PIE DEL MODAL (Sin cambios)
 * ========================================= */
.modal-footer { display: flex;
  justify-content: center; padding: 1.5rem; border-top: 1px solid var(--input-border-color); margin-top: auto; flex-shrink: 0; }
.modal-footer .transparent-btn { width: auto;
  padding-left: 2rem; padding-right: 2rem; }

/* =========================================
 * MEDIA QUERY (Con ajuste V6.0)
 * ========================================= */
@media (max-width: 600px) {
   .form-actions-edit-serie {
       justify-content: center;
   }
   .form-actions-edit-serie .btn-add-serie,
   .form-actions-edit-serie .btn-update-serie,
   .form-actions-edit-serie .btn-cancel-edit {
       flex-grow: 1;
       max-width: 200px;
   }
   .modal-footer .transparent-btn {
       width: 100%;
       max-width: none;
   }
   
   /* V6.0: Asegura que el grid de reps se apile en m√≥vil */
   .form-rep-grid {
       grid-template-columns: 1fr 1fr; /* 2 columnas en m√≥vil */
   }
   .form-rep-grid .form-group-small:first-child { /* El selector de TIPO */
       grid-column: 1 / -1; /* Ocupa todo el ancho */
   }
}

--- EditarEjercicioModal.js ---

// ---- frontend/src/components/EditarEjercicioModal.js (MODIFICADO CON VALIDACI√ìN DE INPUTS) ----

import React, { useState, useEffect } from 'react';
import './EditarEjercicioModal.css';

// --- ¬°NUEVO! Helper de Perfil.js: Bloquea teclas (e, +, -, etc.) ---
const handleNumericKeyDown = (e, allowDecimal = false) => {
  // Teclas siempre permitidas
  if ([8, 9, 37, 39, 46, 35, 36].includes(e.keyCode)) {
    return;
  }
  // Bloquear 'e', '+', '-'
  if (['e', 'E', '+', '-'].includes(e.key)) {
    e.preventDefault();
    return;
  }
  // Si NO se permite decimal, bloquear '.' y ','
  if (!allowDecimal && ['.', ','].includes(e.key)) {
    e.preventDefault();
    return;
  }
};


/**
 * Funci√≥n helper para formatear el objeto de objetivo (serie o intervalo)
 * en un string legible para el usuario.
 */
const formatObjetivoNatural = (obj, tipo) => {
  if (!obj) return '';
  if (tipo === 'cardio') {
    // Formateo para Cardio
    const metricas = [];
    if (obj.tiempo_min_objetivo) metricas.push(`${obj.tiempo_min_objetivo} min`);
    if (obj.distancia_km_objetivo) metricas.push(`${obj.distancia_km_objetivo} km`);
    let texto = metricas.join(' / ');
    if (obj.descanso_seg_post) texto += ` (${obj.descanso_seg_post}s)`;
    return texto || "Intervalo vac√≠o";
  } else {
    // Formateo para Fuerza
    let repStr = "";
    if (obj.tipo_rep_objetivo === 'fallo') {
      repStr = `Al Fallo${obj.reps_min_objetivo ? ` (~${obj.reps_min_objetivo}r)` : ''}`;
    } else if (obj.tipo_rep_objetivo === 'rango') {
      repStr = `${obj.reps_min_objetivo || '?'}-${obj.reps_max_objetivo || '?'} reps`;
    } else { // 'fijo'
      repStr = `${obj.reps_min_objetivo || '?'} reps`;
    }
    let pesoStr = obj.peso_kg_objetivo != null ? ` con ${obj.peso_kg_objetivo} kg` : '';
    let descansoStr = obj.descanso_seg_post != null ? ` (${obj.descanso_seg_post}s)` : '';
    return `${repStr}${pesoStr}${descansoStr}`;
  }
};

/**
 * Componente interno para gestionar la edici√≥n de series de FUERZA.
 */
const FormularioFuerzaEditable = ({ objetivos, setObjetivos }) => {
  // Estados para los inputs del formulario de edici√≥n/creaci√≥n
  const [tipoRep, setTipoRep] = useState('fijo');
  const [repsMin, setRepsMin] = useState("10"); 
  const [repsMax, setRepsMax] = useState("12");
  const [peso, setPeso] = useState("");
  const [descanso, setDescanso] = useState("60");
  const [editingSerieNum, setEditingSerieNum] = useState(null);
  const [showForm, setShowForm] = useState(false);

  // --- ¬°NUEVO! Handler de validaci√≥n para el formulario "Editar Fuerza" ---
  const handleValidationChange = (e) => {
    const { name, value } = e.target;
    
    // Reglas de Regex
    const max3Int = /^\d{0,3}$/; // M√°x 3 d√≠gitos enteros
    const max4Int = /^\d{0,4}$/; // M√°x 4 d√≠gitos enteros
    const decimal_5_2 = /^(|\d{1,3}([.,]\d{0,2})?)$/; // M√°x 999.99 (6 chars total)

    switch (name) {
      case 'repsMin':
        if (max3Int.test(value)) setRepsMin(value);
        break;
      case 'repsMax':
        if (max3Int.test(value)) setRepsMax(value);
        break;
      case 'peso':
        if (decimal_5_2.test(value) && value.length <= 6) {
          setPeso(value.replace(',', '.'));
        }
        break;
      case 'descanso':
        if (max4Int.test(value)) setDescanso(value);
        break;
      default:
        break;
    }
  };


  /**
   * Carga los datos de una serie existente en los inputs del formulario para editarla.
   */
  const handleSelectSerieForEdit = (serie) => {
    setEditingSerieNum(serie.num_serie);
    setShowForm(true);
    setTipoRep(serie.tipo_rep_objetivo || 'fijo');
    setRepsMin(serie.reps_min_objetivo || "");
    setRepsMax(serie.reps_max_objetivo || "");
    setPeso(serie.peso_kg_objetivo || "");
    setDescanso(serie.descanso_seg_post || "60");
  };

  /**
   * Muestra el formulario con valores por defecto para a√±adir una NUEVA serie.
   */
  const handleShowAddForm = () => {
    setEditingSerieNum(null); // No estamos editando
    setShowForm(true);
    // Resetea inputs a valores por defecto para una nueva serie
    setTipoRep('rango');
    setRepsMin("8");
    setRepsMax("10");
    setPeso("");
    setDescanso("60");
  };

  /**
   * Oculta el formulario y resetea el estado de edici√≥n.
   */
  const handleCancelOrReset = () => {
    setEditingSerieNum(null);
    setShowForm(false);
  };

  /**
   * Valida y guarda la serie (nueva o actualizada) en el estado 'objetivos'.
   */
  const handleSaveOrAddSerie = () => {
    // --- Validaciones de inputs ---
    if (tipoRep === 'fijo') {
      if (!repsMin || parseInt(repsMin, 10) < 1) {
        alert("Para 'Reps Fijo', introduce un n√∫mero v√°lido (>= 1).");
        return;
      }
    } else if (tipoRep === 'rango') {
      const min = parseInt(repsMin, 10);
      const max = parseInt(repsMax, 10);
      if (!repsMin || !repsMax || isNaN(min) || isNaN(max) || min < 1 || max < min) {
        alert("Para 'Rango', introduce un rango v√°lido (M√≠n >= 1, M√°x >= M√≠n).");
        return;
      }
    } else if (tipoRep === 'fallo') {
      const repsAprox = parseInt(repsMin, 10);
      if (repsMin && (isNaN(repsAprox) || repsAprox < 0)) { // Permite vac√≠o o >= 0
        alert("Para 'Al Fallo', las repeticiones aproximadas deben ser un n√∫mero v√°lido (>= 0) o dejarse vac√≠o.");
        return;
      }
    }
    const pesoNum = parseFloat(peso);
    if (peso && (isNaN(pesoNum) || pesoNum < 0)) {
      alert("El peso debe ser un n√∫mero v√°lido (>= 0) o dejarse vac√≠o.");
      return;
    }
    const descansoNum = parseInt(descanso, 10);
    if (descanso && (isNaN(descansoNum) || descansoNum < 0)) {
      alert("El descanso debe ser un n√∫mero v√°lido (>= 0) o dejarse vac√≠o.");
      return;
    }

    // --- Creaci√≥n del objeto serie ---
    const serieActualizada = {
      tipo_rep_objetivo: tipoRep,
      reps_min_objetivo: (tipoRep !== 'fallo') ?
        (repsMin || null) : (repsMin && !isNaN(parseInt(repsMin, 10)) ? parseInt(repsMin, 10) : null),
      reps_max_objetivo: (tipoRep === 'rango') ?
        (repsMax || null) : null,
      peso_kg_objetivo: (peso && !isNaN(pesoNum)) ?
        pesoNum : null,
      descanso_seg_post: (descanso && !isNaN(descansoNum)) ?
        descansoNum : null,
      // Asegura que los campos de cardio est√©n nulos
      tiempo_min_objetivo: null,
      distancia_km_objetivo: null,
    };

    if (editingSerieNum !== null) {
      // --- L√≥gica para ACTUALIZAR una serie existente ---
      setObjetivos(objetivos.map(s =>
        s.num_serie === editingSerieNum
          ? { ...s, ...serieActualizada } // Actualiza la serie
          : s
      ));
      handleCancelOrReset(); // Oculta el form
    } else {
      // --- L√≥gica para A√ëADIR una nueva serie ---
      const nuevaSerie = {
        ...serieActualizada,
        // Asigna el siguiente n√∫mero de serie
        num_serie: (objetivos[objetivos.length - 1]?.num_serie || 0) + 1,
      };
      setObjetivos([...objetivos, nuevaSerie]); // A√±ade la nueva serie al array
      setShowForm(false); // Oculta el form
    }
  };

  /**
   * Borra una serie de la lista y renumera las restantes.
   */
  const handleRemoveSerie = (num_serie_to_remove) => {
    const seriesFiltradas = objetivos.filter(s => s.num_serie !== num_serie_to_remove);
    // Renumera las series restantes para mantener consistencia (1, 2, 3...)
    const seriesRenumeradas = seriesFiltradas.map((s, index) => ({ ...s, num_serie: index + 1 }));
    setObjetivos(seriesRenumeradas);

    // Si se estaba editando la serie que se borr√≥, cancela la edici√≥n
    if (editingSerieNum === num_serie_to_remove) {
      handleCancelOrReset();
    }
  };

  return (
    <>
      {/* Lista de series (preview) */}
      <div className="lista-series-preview" style={{ gridColumn: '1 / -1' }}>
        {objetivos.length === 0 ? (
          <p className="subtitle" style={{ margin: 0, fontSize: '0.9rem', textAlign: 'center' }}>A√±ade una serie...</p>
        ) : (
          objetivos.map(s => (
            <div
              key={s.id || s.num_serie} 
              className={`serie-preview-item ${s.num_serie === editingSerieNum ? 'editing-serie' : ''}`}
            >
              <span className="serie-info">
                <strong>Serie {s.num_serie}:</strong> {formatObjetivoNatural(s, 'fuerza')}
              </span>
              <div className="serie-actions">
                <button
                  type="button" className="btn-icon-edit"
                  onClick={() => handleSelectSerieForEdit(s)}
                  title="Editar esta serie"
                  disabled={editingSerieNum === s.num_serie} 
                >‚úèÔ∏è</button>
                <button
                  type="button" className="btn-icon-delete"
                  onClick={() => handleRemoveSerie(s.num_serie)}
                  title="Borrar esta serie"
                >&times;</button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Bot√≥n "+ A√±adir Nueva Serie" */}
      {!showForm && (
        <div className="add-new-serie-container" style={{ gridColumn: '1 / -1' }}>
          <button type="button" className="btn-add-new-serie" onClick={handleShowAddForm}>
            + A√±adir Nueva Serie
          </button>
        </div>
      )}

      {/* Formulario Inputs (CONDICIONAL) */}
      {showForm && (
        <div className="edit-serie-form" style={{ gridColumn: '1 / -1', borderTop: '1px solid var(--input-border-color)', paddingTop: '1rem', marginTop: '1rem' }}>

          {/* --- Grid para Reps (adaptado para fallo) --- */}
          <div className="form-rep-grid" style={{ gridColumn: 'span 3' }}>
            <div className="form-group-small">
              <label>Tipo Reps</label>
              <select value={tipoRep} onChange={(e) => setTipoRep(e.target.value)}>
                <option value="fijo">Fijo</option>
                <option value="rango">Rango</option>
                <option value="fallo">Al fallo</option>
              </select>
            </div>

            <div className="form-group-small">
              <label>{tipoRep === 'rango' ? 'Reps M√≠n' : (tipoRep === 'fallo' ? 'Reps Aprox.' : 'Reps')}</label>
              {tipoRep === 'fallo' ?
              (
                  <input
                    type="number" min="0"
                    value={repsMin}
                    // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
                    name="repsMin"
                    onChange={handleValidationChange}
                    onKeyDown={(e) => handleNumericKeyDown(e, false)}
                    // --- FIN CAMBIOS ---
                  />
                ) : (
                  <input
                    type="number" min="1"
                    value={repsMin}
                    required
                    // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
                    name="repsMin"
                    onChange={handleValidationChange}
                    onKeyDown={(e) => handleNumericKeyDown(e, false)}
                    // --- FIN CAMBIOS ---
                  />
                )}
            </div>

            {/* Input M√°ximo (solo para Rango) */}
            {tipoRep === 'rango' && (
              <div className="form-group-small">
                <label>Reps M√°x</label>
                <input
                  type="number"
                  min={(parseInt(repsMin, 10) || 0) + 1}
                  value={repsMax}
                  required
                  // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
                  name="repsMax"
                  onChange={handleValidationChange}
                  onKeyDown={(e) => handleNumericKeyDown(e, false)}
                  // --- FIN CAMBIOS ---
                />
              </div>
            )}
          </div>

          {/* Inputs para Peso y Descanso */}
          <div className="form-group-small" style={{ gridColumn: tipoRep === 'rango' ? 'span 1' : 'span 2' }}>
            <label>Peso (kg)</label>
            <input 
              type="number" 
              step="0.01" 
              min="0" 
              value={peso} 
              // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
              name="peso"
              onChange={handleValidationChange} 
              onKeyDown={(e) => handleNumericKeyDown(e, true)}
              // --- FIN CAMBIOS ---
            />
          </div>
          <div className="form-group-small" style={{ gridColumn: tipoRep === 'rango' ? 'span 1' : 'span 1' }}>
            <label>Descanso (s)</label>
            <input 
              type="number" 
              min="0" 
              value={descanso} 
              placeholder="Opcional" 
              // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
              name="descanso"
              onChange={handleValidationChange}
              onKeyDown={(e) => handleNumericKeyDown(e, false)}
              // --- FIN CAMBIOS ---
            />
          </div>

          {/* Botones Acci√≥n Serie */}
          <div className="form-actions-edit-serie" style={{ gridColumn: '1 / -1' }}>
            <button type="button" onClick={handleSaveOrAddSerie} className={editingSerieNum ? "btn-update-serie" : "btn-add-serie"}>
              {editingSerieNum ? `Actualizar Serie ${editingSerieNum}` : 'Confirmar Serie'}
            </button>
            <button type="button" className="btn-cancel-edit" onClick={handleCancelOrReset}>
              Cancelar
            </button>
          </div>
        </div>
      )}
    </>
  );
};

/**
 * Componente interno para gestionar la edici√≥n de intervalos de CARDIO.
 */
const FormularioCardioEditable = ({ objetivos, setObjetivos }) => {
  // Estados de los inputs para cardio
  const [tiempo, setTiempo] = useState("");
  const [distancia, setDistancia] = useState("");
  const [descanso, setDescanso] = useState("");
  const [editingIntervaloNum, setEditingIntervaloNum] = useState(null);
  const [showForm, setShowForm] = useState(false);

  // --- ¬°NUEVO! Handler de validaci√≥n para el formulario "Editar Cardio" ---
  const handleValidationChange = (e) => {
    const { name, value } = e.target;
    
    // Reglas de Regex
    const max4Int = /^\d{0,4}$/; // M√°x 4 d√≠gitos enteros
    const decimal_5_2 = /^(|\d{1,3}([.,]\d{0,2})?)$/; // M√°x 999.99 (6 chars total)

    switch (name) {
      case 'tiempo':
        if (max4Int.test(value)) setTiempo(value);
        break;
      case 'distancia':
        if (decimal_5_2.test(value) && value.length <= 6) {
          setDistancia(value.replace(',', '.'));
        }
        break;
      case 'descanso':
        if (max4Int.test(value)) setDescanso(value);
        break;
      default:
        break;
    }
  };

  /**
   * Carga datos del intervalo seleccionado en el formulario.
   */
  const handleSelectIntervaloForEdit = (intervalo) => {
    setEditingIntervaloNum(intervalo.num_serie);
    setShowForm(true);
    setTiempo(intervalo.tiempo_min_objetivo || "");
    setDistancia(intervalo.distancia_km_objetivo || "");
    setDescanso(intervalo.descanso_seg_post || "");
  };

  /**
   * Muestra el formulario vac√≠o para a√±adir un nuevo intervalo.
   */
  const handleShowAddForm = () => {
    setEditingIntervaloNum(null);
    setShowForm(true);
    setTiempo("");
    setDistancia("");
    setDescanso("");
  };

  /**
   * Oculta el formulario y resetea el estado de edici√≥n.
   */
  const handleCancelOrReset = () => {
    setEditingIntervaloNum(null);
    setShowForm(false);
  };

  /**
   * Valida y guarda el intervalo (nuevo o editado) en el estado 'objetivos'.
   */
  const handleSaveOrAddIntervalo = () => {
    // --- Validaciones Cardio ---
    const tiempoNum = parseInt(tiempo, 10);
    const distNum = parseFloat(distancia);
    const descansoNum = parseInt(descanso, 10);

    // Debe tener al menos tiempo o distancia
    if ((!tiempo || isNaN(tiempoNum) || tiempoNum <= 0) && (!distancia || isNaN(distNum) || distNum <= 0)) {
      alert("Introduce un valor v√°lido (> 0) para Tiempo o Distancia.");
      return;
    }
    // Validaciones individuales (permiten 0 o vac√≠o si el *otro* campo est√° relleno)
    if (tiempo && (isNaN(tiempoNum) || tiempoNum < 0)) {
      alert("El tiempo debe ser un n√∫mero v√°lido (>= 0).");
      return;
    }
    if (distancia && (isNaN(distNum) || distNum < 0)) {
      alert("La distancia debe ser un n√∫mero v√°lido (>= 0).");
      return;
    }
    if (descanso && (isNaN(descansoNum) || descansoNum < 0)) {
      alert("El descanso debe ser un n√∫mero v√°lido (>= 0) o dejarse vac√≠o.");
      return;
    }

    // --- Creaci√≥n del objeto intervalo ---
    const intervaloActualizado = {
      tiempo_min_objetivo: (tiempo && !isNaN(tiempoNum)) ? tiempoNum : null,
      distancia_km_objetivo: (distancia && !isNaN(distNum)) ? distNum : null,
      descanso_seg_post: (descanso && !isNaN(descansoNum)) ? descansoNum : null,
      // Asegura que los campos de fuerza est√©n nulos
      tipo_rep_objetivo: 'fijo', // Valor por defecto
      reps_min_objetivo: null,
      reps_max_objetivo: null,
      peso_kg_objetivo: null,
    };

    if (editingIntervaloNum !== null) {
      // --- L√≥gica para ACTUALIZAR ---
      setObjetivos(objetivos.map(i =>
        i.num_serie === editingIntervaloNum ? { ...i, ...intervaloActualizado } : i
      ));
      handleCancelOrReset();
    } else {
      // --- L√≥gica para A√ëADIR ---
      const nuevoIntervalo = {
        ...intervaloActualizado,
        num_serie: (objetivos[objetivos.length - 1]?.num_serie || 0) + 1,
      };
      setObjetivos([...objetivos, nuevoIntervalo]);
      setShowForm(false);
    }
  };

  /**
   * Borra un intervalo de la lista y renumera los restantes.
   */
  const handleRemoveIntervalo = (num_serie_to_remove) => {
    const intervalosFiltrados = objetivos.filter(i => i.num_serie !== num_serie_to_remove);
    const intervalosRenumerados = intervalosFiltrados.map((i, index) => ({ ...i, num_serie: index + 1 }));
    setObjetivos(intervalosRenumerados);
    if (editingIntervaloNum === num_serie_to_remove) {
      handleCancelOrReset();
    }
  };

  return (
    <>
      {/* Lista de intervalos (preview) */}
      <div className="lista-series-preview" style={{ gridColumn: '1 / -1' }}>
        {objetivos.length === 0 ? (
          <p className="subtitle" style={{ margin: 0, fontSize: '0.9rem', textAlign: 'center' }}>A√±ade un intervalo...</p>
        ) : (
          objetivos.map(i => (
            <div
              key={i.id || i.num_serie}
              className={`serie-preview-item ${i.num_serie === editingIntervaloNum ? 'editing-serie' : ''}`}
            >
              <span className="serie-info">
                <strong>Intervalo {i.num_serie}:</strong> {formatObjetivoNatural(i, 'cardio')}
              </span>
              <div className="serie-actions">
                <button type="button" className="btn-icon-edit" onClick={() => handleSelectIntervaloForEdit(i)} title="Editar intervalo" disabled={editingIntervaloNum === i.num_serie}>‚úèÔ∏è</button>
                <button type="button" className="btn-icon-delete" onClick={() => handleRemoveIntervalo(i.num_serie)} title="Borrar intervalo">&times;</button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Bot√≥n "+ A√±adir Nuevo Intervalo" */}
      {!showForm && (
        <div className="add-new-serie-container" style={{ gridColumn: '1 / -1' }}>
          <button type="button" className="btn-add-new-serie" onClick={handleShowAddForm}>
            + A√±adir Nuevo Intervalo
          </button>
        </div>
      )}

      {/* Formulario Inputs Cardio (CONDICIONAL) */}
      {showForm && (
        <div className="edit-serie-form" style={{ gridColumn: '1 / -1', borderTop: '1px solid var(--input-border-color)', paddingTop: '1rem', marginTop: '1rem' }}>
          <div className="form-grid">
            <div className="form-group-small">
              <label>Tiempo (min)</label>
              <input
                type="number" min="0" step="1" 
                value={tiempo} 
                // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
                name="tiempo"
                onChange={handleValidationChange}
                onKeyDown={(e) => handleNumericKeyDown(e, false)}
                // --- FIN CAMBIOS ---
              />
            </div>
            <div className="form-group-small">
              <label>Distancia (km)</label>
              <input 
                type="number" min="0" step="0.01"
                value={distancia} 
                // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
                name="distancia"
                onChange={handleValidationChange} 
                onKeyDown={(e) => handleNumericKeyDown(e, true)}
                // --- FIN CAMBIOS ---
              />
            </div>
            <div className="form-group-small">
              <label>Descanso (s)</label>
              <input 
                type="number" min="0" 
                value={descanso} 
                placeholder="Opcional" 
                // --- ¬°CAMBIOS DE VALIDACI√ìN! ---
                name="descanso"
                onChange={handleValidationChange}
                onKeyDown={(e) => handleNumericKeyDown(e, false)}
                // --- FIN CAMBIOS ---
              />
            </div>
          </div>

          {/* Botones Acci√≥n Intervalo */}
          <div className="form-actions-edit-serie" style={{ gridColumn: '1 / -1' }}>
            <button type="button" onClick={handleSaveOrAddIntervalo} className={editingIntervaloNum ? "btn-update-serie" : "btn-add-serie"}>
              {editingIntervaloNum ? `Actualizar Intervalo ${editingIntervaloNum}` : 'Confirmar Intervalo'}
            </button>
            <button type="button" className="btn-cancel-edit" onClick={handleCancelOrReset}>
              Cancelar
            </button>
          </div>
        </div>
      )}
    </>
  );
};


/**
 * Componente Principal del Modal para Editar un Ejercicio en una Rutina.
 */
function EditarEjercicioModal({ isOpen, onClose, ejercicio, onGuardar, maxOrden }) {
  // Estado para el orden del ejercicio en la rutina
  const [orden, setOrden] = useState(1);
  // Estado para la lista de objetivos (series o intervalos)
  const [objetivos, setObjetivos] = useState([]);
  // Estado para errores de la API al guardar
  const [apiError, setApiError] = useState(null);

  /**
   * Efecto para cargar los datos del ejercicio en el estado local del modal
   */
  useEffect(() => {
    if (isOpen && ejercicio) {
      setOrden(ejercicio.orden);
      // Clona el array de objetivos para evitar mutaciones directas del estado padre
      setObjetivos(ejercicio.objetivos ? [...ejercicio.objetivos] : []);
      setApiError(null); // Limpia errores previos
    } else if (!isOpen) {
      // Resetea estados al cerrar para evitar mostrar datos viejos
      setOrden(1);
      setObjetivos([]);
      setApiError(null);
    }
  }, [isOpen, ejercicio]); // Se ejecuta si isOpen o ejercicio cambian

  /**
   * Manejador del submit del formulario principal del modal.
   */
  const handleSubmit = (e) => {
    e.preventDefault();
    setApiError(null); // Limpia errores antes de intentar guardar

    // Validaciones b√°sicas antes de enviar
    if (parseInt(orden, 10) < 1) {
      setApiError("El orden debe ser 1 o mayor.");
      return;
    }
    if (objetivos.length === 0) {
      setApiError(`Debes definir al menos un${ejercicio.tipo === 'cardio' ? ' intervalo' : 'a serie'}.`);
      return;
    }

    // Renumera las series/intervalos por si se borr√≥ alguna intermedia
    const objetivosRenumerados = objetivos.map((o, i) => ({ ...o, num_serie: i + 1 }));
    
    // Prepara el objeto final para enviar a la API
    const datosAGuardar = {
      id: ejercicio.id, // ID de la tabla rutina_ejercicios
      orden: parseInt(orden, 10),
      objetivos: objetivosRenumerados // El array actualizado de series/intervalos
    };
    
    // Llama a la funci√≥n onGuardar pasada como prop
    onGuardar(datosAGuardar, setApiError);
  };

  // Si el modal no debe estar abierto o no hay datos del ejercicio, no renderiza nada
  if (!isOpen || !ejercicio) {
    return null;
  }

  // Renderizado del modal
  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        {/* Cabecera del modal */}
        <div className="modal-header">
          <h3>Editar Ejercicio</h3>
          <button className="modal-close-btn" onClick={onClose}>&times;</button>
        </div>

        {/* Formulario principal */}
        <form className="modal-form" onSubmit={handleSubmit}>
          {/* Muestra errores de validaci√≥n o de la API aqu√≠ */}
          {apiError && <div className="message" style={{ marginBottom: '1rem' }}>{apiError}</div>}

          {/* Nombre del ejercicio (no editable) */}
          <p className="edit-ejercicio-nombre">{ejercicio.nombre_ejercicio} ({ejercicio.tipo})</p>

          {/* Grid para inputs */}
          <div className="edit-form-grid">

            {/* Selector para el Orden del Ejercicio */}
            <div className="form-group-small" style={{ gridColumn: '1 / -1' }}>
              <label htmlFor="orden-ejercicio">Orden en la Rutina</label>
              <select
                id="orden-ejercicio"
                name="orden"
                value={orden}
                onChange={(e) => setOrden(e.target.value)}
                required
              >
                {/* Genera din√°micamente las opciones de orden (1 hasta maxOrden) */}
                {maxOrden > 0 &&
                  Array.from({ length: maxOrden }, (_, i) => i + 1)
                    .map(numero => (
                      <option key={numero} value={numero}>
                        {numero}
                      </option>
                    ))
                }
                {(!maxOrden || maxOrden === 0) && (
                  <option value={orden}>{orden}</option>
                )}
              </select>
            </div>

            {/* Renderiza el componente adecuado para editar Fuerza o Cardio */}
            {ejercicio.tipo === 'cardio' ?
              (<FormularioCardioEditable objetivos={objetivos} setObjetivos={setObjetivos} />)
              :
              (<FormularioFuerzaEditable objetivos={objetivos} setObjetivos={setObjetivos} />)
            }
          </div>

          {/* Footer con el bot√≥n de guardar */}
          <div className="modal-footer">
            <button type="submit" className="transparent-btn"> Guardar Cambios </button>
          </div>
        </form>
      </div>
    </div>
  );
}

export default EditarEjercicioModal;

--- Estadisticas.css ---

/* ---- frontend/src/Estadisticas.css (Refactorizado) ---- */

/* =========================================
 * ESTILOS GENERALES DEL CONTENEDOR
 * ========================================= */

.estadisticas-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 900px; /* Ancho m√°ximo del contenido */
  margin: 0 auto; /* Centrado horizontal */
}

.estadisticas-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
  text-align: center; /* Centramos el t√≠tulo principal */
}

.estadisticas-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 2rem;
  text-align: center; /* Centramos el subt√≠tulo */
}

/* =========================================
 * PESTA√ëAS (TABS)
 * ========================================= */

.comunidad-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 2rem;
  border-bottom: 1px solid var(--input-border-color); /* L√≠nea inferior para separar */
  justify-content: center; /* Centramos las pesta√±as */
}

.tab-btn {
  background: none;
  border: none;
  font-family: var(--font-family);
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-secondary-color); /* Color inactivo */
  padding: 0 0.5rem 1rem 0.5rem; /* Padding inferior para el borde */
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 3px solid transparent; /* Borde inferior transparente por defecto */
}

.tab-btn:hover {
  color: var(--text-color); /* Color al pasar el rat√≥n */
}

.tab-btn.active {
  color: var(--primary-color); /* Color activo */
  border-bottom-color: var(--primary-color); /* Borde inferior visible y coloreado */
}

/* =========================================
 * SECCI√ìN "MIS PRS"
 * ========================================= */

/* --- Filtros --- */
.pr-filtros {
  display: flex;
  padding-bottom: 2rem; /* Espacio antes de la lista */
  gap: 1rem; /* Espacio entre input y select */
  flex-wrap: wrap; /* Permite que pasen a la siguiente l√≠nea si no caben */
}

.pr-search-input {
  flex: 1; /* Ocupa espacio disponible */
  min-width: 180px; /* Evita que colapse demasiado */
  height: 48px;
  padding: 0 1rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  box-sizing: border-box; /* Incluye padding y borde en el tama√±o total */
  transition: all 0.3s;
}

.pr-search-input:focus {
  outline: none; /* Quita el borde por defecto del navegador */
  border-color: var(--primary-color); /* Borde coloreado al enfocar */
  box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2); /* Sombra suave al enfocar */
}

/* Selector de grupo (reutiliza/comparte estilo con modal si aplica) */
.modal-group-select { /* Aseg√∫rate que esta clase la usa tu select en Estadisticas.js */
  flex: 1; /* Ocupa espacio disponible */
  min-width: 180px; /* Evita que colapse demasiado */
  height: 48px;
  padding: 0 0.8rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  box-sizing: border-box;
  transition: all 0.3s;
  cursor: pointer; /* Indica que es interactivo */
}

.modal-group-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}

/* --- Lista de PRs --- */
.pr-list-container {
  display: flex;
  flex-direction: column;
  gap: 1.5rem; /* Espacio entre tarjetas de PR */
}

.pr-item-card {
  background-color: var(--surface-color); /* Fondo de la tarjeta */
  border: 1px solid var(--input-border-color); /* Borde sutil */
  border-radius: 8px; /* Bordes redondeados */
  padding: 1rem; /* Espacio interior */
}

.pr-item-header {
  display: flex;
  justify-content: space-between; /* Nombre a la izquierda, grupo a la derecha */
  align-items: center; /* Centrado vertical */
  margin-bottom: 1rem; /* Espacio antes de los r√©cords */
  border-bottom: 1px solid var(--input-border-color); /* L√≠nea separadora */
  padding-bottom: 0.75rem; /* Espacio sobre la l√≠nea */
}

.pr-item-header strong {
  font-size: 1.1rem;
  color: var(--text-color); /* Nombre del ejercicio */
}

.pr-item-header span {
  font-size: 0.9rem;
  color: var(--text-secondary-color); /* Grupo muscular (texto secundario) */
  background-color: var(--input-bg-color); /* Fondo sutil para la etiqueta */
  padding: 0.2rem 0.5rem; /* Padding de la etiqueta */
  border-radius: 6px; /* Bordes redondeados de la etiqueta */
  white-space: nowrap; /* Evita que el grupo muscular se parta */
}

.pr-records-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* Columnas flexibles */
  gap: 1rem; /* Espacio entre los r√©cords */
}

.pr-record-item {
  text-align: center; /* Centra el texto */
  background-color: var(--input-bg-color); /* Fondo ligeramente distinto */
  padding: 1rem;
  border-radius: 8px;
}

.pr-record-item strong {
  display: block; /* Ocupa su propia l√≠nea */
  font-size: 0.9rem;
  color: var(--text-secondary-color); /* Texto del t√≠tulo (Mayor Peso, etc.) */
  margin-bottom: 0.5rem;
}

.pr-record-item span {
  display: block; /* Ocupa su propia l√≠nea */
  font-size: 1.75rem; /* Tama√±o grande para el valor */
  font-weight: 700; /* Negrita */
  color: var(--text-color); /* Color del valor */
}

/* =========================================
 * SECCI√ìN "RANKINGS DE AMIGOS"
 * ========================================= */

/* T√≠tulo de secci√≥n (para "Destacados" y "Comparar") */
.section-title {
  font-size: 1.5rem; /* Un poco m√°s peque√±o que el h2 principal */
  color: var(--text-color);
  margin-top: 2.5rem; /* Espacio antes del t√≠tulo */
  margin-bottom: 1.5rem; /* Espacio despu√©s del t√≠tulo */
  padding-bottom: 0.5rem;
  text-align: center; /* Centra el t√≠tulo */
  border-bottom: none; /* Sin l√≠nea inferior por defecto */
}

/* Estilo especial para el t√≠tulo que act√∫a como separador */
.section-title.separator {
  margin-top: 3rem; /* M√°s espacio arriba */
  padding-top: 2rem; /* Espacio debajo de la l√≠nea */
  border-top: 1px solid var(--input-border-color); /* L√≠nea arriba */
}

/* Grid para las tarjetas de podio (RankingCard y CardioRankingCard) */
.ranking-grid-container {
  display: grid;
  /* M√≠nimo 320px por tarjeta, crea columnas autom√°ticamente */
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1.5rem; /* Espacio entre tarjetas */
}

/* Contenedor para los controles del comparador (bot√≥n Seleccionar Ejercicio) */
.comparator-controls {
  max-width: 400px; /* Limita el ancho del bot√≥n */
  margin-bottom: 1.5rem; /* Espacio antes del bot√≥n */
  margin-left: auto; /* Centra el contenedor */
  margin-right: auto; /* Centra el contenedor */
}

/* Reutiliza el estilo del bot√≥n transparente global */
.comparator-controls .transparent-btn {
  width: 100%; /* El bot√≥n ocupa todo el ancho del contenedor */
}

/* Espacio extra arriba para la grid de resultados del comparador */
.ranking-grid-container.results-comparator {
  margin-top: 1.5rem;
}

/* Mensaje 'Sin datos' espec√≠fico del comparador */
.no-data-msg.comparator-no-data {
  grid-column: 1 / -1; /* Ocupa todas las columnas de la grid */
  margin-top: 1rem;
  border: none; /* Sin borde */
  background: transparent; /* Sin fondo */
  padding: 0;
  font-size: 1rem;
  text-align: center; /* Asegura centrado */
  color: var(--text-secondary-color); /* Texto secundario */
  font-style: italic; /* Cursiva */
}

/* =========================================
 * MENSAJES GEN√âRICOS (Sin datos)
 * ========================================= */

.no-data-msg {
  text-align: center;
  color: var(--text-secondary-color);
  font-style: italic;
  padding: 2rem;
  background-color: var(--surface-color); /* Fondo sutil */
  border: 1px dashed var(--input-border-color); /* Borde discontinuo */
  border-radius: 12px; /* Bordes redondeados */
  margin-top: 1rem; /* Espacio arriba */
  /* Si est√° dentro de una grid, necesita ocupar todas las columnas */
  grid-column: 1 / -1;
}


/* =========================================
 * MEDIA QUERIES (RESPONSIVE)
 * ========================================= */

@media (max-width: 600px) { /* Ajusta este breakpoint si es necesario */

  .estadisticas-container {
    padding: 1.5rem 1rem; /* Menos padding en m√≥vil */
  }

  /* --- Ajuste para Filtros "Mis PRs" --- */
  .pr-filtros {
    flex-direction: column; /* Apila los filtros verticalmente */
    gap: 1rem; /* Reduce el espacio vertical entre ellos */
  }

  .pr-search-input,
  .modal-group-select { /* Aseg√∫rate que es la clase correcta del select */
    width: 100%; /* Ocupan todo el ancho disponible */
    min-width: 0; /* Anula el min-width de escritorio */
    flex: none; /* Anula las propiedades flex de escritorio */
  }

  /* --- Ajuste para T√≠tulos --- */
  .estadisticas-container h2 {
    font-size: 1.8rem; /* T√≠tulo principal un poco m√°s peque√±o */
  }
  .section-title {
    font-size: 1.3rem; /* T√≠tulos de secci√≥n un poco m√°s peque√±os */
  }

  .pr-record-item span {
    font-size: 1.5rem; /* Valor del r√©cord un poco m√°s peque√±o */
  }

  /* --- Ajuste para Tarjetas de Ranking --- */
  .ranking-grid-container {
    /* auto-fit se encargar√° de poner 1 columna si no caben 2 de 320px */
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Reducimos un poco el minmax */
  }

}

--- Estadisticas.js ---

// ---- frontend/src/Estadisticas.js ----

import React, { useState, useEffect, useMemo, useCallback } from 'react';
import './Estadisticas.css';
import RankingCard from './components/RankingCard';
import CardioRankingCard from './components/CardioRankingCard';
import SelectorEjerciciosModal from './components/SelectorEjerciciosModal';
import iconoTrofeo from './assets/trofeo.png';
// Icono principal
import iconoRanking from './assets/ranking.png';   // Icono para Rankings Destacados
import iconoEstrella from './assets/estrella.png'; // Icono para Mis PRs
// ¬°NUEVA IMPORTACI√ìN!
import GuiaModal from './components/GuiaModal'; 

// ==================================================================
// --- Componente Interno: Pesta√±a "Mis PRs" (Sin cambios) ---
// ==================================================================
const TabMisPRs = ({ token }) => {
  const [prs, setPrs] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [filtroNombre, setFiltroNombre] = useState("");
  const [filtroGrupoPRs, setFiltroGrupoPRs] = useState("Todos");

  useEffect(() => {
    const cargarMisPRs = async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await fetch('http://localhost/programacion/TFG/movium/backend/api/get_mis_todos_prs.php', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.mensaje || "Error al cargar mis PRs.");
   
           setPrs(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };
    if (token) {
        cargarMisPRs();
    } else {
        setError("Token no disponible.");
        setLoading(false);
    }
  }, [token]);

  const gruposMuscularesPRs = useMemo(() => {
    const grupos = new Set(prs.map(pr => pr.grupo_muscular).filter(Boolean));
    return ["Todos", ...Array.from(grupos).sort()]; // Ordenar alfab√©ticamente
  }, [prs]);

  const listaFiltrada = useMemo(() => {
    return prs.filter(pr => {
      const pasaFiltroGrupo = (filtroGrupoPRs === "Todos") || (pr.grupo_muscular === filtroGrupoPRs);
      const filtroLower = filtroNombre.toLowerCase();
      const pasaFiltroNombre = !filtroNombre ||
         pr.nombre.toLowerCase().includes(filtroLower) ||
        (pr.grupo_muscular && pr.grupo_muscular.toLowerCase().includes(filtroLower));
      return pasaFiltroGrupo && pasaFiltroNombre;
    });
  }, [prs, filtroNombre, filtroGrupoPRs]);

  // *** FUNCI√ìN renderPR MODIFICADA PARA MOSTRAR 0 ***
  const renderPR = (pr) => {
    if (pr.tipo === 'cardio') {
      const hasSpeed = pr.max_velocidad_media != null;
      // Variables para mostrar, usando '0' como default y a√±adiendo unidad
      const tiempoDisplay = pr.max_tiempo != null ? `${pr.max_tiempo} min` : '0 min';
      const distDisplay = pr.max_dist != null ? `${pr.max_dist} km` : '0 km';
      const speedDisplay = hasSpeed ? `${pr.max_velocidad_media} km/h` : '0 km/h';
      
      // Mantenemos 3 columnas siempre para consistencia visual
      const gridColumns = '1fr 1fr 1fr';

      return (
        <div className="pr-records-grid" style={{ gridTemplateColumns: gridColumns }}>
          <div className="pr-record-item">
            <strong>Mayor Tiempo</strong>
            <span>{tiempoDisplay}</span>
          </div>
          <div className="pr-record-item">
            <strong>Mayor Distancia</strong>
            <span>{distDisplay}</span>
    
          </div>
          {/* Mostramos siempre la velocidad, atenuada si es 0 */}
          <div className="pr-record-item" style={!hasSpeed ? { opacity: 0.6 } : {}}>
              <strong>Velocidad Media M√°x</strong>
              <span>{speedDisplay}</span>
          </div>
        </div>
      );
    } else { // fuerza o calistenia
      // Variables para mostrar, usando '0' como default y a√±adiendo unidad
      const pesoDisplay = pr.max_peso != null ? `${pr.max_peso} kg` : '0 kg';
      const repsDisplay = pr.max_reps != null ? pr.max_reps : '0';
      // Reps no lleva unidad

      return (
         <div className="pr-records-grid">
          <div className="pr-record-item">
            <strong>Mayor Peso</strong>
            <span>{pesoDisplay}</span>
          </div>
          <div className="pr-record-item">
            <strong>M√°ximas Reps</strong>
         
             <span>{repsDisplay}</span>
          </div>
        </div>
      );
    }
  };
  // *** FIN FUNCI√ìN renderPR MODIFICADA ***

  return (
    <div>
      {/* Filtros */}
      <div className="pr-filtros">
        <input
          type="search"
          placeholder="Filtrar por nombre..."
          className="modal-search pr-search-input" // Reutiliza clase modal-search si aplica
          value={filtroNombre}
          onChange={(e) => setFiltroNombre(e.target.value)}
        />
        <select
          className="modal-group-select" // Reutiliza clase modal-group-select si aplica
          value={filtroGrupoPRs}
          onChange={(e) => setFiltroGrupoPRs(e.target.value)}
        >
          {gruposMuscularesPRs.map(grupo => (
            <option key={grupo} value={grupo}>
               {grupo === "Todos" ? "Todos los Grupos" : (grupo || "Sin Grupo")}
            </option>
          ))}
        </select>
      </div>

      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px', marginBottom: '0' }}>
        <img src={iconoEstrella} alt="" width="64" height="64" />
        <h3
          className="section-title"
  
           style={{
            marginTop: '0',
            marginBottom: '1.5rem',
          }}
        >
          Tus Records Personales
        </h3>
      </div>

      {/* Mensajes de estado */}
      {error && <div className="message" style={{marginBottom: '1.5rem'}}>{error}</div>}
 
           {loading && <p className="subtitle" style={{textAlign: 'center', marginTop: '2rem'}}>Cargando tus r√©cords...</p>}

      {/* Lista de PRs */}
      {!loading && !error && (
        <div className="pr-list-container">
          {listaFiltrada.length > 0 ?
 (
            listaFiltrada.map(pr => (
               <div key={pr.ejercicio_id} className="pr-item-card">
                  <div className="pr-item-header">
                    <strong>{pr.nombre}</strong>
                    <span>{pr.grupo_muscular || 'General'}</span>
        
                   </div>
                  {renderPR(pr)}
                </div>
            ))
          ) : (
             <p className="no-data-msg" style={{border: 'none', padding: '2rem 0'}}>
             
               {prs.length === 0
                  ? `A√∫n no tienes PRs registrados.`
                  : "No se encontraron PRs con ese filtro."
                }
             </p>
          )}
        </div>
 
           )}
    </div>
  );
};
// ==================================================================

// ==================================================================
// --- Componente Interno: Pesta√±a "Rankings de Amigos" (Sin cambios) ---
// ==================================================================
const TabRankings = ({ token, miUsuarioId }) => {
  const [rankingDataGlobal, setRankingDataGlobal] = useState(null);
  const [loadingGlobal, setLoadingGlobal] = useState(true);
  const [errorGlobal, setErrorGlobal] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [ejercicioSelectComp, setEjercicioSelectComp] = useState(null);
  const [rankingDetalleComp, setRankingDetalleComp] = useState(null);
  const [loadingComp, setLoadingComp] = useState(false);
  const [errorComp, setErrorComp] = useState(null);
  const [listaMaestra, setListaMaestra] = useState([]);

  useEffect(() => {
    const cargarGlobalRankings = async () => {
      setLoadingGlobal(true);
      setErrorGlobal(null);
      setRankingDataGlobal(null);
      if (!token) {
        setErrorGlobal("Token no disponible para cargar rankings.");
        setLoadingGlobal(false);
        return;
      }
      try {
        const res = await fetch('http://localhost/programacion/TFG/movium/backend/api/get_global_rankings.php', {
       
             headers: { 'Authorization': `Bearer ${token}` }
          });
        const data = await res.json();
        if (!res.ok) throw new Error(data.mensaje || "Error al cargar los rankings globales.");
        const defaultData = {
          press_banca: [], sentadilla: [], peso_muerto: [],
          max_distancia: [], max_tiempo: [], max_velocidad_media: []
        };
 
           setRankingDataGlobal({...defaultData, ...data});
      } catch (err) {
        setErrorGlobal(err.message);
      } finally {
        setLoadingGlobal(false);
      }
    };
    cargarGlobalRankings();
   }, [token]);

  useEffect(() => {
     const cargarMaestra = async () => {
      if (!token || listaMaestra.length > 0) return;
      try {
        const res = await fetch(`http://localhost/programacion/TFG/movium/backend/api/get_ejercicios_maestra.php`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.mensaje || "Error al cargar ejercicios");
        setListaMaestra(data);
      } catch (err) {
        console.error("Error cargando lista maestra:", err);
      }
     };
    cargarMaestra();
    }, [token, listaMaestra]);

  const handleSelectEjercicioComp = async (ej) => {
    setIsModalOpen(false);
    if (ejercicioSelectComp?.id === ej.id) return;

    setEjercicioSelectComp(ej);
    setLoadingComp(true);
    setErrorComp(null);
    setRankingDetalleComp(null);
    if (!token) {
        setErrorComp("Token no disponible para cargar detalles.");
        setLoadingComp(false);
        return;
    }

    try {
      const res = await fetch(`http://localhost/programacion/TFG/movium/backend/api/get_ranking_detalle.php?id=${ej.id}`, {
         headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.mensaje || `Error al cargar ranking para ${ej.nombre}`);
      setRankingDetalleComp(data);
    } catch (err) {
      setErrorComp(err.message);
    } finally {
      setLoadingComp(false);
    }
   };

  return (
    <div className="tab-rankings-content">
      {/* SECCI√ìN 1: RANKINGS DESTACADOS */}
      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '1.5rem', gap: '10px', marginTop: '2.5rem' }}>
        <img src={iconoRanking} alt="" width="64" height="64" />
        <h3 className="section-title" style={{ marginTop: '0'}}>
          Rankings Destacados
        </h3>
      </div>

      {errorGlobal && <div className="message" style={{marginBottom: '1.5rem'}}>{errorGlobal}</div>}
      {loadingGlobal && <p className="subtitle" style={{textAlign: 'center'}}>Cargando r√©cords globales...</p>}

      {!loadingGlobal && !errorGlobal && rankingDataGlobal && (
        <div className="ranking-grid-container">
            <RankingCard title="Press de Banca" data={rankingDataGlobal.press_banca} miUsuarioId={miUsuarioId} />
            <RankingCard title="Sentadilla" data={rankingDataGlobal.sentadilla} miUsuarioId={miUsuarioId} />
            <RankingCard title="Peso Muerto" data={rankingDataGlobal.peso_muerto} miUsuarioId={miUsuarioId} />
            <CardioRankingCard
 
               title="R√©cords de Carrera (Cinta)"
              rankings={{
                max_distancia: rankingDataGlobal.max_distancia,
                max_tiempo: rankingDataGlobal.max_tiempo,
                max_velocidad_media: rankingDataGlobal.max_velocidad_media
              }}
     
               miUsuarioId={miUsuarioId}
            />
        </div>
      )}

      {/* SECCI√ìN 2: COMPARADOR DIN√ÅMICO */}
      <h3 className="section-title separator">
        Comparar un Ejercicio Espec√≠fico
      </h3>
      <div className="comparator-controls">
          <button
            
             className="transparent-btn"
            onClick={() => setIsModalOpen(true)}
            disabled={listaMaestra.length === 0 || loadingGlobal}
          >
            {ejercicioSelectComp ?
 `Comparando: ${ejercicioSelectComp.nombre}` : 'Seleccionar Ejercicio'}
          </button>
      </div>
       {loadingComp && <p className="subtitle" style={{marginTop: '1rem', textAlign: 'center'}}>Cargando ranking...</p>}
       {errorComp && <div className="message" style={{marginTop: '1rem'}}>{errorComp}</div>}
       {rankingDetalleComp && ejercicioSelectComp && !loadingComp && !errorComp && (
        <div className="ranking-grid-container results-comparator">
          {(ejercicioSelectComp.tipo === 'fuerza' || ejercicioSelectComp.tipo === 'calistenia') && rankingDetalleComp.max_peso?.length > 0 && (
      
             <RankingCard title={`${ejercicioSelectComp.nombre} (Max Peso)`} data={rankingDetalleComp.max_peso} miUsuarioId={miUsuarioId} />
          )}
          {(ejercicioSelectComp.tipo === 'fuerza' || ejercicioSelectComp.tipo === 'calistenia') && rankingDetalleComp.max_reps?.length > 0 && (
             <RankingCard
                title={`${ejercicioSelectComp.nombre} (Mejor Serie e1RM)`}
                data={rankingDetalleComp.max_reps}
        
                 miUsuarioId={miUsuarioId}
             />
          )}
          {ejercicioSelectComp.tipo === 'cardio' && rankingDetalleComp.max_dist?.length > 0 && (
            <RankingCard title={`${ejercicioSelectComp.nombre} (Max Distancia)`} data={rankingDetalleComp.max_dist} miUsuarioId={miUsuarioId}/>
          )}
          {ejercicioSelectComp.tipo === 'cardio' && rankingDetalleComp.max_tiempo?.length > 0 && (
      
             <RankingCard title={`${ejercicioSelectComp.nombre} (Max Tiempo)`} data={rankingDetalleComp.max_tiempo} miUsuarioId={miUsuarioId}/>
          )}
          { !loadingComp && rankingDetalleComp &&
             (!rankingDetalleComp.max_peso || rankingDetalleComp.max_peso.length === 0) &&
             (!rankingDetalleComp.max_reps || rankingDetalleComp.max_reps.length === 0) &&
             (!rankingDetalleComp.max_dist || rankingDetalleComp.max_dist.length === 0) &&
             (!rankingDetalleComp.max_tiempo || rankingDetalleComp.max_tiempo.length === 0) &&
             <p className="no-data-msg comparator-no-data" style={{textAlign: 'center'}}>
                 No hay r√©cords registrados para "{ejercicioSelectComp.nombre}" entre tus amigos.
             </p>
           }
        </div>
      )}
      <SelectorEjerciciosModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        listaEjercicios={listaMaestra}
        onEjercicioSelect={handleSelectEjercicioComp}
      />

    </div>
  );
};
// ==================================================================


// ==================================================================
// --- Componente Principal Estadisticas (MODIFICADO) ---
// ==================================================================
function Estadisticas() {
    const [vista, setVista] = useState('mis_prs');
    const [miUsuarioId, setMiUsuarioId] = useState(null);
    const token = localStorage.getItem('movium_token');

    // --- ¬°NUEVO! ESTADO PARA LA GU√çA ---
    const [showGuiaRecords, setShowGuiaRecords] = useState(false);

    // --- ¬°NUEVO! HELPER PARA MARCAR GU√çA (copiado de Dashboard.js) ---
    const marcarGuiaComoVista = async (nombreGuia) => {
        const token = localStorage.getItem('movium_token');
        if (!token) return;
        try {
            await fetch('http://localhost/programacion/TFG/movium/backend/api/marcar_guia_vista.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ guia_vista: nombreGuia })
            });
        } catch (error) {
            console.error("Error al marcar la gu√≠a como vista:", error);
        }
    };

    // --- ¬°NUEVO! USE EFFECT PARA MOSTRAR GU√çA ---
    useEffect(() => {
        try {
            const storedUser = JSON.parse(localStorage.getItem('movium_user'));
            // Asumimos que a√±adir√°s 'ha_visto_guia_records' al login.php y marcar_guia_vista.php
            if (storedUser && !storedUser.ha_visto_guia_records) {
                setShowGuiaRecords(true);
            }
        } catch (e) {
            console.error("Error al leer datos de usuario para la gu√≠a de R√©cords:", e);
        }
    }, []); // Se ejecuta solo al montar

    // --- ¬°NUEVO! HANDLER PARA CERRAR GU√çA ---
    const handleCerrarGuiaRecords = () => {
        try {
            marcarGuiaComoVista('records'); // Clave 'records'
            const storedUser = JSON.parse(localStorage.getItem('movium_user'));
            if (storedUser) {
                const updatedUser = { ...storedUser, ha_visto_guia_records: true };
                localStorage.setItem('movium_user', JSON.stringify(updatedUser));
            }
            setShowGuiaRecords(false);
        } catch (e) {
            console.error("Error al cerrar la gu√≠a de R√©cords:", e);
            setShowGuiaRecords(false);
        }
    };

    // useEffect para decodificar token (existente)
    useEffect(() => {
        try {
            if (token) {
                const payloadBase64 = token.split('.')[1];
                const base64 = payloadBase64.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
      
                     return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const decodedPayload = JSON.parse(jsonPayload);

                if (decodedPayload.data && decodedPayload.data.id) {
                     setMiUsuarioId(decodedPayload.data.id);
       
                   } else {
                     console.error("ID de usuario no encontrado en el payload del token:", decodedPayload);
                }
            } else {
                 console.warn("No se encontr√≥ token de autenticaci√≥n.");
     
               }
        } catch (e) {
            console.error("Error decodificando token:", e);
        }
    }, [token]);

    // Renderizado principal
    return (
        <>
            <div className="estadisticas-container">
                {/* Cabecera principal con icono */}
                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
                  <img src={iconoTrofeo} alt="" width="64" height="64" />
                  <h2>R√©cords</h2>
                </div>
        
                 <p className="subtitle" style={{ textAlign: 'center' }}>
                  Tu "Sal√≥n de la Fama" personal y rankings de amigos.
                </p>

                {/* Pesta√±as */}
                <div className="comunidad-tabs">
                    <button
             
                         className={`tab-btn ${vista === 'mis_prs' ? 'active' : ''}`}
                        onClick={() => setVista('mis_prs')}
                    >
                        Mis PRs
                    </button>
           
                     <button
                        className={`tab-btn ${vista === 'rankings' ? 'active' : ''}`}
                        onClick={() => setVista('rankings')}
                    >
                        Rankings de Amigos
        
                     </button>
                </div>

                {/* Contenido condicional */}
                {vista === 'mis_prs' && <TabMisPRs token={token} />}
                {vista === 'rankings' && <TabRankings token={token} miUsuarioId={miUsuarioId} />}

            </div>

            {/* --- ¬°NUEVO! RENDERIZADO DEL MODAL DE GU√çA --- */}
            <GuiaModal
                isOpen={showGuiaRecords}
                onClose={handleCerrarGuiaRecords}
                titulo="¬°Tu Sal√≥n de la Fama!"
            >
                <p>¬°Bienvenido a tus <strong>R√©cords</strong>!</p>
                <p>Esta secci√≥n es donde mides tu progreso real y te comparas con amigos. Se divide en dos pesta√±as:</p>
                <ul style={{ marginTop: '0.5rem', marginBottom: '1rem', paddingLeft: '1.2rem' }}>
                    <li style={{ marginBottom: '0.5rem' }}>
                        <strong>Mis PRs:</strong> Aqu√≠ ver√°s <i>todos</i> tus R√©cords Personales (Mayor Peso, M√°ximas Reps, etc.) para <i>cada</i> ejercicio que hayas registrado.
                    </li>
                    <li>
                        <strong>Rankings de Amigos:</strong> Compara tus mejores marcas en ejercicios clave (como Press de Banca o Sentadilla) con las de tus amigos.
                    </li>
                </ul>
                <p>¬°Registra tus entrenos para empezar a llenar esta secci√≥n!</p>
            </GuiaModal>
        </>
    );
}

export default Estadisticas;

--- Feed.css ---

/* ---- frontend/src/Feed.css (AHORA S√ç, COMPLETO) ---- */

/* 1. Contenedor de la p√°gina
   (Estilo basado en .comunidad-container) */
.feed-page-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 900px;
  margin: 0 auto;
}

/* 2. Bot√≥n Volver
   (Estilo copiado de .btn-volver en RutinaProgreso.css) */
.feed-page-container .btn-volver {
  background: none;
  border: 1px solid var(--input-border-color);
  color: var(--text-secondary-color);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  font-family: var(--font-family);
  transition: all 0.3s ease;
  margin-bottom: 1.5rem; /* M√°s espacio */
}
.feed-page-container .btn-volver:hover {
  background-color: var(--input-bg-color);
  color: var(--text-color);
}

/* 3. Cabecera (Icono + T√≠tulo + Subt√≠tulo)
   (Estilo centrado como en Dashboard o Comunidad) */
.feed-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 2rem; /* Espacio antes del feed */
  gap: 10px;
}

.feed-header h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin: 0;
}

.feed-header .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin: 0;
  text-align: center;
}

/* 4. Mensaje de "No hay actividad" o "Cargando"
   (Estilo copiado de .no-rutinas-msg o .no-data-msg) */
.feed-empty {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  text-align: center;
  margin-top: 3rem;
  padding: 1.5rem;
  background-color: var(--surface-color);
  border: 1px dashed var(--input-border-color);
  border-radius: 12px;
}

/* 5. Contenedor del Feed */
.feed-container {
  display: flex;
  flex-direction: column;
  gap: 1rem; /* Espacio entre cada item del feed */
}

/* 6. Item individual del Feed */
.feed-item {
  display: flex;
  flex-direction: column; 
  gap: 1rem; 
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.25rem 1.5rem;
  box-shadow: var(--box-shadow);
  transition: all 0.3s ease;
}
.feed-item:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

/* 7. Cabecera del Item (Nombre, Rutina, Fecha) */
.feed-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.25rem 1rem;
}

.feed-item-main {
  font-size: 1.05rem;
  color: var(--text-color);
  word-break: break-word;
}

.feed-item-main .feed-user {
  font-weight: 700;
  color: var(--primary-color); /* Todos los usuarios en azul */
}

.feed-item-main .feed-rutina {
  font-weight: 700;
  font-style: italic;
  color: var(--text-secondary-color);
}

.feed-fecha {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  flex-shrink: 0;
  white-space: nowrap;
}

/* 8. Stats (Resumen de la sesi√≥n)
   (Estilo copiado de RutinaProgreso.css .sesion-totales) */
.feed-item-stats {
  display: flex;
  gap: 0.75rem 1.5rem; /* M√°s espacio horizontal */
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  flex-wrap: wrap;
  padding: 0.75rem 1rem; /* Padding interno */
  background-color: var(--input-bg-color);
  border-radius: 8px;
  justify-content: center; /* Centra los stats */
}
.feed-item-stats span {
  white-space: nowrap;
  font-weight: 700;
  display: flex; /* Para alinear icono y texto */
  align-items: center;
  gap: 0.4rem; /* Espacio entre icono y texto */
}

/* 9. Estilos de Expansi√≥n */

/* Contenedor del bot√≥n "Ver Detalles" */
.feed-item-actions {
  text-align: center;
  margin-top: -0.5rem; /* Pega el bot√≥n un poco m√°s a los stats */
}

/* Bot√≥n "Ver Detalles" */
.btn-feed-details {
  background: none;
  border: none;
  color: var(--text-secondary-color);
  font-family: var(--font-family);
  font-size: 0.85rem;
  font-weight: 700;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  border-radius: 6px;
  transition: all 0.2s ease;
}
.btn-feed-details:hover {
  color: var(--primary-color);
  background-color: var(--input-bg-color);
}

/* Contenedor de los detalles (el que se expande) */
.feed-item-details {
  animation: fadeInDetails 0.4s ease-out;
  border-top: 1px solid var(--input-border-color);
  padding-top: 1rem;
  margin-top: 0.5rem;
}

/* REUTILIZACI√ìN DE ESTILOS DE RUTINAPROGRESO.CSS */
/* (Aseg√∫rate de que RutinaProgreso.css est√° importado en FeedPage.js) */

.feed-item-details .ejercicio-grupo > strong {
  font-size: 1rem; 
  color: var(--text-color);
  font-weight: 700;
}
.feed-item-details .serie-item {
  font-size: 0.9rem; 
  gap: 0.5rem;
  padding-left: 0.5rem;
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  color: var(--text-secondary-color);
}
.feed-item-details .serie-item span:first-child {
  color: var(--text-color);
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 40px;
}
.feed-item-details .serie-item span:nth-child(2) {
  text-align: right;
  flex-grow: 1;
}
.feed-item-details .ejercicio-grupo ul {
  padding-left: 0.5rem; /* Menos indentaci√≥n */
  list-style: none;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

/* Estilo para la etiqueta 'F' de fallo */
.feed-item-details .fallo-tag {
  background-color: var(--primary-color);
  color: #fff;
  font-size: 0.7rem;
  padding: 0.1rem 0.3rem;
  border-radius: 4px;
  font-weight: bold;
  margin-left: 0.4rem;
  white-space: nowrap;
  vertical-align: middle;
}

/* Mensaje de error general (copiado de global.css) */
.feed-page-container .message {
  margin-bottom: 1.5rem;
  padding: 0.8rem;
  border-radius: 5px;
  font-weight: 700;
  text-align: center;
  background-color: rgba(217, 48, 37, 0.1);
  color: #d93025;
  border: 1px solid #d93025;
}


/* Animaci√≥n simple */
@keyframes fadeInDetails {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Media Query para m√≥vil */
@media (max-width: 600px) {
  .feed-page-container {
    padding: 1.5rem 1rem;
  }

  .feed-header h2 {
    font-size: 1.8rem;
  }
  
  .feed-item-stats {
    justify-content: flex-start; /* Alinea stats a la izquierda en m√≥vil */
    gap: 0.5rem 1rem;
  }
}

--- FeedPage.js ---

// ---- frontend/src/FeedPage.js (ACTUALIZADO CON DETALLES EXPANDIBLES) ----

import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import './Feed.css'; 
// ¬°IMPORTANTE! Reutilizamos los estilos del historial
import './RutinaProgreso.css'; 
import iconoFeed from './assets/feed.png';

// --- Funciones Helper (formatRelativeDate, formatDuracion) ---
// (Pega aqu√≠ las funciones que te pas√© en el mensaje anterior)
const formatRelativeDate = (dateString) => {
    if (!dateString) { return null; }
    try {
        const sessionDate = new Date(dateString);
        const today = new Date();
        const diffTime = today.getTime() - sessionDate.getTime();
        if (diffTime < 0) return "En el futuro"; // Por si acaso

        const diffMinutes = Math.floor(diffTime / (1000 * 60));
        const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (diffMinutes < 1) { return "Ahora mismo"; }
        if (diffMinutes < 60) { return `Hace ${diffMinutes} min`; }
        if (diffHours < 24) { return `Hace ${diffHours} h`; }
        if (diffDays === 1) { return 'Ayer'; }
        if (diffDays < 7) { return `Hace ${diffDays} d√≠as`; }
        
        return sessionDate.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
    } catch (e) { 
        console.error("Error formateando fecha:", e); 
        return 'fecha inv√°lida'; 
    }
};

const formatDuracion = (duracionSql) => {
    if (!duracionSql || duracionSql === '00:00:00') return null;
    const partes = duracionSql.split(':');
    const horas = parseInt(partes[0], 10);
    const minutos = parseInt(partes[1], 10);
    let resultado = '';
    if (horas > 0) { resultado += `${horas}h `; }
    if (minutos > 0 || horas === 0) { resultado += `${minutos}m`; }
    return resultado.trim();
};
// --- Fin Funciones Helper ---


/**
 * ---------------------------------
 * Componente Interno para el Item del Feed
 * ---------------------------------
 */
const FeedItem = ({ item, token }) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const [isLoadingDetails, setIsLoadingDetails] = useState(false);
    const [errorDetails, setErrorDetails] = useState(null);
    const [detallesEjercicios, setDetallesEjercicios] = useState([]); // Aqu√≠ guardamos los ejercicios

    // Formateo de datos del item (resumen)
    const fechaRelativa = formatRelativeDate(item.fecha_fin);
    const duracionFormateada = formatDuracion(item.duracion);
    const volTotal = parseFloat(item.total_volumen_fuerza);
    const tiempoTotal = parseFloat(item.total_tiempo_cardio);
    const distTotal = parseFloat(item.total_distancia_cardio);

    // Funci√≥n para buscar los detalles de ESTA sesi√≥n
    const handleToggleDetails = async () => {
        if (isExpanded) {
            setIsExpanded(false); // Si ya estaba abierto, solo lo cierra
            return;
        }

        // Si no est√° abierto y no tenemos datos, los busca
        setIsExpanded(true);
        if (detallesEjercicios.length > 0) {
            return; // Ya los ten√≠amos, no hace falta buscar
        }

        setIsLoadingDetails(true);
        setErrorDetails(null);
        try {
            const res = await fetch(`http://localhost/programacion/TFG/movium/backend/api/get_session_details.php?id=${item.sesion_id}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.mensaje || "Error al cargar detalles.");
            setDetallesEjercicios(data); // Guardamos el array de ejercicios
        } catch (err) {
            setErrorDetails(err.message);
        } finally {
            setIsLoadingDetails(false);
        }
    };

    return (
        <div className="feed-item">
            
            {/* 1. Cabecera (Nombre, Rutina y Fecha) */}
            <div className="feed-item-header">
                <div className="feed-item-main">
                    <strong className="feed-user">
                        {item.nombre_usuario}
                    </strong>
                    <span> ha completado </span>
                    <span className="feed-rutina">
                        {item.nombre_rutina || '[Rutina Eliminada]'}
                    </span>
                </div>
                {fechaRelativa && (
                    <span className="feed-fecha">
                        {fechaRelativa}
                    </span>
                )}
            </div>

            {/* 2. Cuerpo con los stats (Resumen) */}
            <div className="feed-item-stats">
                {duracionFormateada && ( <span>üïí {duracionFormateada}</span> )}
                {volTotal > 0 && ( <span>üèãÔ∏è {Math.round(volTotal)} kg</span> )}
                {tiempoTotal > 0 && ( <span>‚è±Ô∏è {tiempoTotal} min</span> )}
                {distTotal > 0 && ( <span>üìç {distTotal.toFixed(1)} km</span> )}
            </div>

            {/* 3. Bot√≥n para expandir */}
            <div className="feed-item-actions">
                <button onClick={handleToggleDetails} className="btn-feed-details">
                    {isExpanded ? "Ocultar Detalles" : "Ver Detalles"}
                </button>
            </div>

            {/* 4. Contenedor de Detalles (condicional) */}
            {isExpanded && (
                <div className="feed-item-details">
                    {isLoadingDetails && <p className="subtitle" style={{fontSize: '0.9rem', textAlign: 'center'}}>Cargando detalles...</p>}
                    {errorDetails && <div className="message" style={{fontSize: '0.9rem', padding: '0.5rem'}}>{errorDetails}</div>}
                    
                    {/* ¬°¬°REUTILIZAMOS EL CSS DE RutinaProgreso.js!! */}
                    <div className="ejercicios-container" style={{gap: '0.75rem', marginTop: '0.5rem'}}>
                        {detallesEjercicios.map(ejercicio => (
                            <div key={ejercicio.orden + '_' + ejercicio.nombre_ejercicio} className="ejercicio-grupo" style={{gap: '0.25rem'}}>
                                <strong>{ejercicio.nombre_ejercicio}</strong>
                                <ul>
                                    {ejercicio.series.map((serie, index) => (
                                        <li key={index} className="serie-item">
                                            <span>S{serie.num_serie}:</span>
                                            {ejercicio.tipo_ejercicio === 'cardio' ? (
                                                <span>
                                                    {(serie.tiempo_min_realizado != null && serie.tiempo_min_realizado > 0) ? `${serie.tiempo_min_realizado} min` : ''}
                                                    {(serie.distancia_km_realizada != null && serie.distancia_km_realizada > 0) ? ` ${ (serie.tiempo_min_realizado != null && serie.tiempo_min_realizado > 0) ? 'üìç' : '' } ${serie.distancia_km_realizada} km` : ''}
                                                    {!(serie.tiempo_min_realizado > 0) && !(serie.distancia_km_realizada > 0) && '-'}
                                                </span>
                                            ) : (
                                                <span>
                                                    {serie.repeticiones_realizadas ?? '-'} reps
                                                    {serie.peso_kg_usado != null && ` x ${serie.peso_kg_usado} kg`}
                                                    {serie.fue_al_fallo && <span className="fallo-tag" title="Al fallo">F</span>}
                                                </span>
                                            )}
                                            {/* Aqu√≠ podr√≠amos a√±adir el icono de nota üìù si quisi√©ramos */}
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                    </div>
                </div>
            )}
        </div>
    );
};
/**
 * ---------------------------------
 * Componente Principal (FeedPage)
 * ---------------------------------
 */
function FeedPage() {
    const [feedItems, setFeedItems] = useState([]);
    const [loadingFeed, setLoadingFeed] = useState(true);
    const [error, setError] = useState(null);
    const navigate = useNavigate();
    const token = localStorage.getItem('movium_token');

    // Carga el feed INICIAL (solo res√∫menes)
    const cargarFeed = useCallback(async () => {
        setLoadingFeed(true);
        setError(null);
        try {
            // Este PHP es el de la semana pasada, el r√°pido
            const res = await fetch('http://localhost/programacion/TFG/movium/backend/api/get_amigos_feed.php', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.mensaje || "Error al cargar el feed.");
            // Guardamos los items, CADA UNO CON SU sesion_id
            setFeedItems(data);
        } catch (err) {
            setError(err.message);
        } finally {
            setLoadingFeed(false);
        }
    }, [token]);

    useEffect(() => {
        cargarFeed();
    }, [cargarFeed]);


    if (loadingFeed) {
        return (
            <div className="feed-page-container">
                <button className="btn-volver" onClick={() => navigate('/comunidad')} disabled>&larr; Volver a Comunidad</button>
                <div className="feed-header">
                    <img src={iconoFeed} alt="" width="64" height="64" />
                    <h2>Feed de Actividad</h2>
                    <p className="subtitle">Mira la actividad reciente de tus amigos.</p>
                </div>
                <p className="subtitle" style={{ textAlign: 'center', marginTop: '3rem' }}>Cargando actividad...</p>
            </div>
        );
    }

    return (
        <div className="feed-page-container">
            
            <button className="btn-volver" onClick={() => navigate('/comunidad')}>
                &larr; Volver a Comunidad
            </button>
            
            <div className="feed-header">
                <img src={iconoFeed} alt="" width="64" height="64" />
                <h2>Feed de Actividad</h2>
                <p className="subtitle">Mira la actividad reciente de tus amigos.</p>
            </div>

            {error && <div className="message" style={{ marginBottom: '1.5rem' }}>{error}</div>}

            {feedItems.length > 0 ? (
                <div className="feed-container">
                    {/* Mapeamos y renderizamos el componente FeedItem */}
                    {feedItems.map((item, index) => (
                        <FeedItem 
                            key={item.sesion_id || index} // Usar sesion_id como key
                            item={item} 
                            token={token} 
                        />
                    ))}
                </div>
            ) : (
                <p className="feed-empty">
                    A√∫n no hay actividad reciente de tus amigos. ¬°An√≠males a entrenar!
                </p>
            )}
        </div>
    );
}

export default FeedPage;

--- finalizar_entrenamiento.php ---

<?php
// ---- backend/api/finalizar_entrenamiento.php (Refactorizado) ----

// --- Configuraci√≥n de Cabeceras ---
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Authorization");
header("Content-Type: application/json; charset=UTF-8");

// --- Manejo de Solicitud OPTIONS (Preflight) ---
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    http_response_code(200);
    exit();
}

// --- Dependencias ---
require_once __DIR__ . '/../config/database.php';
require_once __DIR__ . '/../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- Constantes y Configuraci√≥n ---
define("JWT_SECRET_KEY", "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±");

// ==================================================================
// PASO 1: Validaci√≥n de Token JWT
// ==================================================================
$usuario_id = null;
try {
    $authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
    if (!$authHeader) {
        throw new Exception("No se proporcion√≥ token.", 401);
    }
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
    if (!$jwt) {
        throw new Exception("Formato de token inv√°lido.", 401);
    }
    $decoded = JWT::decode($jwt, new Key(JWT_SECRET_KEY, 'HS256'));
    $usuario_id = $decoded->data->id;
    if (!$usuario_id) {
         throw new Exception("ID de usuario no encontrado en el token.", 401);
    }
} catch (Exception $e) {
    http_response_code($e->getCode() ?: 401); // Usa el c√≥digo de la excepci√≥n si existe, sino 401
    echo json_encode(["mensaje" => "Acceso denegado: " . $e->getMessage()]);
    exit();
}

// ==================================================================
// PASO 2: Obtener y Validar Datos de Entrada
// ==================================================================
$input = json_decode(file_get_contents('php://input'));

if (
    !$input ||
    !isset($input->rutina_id) || !is_numeric($input->rutina_id) ||
    !isset($input->series) || !is_array($input->series) ||
    !isset($input->fecha_inicio) || empty($input->fecha_inicio)
) {
    http_response_code(400);
    echo json_encode(["mensaje" => "Datos de entrada incompletos o mal formados. Se esperaba 'rutina_id' (num√©rico), un array 'series' y 'fecha_inicio' (string ISO UTC)."]);
    exit();
}

$rutina_id = (int)$input->rutina_id;
$series_realizadas = $input->series;
$notas_sesion = isset($input->notas_sesion) ? htmlspecialchars(strip_tags($input->notas_sesion)) : null;

// --- Procesar Fecha de Inicio (UTC) ---
$fechaInicioSql = null;
try {
    $fechaInicioDT = new DateTime($input->fecha_inicio);
    // Asegurar expl√≠citamente la zona horaria UTC
    $fechaInicioDT->setTimezone(new DateTimeZone('UTC'));
    // Formatear para MySQL (mantendr√° el valor horario UTC)
    $fechaInicioSql = $fechaInicioDT->format('Y-m-d H:i:s');
} catch (Exception $e) {
    http_response_code(400);
    echo json_encode(["mensaje" => "Formato de fecha de inicio inv√°lido. Se esperaba formato ISO 8601 UTC (ej: 'YYYY-MM-DDTHH:MM:SSZ'). Error: " . $e->getMessage()]);
    exit();
}

// ==================================================================
// PASO 3: L√≥gica de Guardado en Base de Datos (con Transacci√≥n)
// ==================================================================
$db = null;
$sesion_id = null;
try {
    $database = new Database();
    $db = $database->getConnection();
    if (!$db) {
         throw new Exception("Error de conexi√≥n a la base de datos.", 500);
    }

    $db->beginTransaction();

    // --- 3a: Crear la Sesi√≥n ---
    $sqlSesion = "INSERT INTO sesiones_entrenamiento (usuario_id, rutina_id, fecha_inicio, fecha_fin, notas_sesion)
                  VALUES (?, ?, ?, UTC_TIMESTAMP(), ?)";
    $stmtSesion = $db->prepare($sqlSesion);
    if (!$stmtSesion->execute([$usuario_id, $rutina_id, $fechaInicioSql, $notas_sesion])) {
        throw new Exception("Error al crear la sesi√≥n: " . implode(" - ", $stmtSesion->errorInfo()), 500);
    }
    $sesion_id = $db->lastInsertId();
    $stmtSesion = null; // Liberar recurso
    if (!$sesion_id || $sesion_id == 0) { // lastInsertId puede devolver "0" o false
         throw new Exception("No se pudo obtener el ID de la nueva sesi√≥n.", 500);
    }

    // --- 3b: Insertar Series Realizadas ---
    if (!empty($series_realizadas)) {
        $sqlSerie = "INSERT INTO series_realizadas
                        (sesion_id, ejercicio_id, orden_ejercicio_rutina, num_serie,
                         repeticiones_realizadas, fue_al_fallo, peso_kg_usado,
                         tiempo_min_realizado, distancia_km_realizada, notas_serie)
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        $stmtSerie = $db->prepare($sqlSerie);

        foreach ($series_realizadas as $index => $serie) {
            // Validar datos m√≠nimos de cada serie
            if (!isset($serie->ejercicio_id) || !is_numeric($serie->ejercicio_id) || $serie->ejercicio_id <= 0 ||
                !isset($serie->num_serie) || !is_numeric($serie->num_serie) || $serie->num_serie <= 0) {
                throw new Exception("Datos inv√°lidos en la serie #".($index+1).". Falta 'ejercicio_id' o 'num_serie' v√°lidos.", 400);
            }

            // Limpiar y asignar variables
            $ej_id = (int)$serie->ejercicio_id;
            $orden = isset($serie->orden_ejercicio_rutina) ? (int)$serie->orden_ejercicio_rutina : 1; // Default a 1 si no viene
            $num_s = (int)$serie->num_serie;
            $notas_serie = isset($serie->notas_serie) ? htmlspecialchars(strip_tags($serie->notas_serie)) : null;
            $reps = isset($serie->repeticiones_realizadas) && is_numeric($serie->repeticiones_realizadas) && $serie->repeticiones_realizadas >= 0 ? (int)$serie->repeticiones_realizadas : null;
            $fallo = isset($serie->fue_al_fallo) ? (bool)$serie->fue_al_fallo : false;
            $peso = isset($serie->peso_kg_usado) && is_numeric($serie->peso_kg_usado) && $serie->peso_kg_usado >= 0 ? (float)$serie->peso_kg_usado : null;
            $tiempo = isset($serie->tiempo_min_realizado) && is_numeric($serie->tiempo_min_realizado) && $serie->tiempo_min_realizado >= 0 ? (int)$serie->tiempo_min_realizado : null;
            $dist = isset($serie->distancia_km_realizada) && is_numeric($serie->distancia_km_realizada) && $serie->distancia_km_realizada >= 0 ? (float)$serie->distancia_km_realizada : null;

            // Ejecutar inserci√≥n
            if (!$stmtSerie->execute([
                $sesion_id, $ej_id, $orden, $num_s,
                $reps, $fallo, $peso, $tiempo, $dist, $notas_serie
            ])) {
                throw new Exception("Error al guardar la serie #".($index+1).": " . implode(" - ", $stmtSerie->errorInfo()), 500);
            }
        }
        $stmtSerie = null; // Liberar recurso
    }

    // --- 3c: Confirmar Transacci√≥n ---
    $db->commit();

    // --- Respuesta Exitosa ---
    http_response_code(201); // 201 Created
    echo json_encode([
        "mensaje" => "Entrenamiento guardado con √©xito.",
        "sesion_id" => (int)$sesion_id, // Asegurar que sea n√∫mero
        "series_guardadas" => count($series_realizadas)
    ]);

} catch (Exception $e) {
    // --- Manejo de Errores ---
    if ($db && $db->inTransaction()) {
        $db->rollBack(); // Deshacer cambios si algo fall√≥
    }
    // Usar el c√≥digo HTTP de la excepci√≥n si est√° disponible, sino 500
    http_response_code(is_numeric($e->getCode()) && $e->getCode() >= 400 ? $e->getCode() : 500);
    echo json_encode(["mensaje" => "Error al guardar entrenamiento: " . $e->getMessage()]);

} finally {
    // --- Limpieza ---
    if ($db) {
        $db = null; // Cerrar la conexi√≥n impl√≠citamente
    }
}
?>

--- get_amigos_feed.php ---

<?php
// ---- backend/api/get_amigos_feed.php (MODIFICADO CON TOTALES) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else { 
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: L√≥gica del Feed (MODIFICADA) ---
$database = new Database();
$db = $database->getConnection();
$mi_id = $usuario_id;
$limite_feed = 20;

try {
    // 1. Obtener la lista de IDs de amigos (Sin cambios)
    $query_amigos = "SELECT amigo_id FROM amistades WHERE usuario_id = :mi_id";
    $stmt_amigos = $db->prepare($query_amigos);
    $stmt_amigos->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt_amigos->execute();
    
    $lista_ids_amigos = $stmt_amigos->fetchAll(PDO::FETCH_COLUMN, 0);

    if (count($lista_ids_amigos) === 0) {
        http_response_code(200);
        echo json_encode([]);
        exit();
    }

    // 2. Crear los placeholders (?) para la consulta IN (Sin cambios)
    $placeholders = str_repeat('?,', count($lista_ids_amigos) - 1) . '?';

    // 3. --- ¬°¬°LA NUEVA CONSULTA ESTRELLA!! ---
    $query_feed = "
        -- CTE 1: Obtener las 20 sesiones m√°s recientes de los amigos
        WITH SesionesAmigos AS (
            SELECT 
                s.id as sesion_id,
                s.fecha_inicio,
                s.fecha_fin,
                s.usuario_id,
                s.rutina_id,
                TIMEDIFF(s.fecha_fin, s.fecha_inicio) as duracion
            FROM 
                sesiones_entrenamiento s
            WHERE 
                s.usuario_id IN ($placeholders) -- Filtro por IDs de amigos
            ORDER BY 
                s.fecha_fin DESC
            LIMIT ? -- L√≠mite de 20
        ),
        
        -- CTE 2: Calcular los totales PARA ESAS 20 SESIONES
        TotalesSesion AS (
            SELECT
                sr.sesion_id,
                
                -- Suma de Volumen de Fuerza
                SUM(CASE WHEN e.tipo <> 'cardio' THEN COALESCE(sr.repeticiones_realizadas, 0) * COALESCE(sr.peso_kg_usado, 0) ELSE 0 END) as total_volumen_fuerza,
                
                -- Suma de Tiempo de Cardio
                SUM(CASE WHEN e.tipo = 'cardio' THEN COALESCE(sr.tiempo_min_realizado, 0) ELSE 0 END) as total_tiempo_cardio,
                
                -- Suma de Distancia de Cardio
                SUM(CASE WHEN e.tipo = 'cardio' THEN COALESCE(sr.distancia_km_realizada, 0) ELSE 0 END) as total_distancia_cardio
            FROM 
                series_realizadas sr
            JOIN 
                ejercicios e ON sr.ejercicio_id = e.id
            WHERE 
                sr.sesion_id IN (SELECT sesion_id FROM SesionesAmigos) -- Solo de las 20 sesiones
            GROUP BY 
                sr.sesion_id
        )
        
        -- Consulta Final: Unir la info de las sesiones con los totales y los nombres
        SELECT 
            sa.sesion_id,
            sa.fecha_fin,
            sa.duracion,
            u.nombre_usuario,
            r.nombre AS nombre_rutina,
            -- Ya no seleccionamos r.color_tag
            
            -- Usamos COALESCE para mostrar 0 si no hay datos de ese tipo
            COALESCE(ts.total_volumen_fuerza, 0) as total_volumen_fuerza,
            COALESCE(ts.total_tiempo_cardio, 0) as total_tiempo_cardio,
            COALESCE(ts.total_distancia_cardio, 0) as total_distancia_cardio
        FROM 
            SesionesAmigos sa
        JOIN 
            usuarios u ON sa.usuario_id = u.id
        LEFT JOIN 
            rutinas r ON sa.rutina_id = r.id
        LEFT JOIN 
            TotalesSesion ts ON sa.sesion_id = ts.sesion_id
        ORDER BY 
            sa.fecha_fin DESC;
    ";

    $stmt_feed = $db->prepare($query_feed);
    
    // 4. Bindeamos los par√°metros
    
    // Bindeamos los IDs de amigos
    $param_index = 1;
    foreach ($lista_ids_amigos as $id_amigo) {
        $stmt_feed->bindValue($param_index, $id_amigo, PDO::PARAM_INT);
        $param_index++;
    }
    
    // Bindeamos el l√≠mite (el √∫ltimo '?')
    $stmt_feed->bindValue($param_index, $limite_feed, PDO::PARAM_INT);
    
    // 5. Ejecutar y devolver
    $stmt_feed->execute();
    $feed_items = $stmt_feed->fetchAll(PDO::FETCH_ASSOC);

    http_response_code(200);
    echo json_encode($feed_items);

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener el feed de actividad.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_ejercicios_de_rutina.php ---

<?php
// ---- backend/api/get_ejercicios_de_rutina.php (REESCRITO V6.0) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: Obtener ID de rutina (Sin cambios) ---
$rutina_id = $_GET['id'] ?? null;
if (!$rutina_id) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No se especific√≥ un ID de rutina."));
    die();
}

// =================================================================
// PASO 3: L√ìGICA V6.0 (2 CONSULTAS ANIDADAS)
// =================================================================

try {
    $database = new Database();
    $db = $database->getConnection();

    // ---- CONSULTA 1: Obtener "Padres" (Sin cambios) ----
    $query_ejercicios = "SELECT 
                            re.id,
                            re.ejercicio_id,
                            re.orden,
                            ej.nombre as nombre_ejercicio,
                            ej.grupo_muscular,
                            ej.tipo
                         FROM 
                            rutina_ejercicios re
                         JOIN 
                            ejercicios ej ON re.ejercicio_id = ej.id
                         JOIN
                            rutinas ru ON re.rutina_id = ru.id
                         WHERE 
                            re.rutina_id = :rutina_id AND ru.usuario_id = :usuario_id
                         ORDER BY 
                            re.orden ASC";
    
    $stmt_ejercicios = $db->prepare($query_ejercicios);
    $stmt_ejercicios->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_ejercicios->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_ejercicios->execute();
    
    $ejercicios_en_rutina = $stmt_ejercicios->fetchAll(PDO::FETCH_ASSOC);

    if (count($ejercicios_en_rutina) > 0) {
        
        // ---- CONSULTA 2: Obtener "Hijos" (¬°¬°CAMBIOS V6.0 AQU√ç!!) ----
        
        $rutina_ejercicio_ids = array_map(function($ej) {
            return $ej['id'];
        }, $ejercicios_en_rutina);
        
        $placeholders = str_repeat('?,', count($rutina_ejercicio_ids) - 1) . '?';
        
        // ¬°Consulta actualizada a V6.0!
        $query_objetivos = "SELECT 
                                id,
                                rutina_ejercicio_id,
                                num_serie,
                                
                                /* --- CAMPOS V6.0 --- */
                                tipo_rep_objetivo,
                                reps_min_objetivo,
                                reps_max_objetivo,
                                /* ----------------- */
                                
                                peso_kg_objetivo,
                                tiempo_min_objetivo,
                                distancia_km_objetivo,
                                descanso_seg_post
                            FROM 
                                rutina_objetivos
                            WHERE 
                                rutina_ejercicio_id IN ($placeholders)
                            ORDER BY
                                num_serie ASC";
        
        $stmt_objetivos = $db->prepare($query_objetivos);
        $stmt_objetivos->execute($rutina_ejercicio_ids);
        $objetivos = $stmt_objetivos->fetchAll(PDO::FETCH_ASSOC);

        // ---- PASO 3: Combinar los datos (Sin cambios) ----
        $objetivos_map = [];
        foreach ($objetivos as $obj) {
            $objetivos_map[$obj['rutina_ejercicio_id']][] = $obj;
        }
        
        foreach ($ejercicios_en_rutina as $i => $ej) {
            $ej_id = $ej['id'];
            if (isset($objetivos_map[$ej_id])) {
                $ejercicios_en_rutina[$i]['objetivos'] = $objetivos_map[$ej_id];
            } else {
                $ejercicios_en_rutina[$i]['objetivos'] = [];
            }
        }
    }

    // 5. Devolver el resultado
    http_response_code(200);
    echo json_encode($ejercicios_en_rutina);

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos al obtener los ejercicios de la rutina.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_ejercicios_maestra.php ---

<?php
// ---- backend/api/get_ejercicios_maestra.php ----

// Cabeceras CORS
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET"); // Es un GET
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// Tu clave secreta (LA MISMA de siempre)
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";

// =================================================================
// PASO 1: L√ìGICA DE VALIDACI√ìN DE TOKEN (Exactamente igual que en tus otros scripts)
// =================================================================
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null; // No usaremos $usuario_id en la query, pero validamos que exista un token

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}

if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id; // Confirmamos que el token es v√°lido
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido."));
        die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
    die();
}

// Si llegamos aqu√≠, el usuario est√° autenticado.
// =================================================================
// PASO 2: L√ìGICA PARA OBTENER LA LISTA MAESTRA DE EJERCICIOS
// =================================================================

try {
    $database = new Database();
    $db = $database->getConnection();

    // 1. Preparar la sentencia SQL para SELECCIONAR
    // Queremos id, nombre y grupo_muscular de TODOS los ejercicios
    $query = "SELECT id, nombre, grupo_muscular, tipo
              FROM ejercicios 
              ORDER BY nombre ASC"; // Ordenados alfab√©ticamente para el <select>
    
    $stmt = $db->prepare($query);
    
    // 2. Ejecutar (No necesitamos bindParam aqu√≠, ya que no hay variables)
    $stmt->execute();
    
    $num = $stmt->rowCount();

    // 3. Comprobar si se encontraron ejercicios
    if ($num > 0) {
        
        // fetchAll() es la forma m√°s directa de obtener todos los resultados
        $ejercicios_array = $stmt->fetchAll(PDO::FETCH_ASSOC);

        // 4. Devolver el array de ejercicios como JSON
        http_response_code(200);
        echo json_encode($ejercicios_array); // Devolvemos el array completo

    } else {
        // Si la tabla 'ejercicios' est√° vac√≠a
        http_response_code(200);
        echo json_encode(array()); // Devolvemos un array vac√≠o
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos al obtener ejercicios.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_global_rankings.php ---

<?php
// ---- backend/api/get_global_rankings.php (CORREGIDO) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±"; // Clave secreta para JWT
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: IDs de Ejercicios Clave (FUERZA) y Nombre (CARDIO) ---
$ID_BANCA = 1;       // 'Press de Banca con Barra' (Asumimos ID fijo)
$ID_SENTADILLA = 20; // 'Sentadilla con Barra (Squat)' (Asumimos ID fijo)
$ID_PESO_MUERTO = 18;// 'Peso Muerto (Deadlift)' (Asumimos ID fijo)
// ¬°CAMBIO! Usamos nombre para cardio
$NOMBRE_CORRER = 'Cinta - Correr';

$mi_id = $usuario_id;
$database = new Database();
$db = $database->getConnection();

// --- PASO 3: L√≥gica de Ranking ---
try {

    // 3a. Obtener la lista de IDs (Amigos + T√∫)
    $query_amigos = "SELECT amigo_id FROM amistades WHERE usuario_id = :mi_id";
    $stmt_amigos = $db->prepare($query_amigos);
    $stmt_amigos->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt_amigos->execute();
    $lista_ids_usuarios = $stmt_amigos->fetchAll(PDO::FETCH_COLUMN, 0);
    $lista_ids_usuarios[] = $mi_id; // A√±adimos nuestro propio ID

    // 3b. Crear placeholders (?) para las consultas "IN (...)"
    // Prevenir error si no hay amigos (lista_ids_usuarios solo tendr√≠a 1 elemento)
    if (count($lista_ids_usuarios) == 0) {
        // Devuelve respuesta vac√≠a si no hay usuario (imposible por token) o amigos
        http_response_code(200);
        echo json_encode([
            "press_banca" => [], "sentadilla" => [], "peso_muerto" => [],
            "max_distancia" => [], "max_tiempo" => [], "max_velocidad_media" => []
        ]);
        exit();
    }
    $placeholders = str_repeat('?,', count($lista_ids_usuarios) - 1) . '?';

    // 3c. Preparamos el array de respuesta
    $respuesta = [
        "press_banca" => [],
        "sentadilla" => [],
        "peso_muerto" => [],
        "max_distancia" => [],
        "max_tiempo" => [],
        "max_velocidad_media" => []
    ];

    // -----------------------------------------------------------------
    // FUNCI√ìN AUXILIAR (Helper) para no repetir c√≥digo de Fuerza (MODIFICADA)
    // -----------------------------------------------------------------
    function getRankingFuerza($db, $ejercicio_id, $lista_ids, $placeholders) {
        // Busca el MAX(peso_kg_usado) para un ejercicio dado
        // ¬°CAMBIO! A√±adimos u.id y lo incluimos en GROUP BY
        $sql = "SELECT
                    u.id as usuario_id, -- <<< A√ëADIDO
                    u.nombre_usuario,
                    MAX(sr.peso_kg_usado) as valor
                FROM series_realizadas sr
                JOIN sesiones_entrenamiento s ON sr.sesion_id = s.id
                JOIN usuarios u ON s.usuario_id = u.id
                WHERE
                    sr.ejercicio_id = ?
                    AND s.usuario_id IN ($placeholders)
                    AND sr.peso_kg_usado > 0
                GROUP BY s.usuario_id, u.id, u.nombre_usuario -- <<< u.id A√ëADIDO
                ORDER BY valor DESC
                LIMIT 3";

        $stmt = $db->prepare($sql);
        $params = array_merge([$ejercicio_id], $lista_ids);
        $stmt->execute($params);
        $ranking = $stmt->fetchAll(PDO::FETCH_ASSOC);

        // A√±adimos el 'label' (kg) al resultado
        foreach ($ranking as &$item) {
            $item['label'] = 'kg';
            // Asegurarse de que el valor es num√©rico para JSON
            $item['valor'] = is_numeric($item['valor']) ? (float)$item['valor'] : $item['valor'];
        }
        return $ranking;
    }
    // -----------------------------------------------------------------

    // 3d. Consultas de Fuerza (Usan la funci√≥n auxiliar modificada)
    $respuesta["press_banca"] = getRankingFuerza($db, $ID_BANCA, $lista_ids_usuarios, $placeholders);
    $respuesta["sentadilla"] = getRankingFuerza($db, $ID_SENTADILLA, $lista_ids_usuarios, $placeholders);
    $respuesta["peso_muerto"] = getRankingFuerza($db, $ID_PESO_MUERTO, $lista_ids_usuarios, $placeholders);

    // 3e. Consultas de Cardio (MODIFICADAS)

    // ¬°CAMBIO! Los par√°metros ahora usan el nombre del ejercicio
    $params_correr = array_merge([$NOMBRE_CORRER], $lista_ids_usuarios);

    // Max Distancia (MODIFICADA: usa nombre, a√±ade u.id)
    $sql_dist = "SELECT
                    u.id as usuario_id, -- <<< A√ëADIDO
                    u.nombre_usuario,
                    MAX(sr.distancia_km_realizada) as valor
                 FROM series_realizadas sr
                 JOIN sesiones_entrenamiento s ON sr.sesion_id = s.id
                 JOIN usuarios u ON s.usuario_id = u.id
                 JOIN ejercicios e ON sr.ejercicio_id = e.id -- <<< JOIN A√ëADIDO
                 WHERE e.nombre = ? -- <<< CAMBIO A NOMBRE
                   AND s.usuario_id IN ($placeholders)
                   AND sr.distancia_km_realizada > 0
                 GROUP BY s.usuario_id, u.id, u.nombre_usuario -- <<< u.id A√ëADIDO
                 ORDER BY valor DESC LIMIT 3";
    $stmt_dist = $db->prepare($sql_dist);
    $stmt_dist->execute($params_correr); // Usamos los nuevos params
    $ranking_dist = $stmt_dist->fetchAll(PDO::FETCH_ASSOC);
    foreach ($ranking_dist as &$item) {
        $item['label'] = 'km';
        $item['valor'] = is_numeric($item['valor']) ? (float)$item['valor'] : $item['valor'];
    }
    $respuesta["max_distancia"] = $ranking_dist;

    // Max Tiempo (MODIFICADA: usa nombre, a√±ade u.id)
    $sql_tiempo = "SELECT
                       u.id as usuario_id, -- <<< A√ëADIDO
                       u.nombre_usuario,
                       MAX(sr.tiempo_min_realizado) as valor
                   FROM series_realizadas sr
                   JOIN sesiones_entrenamiento s ON sr.sesion_id = s.id
                   JOIN usuarios u ON s.usuario_id = u.id
                   JOIN ejercicios e ON sr.ejercicio_id = e.id -- <<< JOIN A√ëADIDO
                   WHERE e.nombre = ? -- <<< CAMBIO A NOMBRE
                     AND s.usuario_id IN ($placeholders)
                     AND sr.tiempo_min_realizado > 0
                   GROUP BY s.usuario_id, u.id, u.nombre_usuario -- <<< u.id A√ëADIDO
                   ORDER BY valor DESC LIMIT 3";
    $stmt_tiempo = $db->prepare($sql_tiempo);
    $stmt_tiempo->execute($params_correr); // Reutilizamos los params
    $ranking_tiempo = $stmt_tiempo->fetchAll(PDO::FETCH_ASSOC);
    foreach ($ranking_tiempo as &$item) {
        $item['label'] = 'min';
        $item['valor'] = is_numeric($item['valor']) ? (float)$item['valor'] : $item['valor'];
    }
    $respuesta["max_tiempo"] = $ranking_tiempo;

    // 3f. Consulta de Velocidad Media (MODIFICADA: usa nombre, a√±ade u.id)

    // ¬°CAMBIO! Los par√°metros se invierten y usan nombre
    $params_velocidad = array_merge($lista_ids_usuarios, [$NOMBRE_CORRER]);

    $sql_velocidad = "
        WITH SesionesCardio AS (
            SELECT
                s.usuario_id,
                s.id as sesion_id,
                (
                    SUM(sr.distancia_km_realizada) /
                    NULLIF(SUM(sr.tiempo_min_realizado) / 60, 0)
                ) as velocidad_media_sesion
            FROM
                sesiones_entrenamiento s
            JOIN
                series_realizadas sr ON s.id = sr.sesion_id
            JOIN
                ejercicios e ON sr.ejercicio_id = e.id -- <<< JOIN A√ëADIDO
            WHERE
                s.usuario_id IN ($placeholders)
                AND e.nombre = ? -- <<< CAMBIO A NOMBRE
                AND sr.tiempo_min_realizado > 0
                AND sr.distancia_km_realizada > 0
            GROUP BY
                s.usuario_id, s.id
        )
        SELECT
            u.id as usuario_id, -- <<< A√ëADIDO
            u.nombre_usuario,
            MAX(sc.velocidad_media_sesion) as valor
        FROM
            SesionesCardio sc
        JOIN
            usuarios u ON sc.usuario_id = u.id
        WHERE
            sc.velocidad_media_sesion IS NOT NULL
        GROUP BY
            sc.usuario_id, u.id, u.nombre_usuario -- <<< u.id A√ëADIDO
        ORDER BY
            valor DESC
        LIMIT 3";

    $stmt_velocidad = $db->prepare($sql_velocidad);
    $stmt_velocidad->execute($params_velocidad); // Usamos los nuevos params
    $ranking_velocidad = $stmt_velocidad->fetchAll(PDO::FETCH_ASSOC);
    foreach ($ranking_velocidad as &$item) {
        $item['valor'] = round((float)$item['valor'], 1); // Redondeamos a 1 decimal y aseguramos float
        $item['label'] = 'km/h';
    }
    $respuesta["max_velocidad_media"] = $ranking_velocidad;


    // --- PASO 4: Devolver la respuesta ---
    http_response_code(200);
    echo json_encode($respuesta);


} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener los rankings globales.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_historial_fechas.php ---

<?php
// ---- backend/api/get_historial_fechas.php (REFACTORIZADO PARA PUNTOS M√öLTIPLES) ----

// Cabeceras CORS
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

// Dependencias
require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}

if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); 
        die();
    }
} else { 
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); 
    die();
}

// --- PASO 2: L√≥gica de Consulta (¬°NUEVA L√ìGICA!) ---
$database = new Database();
$db = $database->getConnection();

// Color por defecto para rutinas con color NULL
$default_color_null = "#AAAAAA"; // Gris

try {
    // Esta consulta agrupa por d√≠a y CONCATENA todos los colores de ese d√≠a
    $query = "SELECT 
                DATE(s.fecha_inicio) as fecha,
                GROUP_CONCAT(r.color_tag) as colores_str
              FROM 
                sesiones_entrenamiento s
              LEFT JOIN 
                rutinas r ON s.rutina_id = r.id
              WHERE 
                s.usuario_id = :usuario_id
              GROUP BY 
                DATE(s.fecha_inicio)
              ORDER BY 
                fecha ASC";
    
    $stmt = $db->prepare($query);
    $stmt->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt->execute();

    $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

    // --- PASO 3: Procesar resultados y crear el "mapa" de arrays de colores ---
    $fechas_con_colores_map = [];

    foreach ($rows as $row) {
        $fecha = $row['fecha'];
        $colores_str = $row['colores_str']; // Ej: "#FF0000,NULL,#0000FF" o NULL

        if ($colores_str === null) {
            $fechas_con_colores_map[$fecha] = [$default_color_null];
            continue;
        }

        $colores_array = explode(',', $colores_str);
        
        $colores_limpios = array_map(function($color) use ($default_color_null) {
            if ($color === 'NULL' || $color === null || $color === '') {
                return $default_color_null;
            }
            return $color;
        }, $colores_array);

        $fechas_con_colores_map[$fecha] = $colores_limpios;
    }

    http_response_code(200);
    echo json_encode($fechas_con_colores_map); 

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener el historial de fechas.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_historial_por_fecha.php ---

<?php
// ---- backend/api/get_historial_por_fecha.php (NUEVO ARCHIVO) ----

// Cabeceras CORS
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

// Dependencias
require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}

if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); 
        die();
    }
} else { 
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); 
    die();
}

// --- PASO 2: Obtener Fecha ---
$fecha_seleccionada = $_GET['fecha'] ?? null;

if (!$fecha_seleccionada) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No se especific√≥ una fecha v√°lida.")); // <-- Este es tu error
    die();
}

// --- PASO 3: L√≥gica de Consulta ---
$database = new Database();
$db = $database->getConnection();

try {
    // 1. Obtenemos todas las series de todas las sesiones de ESE D√çA
    $query_historial = "SELECT
                            s.id as sesion_id,
                            s.fecha_inicio,
                            s.fecha_fin,
                            TIMEDIFF(s.fecha_fin, s.fecha_inicio) as duracion,
                            s.notas_sesion,
                            
                            r.nombre as nombre_rutina,
                            r.color_tag, 

                            e.nombre as nombre_ejercicio,
                            e.tipo as tipo_ejercicio,
                            sr.num_serie,
                            sr.repeticiones_realizadas,
                            sr.fue_al_fallo,
                            sr.peso_kg_usado,
                            sr.tiempo_min_realizado,
                            sr.distancia_km_realizada,
                            sr.notas_serie,
                            sr.orden_ejercicio_rutina
                         FROM
                            sesiones_entrenamiento s
                         JOIN
                            series_realizadas sr ON s.id = sr.sesion_id
                         JOIN
                            ejercicios e ON sr.ejercicio_id = e.id
                         LEFT JOIN
                            rutinas r ON s.rutina_id = r.id
                         WHERE
                            s.usuario_id = :usuario_id
                            AND DATE(s.fecha_inicio) = :fecha_seleccionada
                         ORDER BY
                            s.fecha_inicio ASC, 
                            sr.orden_ejercicio_rutina ASC, 
                            sr.num_serie ASC";
    
    $stmt_historial = $db->prepare($query_historial);
    $stmt_historial->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_historial->bindParam(":fecha_seleccionada", $fecha_seleccionada, PDO::PARAM_STR);
    $stmt_historial->execute();

    $series_flat_list = $stmt_historial->fetchAll(PDO::FETCH_ASSOC);

    // 2. Agrupar en PHP
    $historial_agrupado = [];
    foreach ($series_flat_list as $serie) {
        $sesion_id = $serie['sesion_id'];
        $ejercicio_nombre = $serie['nombre_ejercicio'];
        $tipo_ejercicio = $serie['tipo_ejercicio'];

        if (!isset($historial_agrupado[$sesion_id])) {
            $historial_agrupado[$sesion_id] = [
                "sesion_id" => $sesion_id,
                "fecha_inicio" => $serie['fecha_inicio'],
                "nombre_rutina" => $serie['nombre_rutina'] ?? 'Rutina Eliminada',
                "color_tag" => $serie['color_tag'],
                "notas_sesion" => $serie['notas_sesion'],
                "duracion" => $serie['duracion'],
                "total_volumen_fuerza" => 0,
                "total_reps_fuerza" => 0,
                "total_tiempo_cardio" => 0,
                "total_distancia_cardio" => 0,
                "ejercicios" => []
            ];
        }

        if ($tipo_ejercicio <> 'cardio') {
            $historial_agrupado[$sesion_id]["total_volumen_fuerza"] += (floatval($serie['repeticiones_realizadas'] ?? 0) * floatval($serie['peso_kg_usado'] ?? 0));
            $historial_agrupado[$sesion_id]["total_reps_fuerza"] += intval($serie['repeticiones_realizadas'] ?? 0);
        } else {
            $historial_agrupado[$sesion_id]["total_tiempo_cardio"] += intval($serie['tiempo_min_realizado'] ?? 0);
            $historial_agrupado[$sesion_id]["total_distancia_cardio"] += floatval($serie['distancia_km_realizada'] ?? 0);
        }

        $ejercicio_key = ($serie['orden_ejercicio_rutina'] ?? '0') . '_' . $ejercicio_nombre;
        if (!isset($historial_agrupado[$sesion_id]["ejercicios"][$ejercicio_key])) {
             $historial_agrupado[$sesion_id]["ejercicios"][$ejercicio_key] = [
                "nombre_ejercicio" => $ejercicio_nombre,
                "tipo_ejercicio" => $tipo_ejercicio,
                "orden" => $serie['orden_ejercicio_rutina'],
                "series" => []
             ];
        }

        $historial_agrupado[$sesion_id]["ejercicios"][$ejercicio_key]["series"][] = [
            "num_serie" => $serie['num_serie'],
            "repeticiones_realizadas" => $serie['repeticiones_realizadas'],
            "fue_al_fallo" => (bool)$serie['fue_al_fallo'],
            "peso_kg_usado" => $serie['peso_kg_usado'],
            "tiempo_min_realizado" => $serie['tiempo_min_realizado'],
            "distancia_km_realizada" => $serie['distancia_km_realizada'],
            "notas_serie" => $serie['notas_serie']
        ];
    }

    foreach ($historial_agrupado as $sesion_id => $sesion_data) {
        $ejercicios_array = array_values($sesion_data["ejercicios"]);
        usort($ejercicios_array, function($a, $b) {
            return ($a['orden'] ?? 0) <=> ($b['orden'] ?? 0);
        });
        $historial_agrupado[$sesion_id]["ejercicios"] = $ejercicios_array;
    }

    http_response_code(200);
    echo json_encode(array_values($historial_agrupado)); 

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener el historial de la fecha.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_mis_amigos.php ---

<?php
// ---- backend/api/get_mis_amigos.php ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else { 
    http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: L√≥gica de Consulta ---
$database = new Database();
$db = $database->getConnection();

try {
    // Buscamos en 'amistades' las filas donde 'usuario_id' es el m√≠o
    // y hacemos JOIN con 'usuarios' para obtener los datos de 'amigo_id'
    $query = "SELECT 
                u.id, 
                u.nombre_usuario, 
                a.fecha_amistad,
                a.solicitante_id
              FROM 
                usuarios u
              JOIN 
                amistades a ON u.id = a.amigo_id
              WHERE 
                a.usuario_id = :mi_id
              ORDER BY 
                u.nombre_usuario ASC";
    
    $stmt = $db->prepare($query);
    $stmt->bindParam(":mi_id", $usuario_id, PDO::PARAM_INT);
    $stmt->execute();

    $amigos = $stmt->fetchAll(PDO::FETCH_ASSOC);

    http_response_code(200);
    echo json_encode($amigos); // Devuelve el array (estar√° vac√≠o si no tiene amigos)

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener la lista de amigos.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_mis_todos_prs.php ---

<?php
// ---- backend/api/get_mis_todos_prs.php (MODIFICADO para Max Velocidad) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar - sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±"; // Clave secreta para JWT
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else {
    http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: L√≥gica de Consulta (MODIFICADA) ---
$database = new Database();
$db = $database->getConnection();

try {
    // ¬°NUEVA CONSULTA CON C√ÅLCULO DE VELOCIDAD MEDIA M√ÅXIMA POR EJERCICIO!
    $query_data = "
        WITH MaxRawValues AS (
            -- Subconsulta para obtener m√°ximos de peso, reps, tiempo, distancia por serie
            SELECT
                sr.ejercicio_id,
                MAX(sr.peso_kg_usado) as max_peso,
                MAX(sr.repeticiones_realizadas) as max_reps,
                MAX(sr.tiempo_min_realizado) as max_tiempo,
                MAX(sr.distancia_km_realizada) as max_dist
            FROM
                series_realizadas sr
            JOIN
                sesiones_entrenamiento s ON sr.sesion_id = s.id
            WHERE
                s.usuario_id = :usuario_id_raw -- Usamos un alias diferente aqu√≠
            GROUP BY
                sr.ejercicio_id
        ),
        SessionSpeeds AS (
             -- Subconsulta para calcular velocidad media de CADA sesi√≥n para CADA ejercicio
            SELECT
                sr.ejercicio_id,
                s.id as sesion_id,
                ( SUM(sr.distancia_km_realizada) / NULLIF(SUM(sr.tiempo_min_realizado) / 60, 0) ) as velocidad_media_sesion
            FROM series_realizadas sr
            JOIN sesiones_entrenamiento s ON sr.sesion_id = s.id
            WHERE s.usuario_id = :usuario_id_speed -- Y otro alias aqu√≠
              AND sr.tiempo_min_realizado > 0
              AND sr.distancia_km_realizada > 0
            GROUP BY sr.ejercicio_id, s.id -- Agrupamos por ejercicio Y sesi√≥n
        ),
        MaxAvgSpeedPerExercise AS (
            -- Subconsulta para encontrar la M√ÅXIMA velocidad media por ejercicio
            SELECT
                ejercicio_id,
                MAX(velocidad_media_sesion) as max_velocidad_media
            FROM SessionSpeeds
            WHERE velocidad_media_sesion IS NOT NULL
            GROUP BY ejercicio_id
        )
        -- Consulta final que une todo
        SELECT
            e.id as ejercicio_id,
            e.nombre,
            e.tipo,
            e.grupo_muscular,
            raw.max_peso,
            raw.max_reps,
            raw.max_tiempo,
            raw.max_dist,
            -- A√±adimos la velocidad media m√°xima redondeada
            ROUND(max_speed.max_velocidad_media, 1) as max_velocidad_media
        FROM
            ejercicios e
        -- Unimos con los valores m√°ximos directos (peso, reps, etc.)
        LEFT JOIN MaxRawValues raw ON e.id = raw.ejercicio_id
        -- Unimos con la velocidad media m√°xima calculada
        LEFT JOIN MaxAvgSpeedPerExercise max_speed ON e.id = max_speed.ejercicio_id
        -- Filtramos para mostrar solo ejercicios donde el usuario tenga alg√∫n r√©cord registrado
        WHERE
            e.id IN (SELECT DISTINCT ejercicio_id FROM series_realizadas sr JOIN sesiones_entrenamiento s ON sr.sesion_id = s.id WHERE s.usuario_id = :usuario_id_filter)
            AND (raw.max_peso > 0 OR raw.max_reps > 0 OR raw.max_tiempo > 0 OR raw.max_dist > 0 OR max_speed.max_velocidad_media > 0)
        ORDER BY
            e.nombre ASC;
    ";

    $stmt_data = $db->prepare($query_data);
    // Bindeamos el ID del usuario a todos los placeholders necesarios
    $stmt_data->bindParam(":usuario_id_raw", $usuario_id, PDO::PARAM_INT);
    $stmt_data->bindParam(":usuario_id_speed", $usuario_id, PDO::PARAM_INT);
    $stmt_data->bindParam(":usuario_id_filter", $usuario_id, PDO::PARAM_INT);
    $stmt_data->execute();

    $prs = $stmt_data->fetchAll(PDO::FETCH_ASSOC);

    // Convertimos NULL a 0 para consistencia en el frontend si es necesario, aunque quiz√°s sea mejor manejar NULL
     foreach ($prs as &$pr) {
         $pr['max_peso'] = $pr['max_peso'] ?? null;
         $pr['max_reps'] = $pr['max_reps'] ?? null;
         $pr['max_tiempo'] = $pr['max_tiempo'] ?? null;
         $pr['max_dist'] = $pr['max_dist'] ?? null;
         $pr['max_velocidad_media'] = $pr['max_velocidad_media'] ?? null; // Mantenemos null si no hay dato
     }


    http_response_code(200);
    echo json_encode($prs); // Devuelve el array de PRs con la nueva m√©trica

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener tus PRs.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_perfil.php ---

<?php
// ---- backend/api/get_perfil.php ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";

// --- PASO 1: Validaci√≥n de Token (Id√©ntica) ---
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null; 

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido."));
        die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
    die();
}

// --- PASO 2: L√≥gica para obtener el perfil ---
try {
    $database = new Database();
    $db = $database->getConnection();

    $query = "SELECT 
                  u.nombre_usuario, 
                  u.correo_electronico,
                  p.nombre_real,
                  p.apellidos,
                  p.fecha_nacimiento,
                  p.altura_cm,
                  p.peso_kg, -- <-- ¬°CAMBIO AQU√ç!
                  p.telefono,
                  p.direccion
                FROM 
                  usuarios u
                LEFT JOIN 
                  perfiles p ON u.id = p.usuario_id
                WHERE 
                  u.id = :usuario_id
                LIMIT 1";
    
    $stmt = $db->prepare($query);
    $stmt->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt->execute();
    
    $perfil = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($perfil) {
        http_response_code(200);
        echo json_encode($perfil);
    } else {
        http_response_code(404);
        echo json_encode(array("mensaje" => "Usuario no encontrado."));
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_progreso_rutina.php ---

<?php
// ---- backend/api/get_progreso_rutina.php (VERSI√ìN 3.2 CON DURACI√ìN Y PAGINACI√ìN) ----

// Cabeceras CORS (sin cambios)
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";

// =================================================================
// PASO 1: VALIDACI√ìN TOKEN (Sin cambios)
// =================================================================
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}

if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denigado. Token inv√°lido."));
        die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
    die();
}

// =================================================================
// PASO 2: OBTENER ID RUTINA Y PAR√ÅMETROS DE PAGINACI√ìN (Sin cambios)
// =================================================================
$rutina_id = $_GET['id'] ?? null;
if (!$rutina_id || !is_numeric($rutina_id)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No se especific√≥ un ID de rutina v√°lido."));
    die();
}

$page = (int)($_GET['page'] ?? 1);
if ($page < 1) { $page = 1; }
$limit = 10; // ¬°Debe coincidir con ITEMS_PER_PAGE en RutinaProgreso.js!
$offset = ($page - 1) * $limit;

// =================================================================
// PASO 3: L√ìGICA DE DOBLE CONSULTA (GR√ÅFICA + HISTORIAL)
// =================================================================

$respuesta = [
    "rutina_info" => null,
    "grafica" => [],
    "historial" => [],
    "total_sesiones" => 0
];
$limite_grafica = 30; // Para la gr√°fica (sin cambios)

try {
    $database = new Database();
    $db = $database->getConnection();

    // --- Info de la Rutina (Sin cambios) ---
    $query_info = "SELECT nombre FROM rutinas WHERE id = :rutina_id AND usuario_id = :usuario_id LIMIT 1";
    $stmt_info = $db->prepare($query_info);
    $stmt_info->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_info->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_info->execute();
    $info = $stmt_info->fetch(PDO::FETCH_ASSOC);
    if (!$info) {
        http_response_code(404);
        echo json_encode(array("mensaje" => "Rutina no encontrada o no te pertenece."));
        die();
    }
    $respuesta["rutina_info"] = $info;

    // --- CONSULTA DE CONTEO TOTAL DE SESIONES (Sin cambios) ---
    $query_count = "SELECT COUNT(id) as total_sesiones
                    FROM sesiones_entrenamiento
                    WHERE usuario_id = :usuario_id AND rutina_id = :rutina_id";
    $stmt_count = $db->prepare($query_count);
    $stmt_count->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_count->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_count->execute();
    $total_row = $stmt_count->fetch(PDO::FETCH_ASSOC);
    $respuesta["total_sesiones"] = (int)($total_row['total_sesiones'] ?? 0);

    // --- CONSULTA 1: DATOS PARA LA GR√ÅFICA (Sin cambios) ---
    // Solo se carga si page=1
    if ($page === 1 && $respuesta["total_sesiones"] > 0) { // A√±adida condici√≥n para evitar consulta si no hay sesiones
        $query_grafica = "
            WITH SesionesNumeradas AS (
                SELECT
                    s.id as sesion_id,
                    DATE(s.fecha_inicio) as fecha,
                    ROW_NUMBER() OVER (ORDER BY s.fecha_inicio ASC) as sesion_num
                FROM sesiones_entrenamiento s
                WHERE s.usuario_id = :usuario_id AND s.rutina_id = :rutina_id_sn
            ),
            DatosAgrupados AS (
                 SELECT
                    sn.sesion_num,
                    sn.fecha,
                    SUM(CASE WHEN e.tipo <> 'cardio' THEN COALESCE(sr.repeticiones_realizadas, 0) * COALESCE(sr.peso_kg_usado, 0) ELSE 0 END) as volumen_fuerza,
                    SUM(CASE WHEN e.tipo <> 'cardio' THEN COALESCE(sr.repeticiones_realizadas, 0) ELSE 0 END) as reps_totales_fuerza,
                    SUM(CASE WHEN e.tipo = 'cardio' THEN COALESCE(sr.tiempo_min_realizado, 0) ELSE 0 END) as tiempo_cardio,
                    SUM(CASE WHEN e.tipo = 'cardio' THEN COALESCE(sr.distancia_km_realizada, 0) ELSE 0 END) as distancia_cardio,
                    ( SUM(CASE WHEN e.tipo = 'cardio' THEN COALESCE(sr.distancia_km_realizada, 0) ELSE 0 END) / NULLIF(SUM(CASE WHEN e.tipo = 'cardio' THEN COALESCE(sr.tiempo_min_realizado, 0) ELSE 0 END) / 60, 0) ) as velocidad_media_kmh
                 FROM SesionesNumeradas sn
                 JOIN series_realizadas sr ON sn.sesion_id = sr.sesion_id
                 JOIN ejercicios e ON sr.ejercicio_id = e.id
                 GROUP BY sn.sesion_num, sn.fecha
            )
            SELECT * FROM DatosAgrupados
            WHERE sesion_num > (SELECT COALESCE(MAX(sesion_num), 0) FROM DatosAgrupados) - :limite_grafica
            ORDER BY sesion_num ASC";
        $stmt_grafica = $db->prepare($query_grafica);
        $stmt_grafica->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
        $stmt_grafica->bindParam(":rutina_id_sn", $rutina_id, PDO::PARAM_INT);
        $stmt_grafica->bindParam(":limite_grafica", $limite_grafica, PDO::PARAM_INT);
        $stmt_grafica->execute();
        if ($stmt_grafica->rowCount() > 0) {
            $respuesta["grafica"] = $stmt_grafica->fetchAll(PDO::FETCH_ASSOC);
        }
    }

    // --- MODIFICADO: CONSULTA 2: DATOS PARA EL HISTORIAL (PAGINADO Y CON DURACI√ìN) ---

    // 2a. Obtener los IDs de las sesiones para la p√°gina actual (sin cambios)
    $query_sesion_ids = "SELECT id
                         FROM sesiones_entrenamiento
                         WHERE usuario_id = :usuario_id AND rutina_id = :rutina_id
                         ORDER BY fecha_inicio DESC
                         LIMIT :limit OFFSET :offset";
    $stmt_sesion_ids = $db->prepare($query_sesion_ids);
    $stmt_sesion_ids->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_sesion_ids->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_sesion_ids->bindParam(":limit", $limit, PDO::PARAM_INT);
    $stmt_sesion_ids->bindParam(":offset", $offset, PDO::PARAM_INT);
    $stmt_sesion_ids->execute();
    $sesion_ids = $stmt_sesion_ids->fetchAll(PDO::FETCH_COLUMN, 0);

    $series_flat_list = [];

    // 2b. Si encontramos IDs, buscamos las series y datos de sesi√≥n para ESAS sesiones
    if (count($sesion_ids) > 0) {
        $placeholders = str_repeat('?,', count($sesion_ids) - 1) . '?';

        // **** CONSULTA MODIFICADA: A√±adimos TIMEDIFF y seleccionamos fecha_fin ****
        $query_historial = "SELECT
                                s.id as sesion_id,
                                s.fecha_inicio,
                                s.fecha_fin, -- <-- A√±adido fecha_fin
                                TIMEDIFF(s.fecha_fin, s.fecha_inicio) as duracion, -- <-- Calculamos duraci√≥n
                                s.notas_sesion,
                                e.nombre as nombre_ejercicio,
                                e.tipo as tipo_ejercicio,
                                sr.num_serie,
                                sr.repeticiones_realizadas,
                                sr.fue_al_fallo,
                                sr.peso_kg_usado,
                                sr.tiempo_min_realizado,
                                sr.distancia_km_realizada,
                                sr.notas_serie,
                                sr.orden_ejercicio_rutina
                             FROM
                                sesiones_entrenamiento s
                            JOIN
                                series_realizadas sr ON s.id = sr.sesion_id
                            JOIN
                                ejercicios e ON sr.ejercicio_id = e.id
                            WHERE
                                s.id IN ($placeholders) -- Usamos los IDs paginados
                            ORDER BY
                                s.fecha_inicio DESC, sr.orden_ejercicio_rutina ASC, sr.num_serie ASC";

        $stmt_historial = $db->prepare($query_historial);
        $stmt_historial->execute($sesion_ids);
        $series_flat_list = $stmt_historial->fetchAll(PDO::FETCH_ASSOC);
    }
    // **** FIN MODIFICACI√ìN CONSULTA ****

    // --- AGRUPACI√ìN EN PHP (MODIFICADO para a√±adir duraci√≥n) ---
    $historial_agrupado = [];
    foreach ($series_flat_list as $serie) {
        $sesion_id = $serie['sesion_id'];
        $ejercicio_nombre = $serie['nombre_ejercicio'];
        $tipo_ejercicio = $serie['tipo_ejercicio'];

        // Si es la primera vez que vemos esta sesi√≥n, inicializamos sus datos
        if (!isset($historial_agrupado[$sesion_id])) {
            // **** A√ëADIMOS 'duracion' al inicializar ****
            $historial_agrupado[$sesion_id] = [
                "sesion_id" => $sesion_id,
                "fecha_inicio" => $serie['fecha_inicio'],
                "notas_sesion" => $serie['notas_sesion'],
                "duracion" => $serie['duracion'], // <-- Guardamos la duraci√≥n calculada por SQL
                "total_volumen_fuerza" => 0,
                "total_reps_fuerza" => 0,
                "total_tiempo_cardio" => 0,
                "total_distancia_cardio" => 0,
                "ejercicios" => []
            ];
            // **** FIN MODIFICACI√ìN INICIALIZACI√ìN ****
        }

        // --- C√°lculo de totales (Sin cambios) ---
        if ($tipo_ejercicio <> 'cardio') {
            $historial_agrupado[$sesion_id]["total_volumen_fuerza"] += (floatval($serie['repeticiones_realizadas'] ?? 0) * floatval($serie['peso_kg_usado'] ?? 0));
            $historial_agrupado[$sesion_id]["total_reps_fuerza"] += intval($serie['repeticiones_realizadas'] ?? 0);
        } else {
            $historial_agrupado[$sesion_id]["total_tiempo_cardio"] += intval($serie['tiempo_min_realizado'] ?? 0);
            $historial_agrupado[$sesion_id]["total_distancia_cardio"] += floatval($serie['distancia_km_realizada'] ?? 0);
        }

        // --- Agrupaci√≥n por ejercicio (Sin cambios) ---
        $ejercicio_key = ($serie['orden_ejercicio_rutina'] ?? '0') . '_' . $ejercicio_nombre;
        if (!isset($historial_agrupado[$sesion_id]["ejercicios"][$ejercicio_key])) {
             $historial_agrupado[$sesion_id]["ejercicios"][$ejercicio_key] = [
                "nombre_ejercicio" => $ejercicio_nombre,
                "tipo_ejercicio" => $tipo_ejercicio,
                "orden" => $serie['orden_ejercicio_rutina'],
                "series" => []
             ];
        }

        // --- A√±adir serie al ejercicio (Sin cambios) ---
        $historial_agrupado[$sesion_id]["ejercicios"][$ejercicio_key]["series"][] = [
            "num_serie" => $serie['num_serie'],
            "repeticiones_realizadas" => $serie['repeticiones_realizadas'],
            "fue_al_fallo" => (bool)$serie['fue_al_fallo'],
            "peso_kg_usado" => $serie['peso_kg_usado'],
            "tiempo_min_realizado" => $serie['tiempo_min_realizado'],
            "distancia_km_realizada" => $serie['distancia_km_realizada'],
            "notas_serie" => $serie['notas_serie']
        ];
    }

    // --- Ordenar ejercicios dentro de la sesi√≥n (Sin cambios) ---
    foreach ($historial_agrupado as $sesion_id => $sesion_data) {
        $ejercicios_array = array_values($sesion_data["ejercicios"]);
        usort($ejercicios_array, function($a, $b) {
            return ($a['orden'] ?? 0) <=> ($b['orden'] ?? 0);
        });
        $historial_agrupado[$sesion_id]["ejercicios"] = $ejercicios_array;
    }

    // --- PASO 4: DEVOLVER LA RESPUESTA COMPLETA (Sin cambios en esta parte) ---
    $respuesta["historial"] = array_values($historial_agrupado);

    http_response_code(200);
    echo json_encode($respuesta);

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos al obtener el progreso de la rutina.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_ranking_detalle.php ---

<?php
// ---- backend/api/get_ranking_detalle.php (CORREGIDO) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else {
    http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: Obtener ID del Ejercicio ---
$ejercicio_id = $_GET['id'] ?? null;
if (!$ejercicio_id || !is_numeric($ejercicio_id)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No se especific√≥ un ID de ejercicio v√°lido."));
    die();
}

$mi_id = $usuario_id;
$database = new Database();
$db = $database->getConnection();

// --- PASO 3: L√≥gica de Ranking Detallado ---
try {

    // 3a. Obtener tipo de ejercicio
    $query_tipo = "SELECT tipo FROM ejercicios WHERE id = :ejercicio_id LIMIT 1";
    $stmt_tipo = $db->prepare($query_tipo);
    $stmt_tipo->bindParam(":ejercicio_id", $ejercicio_id, PDO::PARAM_INT);
    $stmt_tipo->execute();
    $ejercicio_info = $stmt_tipo->fetch(PDO::FETCH_ASSOC);

    if (!$ejercicio_info) {
        http_response_code(404);
        echo json_encode(array("mensaje" => "Ejercicio no encontrado."));
        die();
    }
    $tipo_ejercicio = $ejercicio_info['tipo'];

    // 3b. Obtener lista de IDs (Amigos + T√∫)
    $query_amigos = "SELECT amigo_id FROM amistades WHERE usuario_id = :mi_id";
    $stmt_amigos = $db->prepare($query_amigos);
    $stmt_amigos->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt_amigos->execute();
    $lista_ids_usuarios = $stmt_amigos->fetchAll(PDO::FETCH_COLUMN, 0);
    $lista_ids_usuarios[] = $mi_id;

    // 3c. Crear placeholders (?)
    if (count($lista_ids_usuarios) == 0) {
        // Devuelve respuesta vac√≠a
        http_response_code(200);
        echo json_encode([ "max_peso" => [], "max_reps" => [], "max_dist" => [], "max_tiempo" => [] ]);
        exit();
    }
    $placeholders = str_repeat('?,', count($lista_ids_usuarios) - 1) . '?';

    // 3d. Preparamos el array de respuesta
    $respuesta = [
        "max_peso" => [],
        "max_reps" => [], // Se convertir√° en e1RM si es fuerza
        "max_dist" => [],
        "max_tiempo" => []
    ];

    // 3e. Par√°metros base para las consultas
    $base_params = array_merge([$ejercicio_id], $lista_ids_usuarios);

    // -----------------------------------------------------------------
    // FUNCI√ìN AUXILIAR GENERALIZADA (MODIFICADA con filtro para e1RM)
    // -----------------------------------------------------------------
    function getRankingDetalle($db, $metrica_sql, $label, $ejercicio_id, $lista_ids, $placeholders, $is_e1RM = false) {
         $sql = "SELECT
                    u.id as usuario_id,
                    u.nombre_usuario,
                    MAX($metrica_sql) as valor
                FROM series_realizadas sr
                JOIN sesiones_entrenamiento s ON sr.sesion_id = s.id
                JOIN usuarios u ON s.usuario_id = u.id
                WHERE
                    sr.ejercicio_id = ?
                    AND s.usuario_id IN ($placeholders)
                    AND $metrica_sql IS NOT NULL AND $metrica_sql > 0";

        // ¬°CAMBIO! A√±adimos filtro extra si estamos calculando e1RM
        if ($is_e1RM) {
            $sql .= " AND sr.repeticiones_realizadas > 1
                      AND sr.peso_kg_usado > 0 ";
        }

        $sql .= " GROUP BY s.usuario_id, u.id, u.nombre_usuario
                  ORDER BY valor DESC
                  LIMIT 3";

        $stmt = $db->prepare($sql);
        $params = array_merge([$ejercicio_id], $lista_ids);
        $stmt->execute($params);
        $ranking = $stmt->fetchAll(PDO::FETCH_ASSOC);

        foreach ($ranking as &$item) {
            $item['label'] = $label;
            $item['valor'] = is_numeric($item['valor']) ? (float)$item['valor'] : $item['valor'];
        }
        return $ranking;
    }
    // -----------------------------------------------------------------

    // 3f. Ejecutar consultas seg√∫n el tipo
    if ($tipo_ejercicio == 'fuerza' || $tipo_ejercicio == 'calistenia') {
        // Max Peso (sin cambios)
        $respuesta["max_peso"] = getRankingDetalle($db, 'sr.peso_kg_usado', 'kg', $ejercicio_id, $lista_ids_usuarios, $placeholders);

        // ¬°CAMBIO! Calcular e1RM para la m√©trica de 'max_reps'
        $metrica_e1RM = "ROUND(sr.peso_kg_usado * (1 + (sr.repeticiones_realizadas / 30)), 1)";
        $respuesta["max_reps"] = getRankingDetalle($db, $metrica_e1RM, 'e1RM (kg)', $ejercicio_id, $lista_ids_usuarios, $placeholders, true); // Pasamos true para activar filtro

    } elseif ($tipo_ejercicio == 'cardio') {
        // Cardio (sin cambios)
        $respuesta["max_dist"] = getRankingDetalle($db, 'sr.distancia_km_realizada', 'km', $ejercicio_id, $lista_ids_usuarios, $placeholders);
        $respuesta["max_tiempo"] = getRankingDetalle($db, 'sr.tiempo_min_realizado', 'min', $ejercicio_id, $lista_ids_usuarios, $placeholders);
    }

    // --- PASO 4: Devolver la respuesta ---
    http_response_code(200);
    echo json_encode($respuesta);

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener el ranking detallado.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_rutina_info.php ---

<?php
// ---- backend/api/get_rutina_info.php (MODIFICADO) ----

// Cabeceras CORS
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");
require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// Tu clave secreta
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
// =================================================================
// PASO 1: L√ìGICA DE VALIDACI√ìN DE TOKEN (Id√©ntica)
// =================================================================
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}

if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido."));
        die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
    die();
}

// =================================================================
// PASO 2: OBTENER EL ID DE LA RUTINA DESDE LA URL
// =================================================================
$rutina_id = $_GET['id'] ?? null;
if (!$rutina_id) {
    http_response_code(400); // Bad Request
    echo json_encode(array("mensaje" => "No se especific√≥ un ID de rutina."));
    die();
}

// =================================================================
// PASO 3: L√ìGICA PARA OBTENER LA INFO DE ESA RUTINA (MODIFICADA)
// =================================================================

try {
    $database = new Database();
    $db = $database->getConnection();

    // --- ¬°NUEVO BLOQUE! ---
    // 1. Obtenemos el orden m√°ximo actual del usuario
    $query_max = "SELECT MAX(orden) as max_orden FROM rutinas WHERE usuario_id = :usuario_id_max";
    $stmt_max = $db->prepare($query_max);
    $stmt_max->bindParam(":usuario_id_max", $usuario_id, PDO::PARAM_INT);
    $stmt_max->execute();
    $max_orden_row = $stmt_max->fetch(PDO::FETCH_ASSOC);
    // Si no tiene rutinas, max_orden ser√° NULL, as√≠ que usamos ?? 0
    $max_orden_usuario = (int)($max_orden_row['max_orden'] ?? 0);
    // --- FIN NUEVO BLOQUE ---

    // 2. Preparar la sentencia SQL (¬°MODIFICADA!)
    // A√±adimos 'orden' y 'color_tag'
    $query = "SELECT id, nombre, dias_semana, orden, color_tag 
              FROM rutinas 
              WHERE id = :rutina_id AND usuario_id = :usuario_id
              LIMIT 1";
    $stmt = $db->prepare($query);
    
    // 3. Bindear (enlazar) los par√°metros
    $stmt->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    // 4. Ejecutar
    $stmt->execute();
    
    // 5. Obtener el resultado
    $rutina = $stmt->fetch(PDO::FETCH_ASSOC);
    // 6. Comprobar si se encontr√≥ la rutina
    if ($rutina) {
        // ¬°√âxito!
        
        // --- ¬°CAMBIO AQU√ç! ---
        // 7. A√±adimos el max_orden a la respuesta
        // Si no hay rutinas (max_orden_usuario es 0), al menos enviamos 1
        $rutina['max_orden_disponible'] = ($max_orden_usuario > 0) ? $max_orden_usuario : 1;
        // --- FIN CAMBIO ---

        http_response_code(200);
        echo json_encode($rutina);
        // Ahora incluye 'orden', 'color_tag' y 'max_orden_disponible'
    } else {
        // No se encontr√≥ la rutina
        http_response_code(404);
        // Not Found
        echo json_encode(array("mensaje" => "Rutina no encontrada o no te pertenece."));
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_rutinas.php ---

<?php
// ---- backend/api/get_rutinas.php (Modificado para 'orden' y 'color_tag') ----

// ... (Cabeceras CORS) ...
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// ... (Validaci√≥n de Token sin cambios) ...
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido."));
        die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
    die();
}

try {
    $database = new Database();
    $db = $database->getConnection();

    // 1. Preparar la sentencia SQL MODIFICADA
    $query = "SELECT
                r.id,
                r.nombre,
                r.dias_semana,
                r.orden,           -- <-- ¬°NUEVO!
                r.color_tag,       -- <-- ¬°NUEVO!
                MAX(s.fecha_inicio) as ultima_sesion
             FROM
                rutinas r
              LEFT JOIN 
                sesiones_entrenamiento s ON r.id = s.rutina_id AND s.usuario_id = :usuario_id_sesion
              WHERE
                r.usuario_id = :usuario_id_rutina
              GROUP BY
                r.id, r.nombre, r.dias_semana, r.orden, r.color_tag -- <-- ¬°NUEVO! Agregados a GROUP BY
              ORDER BY
                r.orden ASC, r.fecha_creacion DESC"; // <-- ¬°NUEVO! Ordenamos por 'orden'

    $stmt = $db->prepare($query);
    $stmt->bindParam(":usuario_id_rutina", $usuario_id, PDO::PARAM_INT);
    $stmt->bindParam(":usuario_id_sesion", $usuario_id, PDO::PARAM_INT);
    $stmt->execute();

    $num = $stmt->rowCount();
    if ($num > 0) {
        $rutinas_array = array();
        $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

        foreach ($rows as $row) {
            extract($row);
            $rutina_item = array(
                "id" => $id,
                "nombre" => $nombre,
                "dias" => $dias_semana,
                "ultima_sesion" => $ultima_sesion,
                "orden" => $orden,         // <-- ¬°NUEVO!
                "color_tag" => $color_tag   // <-- ¬°NUEVO!
            );
            array_push($rutinas_array, $rutina_item);
        }

        http_response_code(200);
        echo json_encode($rutinas_array);

    } else {
        http_response_code(200);
        echo json_encode(array());
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos al obtener las rutinas.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_session_details.php ---

<?php
// ---- backend/api/get_session_details.php (NUEVO ARCHIVO) ----

// Cabeceras CORS
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

// Dependencias
require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}

if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); 
        die();
    }
} else { 
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); 
    die();
}

// --- PASO 2: Obtener ID de la Sesi√≥n ---
$sesion_id_solicitada = $_GET['id'] ?? null;

if (!$sesion_id_solicitada || !is_numeric($sesion_id_solicitada)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "No se especific√≥ un ID de sesi√≥n v√°lido."));
    die();
}

// --- PASO 3: L√≥gica de Consulta ---
$database = new Database();
$db = $database->getConnection();

try {
    // 1. (SEGURIDAD) Verificar que el usuario que pide los detalles
    //    sea amigo del due√±o de la sesi√≥n.
    $query_check = "
        SELECT s.usuario_id 
        FROM sesiones_entrenamiento s
        WHERE s.id = :sesion_id
        AND (
            -- O soy yo mismo
            s.usuario_id = :mi_id 
            -- O el due√±o de la sesi√≥n est√° en mi lista de amigos
            OR s.usuario_id IN (SELECT amigo_id FROM amistades WHERE usuario_id = :mi_id_amistad)
        )
        LIMIT 1
    ";
    $stmt_check = $db->prepare($query_check);
    $stmt_check->bindParam(":sesion_id", $sesion_id_solicitada, PDO::PARAM_INT);
    $stmt_check->bindParam(":mi_id", $usuario_id, PDO::PARAM_INT);
    $stmt_check->bindParam(":mi_id_amistad", $usuario_id, PDO::PARAM_INT);
    $stmt_check->execute();

    if ($stmt_check->rowCount() == 0) {
        http_response_code(403); // Forbidden
        echo json_encode(array("mensaje" => "No tienes permiso para ver esta sesi√≥n."));
        die();
    }

    // 2. Si hay permiso, obtener los detalles (Copiado de get_historial_por_fecha.php)
    $query_detalles = "SELECT
                            e.nombre as nombre_ejercicio,
                            e.tipo as tipo_ejercicio,
                            sr.num_serie,
                            sr.repeticiones_realizadas,
                            sr.fue_al_fallo,
                            sr.peso_kg_usado,
                            sr.tiempo_min_realizado,
                            sr.distancia_km_realizada,
                            sr.notas_serie,
                            sr.orden_ejercicio_rutina
                         FROM
                            series_realizadas sr
                         JOIN
                            ejercicios e ON sr.ejercicio_id = e.id
                         WHERE
                            sr.sesion_id = :sesion_id -- ¬°AQU√ç EST√Å EL CAMBIO!
                         ORDER BY
                            sr.orden_ejercicio_rutina ASC, 
                            sr.num_serie ASC";
    
    $stmt_detalles = $db->prepare($query_detalles);
    $stmt_detalles->bindParam(":sesion_id", $sesion_id_solicitada, PDO::PARAM_INT);
    $stmt_detalles->execute();

    $series_flat_list = $stmt_detalles->fetchAll(PDO::FETCH_ASSOC);

    // 3. Agrupar en PHP (Copiado de get_historial_por_fecha.php)
    $ejercicios_agrupados = [];
    foreach ($series_flat_list as $serie) {
        $ejercicio_nombre = $serie['nombre_ejercicio'];
        $tipo_ejercicio = $serie['tipo_ejercicio'];
        
        $ejercicio_key = ($serie['orden_ejercicio_rutina'] ?? '0') . '_' . $ejercicio_nombre;
        
        if (!isset($ejercicios_agrupados[$ejercicio_key])) {
             $ejercicios_agrupados[$ejercicio_key] = [
                "nombre_ejercicio" => $ejercicio_nombre,
                "tipo_ejercicio" => $tipo_ejercicio,
                "orden" => $serie['orden_ejercicio_rutina'],
                "series" => []
             ];
        }

        $ejercicios_agrupados[$ejercicio_key]["series"][] = [
            "num_serie" => $serie['num_serie'],
            "repeticiones_realizadas" => $serie['repeticiones_realizadas'],
            "fue_al_fallo" => (bool)$serie['fue_al_fallo'],
            "peso_kg_usado" => $serie['peso_kg_usado'],
            "tiempo_min_realizado" => $serie['tiempo_min_realizado'],
            "distancia_km_realizada" => $serie['distancia_km_realizada'],
            "notas_serie" => $serie['notas_serie']
        ];
    }

    // Ordenar el array final
    $ejercicios_array = array_values($ejercicios_agrupados);
    usort($ejercicios_array, function($a, $b) {
        return ($a['orden'] ?? 0) <=> ($b['orden'] ?? 0);
    });

    http_response_code(200);
    echo json_encode($ejercicios_array); // Devolvemos solo el array de ejercicios

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener los detalles de la sesi√≥n.",
        "error" => $e->getMessage()
    ));
}
?>

--- get_todos_prs_amigo.php ---

<?php
// ---- backend/api/get_todos_prs_amigo.php ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Est√°ndar) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else { 
    http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: Obtener IDs ---
$mi_id = $usuario_id;
$id_amigo = $_GET['id_amigo'] ?? null;

if (!$id_amigo || !is_numeric($id_amigo)) {
    http_response_code(400); 
    echo json_encode(array("mensaje" => "No se especific√≥ un 'id_amigo' v√°lido."));
    die();
}

// --- PASO 3: L√≥gica de Seguridad y Consulta ---
$database = new Database();
$db = $database->getConnection();

try {
    // 1. (SEGURIDAD) Comprobar si somos amigos
    $query_check = "SELECT id FROM amistades 
                    WHERE usuario_id = :mi_id AND amigo_id = :id_amigo 
                    LIMIT 1";
    $stmt_check = $db->prepare($query_check);
    $stmt_check->bindParam(":mi_id", $mi_id, PDO::PARAM_INT);
    $stmt_check->bindParam(":id_amigo", $id_amigo, PDO::PARAM_INT);
    $stmt_check->execute();

    if ($stmt_check->rowCount() == 0) {
        http_response_code(403); // 403 Forbidden
        echo json_encode(array("mensaje" => "Acceso prohibido. No sigues a este usuario."));
        die();
    }

    // 2. (DATOS) Obtenemos TODOS los PRs del amigo
    // Agrupamos por ejercicio y sacamos los m√°ximos
    $query_data = "
        WITH MaxSeries AS (
            SELECT 
                sr.ejercicio_id,
                MAX(sr.peso_kg_usado) as max_peso,
                MAX(sr.repeticiones_realizadas) as max_reps,
                MAX(sr.tiempo_min_realizado) as max_tiempo,
                MAX(sr.distancia_km_realizada) as max_dist
            FROM 
                series_realizadas sr
            JOIN 
                sesiones_entrenamiento s ON sr.sesion_id = s.id
            WHERE 
                s.usuario_id = :id_amigo
            GROUP BY 
                sr.ejercicio_id
        )
        SELECT 
            e.id as ejercicio_id,
            e.nombre,
            e.tipo,
            e.grupo_muscular,
            ms.max_peso,
            ms.max_reps,
            ms.max_tiempo,
            ms.max_dist
        FROM 
            MaxSeries ms
        JOIN 
            ejercicios e ON ms.ejercicio_id = e.id
        WHERE
            (ms.max_peso > 0 OR ms.max_reps > 0 OR ms.max_tiempo > 0 OR ms.max_dist > 0)
        ORDER BY
            e.nombre ASC;
    ";
    
    $stmt_data = $db->prepare($query_data);
    $stmt_data->bindParam(":id_amigo", $id_amigo, PDO::PARAM_INT);
    $stmt_data->execute();

    $prs = $stmt_data->fetchAll(PDO::FETCH_ASSOC);

    http_response_code(200);
    echo json_encode($prs); // Devuelve el array de PRs

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al obtener los PRs del amigo.",
        "error" => $e->getMessage()
    ));
}
?>

--- Global.css ---

/* ---- frontend/src/Global.css ---- */
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

/*
 * =========================================
 * VARIABLES GLOBALES (THEMING)
 * =========================================
 */

:root {
  --primary-color: #00aaff;
  --gradient: linear-gradient(90deg, #00f2ea 0%, #8a2be2 100%);
  --font-family: 'Montserrat', sans-serif;
  --bg-color: #121212;
  --surface-color: #1e1e1e;
  --text-color: #e0e0e0;
  --text-secondary-color: #aaa;
  --input-bg-color: #2c2c2c;
  --input-border-color: #444;
  --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

body.light {
  --bg-color: #f0f2f5;
  --surface-color: #ffffff;
  --text-color: #1c1e21;
  --text-secondary-color: #606770;
  --input-bg-color: #f0f2f5;
  --input-border-color: #ddd;
  --box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

/*
 * =========================================
 * ESTILOS BASE Y LAYOUT
 * =========================================
 */

body {
  margin: 0;
  font-family: var(--font-family);
  background-color: var(--bg-color);
  color: var(--text-color);
  transition: background-color 0.3s, color 0.3s;
}

/*
 * =========================================
 * BOTONES REUTILIZABLES
 * =========================================
 */

/* --- Contenedor de Botones (Flex) --- */
.button-group {
  display: flex;
  margin-top: 0.8rem;
}

.button-group button {
  flex: 1; /* El bot√≥n ocupa todo el ancho */
}

/* --- Estilo Base Com√∫n (P√≠ldora) --- */
button[type="submit"],
button.transparent-btn {
  height: 48px;
  border-radius: 999px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
}

/* --- ESTILO DE BOT√ìN √öNICO (Transparente) --- */
.transparent-btn {
  background: transparent;
  color: var(--text-color); /* Color de texto adaptativo */
  border: 4px solid transparent;
  /* Truco de doble fondo para borde degradado */
  background-image: linear-gradient(var(--surface-color), var(--surface-color)),
                    var(--gradient); /* Gradiente simplificado */
  background-origin: border-box;
  background-clip: padding-box, border-box;
}

.transparent-btn:hover {
  box-shadow: 0 0 0 rgba(255, 255, 255, 0);
  transform: scale(1.03);
}

/*
 * =========================================
 * UTILIDADES GLOBALES (Theme Toggle, Mensajes)
 * =========================================
 */

.theme-toggle {
  /* --- ‚úÖ ESTE ES EL ESTILO "POR DEFECTO" (PARA EL LOGIN) --- */
  position: absolute;
  top: 30px;
  right: 20px;
  
  /* --- (Estilos base sin c√≠rculo) --- */
  background: none;
  border: none;
  border-radius: 0; 
  width: 40px;
  height: 40px;
  font-size: 1.4rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
  overflow: hidden; /* Oculta el icono inactivo */
  transition: transform 0.2s ease-in-out, opacity 0.2s ease-in-out; 
}

.theme-toggle:hover {
  transform: scale(1.1);
  opacity: 0.8;
}

.message {
  margin-top: 1.5rem;
  padding: 0.8rem;
  border-radius: 5px;
  font-weight: 700;
  text-align: center;
  background-color: rgba(217, 48, 37, 0.1);
  color: #d93025;
  border: 1px solid #d93025;
}


/*
 * =========================================
 * ANIMACI√ìN DE ICONO DE TEMA (CORREGIDA)
 * =========================================
 */

.theme-icon {
  position: absolute; /* Para que se superpongan */
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  
  /* Transici√≥n para la rotaci√≥n y opacidad */
  transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s ease-in-out;
  backface-visibility: hidden; /* Evita parpadeos */
}

/* --- SOL (Light Mode Icon) --- */
.theme-icon.sun {
  opacity: 0;
  transform: rotateY(180deg); /* Empieza girado (oculto) */
}
.theme-icon.sun.active {
  opacity: 1;
  transform: rotateY(0deg); /* Gira a la vista (activo) */
}

/* --- LUNA (Dark Mode Icon) --- */
.theme-icon.moon {
  opacity: 0;
  transform: rotateY(180deg); /* Empieza girado (oculto) */
}
.theme-icon.moon.active {
  opacity: 1;
  transform: rotateY(0deg); /* Gira a la vista (activo) */
}

--- GuiaModal.css ---

/* ---- frontend/src/components/GuiaModal.css ---- */

/* 1. Fondo Oscuro (Backdrop) */
.modal-backdrop-guia {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7); /* Mismo fondo oscuro */
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000; /* Alto z-index */
  animation: fadeInGuia 0.3s ease;
}

@keyframes fadeInGuia { from { opacity: 0; } to { opacity: 1; } }

/* 2. Contenido del Modal (Estilo Normal) */
.modal-content-guia {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color); /* Borde normal */
  border-radius: 12px;
  width: 90%;
  max-width: 500px; /* Ancho est√°ndar */
  box-shadow: var(--box-shadow); /* Sombra normal */
  display: flex;
  flex-direction: column;
  animation: slideInGuia 0.3s ease-out;
  max-height: 80vh; /* L√≠mite de altura */
}

@keyframes slideInGuia {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* 3. Cabecera (Header) */
.modal-header-guia {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--input-border-color); /* Borde normal */
  flex-shrink: 0;
}

.modal-header-guia h3 {
  margin: 0;
  font-size: 1.25rem;
  color: var(--primary-color); /* T√≠tulo en color primario */
}

.modal-close-btn-guia {
  background: none;
  border: none;
  font-size: 2rem;
  color: var(--text-secondary-color);
  cursor: pointer;
  line-height: 1;
}
.modal-close-btn-guia:hover {
  color: var(--text-color);
}


/* 4. Cuerpo (Body) */
.modal-body-guia {
  padding: 1.5rem;
  line-height: 1.7; /* M√°s interlineado para leer f√°cil */
  overflow-y: auto; /* Scroll si el texto es muy largo */
}

.modal-body-guia p {
  color: var(--text-color);
  margin-top: 0;
  margin-bottom: 1rem; /* Espacio entre p√°rrafos */
}
.modal-body-guia p:last-child {
  margin-bottom: 0;
}

.modal-body-guia strong {
  color: var(--primary-color); /* Resaltar palabras clave */
  font-weight: 700;
}


/* 5. Pie (Footer) */
.modal-footer-guia {
  display: flex;
  justify-content: center; /* Centramos el bot√≥n */
  gap: 1rem;
  padding: 1.5rem;
  border-top: 1px solid var(--input-border-color);
  flex-shrink: 0;
}

/* Bot√≥n de Confirmar (Estilo principal, no rojo) */
.btn-confirm-guia {
  height: 48px;
  border-radius: 999px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
  padding: 0 1.8rem;
  
  /* Estilo principal (azul/gradiente) */
  background: var(--gradient);
  color: #fff;
}
.btn-confirm-guia:hover {
  opacity: 0.9;
  transform: scale(1.03);
}

--- GuiaModal.js ---

import React from 'react';
import './GuiaModal.css'; // Usaremos un CSS nuevo y limpio

function GuiaModal({ isOpen, onClose, titulo, children }) {
  if (!isOpen) {
    return null;
  }

  return (
    // Backdrop (fondo oscuro)
    <div className="modal-backdrop-guia" onClick={onClose}>
      
      {/* Contenido del modal */}
      <div className="modal-content-guia" onClick={(e) => e.stopPropagation()}>
        
        {/* Cabecera */}
        <div className="modal-header-guia">
          <h3>{titulo}</h3>
          <button className="modal-close-btn-guia" onClick={onClose}>
            &times;
          </button>
        </div>
        
        {/* Cuerpo (aqu√≠ se inyecta el texto) */}
        <div className="modal-body-guia">
          {children}
        </div>

        {/* Pie (solo un bot√≥n de 'Entendido') */}
        <div className="modal-footer-guia">
           <button 
            type="button" 
            className="btn-confirm-guia" // Un bot√≥n con estilo principal
            onClick={onClose} 
          >
            Entendido
          </button>
        </div>

      </div>
    </div>
  );
}

export default GuiaModal;

--- Header.css ---

/* ---- frontend/src/components/Header.css ---- */
.app-header {
  grid-area: header;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 1.5rem;
  background-color: var(--surface-color);
  border-bottom: 1px solid var(--input-border-color);
  height: 70px;
  z-index: 100;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.sidebar-toggle-btn {
  background: none;
  border: none;
  color: var(--text-color);
  font-size: 1.6rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 8px;
  transition: background-color 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.sidebar-toggle-btn:hover {
  background-color: var(--input-bg-color);
}

.header-logo {
  height: 30px;
  width: auto;
  flex-shrink: 0; 
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

/*
 * =========================================
 * ‚úÖ ANULACI√ìN (OVERRIDE) PARA EL BOT√ìN DEL HEADER
 * =========================================
 * ¬°AQU√ç EST√Å LA CORRECCI√ìN!
 * * Hemos cambiado '.theme-toggle' por '.app-header .theme-toggle'
 * * Esto le dice al navegador: "Aplica esta regla de 'position: relative'
 * SOLAMENTE al bot√≥n '.theme-toggle' que est√© DENTRO
 * de un elemento '.app-header'".
 * * El bot√≥n del Login no est√° dentro de '.app-header', 
 * as√≠ que NO le afectar√° y mantendr√° su 'position: absolute'.
 */
.app-header .theme-toggle {
  position: relative; /* (Era 'absolute') Lo devuelve al flujo */
  top: auto;          /* (Era '30px') Resetea la posici√≥n */
  right: auto;        /* (Era '20px') Resetea la posici√≥n */
}

--- Header.js ---

// ---- frontend/src/components/Header.js (con localStorage para tema) ----
import React, { useState, useEffect } from 'react';
import './Header.css';
import moviumLogo from '../assets/movium-logo.png';

function Header({ onToggleSidebar }) {
  // 1. Leer tema de localStorage al inicio, o usar 'dark' si no existe
  const [theme, setTheme] = useState(() => {
    const savedTheme = localStorage.getItem('movium_theme');
    // Si hay un tema guardado ('light' o 'dark'), √∫salo. Si no, usa 'dark'.
    return savedTheme === 'light' ? 'light' : 'dark';
  });

  // 2. Funci√≥n para cambiar el tema
  const toggleTheme = () => {
    setTheme((currentTheme) => {
      // Determina cu√°l ser√° el nuevo tema
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      // Guarda el *nuevo* tema en localStorage
      localStorage.setItem('movium_theme', newTheme);
      // Devuelve el nuevo tema para actualizar el estado de React
      return newTheme;
    });
  };

  // 3. Efecto para aplicar la clase al <body> (sin cambios)
  useEffect(() => {
    // Asegura que la clase correcta est√© en el body seg√∫n el estado
    document.body.className = theme;
  }, [theme]); // Se ejecuta cada vez que el estado 'theme' cambia

  return (
    <header className="app-header">
      <div className="header-left">
        <button onClick={onToggleSidebar} className="sidebar-toggle-btn">
          ‚ò∞
        </button>
        <img src={moviumLogo} alt="Movium Logo" className="header-logo" />
      </div>

      <div className="header-actions">
        {/* El bot√≥n ahora llama a la nueva funci√≥n toggleTheme */}
        <button onClick={toggleTheme} className="theme-toggle" aria-label={`Cambiar a tema ${theme === 'dark' ? 'claro' : 'oscuro'}`}>
          {/* Los iconos se muestran/ocultan seg√∫n el estado 'theme' */}
          <span className={`theme-icon sun ${theme === 'light' ? 'active' : ''}`}>‚òÄÔ∏è</span>
          <span className={`theme-icon moon ${theme === 'dark' ? 'active' : ''}`}>üåô</span>
        </button>
      </div>
    </header>
  );
}

export default Header;

--- Historial.css ---

/* ---- frontend/src/Historial.css (REFACTORIZADO CON HOVER CORRECTO Y SUTIL) ---- */

/* Contenedor principal de la p√°gina */
.historial-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 900px;
  margin: 0 auto;
}

/* Contenedor del calendario */
.calendario-wrapper {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
  margin-top: 2rem;
}


/* * =========================================
 * ESTILOS 'react-calendar' (Tema Oscuro)
 * =========================================
 */

/* Contenedor general del calendario */
.calendario-wrapper .react-calendar {
  width: 100%;
  max-width: 100%;
  background: var(--surface-color); 
  border: none;
  font-family: var(--font-family);
  line-height: 1.5;
}

/* Botones de navegaci√≥n (Mes/A√±o y Flechas) */
.calendario-wrapper .react-calendar__navigation button {
  color: var(--text-color);
  min-width: 44px;
  background: none;
  font-size: 1.1rem;
  font-weight: bold;
  border-radius: 8px;
  transition: background-color 0.2s ease, color 0.2s ease;
}

/* Hover "tranquilito" para la navegaci√≥n */
.calendario-wrapper .react-calendar__navigation button:hover,
.calendario-wrapper .react-calendar__navigation button:focus {
  background-color: var(--input-bg-color); /* Fondo gris oscuro sutil */
  color: var(--text-color); /* Mantiene el color de texto */
  outline: none; 
}
.calendario-wrapper .react-calendar__navigation button:disabled {
  color: var(--input-border-color);
  background-color: transparent;
}

/* Nombres de los d√≠as de la semana (L, M, X...) */
.calendario-wrapper .react-calendar__month-view__weekdays__weekday {
  padding: 0.5em;
  color: var(--text-secondary-color);
  text-decoration: none;
  font-size: 0.8rem;
  font-weight: bold;
}
.calendario-wrapper .react-calendar__month-view__weekdays__weekday abbr {
  text-decoration: none;
}

/* --- ¬°CAMBIOS IMPORTANTES AQU√ç! --- */

/* D√≠as (los n√∫meros) - ESTADO BASE */
/* Aumentamos la especificidad usando nuestro wrapper y 'button' */
.calendario-wrapper button.react-calendar__tile {
  position: relative; 
  padding: 1em 0.5em;
  background: none; /* Sin fondo */
  border: 2px solid transparent; /* Borde para que no "salte" */
  color: var(--text-color); /* Texto blanco */
  border-radius: 8px;
  transition: all 0.2s ease;
  cursor: pointer;
}

/* Hover y Focus sobre un D√çA NORMAL */
.calendario-wrapper button.react-calendar__tile:hover,
.calendario-wrapper button.react-calendar__tile:focus {
  /* ¬°Esta es la clave! Usamos tu gris oscuro sutil */
  background-color: var(--input-bg-color); 
  border-color: var(--input-bg-color); /* Borde a juego */
  color: var(--text-color); /* El texto se mantiene blanco */
  outline: none;
}

/* Hover/Focus en un d√≠a DESHABILITADO (otro mes) */
.calendario-wrapper button.react-calendar__tile:disabled:hover,
.calendario-wrapper button.react-calendar__tile:disabled:focus {
  background-color: transparent; /* No hace NADA */
  border-color: transparent;
  cursor: default;
}

/* D√≠a de "Hoy" (Estado base) */
.calendario-wrapper button.react-calendar__tile--now {
  background-color: var(--input-bg-color);
  border-color: var(--input-border-color); /* Borde gris m√°s claro */
  font-weight: bold;
}

/* Hover/Focus sobre el d√≠a de "Hoy" */
.calendario-wrapper button.react-calendar__tile--now:hover,
.calendario-wrapper button.react-calendar__tile--now:focus {
  background-color: var(--input-bg-color); /* Mantiene su fondo */
  border-color: var(--primary-color); /* El borde se pone azul "premium" */
  outline: none;
}

/* D√≠as de otros meses (atenuados) */
.calendario-wrapper .react-calendar__month-view__days__day--neighboringMonth {
  color: var(--input-border-color); /* Texto gris muy claro */
  cursor: default;
}

/* * =========================================
 * CLASES PERSONALIZADAS (Puntos)
 * (Sin cambios en esta secci√≥n)
 * =========================================
 */

/* 1. El CONTENEDOR de los puntos */
.dot-container {
  position: absolute;
  bottom: 8px; 
  left: 0;
  right: 0;
  margin: 0 auto;
  display: flex;
  flex-wrap: nowrap; 
  justify-content: center;
  align-items: center;
  gap: 3px; 
  max-width: 90%; 
  overflow: hidden; 
  pointer-events: none; /* Los puntos no interfieren con el clic */
}

/* 2. El estilo del PUNTO individual */
.dot {
  width: 5px;  
  height: 5px;
  border-radius: 50%;
  flex-shrink: 0; 
  /* El 'backgroundColor' se aplica inline desde React */
}

/* Estilo para el d√≠a que est√° SELECCIONADO (despu√©s del clic) */
.dia-seleccionado,
.dia-seleccionado:hover,
.dia-seleccionado:focus {
  background-color: var(--primary-color);
  color: #fff;
  font-weight: bold;
  border-color: var(--primary-color); /* Borde de 2px */
}

/* Hacemos que los puntos sean visibles sobre el fondo azul */
.dia-seleccionado .dot {
  background-color: #fff ; 
}

.historial-container .btn-volver {
 background: none;
 border: 1px solid var(--input-border-color); 
 color: var(--text-secondary-color);
 padding: 0.5rem 1rem;
 border-radius: 8px;
 cursor: pointer;
 font-size: 0.9rem;
 font-family: var(--font-family);
 transition: all 0.3s ease;
 margin-bottom: 1.5rem;
 width: fit-content; 
 flex-grow: 0; 
}

--- Historial.js ---

// ---- frontend/src/Historial.js (REFACTORIZADO CON DETALLES DE D√çA) ----

import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import Calendar from 'react-calendar';
import 'react-calendar/dist/Calendar.css'; // Estilos base
import './Historial.css'; // Estilos del calendario (puntos)
import './RutinaProgreso.css'; // <-- ¬°IMPORTANTE! Reutilizamos este CSS
import iconoCalendario from './assets/calendario.png';

// --- Copiamos las funciones Helper de RutinaProgreso.js --- [cite: 2193-2198]
const formatFecha = (fechaISO) => {
  if (!fechaISO) return '';
  return new Date(fechaISO).toLocaleDateString('es-ES', {
    day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'
  }); // <-- A√±adimos hora
};

const formatDuracion = (duracionSql) => {
    if (!duracionSql || duracionSql === '00:00:00') return null;
    const partes = duracionSql.split(':');
    const horas = parseInt(partes[0], 10);
    const minutos = parseInt(partes[1], 10);

    let resultado = '';
    if (horas > 0) {
        resultado += `${horas}h `;
    }
    if (minutos > 0 || horas === 0) {
        resultado += `${minutos}m`;
    }
    return resultado.trim();
};

// --- Copiamos el Modal de Notas de RutinaProgreso.js --- [cite: 2199-2213]
const NotaModal = ({ nota, onClose }) => {
    if (!nota || typeof onClose !== 'function') return null;
    const backdropStyle = {
        position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
        backgroundColor: 'rgba(0, 0, 0, 0.7)', display: 'flex',
        alignItems: 'center', justifyContent: 'center', zIndex: 1100,
        animation: 'fadeInModal 0.2s ease-out'
    };
    const contentStyle = {
        backgroundColor: 'var(--surface-color)', padding: '1.5rem', borderRadius: '12px',
        maxWidth: '450px', width: '90%', maxHeight: '70vh', overflowY: 'auto',
        border: '1px solid var(--input-border-color)', position: 'relative',
        fontSize: '1rem', lineHeight: '1.6', boxSizing: 'border-box',
        animation: 'slideInModal 0.2s ease-out'
    };
    const closeButtonStyle = {
        position: 'absolute', top: '0.75rem', right: '0.75rem',
        background: 'none', border: 'none', fontSize: '1.8rem',
        color: 'var(--text-secondary-color)', cursor: 'pointer', lineHeight: 1, padding: '0.2rem'
    };
    const notaTextStyle = {
        whiteSpace: 'pre-wrap', wordBreak: 'break-word',
        marginTop: '0.5rem', marginBottom: '0', color: 'var(--text-color)'
    };
    const keyframesStyle = `
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    `;
    return (
        <>
            <style>{keyframesStyle}</style>
            <div style={backdropStyle} onClick={onClose}>
                <div style={contentStyle} onClick={(e) => e.stopPropagation()}>
                    <button style={closeButtonStyle} onClick={onClose} aria-label="Cerrar nota">&times;</button>
                    <h4 style={{marginTop: 0, marginBottom: '1rem', color: 'var(--primary-color)'}}>Nota:</h4>
                    <p style={notaTextStyle}>{nota}</p>
                </div>
            </div>
        </>
    );
};
// --- Fin de c√≥digo copiado ---


function Historial() {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [fechasConColores, setFechasConColores] = useState({});

  // --- ¬°NUEVOS ESTADOS! ---
  const [fechaSeleccionada, setFechaSeleccionada] = useState(null); // String "YYYY-MM-DD"
  const [datosDelDia, setDatosDelDia] = useState([]); // Array de sesiones
  const [loadingDia, setLoadingDia] = useState(false);
  const [errorDia, setErrorDia] = useState(null);
  
  // Estados para el modal de notas
  const [isNotaModalOpen, setIsNotaModalOpen] = useState(false);
  const [notaParaMostrar, setNotaParaMostrar] = useState('');

  // Cargar las fechas para los puntos (sin cambios)
  useEffect(() => {
    const cargarFechas = async () => {
      setLoading(true);
      setError(null);
      const token = localStorage.getItem('movium_token');
      if (!token) { setError("Error de autenticaci√≥n."); setLoading(false); return; }

      try {
        const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/get_historial_fechas.php', {
          method: 'GET',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) { throw new Error(data.mensaje || 'No se pudieron cargar las fechas.'); }
        setFechasConColores(data);
      } catch (err) { setError(err.message); } 
      finally { setLoading(false); }
    };
    cargarFechas();
  }, []);

  // Funci√≥n para los puntos (sin cambios)
  const handleTileContent = ({ date, view }) => {
    if (view === 'month') {
      const fechaLocal = date.toISOString().split('T')[0]; // Formato YYYY-MM-DD
      const colores = fechasConColores[fechaLocal];
      if (colores && colores.length > 0) {
        return (
          <div className="dot-container">
            {colores.map((color, index) => (
              <div key={index} className="dot" style={{ backgroundColor: color }}></div>
            ))}
          </div>
        );
      }
    }
    return null;
  };

  // --- ¬°NUEVA FUNCI√ìN! ---
  // Se llama al hacer clic en un d√≠a del calendario
  const handleDayClick = async (date) => {
    const fechaLocal = date.toISOString().split('T')[0]; // Formato YYYY-MM-DD
    
    // Si hacemos clic en el mismo d√≠a, no hacemos nada (o podr√≠amos ocultarlo)
    if (fechaSeleccionada === fechaLocal) {
        setFechaSeleccionada(null);
        setDatosDelDia([]);
        setErrorDia(null);
        return;
    }

    // Comprobar si este d√≠a tiene entrenos (mirando nuestro mapa de colores)
    if (!fechasConColores[fechaLocal]) {
        // Si no hay colores, no hay entreno. Limpiamos la selecci√≥n.
        setFechaSeleccionada(null);
        setDatosDelDia([]);
        setErrorDia("No hay entrenamientos registrados para este d√≠a.");
        return;
    }

    // Si hay entrenos, buscamos los detalles
    setLoadingDia(true);
    setErrorDia(null);
    setDatosDelDia([]);
    setFechaSeleccionada(fechaLocal);
    
    const token = localStorage.getItem('movium_token');
    if (!token) {
        setErrorDia("Error de autenticaci√≥n.");
        setLoadingDia(false);
        return;
    }

    try {
        const response = await fetch(`http://localhost/programacion/TFG/movium/backend/api/get_historial_por_fecha.php?fecha=${fechaLocal}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        if (!response.ok) { throw new Error(data.mensaje || 'No se pudieron cargar los datos del d√≠a.'); }
        
        setDatosDelDia(data); // Guardamos el array de sesiones

    } catch (err) {
        setErrorDia(err.message);
    } finally {
        setLoadingDia(false);
    }
  };

  // --- Handlers para el Modal de Notas (copiados) ---
  const handleMostrarNota = (notaTexto) => {
      if(notaTexto){
        setNotaParaMostrar(notaTexto);
        setIsNotaModalOpen(true);
      }
  };

  const handleCloseNotaModal = () => {
      setIsNotaModalOpen(false);
  };

  // Renderizado
  return (
    <>
      <div className="historial-container">
        <button className="btn-volver" onClick={() => navigate(-1)}>
          &larr; Volver
        </button>

        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
          <img src={iconoCalendario} alt="" width="64" height="64" />
          <h2>Historial de Entreno</h2>
        </div>
        <p className="subtitle" style={{ textAlign: 'center' }}>
          Pulsa en un d√≠a marcado para ver el detalle del entrenamiento.
        </p>

        {loading && <p className="subtitle" style={{ textAlign: 'center' }}>Cargando calendario...</p>}
        {error && <div className="message" style={{ marginTop: '1rem' }}>{error}</div>}

        {!loading && !error && (
          <div className="calendario-wrapper">
            <Calendar
              tileContent={handleTileContent}
              onClickDay={handleDayClick} // <-- ¬°PROP NUEVA!
              locale="es-ES"
              // Damos una clase CSS al d√≠a seleccionado
              tileClassName={({ date, view }) => 
                view === 'month' && date.toISOString().split('T')[0] === fechaSeleccionada 
                ? 'dia-seleccionado' 
                : null
              }
            />
          </div>
        )}

        {/* --- ¬°NUEVA SECCI√ìN DE DETALLES! --- */}
        <div className="historial-detalle-dia">
            {loadingDia && <p className="subtitle" style={{ textAlign: 'center', marginTop: '2rem' }}>Cargando d√≠a...</p>}
            {errorDia && <p className="no-data-msg" style={{ marginTop: '2rem' }}>{errorDia}</p>}
            
            {/* Reutilizamos las clases de RutinaProgreso.css */}
            <div className="historial-container" style={{padding: 0, marginTop: '2rem'}}>
              {datosDelDia.length > 0 && (
                datosDelDia.map(sesion => {
                  const duracionFormateada = formatDuracion(sesion.duracion);
                  return (
                    // 1. Tarjeta de Sesi√≥n
                    <div key={sesion.sesion_id} className="sesion-card">
                      <div className="sesion-header">
                        {/* 2. Cabecera (Nombre de rutina y totales) */}
                        <strong style={{color: sesion.color_tag || 'var(--primary-color)'}}>
                          {sesion.nombre_rutina}
                        </strong>
                        <div className="sesion-totales">
                          {duracionFormateada && ( <span>üïí {duracionFormateada}</span> )}
                          {sesion.total_volumen_fuerza > 0 && ( <span>üèãÔ∏è {Math.round(sesion.total_volumen_fuerza)} kg</span> )}
                          {sesion.total_tiempo_cardio > 0 && ( <span>‚è±Ô∏è {sesion.total_tiempo_cardio} min</span> )}
                          {sesion.total_distancia_cardio > 0 && ( <span>üìç {sesion.total_distancia_cardio.toFixed(1)} km</span> )}
                        </div>
                        {sesion.notas_sesion && (
                          <span className="sesion-nota" onClick={() => handleMostrarNota(sesion.notas_sesion)} style={{ cursor: 'pointer' }} role="button">
                            üìù
                          </span>
                        )}
                      </div>
                      
                      {/* 3. Contenedor de Ejercicios */}
                      <div className="ejercicios-container">
                        {sesion.ejercicios.map(ejercicio => (
                          <div key={ejercicio.orden + '_' + ejercicio.nombre_ejercicio} className="ejercicio-grupo">
                            <strong>{ejercicio.nombre_ejercicio}</strong>
                            {/* 4. Lista de Series */}
                            <ul>
                              {ejercicio.series.map((serie, index) => (
                                <li key={index} className="serie-item">
                                  <span>S{serie.num_serie}:</span>
                                  {ejercicio.tipo_ejercicio === 'cardio' ? (
                                    <span>
                                      {(serie.tiempo_min_realizado != null && serie.tiempo_min_realizado > 0) ? `${serie.tiempo_min_realizado} min` : ''}
                                      {(serie.distancia_km_realizada != null && serie.distancia_km_realizada > 0) ? ` ${ (serie.tiempo_min_realizado != null && serie.tiempo_min_realizado > 0) ? 'üìç' : '' } ${serie.distancia_km_realizada} km` : ''}
                                      {!(serie.tiempo_min_realizado > 0) && !(serie.distancia_km_realizada > 0) && '-'}
                                    </span>
                                  ) : (
                                    <span>
                                      {serie.repeticiones_realizadas ?? '-'} reps
                                      {serie.peso_kg_usado != null && ` x ${serie.peso_kg_usado} kg`}
                                      {serie.fue_al_fallo && <span className="fallo-tag" title="Al fallo">F</span>}
                                    </span>
                                  )}
                                  {serie.notas_serie && (
                                    <span className="serie-nota-historial" onClick={() => handleMostrarNota(serie.notas_serie)} style={{ cursor: 'pointer' }} role="button">
                                      üìù
                                    </span>
                                  )}
                                </li>
                              ))}
                            </ul>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })
              )}
            </div>
        </div>
      </div>

      {/* Modal de Notas (copiado) */}
      {isNotaModalOpen && (
          <NotaModal
              nota={notaParaMostrar}
              onClose={handleCloseNotaModal}
          />
      )}
    </>
  );
}

export default Historial;

--- index.css ---

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
    monospace;
}


--- index.js ---

// ---- frontend/src/index.js (VERSI√ìN NUEVA - ¬°EST√Å PERFECTO!) ----
import React from 'react';
import ReactDOM from 'react-dom/client';
import './Global.css';
import './index.css';
import App from './App'; // <-- 1. Apuntar√° al nuevo App.js
import { BrowserRouter } from 'react-router-dom'; // <-- 2. Importamos el Router

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    {/* 3. Envolvemos la App en el BrowserRouter */}
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);

--- login.php ---

<?php
// ---- backend/api/login.php (MODIFICADO) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST");
header("Access-Control-Max-Age: 3600");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");
require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;

$db = new Database();
$conn = $db->getConnection();
$data = json_decode(file_get_contents("php://input"));
// Leemos "identifier" que puede ser usuario o email
if (!empty($data->identifier) && !empty($data->password)) {

    $identifier = htmlspecialchars(strip_tags($data->identifier));
    // **** ¬°CAMBIO AQU√ç! ****
    // A√±adimos LEFT JOIN y seleccionamos los nuevos campos de 'perfiles' (p)
    $query = "SELECT 
                u.id, 
                u.nombre_usuario, 
                u.password_hash, 
                u.correo_electronico,
       
                p.ha_visto_guia_inicio,
                p.ha_visto_guia_rutina,
                p.ha_visto_guia_records,     /* <-- A√ëADIDO */
                p.ha_visto_guia_comunidad,   /* <-- A√ëADIDO */
                p.ha_visto_guia_entreno      /* <-- A√ëADIDO */
              FROM usuarios u
              LEFT JOIN perfiles p ON u.id = p.usuario_id
              WHERE u.nombre_usuario = :identifier OR u.correo_electronico = :identifier
              LIMIT 1";
    // ************************

    $stmt = $conn->prepare($query);
    $stmt->bindParam(':identifier', $identifier);
    $stmt->execute();
    if ($stmt->rowCount() > 0) {
        $row = $stmt->fetch(PDO::FETCH_ASSOC);
        // Extrae $id, $nombre_usuario, $password_hash, $correo_electronico
        // Y TAMBI√âN todos los flags de gu√≠as
        extract($row);
        // Verificamos la contrase√±a (sin cambios)
        if (password_verify(htmlspecialchars(strip_tags($data->password)), $password_hash)) {

            $secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
            // ¬°¬°C√ÅMBIAME!!

            $token_payload = array(
                "iat" => time(),
                "exp" => time() + (24 * 60 * 60), // 24 horas
                "data" => array(
                     "id" => $id,
                     "nombre_usuario" => $nombre_usuario // Guardamos siempre el nombre_usuario en el token
                )
            );
            http_response_code(200);
            $jwt = JWT::encode($token_payload, $secret_key, 'HS256');
            
            // **** ¬°CAMBIO AQU√ç! ****
            // Enviamos los datos de las gu√≠as al frontend
            echo json_encode(array(
                "token" => $jwt,
                "usuario" => array(
                    "id" => $id,
                    "nombre_usuario" => $nombre_usuario,
                    // Usamos (bool) para convertirlos a true/false
                    // Si es null (ej: usuario antiguo sin perfil), ?? 0 lo trata como false
                    "ha_visto_guia_inicio" => (bool)($ha_visto_guia_inicio ?? 0),
                    "ha_visto_guia_rutina" => (bool)($ha_visto_guia_rutina ?? 0),
                    "ha_visto_guia_records" => (bool)($ha_visto_guia_records ?? 0),
                    "ha_visto_guia_comunidad" => (bool)($ha_visto_guia_comunidad ?? 0),
                    "ha_visto_guia_entreno" => (bool)($ha_visto_guia_entreno ?? 0)
                )
            ));
            // ************************

        } else {
            // Error de contrase√±a
            http_response_code(401);
            echo json_encode(array("mensaje" => "Contrase√±a incorrecta."));
        }
    } else {
        // Error de usuario/email no encontrado
        http_response_code(401);
        echo json_encode(array("mensaje" => "Usuario o correo electr√≥nico no encontrado.")); // Mensaje actualizado
    }
} else {
    // Datos incompletos
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos."));
}
?>

--- LoginPage.css ---

/* ---- frontend/src/LoginPage.css ---- */
/* * Los estilos globales (:root, body, botones)
 * se han movido a Global.css
 */

.page-container {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 2rem;
  box-sizing: border-box;
}

.form-wrapper {
  display: flex;
  width: 800px;
  max-width: 90%;
  background-color: var(--surface-color);
  border-radius: 12px;
  box-shadow: var(--box-shadow);
  overflow: hidden;
  border: 1px solid var(--input-border-color);
  transition: background-color 0.3s, border-color 0.3s;
}

/*
 * =========================================
 * PANELES (IZQUIERDO Y DERECHO)
 * =========================================
 */

.panel-izquierdo {
  width: 50%;
  padding: 3rem;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  background-color: #181818; /* Color espec√≠fico para el panel */
  color: #fff;
}

body.light .panel-izquierdo {
  background-color: #f8f9fa;
  color: var(--text-color);
}

.panel-izquierdo .icon {
  width: 100px;
  margin-bottom: 1rem;
}

.panel-izquierdo .logo-text-image {
  width: 175px;
  margin-bottom: 1rem;
}

.panel-izquierdo p {
  font-size: 1.15rem;
  font-weight: 400;
  color: var(--text-secondary-color);
}

body.light .panel-izquierdo p {
  color: #6c757d;
}

.panel-derecho {
  width: 50%;
  padding: 3rem;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

/*
 * =========================================
 * FORMULARIOS (Espec√≠ficos del Login)
 * =========================================
 */

h2 {
  margin-top: 0;
  margin-bottom: 1.5rem;
  font-weight: 700;
  color: var(--text-color);
  text-align: center;
}

form {
  display: flex;
  flex-direction: column;
}

/* --- ¬°CAMBIO AQU√ç! --- */
/* Este es el estilo base del input, SIN margen inferior */
input {
  background-color: var(--input-bg-color);
  color: var(--text-color);
  border: 1px solid var(--input-border-color);
  padding: 1rem;
  margin-bottom: 0; /* ¬°Quitamos el margen de aqu√≠! */
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s;
  width: 100%; /* Aseguramos que ocupe el 100% del wrapper */
  box-sizing: border-box; /* ¬°MUY IMPORTANTE! */
}

input:focus {
  outline: none;
  border-color: var(--primary-color);
}

/* --- ¬°CAMBIO AQU√ç! --- */
/* Wrapper gen√©rico para inputs (Login y Registro) */
.input-wrapper {
  position: relative;
  width: 100%;
  margin-bottom: 1rem; /* AHORA el margen est√° en el wrapper */
}

/* --- ¬°CAMBIO AQU√ç! --- */
/* Wrapper de contrase√±a (Login y Registro) */
.password-wrapper {
  position: relative;
  display: flex; /* Mantenemos flex para alinear el input */
  align-items: center;
  width: 100%;
  margin-bottom: 1rem; /* AHORA el margen est√° en el wrapper */
}

.password-wrapper input {
  /* El input de contrase√±a ya no necesita margen */
  margin-bottom: 0; 
}

/* Bot√≥n "Mostrar" (¬°centrado verticalmente!) */
.password-toggle {
  position: absolute;
  right: 1rem;
  top: 50%; /* Centrado vertical */
  transform: translateY(-50%); /* Centrado vertical */
  cursor: pointer;
  user-select: none;
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--text-secondary-color);
  transition: color 0.3s;
  z-index: 3; /* Por encima del contador */
}

.password-toggle:hover {
  color: var(--text-color);
}

/*
 * =========================================
 * UTILIDADES (Espec√≠ficas del Login)
 * =========================================
 */

.toggle-form {
  margin-top: 1.5rem;
  color: var(--text-secondary-color);
  font-size: 0.9rem;
  text-align: center;
}

.toggle-form span {
  color: var(--primary-color);
  font-weight: 700;
  cursor: pointer;
  transition: opacity 0.3s;
}

.toggle-form span:hover {
  opacity: 0.8;
}

/*
 * =========================================
 * DISE√ëO RESPONSIVO (Espec√≠fico del Login)
 * =========================================
 */

@media (max-width: 768px) {

  .page-container {
    display: flex;
    justify-content: center; /* Centra horizontalmente */
    align-items: center;    /* Centra verticalmente */
    min-height: 100vh;
    padding: 2rem;
    box-sizing: border-box;
  }
  
  .form-wrapper {
    flex-direction: column;
    width: 100%;
    max-width: 500px;
  }
  
  .panel-izquierdo, 
  .panel-derecho {
    width: 100%;
    box-sizing: border-box;
  }

  .panel-izquierdo {
    padding: 2.5rem 1.5rem;
  }

  .panel-derecho {
    padding: 2.5rem 1.5rem;
  }
}

/*
 * =========================================
 * ESTILOS PARA INPUT CON CONTADOR (¬°CORREGIDOS!)
 * =========================================
 */

/* Estilo base del contador (interno) */
.char-counter-login {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  font-size: 0.8rem;
  color: var(--text-secondary-color);
  z-index: 2; /* Debajo del bot√≥n "Mostrar" */
  pointer-events: none; /* No se puede hacer clic en √©l */
}


/* --- LA MAGIA EST√Å AQU√ç --- */

/* 1. Contador para "Nombre de usuario" */
.input-wrapper .char-counter-login {
  right: 1rem; /* Pegado a la derecha */
}

/* 1b. Input de "Nombre de usuario" (le da espacio al contador) */
.input-wrapper .input-with-counter {
  padding-right: 4.5rem; /* Espacio para "18 / 18" */
}


/* 2. Contador para "Contrase√±a" */
.password-wrapper .char-counter-login.password {
  right: 5.5rem; /* Lo muevo 5.5rem desde la derecha */
}

/* 2b. Input de "Contrase√±a" (le da espacio AL BOT√ìN Y AL CONTADOR) */
.password-wrapper .input-with-counter.password {
  /* (5.5rem del contador + 4.5rem del "Mostrar" ~ 10rem) */
  padding-right: 10rem; 
}

--- LoginPage.js ---

// ---- frontend/src/LoginPage.js (CORREGIDO para contadores INTERNOS) ----

import React, { useState, useEffect } from 'react';
import './LoginPage.css';
import moviumIcon from './assets/movium-icono.png';
import moviumLogo from './assets/movium-logo.png';

// --- Constantes de longitud (sin cambios) ---
const MAX_USERNAME_LENGTH = 18;
const MAX_PASSWORD_LENGTH = 50;

function LoginPage() {
  // --- ESTADO DEL COMPONENTE (sin cambios) ---
  const [isLoginView, setIsLoginView] = useState(true);
  const [identifier, setIdentifier] = useState('');
  const [password, setPassword] = useState('');
  const [username, setUsername] = useState('');
  const [message, setMessage] = useState('');
  const [theme, setTheme] = useState(() => {
    const savedTheme = localStorage.getItem('movium_theme');
    return savedTheme === 'light' ? 'light' : 'dark';
  });
  const [showPassword, setShowPassword] = useState(false);

  // --- MANEJADORES DE EVENTOS Y FUNCIONES (sin cambios) ---

  const toggleTheme = () => {
    setTheme((currentTheme) => {
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('movium_theme', newTheme);
      return newTheme;
    });
  };

  useEffect(() => {
    document.body.className = theme;
  }, [theme]);
  // --- LLAMADAS A LA API (sin cambios) ---

  const handleLoginSubmit = async (e) => {
    e.preventDefault();
    setMessage('');
    const loginUrl = 'http://localhost/programacion/TFG/movium/backend/api/login.php';

    try {
      const response = await fetch(loginUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ identifier, password }),
      });
      const data = await response.json();

      if (response.ok) {
        localStorage.setItem('movium_token', data.token);
        localStorage.setItem('movium_user', JSON.stringify(data.usuario)); 
        window.location.href = '/';
      } else {
        setMessage(`Error: ${data.mensaje}`);
      }
      
    } catch (error) {
      setMessage('Error de red. No se pudo conectar al servidor.');
    }
  };

  const handleRegisterSubmit = async (e) => {
    e.preventDefault();
    setMessage('');
    // --- Validaci√≥n (sin cambios) ---
    const minLongitud = 6;
    const regexNumero = /[0-9]/;
    const regexEspecial = /\W/;

    if (username.length < 4) {
       setMessage('El nombre de usuario debe tener al menos 4 caracteres.');
       return;
    }
    if (username.length > MAX_USERNAME_LENGTH) {
       setMessage(`El nombre de usuario no puede tener m√°s de ${MAX_USERNAME_LENGTH} caracteres.`);
       return;
    }
    
    if (password.length < minLongitud) {
      setMessage(`La contrase√±a debe tener al menos ${minLongitud} caracteres.`);
      return;
    }
    if (password.length > MAX_PASSWORD_LENGTH) {
      setMessage(`La contrase√±a no puede tener m√°s de ${MAX_PASSWORD_LENGTH} caracteres.`);
       return;
    }

    if (!regexNumero.test(password)) {
      setMessage("La contrase√±a debe contener al menos un n√∫mero.");
      return;
    }
    if (!regexEspecial.test(password)) {
      setMessage("La contrase√±a debe contener al menos un car√°cter especial (ej: !@#$...).");
      return;
    }
    // --- FIN VALIDACI√ìN ---


    const registerUrl = 'http://localhost/programacion/TFG/movium/backend/api/register.php';
    try {
      const response = await fetch(registerUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nombre_usuario: username,
          password: password,
        }),
      });
      const data = await response.json();

      if (response.ok) { 
        if (data.token && data.usuario) {
            localStorage.setItem('movium_token', data.token);
            localStorage.setItem('movium_user', JSON.stringify(data.usuario)); 
            window.location.href = '/';
        } else {
            setMessage('¬°Registro completado! Ahora puedes iniciar sesi√≥n.');
            toggleView(true);
        }
      } else { 
        setMessage(`Error en el registro: ${data.mensaje}`);
      }
    } catch (error) {
      setMessage('Error de red. No se pudo conectar al servidor.');
    }
  };

  // Funci√≥n interna (sin cambios)
  const toggleView = (isLogin) => {
    setIsLoginView(isLogin);
    setUsername('');
    setIdentifier('');
    setPassword('');
    setMessage('');
    setShowPassword(false);
  };

  // --- RENDERIZADO DEL JSX ---
  return (
    <div className="page-container">
      <button onClick={toggleTheme} className="theme-toggle" aria-label={`Cambiar a tema ${theme === 'dark' ? 'claro' : 'oscuro'}`}>
        <span className={`theme-icon sun ${theme === 'light' ? 'active' : ''}`}>‚òÄÔ∏è</span>
        <span className={`theme-icon moon ${theme === 'dark' ? 'active' : ''}`}>üåô</span>
      </button>

      <div className="form-wrapper">
        <div className="panel-izquierdo">
           <img src={moviumIcon} alt="Movium Icon" className="icon" />
          <img src={moviumLogo} alt="Movium Logo" className="logo-text-image" />
          <p>Tu progreso, tu comunidad, tu gimnasio.</p>
        </div>

        <div className="panel-derecho">
          {isLoginView ? (
            // --- Formulario de Login ---
            <form onSubmit={handleLoginSubmit} className="login-form-view">
               <h2>Iniciar Sesi√≥n</h2>
              
              {/* --- ¬°CAMBIO! Volvemos a usar .input-wrapper --- */}
              <div className="input-wrapper">
                <input
                  type="text"
                  placeholder="Nombre de usuario o Email"
                  value={identifier}
                  onChange={(e) => setIdentifier(e.target.value)}
                  minLength="4"
                  maxLength={MAX_USERNAME_LENGTH} // L√≠mite de 18
                  required
                />
              </div>

              <div className="password-wrapper">
                 <input
                  type={showPassword ? 'text' : 'password'}
                  placeholder="Contrase√±a"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength="4" 
                  maxLength={MAX_PASSWORD_LENGTH} // L√≠mite de 50
                />
                <span
                  className="password-toggle"
                  onClick={() => setShowPassword(!showPassword)}
                >
                  {showPassword ? 'Ocultar' : 'Mostrar'}
                </span>
              </div>

              <div className="button-group">
                <button type="submit" className="transparent-btn">
                  Entrar
                </button>
              </div>

              <p className="toggle-form">
                ¬øNo tienes cuenta?{' '}
                <span onClick={() => toggleView(false)}>Crear cuenta</span>
              </p>
            </form>
            ) : (
            // --- Formulario de Registro ---
            <form onSubmit={handleRegisterSubmit} className="register-form-view">
              <h2>Crear Cuenta</h2>
              
              {/* --- ¬°CAMBIO! Wrapper para el contador de usuario --- */}
              <div className="input-wrapper">
                <input
                  type="text"
                  className="input-with-counter" /* ¬°Clase nueva! */
                  placeholder="Nombre de usuario"
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  required
                  maxLength={MAX_USERNAME_LENGTH}
                />
                {/* Contador de usuario (DENTRO) */}
                <small className="char-counter-login">
                  {username.length} / {MAX_USERNAME_LENGTH}
                </small>
              </div>

              {/* --- ¬°CAMBIO! Wrapper de Contrase√±a (DENTRO) --- */}
              <div className="password-wrapper">
                <input
                  type={showPassword ? 'text' : 'password'}
                  className="input-with-counter password" /* ¬°Clase nueva! */
                  placeholder="Contrase√±a"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength="6"
                  maxLength={MAX_PASSWORD_LENGTH}
                  title="M√≠nimo 6 caracteres, 1 n√∫mero y 1 car√°cter especial."
                />
                <span
                  className="password-toggle"
                  onClick={() => setShowPassword(!showPassword)}
                >
                  {showPassword ? 'Ocultar' : 'Mostrar'}
                </span>
                {/* Contador de Contrase√±a (DENTRO) */}
                <small className="char-counter-login password">
                  {password.length} / {MAX_PASSWORD_LENGTH}
                </small>
              </div>


              <div className="button-group">
                <button type="submit" className="transparent-btn">
                  Registrarse
                </button>
              </div>

              <p className="toggle-form">
                ¬øYa tienes cuenta?{' '}
                <span onClick={() => toggleView(true)}>Inicia sesi√≥n</span>
              </p>
            </form>
            )}

          {message && <p className="message">{message}</p>}
        </div>
      </div>
    </div>
  );
}

export default LoginPage;

--- marcar_guia_vista.php ---

<?php
// ---- backend/api/marcar_guia_vista.php ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Reutilizado) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
// ... (Pega aqu√≠ todo el bloque de validaci√≥n de token de add_amigo.php) ...
// (Aseg√∫rate de que $usuario_id se establece correctamente)
if ($authHeader) { $arr = explode(" ", $authHeader);
$jwt = $arr[1] ?? null; }
if ($jwt) {
    try { $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
$usuario_id = $decoded->data->id; } 
    catch (Exception $e) { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido."));
die(); }
} else { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}


// --- PASO 2: Obtener qu√© gu√≠a se ha visto ---
$data = json_decode(file_get_contents("php://input"));
if (empty($data->guia_vista)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos. Se requiere 'guia_vista'."));
    die();
}

$guia = $data->guia_vista; // "inicio", "rutina", "records", "comunidad", o "entreno"
$columna_a_actualizar = "";
// Validamos la entrada para evitar inyecci√≥n SQL
if ($guia === 'inicio') {
    $columna_a_actualizar = "ha_visto_guia_inicio";
} elseif ($guia === 'rutina') {
    $columna_a_actualizar = "ha_visto_guia_rutina";
} elseif ($guia === 'records') {
    $columna_a_actualizar = "ha_visto_guia_records";
} elseif ($guia === 'comunidad') {
    $columna_a_actualizar = "ha_visto_guia_comunidad";
} elseif ($guia === 'entreno') { /* <-- ¬°AQU√ç EST√Å EL NUEVO! */
    $columna_a_actualizar = "ha_visto_guia_entreno";
} else {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Nombre de gu√≠a no v√°lido."));
    die();
}

// --- PASO 3: Actualizar la BBDD ---
$database = new Database();
$db = $database->getConnection();
try {
    // Usamos INSERT ... ON DUPLICATE KEY UPDATE para crear la fila en 'perfiles' si no exist√≠a
    $query = "INSERT INTO perfiles (usuario_id, $columna_a_actualizar)
              VALUES (:usuario_id, 1)
              ON DUPLICATE KEY UPDATE
              $columna_a_actualizar = 1";
    $stmt = $db->prepare($query);
    $stmt->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    
    if ($stmt->execute()) {
        http_response_code(200);
        echo json_encode(array("mensaje" => "Gu√≠a marcada como vista."));
    } else {
        throw new Exception("Error al actualizar la base de datos.");
    }

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error en la base de datos.",
        "error" => $e->getMessage()
    ));
}
?>

--- Perfil.css ---

/* ---- frontend/src/Perfil.css ---- */

.perfil-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 800px;
  margin: 0 auto;
}

.perfil-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
}

.perfil-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 2rem;
}

.perfil-form {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 2rem;
  box-shadow: var(--box-shadow);
}

.form-grid-perfil {
  display: grid;
  grid-template-columns: 1fr 1fr; /* Dos columnas por defecto */
  gap: 1.5rem;
}

.form-group-perfil {
  display: flex;
  flex-direction: column;
}

/* Ocupa las dos columnas */
.form-group-perfil.form-span-2 {
  grid-column: 1 / -1;
}

.form-group-perfil label {
  display: block;
  font-weight: 700;
  color: var(--text-secondary-color);
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

/* Reutilizamos estilos de inputs de Global.css o Dashboard.css */
.form-group-perfil input[type="text"],
.form-group-perfil input[type="email"],
.form-group-perfil input[type="tel"], /* A√±adido para tel√©fono */
.form-group-perfil input[type="date"],
.form-group-perfil input[type="number"] {
  width: 100%;
  height: 48px;
  padding: 0 1rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  box-sizing: border-box;
  transition: border-color 0.3s, box-shadow 0.3s;
}

.form-group-perfil input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}

.input-disabled {
  background-color: var(--input-border-color);
  color: var(--text-secondary-color);
  cursor: not-allowed;
}

.form-actions-perfil {
  border-top: 1px solid var(--input-border-color);
  padding-top: 2rem;
  display: flex;
  /* justify-content: flex-end; */ /* <-- Quitamos esto */
  justify-content: center;      /* <-- A√ëADIDO: Centra el bot√≥n horizontalmente */
}

/* Reutilizamos el estilo del bot√≥n transparente global,
   pero podemos darle un ancho m√°ximo si queremos */
.form-actions-perfil .transparent-btn {
   width: auto; /* Ancho autom√°tico por defecto */
   padding-left: 2rem; /* Mantenemos el padding */
   padding-right: 2rem;
   max-width: 300px; /* Opcional: Limita el ancho en pantallas grandes */
}


/* Mensaje de √©xito (verde) */
.message.success {
  background-color: rgba(26, 115, 232, 0.1);
  color: #8ab4f8; /* Un azul/verde claro */
  border: 1px solid #8ab4f8;
  margin-bottom: 1.5rem;
}

/* Media query para m√≥viles (una sola columna y bot√≥n ancho) */
@media (max-width: 600px) {
  .form-grid-perfil {
    grid-template-columns: 1fr;
  }

  /* --- NUEVO: Hacer el bot√≥n ocupar todo el ancho en m√≥vil --- */
  .form-actions-perfil .transparent-btn {
      width: 100%;       /* Ocupa todo el ancho disponible */
      max-width: none;   /* Quitamos el l√≠mite de ancho en m√≥vil */
  }
  /* --- FIN NUEVO --- */
}

--- Perfil.js ---

// ---- frontend/src/Perfil.js (AHORA S√ç, CON onKeyDown + handleChange) ----

import React, { useState, useEffect } from 'react';
import './Perfil.css'; // Aseg√∫rate que la ruta es correcta
import iconoPerfil from './assets/mi-perfil.png';
// Aseg√∫rate que la ruta es correcta

function Perfil() {
  // --- Estados del Componente (sin cambios) ---
  const [formData, setFormData] = useState({
    nombre_usuario: '', correo_electronico: '', telefono: '',
    nombre_real: '', apellidos: '', fecha_nacimiento: '',
    altura_cm: '', peso_kg: '', direccion: ''
  });
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [mensajeExito, setMensajeExito] = useState(null);
  const today = new Date().toISOString().split('T')[0];

  // --- ¬°FUNCI√ìN REINTRODUCIDA! ---
  /**
   * Bloquea la entrada de teclas no deseadas en inputs num√©ricos.
   * @param {Event} e El evento de teclado (onKeyDown)
   * @param {boolean} allowDecimal Si es true, permite '.' y ','
   */
  const handleNumericKeyDown = (e, allowDecimal = false) => {
    // Teclas siempre permitidas: Backspace, Tab, Flechas, Supr, Inicio, Fin
    if ([8, 9, 37, 39, 46, 35, 36].includes(e.keyCode)) {
      return;
    }

    // Bloquear 'e', '+', '-' (signo menos)
    if (['e', 'E', '+', '-'].includes(e.key)) {
      e.preventDefault();
      return;
    }

    // Si NO se permite decimal, bloquear '.' y ','
    if (!allowDecimal && ['.', ','].includes(e.key)) {
      e.preventDefault();
      return;
    }
  };
  // --- FIN FUNCI√ìN REINTRODUCIDA ---

  // --- useEffect para mensajes temporales (sin cambios) ---
  useEffect(() => {
    if (error) {
      const errorTimer = setTimeout(() => {
        setError(null);
      }, 5000); 
      return () => clearTimeout(errorTimer);
    }
  }, [error]);

  useEffect(() => {
    if (mensajeExito) {
      const successTimer = setTimeout(() => {
        setMensajeExito(null);
      }, 3000); 
      return () => clearTimeout(successTimer);
    }
  }, [mensajeExito]);

  // --- useEffect para Cargar Datos Iniciales (sin cambios) ---
  useEffect(() => {
    const cargarPerfil = async () => {
      setLoading(true);
      setError(null); 
      setMensajeExito(null); 
      const token = localStorage.getItem('movium_token');

      if (!token) {
        setError("Error de autenticaci√≥n. Por favor, inicia sesi√≥n de nuevo.");
        setLoading(false);
        return;
      }

      try {
        const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/get_perfil.php', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.mensaje || 'No se pudo cargar el perfil.');
        }

        setFormData({
          nombre_usuario: data.nombre_usuario || '',
          correo_electronico: data.correo_electronico || '',
          telefono: data.telefono || '',
          nombre_real: data.nombre_real || '',
          apellidos: data.apellidos || '',
          fecha_nacimiento: data.fecha_nacimiento || '',
          altura_cm: data.altura_cm || '',
          peso_kg: data.peso_kg || '',
          direccion: data.direccion || ''
        });
      } catch (err) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    };
    cargarPerfil();
  }, []);

  // --- ¬°CAMBIO PRINCIPAL AQU√ç! ---
  // --- Manejador de Cambios en Inputs (AHORA CON VALIDACI√ìN DE LONGITUD Y FORMATO) ---
  const handleChange = (e) => {
    const { name, value } = e.target;
    
    // Limpiar mensajes al escribir
    setError(null);
    setMensajeExito(null);

    // --- REGLAS DE VALIDACI√ìN ---

    if (name === 'altura_cm') {
      // onKeyDown ya ha bloqueado '-', 'e', '.' etc.
      // Solo necesitamos preocuparnos por la longitud m√°xima.
      if (value.length > 3) {
        return; // No actualiza el estado si se excede
      }
      setFormData(prevData => ({ ...prevData, [name]: value }));
      
    } else if (name === 'peso_kg') {
      // onKeyDown ya ha bloqueado '-', 'e', '+'.
      // Solo nos preocupamos por el formato (ej: 123.45) y la longitud.
      
      // Esta regex permite:
      // - Un string vac√≠o
      // - Hasta 3 d√≠gitos enteros (ej: 123)
      // - Hasta 3 d√≠gitos, un punto/coma, y hasta 2 decimales (ej: 123.45)
      const regexPeso = /^(|\d{1,3}([.,]\d{0,2})?)$/;
      
      // Comprobamos la regex Y la longitud total (incluyendo el punto/coma)
      if (regexPeso.test(value) && value.length <= 6) {
        // Estandariza la coma a un punto para el estado
        const standardizedValue = value.replace(',', '.');
        setFormData(prevData => ({ ...prevData, [name]: standardizedValue }));
      }
      // Si no cumple (ej: 70.555 o 1234.5), no actualiza el estado
      // (Evita que escribas el 3er decimal o el 4¬∫ d√≠gito entero)

    } else {
      // Comportamiento normal para el resto de inputs (que usan maxLength HTML)
      setFormData(prevData => ({ ...prevData, [name]: value }));
    }
  };
  // --- FIN DEL CAMBIO ---

  // --- Manejador de Env√≠o del Formulario (sin cambios) ---
  const handleSubmit = async (e) => {
    e.preventDefault(); 
    setError(null); 
    setMensajeExito(null);
    const token = localStorage.getItem('movium_token');
    
    // Validaciones (sin cambios, ya las ten√≠as)
    try {
      if (formData.correo_electronico && !/\S+@\S+\.\S+/.test(formData.correo_electronico)) {
        throw new Error("Por favor, introduce un formato de correo v√°lido.");
      }
      if (formData.telefono && (formData.telefono.length < 9 || formData.telefono.length > 15 || !/^\d+$/.test(formData.telefono))) {
         throw new Error("El formato del tel√©fono no es v√°lido (debe tener entre 9 y 15 d√≠gitos num√©ricos).");
      }
      if (formData.altura_cm && (formData.altura_cm < 50 || formData.altura_cm > 300)) {
         throw new Error("La altura debe estar entre 50 y 300 cm.");
      }
      if (formData.peso_kg && (formData.peso_kg < 30 || formData.peso_kg > 300)) {
         throw new Error("El peso debe estar entre 30 y 300 kg.");
      }
      if (formData.nombre_real && formData.nombre_real.length > 100) {
        throw new Error("El nombre no puede tener m√°s de 100 caracteres.");
      }
       if (formData.apellidos && formData.apellidos.length > 150) {
        throw new Error("Los apellidos no pueden tener m√°s de 150 caracteres.");
      }
       if (formData.direccion && formData.direccion.length > 255) {
        throw new Error("La direcci√≥n no puede tener m√°s de 255 caracteres.");
      }

      const dataToSend = { ...formData };
      
      const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/update_perfil.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(dataToSend)
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.mensaje || 'Error al guardar el perfil.');
      }
      setMensajeExito(data.mensaje || "Perfil actualizado con √©xito.");
    } catch (err) {
      setError(err.message);
    }
  };

  // --- Renderizado Condicional (Loading) ---
  if (loading) {
    return (
      <div className="perfil-container">
        <p className="subtitle" style={{ textAlign: 'center' }}>Cargando perfil...</p>
      </div>
    );
  }

  // --- Renderizado Principal ---
  return (
    <div className="perfil-container">

      {/* Cabecera con Icono y T√≠tulos */}
      <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
        <img src={iconoPerfil} alt="" width="64" height="64" />
        <h2>Mi Perfil</h2>
      </div>
      <p className="subtitle" style={{ textAlign: 'center' }}>
        Actualiza tu informaci√≥n personal y de contacto.
       </p>

      {/* Formulario */}
      <form className="perfil-form" onSubmit={handleSubmit}>

        {/* Grid para los campos del formulario */}
        <div className="form-grid-perfil">

          {/* Nombre de Usuario (Deshabilitado) */}
          <div className="form-group-perfil form-span-2">
            <label htmlFor="nombre_usuario">Nombre de Usuario (no se puede cambiar)</label>
             <input
              type="text"
              id="nombre_usuario"
              name="nombre_usuario"
              value={formData.nombre_usuario}
              readOnly
              className="input-disabled"
            />
           </div>

          {/* Correo Electr√≥nico */}
          <div className="form-group-perfil form-span-2">
            <label htmlFor="correo_electronico">Correo Electr√≥nico</label>
            <input
              type="email"
              id="correo_electronico"
              name="correo_electronico"
              value={formData.correo_electronico}
              onChange={handleChange}
              placeholder="tu@correo.com"
              maxLength="100" 
            />
           </div>

          {/* Tel√©fono */}
           <div className="form-group-perfil">
            <label htmlFor="telefono">Tel√©fono</label>
            <input
              type="tel"
              id="telefono"
              name="telefono"
              value={formData.telefono}
               onChange={handleChange}
              placeholder="Tu n√∫mero de tel√©fono"
              minLength="9"
              maxLength="15" 
              pattern="\d*" 
            />
          </div>

        
           {/* Fecha de Nacimiento */}
           <div className="form-group-perfil">
            <label htmlFor="fecha_nacimiento">Fecha de Nacimiento</label>
            <input
              type="date"
              id="fecha_nacimiento"
              name="fecha_nacimiento"
               value={formData.fecha_nacimiento}
              onChange={handleChange}
              max={today} 
            />
          </div>

          {/* Nombre Real */}
          <div className="form-group-perfil">
            <label htmlFor="nombre_real">Nombre</label>
           <input
              type="text"
              id="nombre_real"
              name="nombre_real"
              value={formData.nombre_real}
              onChange={handleChange}
              placeholder="Tu nombre"
              maxLength="100" 
            />
          </div>

          {/* Apellidos */}
          <div className="form-group-perfil">
            <label htmlFor="apellidos">Apellidos</label>
            <input
              type="text"
               id="apellidos"
              name="apellidos"
              value={formData.apellidos}
              onChange={handleChange}
              placeholder="Tus apellidos"
              maxLength="150" 
            />
           </div>

           {/* Altura */}
           <div className="form-group-perfil">
            <label htmlFor="altura_cm">Altura (cm)</label>
            <input
              type="number" // Mantenemos type="number" por el teclado num√©rico en m√≥viles
              id="altura_cm"
              name="altura_cm"
               value={formData.altura_cm}
              onChange={handleChange} // ¬°Validaci√≥n al cambiar!
              placeholder="Tu altura"
              min="50" 
              max="300" 
              step="1" 
              onKeyDown={(e) => handleNumericKeyDown(e, false)} // ¬°Bloqueo de teclas!
            />
          </div>

           {/* Peso */}
          <div className="form-group-perfil">
            <label htmlFor="peso_kg">Peso (kg)</label>
            <input
              type="number" // Mantenemos type="number"
              id="peso_kg"
              name="peso_kg"
              value={formData.peso_kg}
               onChange={handleChange} // ¬°Validaci√≥n al cambiar!
              placeholder="Tu peso"
              min="30"  
              max="300" 
              step="0.01" 
              onKeyDown={(e) => handleNumericKeyDown(e, true)} // ¬°Bloqueo de teclas!
            />
           </div>
           {/* --- FIN DEL CAMBIO --- */}


          {/* Direcci√≥n */}
          <div className="form-group-perfil form-span-2">
            <label htmlFor="direccion">Direcci√≥n</label>
            <input
              type="text"
              id="direccion"
              name="direccion"
               value={formData.direccion}
              onChange={handleChange}
              placeholder="Tu direcci√≥n"
              maxLength="255" 
            />
          </div>

        </div> {/* Fin del form-grid-perfil */}

        {/* --- Zona de Mensajes (sin cambios) --- */}
        <div style={{ marginTop: '1.5rem', marginBottom: '0.5rem', minHeight: '2.5rem' }}> 
          {error && <div className="message">{error}</div>}
          {mensajeExito && <div className="message success">{mensajeExito}</div>}
        </div>
        {/* --- FIN MENSAJES --- */}


        {/* Bot√≥n Guardar Cambios */}
        <div className="form-actions-perfil">
          <button type="submit" className="transparent-btn">
             Guardar Cambios
           </button>
        </div>

      </form> {/* Fin del perfil-form */}
    </div> // Fin del perfil-container
  );
}

export default Perfil;

--- RankingCard.css ---

/* ---- frontend/src/components/RankingCard.css (NUEVO ARCHIVO) ---- */

.ranking-podium-card {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* Para que el header se vea bien */
}

/* Cabecera (T√≠tulo del ejercicio) */
.ranking-podium-header {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--input-border-color);
  background-color: var(--input-bg-color); /* Un fondo m√°s oscuro */
}

.ranking-podium-header strong {
  font-size: 1.1rem;
  color: var(--text-color);
}

/* Cuerpo (Lista del podio) */
.ranking-podium-body {
  padding: 1rem 1.25rem;
}

.podium-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 1rem; /* Espacio entre el 1¬∫, 2¬∫ y 3¬∫ */
}

.podium-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px dashed var(--input-border-color);
}
.podium-item:last-child {
  padding-bottom: 0;
  border-bottom: none;
}

/* Posici√≥n y Medalla */
.podium-pos {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-secondary-color);
  width: 40px;
  text-align: center;
  flex-shrink: 0;
}

/* Nombre de usuario */
.podium-user {
  flex-grow: 1;
  font-size: 1.1rem;
  color: var(--text-color);
  font-weight: 700;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Valor (100 kg, 10 km) */
.podium-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--text-color);
  flex-shrink: 0;
  text-align: right;
}

.podium-label {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  margin-left: 0.25rem;
}

/* ¬°Clave! Resaltar tu propia puntuaci√≥n */
.podium-item.is-me {
  background-color: var(--input-bg-color);
  margin: -0.5rem -0.75rem;
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  border-bottom: none; /* Quitamos el dashed */
}

.podium-item.is-me .podium-pos,
.podium-item.is-me .podium-user,
.podium-item.is-me .podium-value {
  color: var(--primary-color);
}
.podium-item.is-me .podium-label {
  color: var(--primary-color);
  opacity: 0.8;
}


/* Mensaje de "Sin Datos" */
.podium-no-data {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  text-align: center;
  font-style: italic;
  padding: 1rem 0;
  margin: 0;
}

--- RankingCard.js ---

// ---- frontend/src/components/RankingCard.js (NUEVO ARCHIVO) ----

import React from 'react';
import './RankingCard.css'; // Crearemos este CSS

// Array de medallas para el Top 3
const MEDALLAS = ['ü•á', 'ü•à', 'ü•â'];

function RankingCard({ title, data, miUsuarioId, labelOverride = null }) {

  // Comprueba si hay datos o si est√° vac√≠o
  const hayDatos = data && data.length > 0;

  return (
    <div className="ranking-podium-card">
      <div className="ranking-podium-header">
        <strong>{title}</strong>
      </div>
      <div className="ranking-podium-body">
        {hayDatos ? (
          <ol className="podium-list">
            {data.map((item, index) => {
              // Comprobamos si esta fila es del usuario logueado
              const esUsuarioLogueado = item.usuario_id == miUsuarioId;
              
              return (
                <li 
                  key={item.usuario_id} 
                  className={`podium-item ${esUsuarioLogueado ? 'is-me' : ''}`}
                >
                  <span className="podium-pos">{MEDALLAS[index] || `${index + 1}.`}</span>
                  <span className="podium-user">
                    {item.nombre_usuario} {esUsuarioLogueado && '(T√∫)'}
                  </span>
                  <span className="podium-value">
                    {/* Usamos el 'valor' y la 'label' que nos da el PHP.
                      (p.ej. 100 kg, 10.5 km, 25 min, 14.2 km/h)
                    */}
                    {item.valor || 0}
                    <span className="podium-label">{labelOverride || item.label}</span>
                  </span>
                </li>
              );
            })}
          </ol>
        ) : (
          <p className="podium-no-data">
            A√∫n no hay r√©cords para este ejercicio entre tus amigos.
          </p>
        )}
      </div>
    </div>
  );
}

export default RankingCard;

--- register.php ---

<?php
// ---- backend/api/register.php (MODIFICADO con Auto-Login y Validaci√≥n) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST");
header("Access-Control-Max-Age: 3600");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
// --- ¬°A√±adido JWT! ---
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;

$db = new Database();
$conn = $db->getConnection();
$data = json_decode(file_get_contents("php://input"));

// 1. Comprobamos que los datos no est√©n vac√≠os
if (
    !empty($data->nombre_usuario) &&
    !empty($data->password)
) {
    
    // 2. Limpiamos los datos
    $nombre_usuario = htmlspecialchars(strip_tags($data->nombre_usuario));
    $password_limpia = htmlspecialchars(strip_tags($data->password));

    // 3. --- ¬°NUEVO! Validaci√≥n de longitud de usuario ---
    // Usamos mb_strlen para contar correctamente caracteres multibyte (como tildes o √±)
    if (mb_strlen($nombre_usuario, 'UTF-8') > 18) {
        http_response_code(400); // Bad Request
        echo json_encode(array("mensaje" => "El nombre de usuario no puede tener m√°s de 18 caracteres."));
        die(); // Detiene la ejecuci√≥n
    }
    // --- FIN VALIDACI√ìN USUARIO ---

    // 3. --- ¬°NUEVO! Validaci√≥n de longitud de contrase√±a ---
    if (strlen($password_limpia) > 50) {
        http_response_code(400); // Bad Request
        echo json_encode(array("mensaje" => "La contrase√±a no puede tener m√°s de 50 caracteres."));
        die(); // Detiene la ejecuci√≥n
    }
    // --- FIN VALIDACI√ìN CONTRASE√ëA ---

    // 3. --- Validaci√≥n de complejidad de contrase√±a (YA LA TEN√çAS) ---
    $min_longitud = 6; // Definimos una longitud m√≠nima

    if (strlen($password_limpia) < $min_longitud) {
        http_response_code(400); // Bad Request
        echo json_encode(array("mensaje" => "La contrase√±a debe tener al menos $min_longitud caracteres."));
        die(); // Detiene la ejecuci√≥n
    }
    // Comprueba si hay al menos un n√∫mero
    if (!preg_match('/[0-9]/', $password_limpia)) {
        http_response_code(400);
        echo json_encode(array("mensaje" => "La contrase√±a debe contener al menos un n√∫mero."));
        die();
    }
    // Comprueba si hay al menos un car√°cter especial (cualquier cosa que no sea letra o n√∫mero)
    if (!preg_match('/\W/', $password_limpia)) {
        http_response_code(400);
        echo json_encode(array("mensaje" => "La contrase√±a debe contener al menos un car√°cter especial (ej: !@#$...)."));
        die();
    }
    // --- FIN VALIDACI√ìN ---


    // 4. Verificamos si el usuario ya existe
    $check_query = "SELECT id FROM usuarios WHERE nombre_usuario = :nombre_usuario LIMIT 1";
    $check_stmt = $conn->prepare($check_query);
    $check_stmt->bindParam(':nombre_usuario', $nombre_usuario);
    $check_stmt->execute();

    if ($check_stmt->rowCount() > 0) {
        http_response_code(409); // 409 Conflict
        echo json_encode(array("mensaje" => "Ese nombre de usuario ya est√° en uso."));
    } else {
        // 5. Si no existe, procedemos a insertar
        
        // Hasheamos la contrase√±a
        $password_hash = password_hash($password_limpia, PASSWORD_BCRYPT);
        
        $query = "INSERT INTO usuarios (nombre_usuario, password_hash) VALUES (:nombre_usuario, :password_hash)";
        
        $stmt = $conn->prepare($query);

        $stmt->bindParam(':nombre_usuario', $nombre_usuario);
        $stmt->bindParam(':password_hash', $password_hash);

        if ($stmt->execute()) {
            
            // --- ¬°NUEVO! Generar Token (L√≥gica de login.php) ---
            
            // Obtenemos el ID del usuario que acabamos de crear
            $id_nuevo_usuario = $conn->lastInsertId();
            
            $secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
            $token_payload = array(
                "iat" => time(),
                "exp" => time() + (24 * 60 * 60), // 24 horas
                "data" => array(
                     "id" => $id_nuevo_usuario,
                     "nombre_usuario" => $nombre_usuario // Ya lo tenemos de $data
                )
            );

            http_response_code(201); // 201 Created
            $jwt = JWT::encode($token_payload, $secret_key, 'HS256');

            // Devolvemos la misma estructura que login.php
            echo json_encode(array(
                "token" => $jwt,
                "usuario" => array(
                    "id" => $id_nuevo_usuario,
                    "nombre_usuario" => $nombre_usuario,
                    // A√±adimos los flags de gu√≠as por defecto para el nuevo usuario
                    "ha_visto_guia_inicio" => false,
                    "ha_visto_guia_rutina" => false,
                    "ha_visto_guia_records" => false,
                    "ha_visto_guia_comunidad" => false,
                    "ha_visto_guia_entreno" => false
                )
            ));
            // --- FIN CAMBIO ---

        } else {
            // Error gen√©rico si la inserci√≥n falla
            http_response_code(503); // 503 Service Unavailable
            echo json_encode(array("mensaje" => "No se pudo registrar al usuario. Error del servidor."));
        }
    }
} else {
    // Error si faltan datos
    http_response_code(400); // 400 Bad Request
    echo json_encode(array("mensaje" => "Datos incompletos. Faltan usuario o contrase√±a."));
}
?>

--- RegistrarSerieModal.css ---

/* ---- frontend/src/components/RegistrarSerieModal.css (COMPLETO V6.0 - Focus Fix) ---- */

/* ====================================================== */
/* 1. ESTILOS GEN√âRICOS DE MODAL */
/* ====================================================== */

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  width: 90%;
  max-width: 500px;
  height: auto;
  max-height: 90vh;
  box-shadow: var(--box-shadow);
  display: flex;
  flex-direction: column;
  animation: slideIn 0.3s ease-out;
  overflow: hidden;
}

@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--input-border-color);
  flex-shrink: 0;
}

.modal-header h3 { margin: 0; font-size: 1.25rem; }
.modal-close-btn { background: none; border: none; font-size: 2rem; color: var(--text-secondary-color); cursor: pointer; line-height: 1; padding: 0; }
.modal-close-btn:hover { color: var(--text-color); }


/* ====================================================== */
/* 2. ESTILOS DEL FORMULARIO DE REGISTRO DE SERIE */
/* ====================================================== */

.modal-form {
  padding: 1.5rem;
  overflow-y: auto;
  flex-grow: 1;
  scrollbar-width: thin;
  scrollbar-color: var(--input-border-color) var(--input-bg-color);
}
.modal-form::-webkit-scrollbar { width: 8px; }
.modal-form::-webkit-scrollbar-track { background: var(--input-bg-color); border-radius: 4px; }
.modal-form::-webkit-scrollbar-thumb { background-color: var(--input-border-color); border-radius: 4px; border: 2px solid var(--input-bg-color); }
.modal-form::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary-color); }


.objetivo-texto {
  font-size: 1rem;
  font-style: italic;
  color: var(--text-secondary-color);
  text-align: center;
  margin-top: 0;
  margin-bottom: 1.5rem;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--input-border-color);
}

/* Grid para inputs principales */
.form-grid-registro {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

/* Estilos gen√©ricos para grupos de inputs */
.form-group-small {
  display: flex;
  flex-direction: column;
}
.form-group-small label {
  display: block;
  font-weight: 700;
  color: var(--text-secondary-color);
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

/* Estilos para inputs, select y textarea */
.form-group-small input[type="text"],
.form-group-small input[type="number"],
.form-group-small select,
.form-group-small textarea {
  width: 100%;
  height: 48px;
  padding: 0 0.8rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  box-sizing: border-box;
  transition: border-color 0.3s, box-shadow 0.3s;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

.input-disabled {
  background-color: var(--input-border-color);
  color: var(--text-secondary-color);
  cursor: not-allowed;
}

.form-group-small textarea {
  height: auto;
  padding-top: 0.8rem;
  min-height: 80px;
  resize: vertical;
}

.form-group-small input:focus,
.form-group-small select:focus,
.form-group-small textarea:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}

/* --- ESTILO V6.0 PARA CHECKBOX (Focus Fix) --- */
.form-group-checkbox {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-top: 1.5rem;
  cursor: pointer;
  padding: 0.5rem 0;
  border-radius: 6px;
  transition: background-color 0.2s ease;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.form-group-checkbox:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.form-group-checkbox input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--primary-color);
  cursor: pointer;
  margin: 0;
  flex-shrink: 0;
  padding: 0;
  border-radius: 0;
  border: none;
  background-color: transparent;
  appearance: checkbox;
}
/* QUITA EL OUTLINE AZUL/NEGRO POR DEFECTO */
.form-group-checkbox input[type="checkbox"]:focus {
    outline: none; /* Quita el recuadro feo */
}
/* Estilo adicional para navegadores Webkit (Chrome, Safari) */
.form-group-checkbox input[type="checkbox"]:focus-visible {
     outline: none;
     box-shadow: 0 0 0 2px rgba(0, 170, 255, 0.3);
}


.form-group-checkbox label {
  margin-bottom: 0;
  font-weight: normal;
  color: var(--text-color);
  font-size: 0.95rem;
  cursor: pointer;
  line-height: 1.2;
}
/* --- FIN ESTILO CHECKBOX --- */


/* Footer del modal (centrado) */
.modal-footer {
  display: flex;
  justify-content: center;
  gap: 1rem;
  padding: 1.5rem;
  margin-top: 1.5rem;
  border-top: 1px solid var(--input-border-color);
  flex-shrink: 0;
}

/* Clase de error */
.message {
  margin-bottom: 1rem;
  padding: 0.8rem;
  border-radius: 5px;
  font-weight: 700;
  text-align: center;
  background-color: rgba(217, 48, 37, 0.1);
  color: #d93025;
  border: 1px solid #d93025;
}

/* ====================================================== */
/* 3. ESTILOS PARA EL RESUMEN (EN RESUMENFINALMODAL) */
/* ====================================================== */

/* Contenedor con scroll */
.resumen-container {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--input-border-color);
  flex-grow: 1;
  overflow-y: auto;
  max-height: 30vh;
  padding-right: 0.5rem;
  scrollbar-width: thin;
  scrollbar-color: var(--input-border-color) var(--input-bg-color);
}
.resumen-container::-webkit-scrollbar { width: 8px; }
.resumen-container::-webkit-scrollbar-track { background: var(--input-bg-color); border-radius: 4px; }
.resumen-container::-webkit-scrollbar-thumb { background-color: var(--input-border-color); border-radius: 4px; border: 2px solid var(--input-bg-color); }
.resumen-container::-webkit-scrollbar-thumb:hover { background-color: var(--text-secondary-color); }

.resumen-container h4 {
  margin-top: 0;
  margin-bottom: 1rem;
  color: var(--text-color);
  text-align: center;
}

/* Grupo de cada ejercicio */
.resumen-ejercicio-grupo {
  margin-bottom: 1.25rem;
  padding-bottom: 0.75rem;
}
.resumen-ejercicio-grupo:last-child {
  margin-bottom: 0;
  border-bottom: none;
}

/* Cabecera del ejercicio (nombre) */
.resumen-ejercicio-header {
  margin-bottom: 0.5rem;
  padding: 0.2rem 0.5rem;
  background-color: var(--input-bg-color);
  border-radius: 4px;
}
.resumen-ejercicio-header strong {
  font-size: 1.05rem;
  color: var(--text-color);
}

/* Lista de series dentro de un ejercicio */
.resumen-series-lista {
  list-style: none;
  padding: 0;
  margin: 0 0 0 0.5rem;
}

.resumen-series-lista li {
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--input-border-color);
}
.resumen-series-lista li:last-child {
  border-bottom: none;
}

/* Contenedor para los detalles de la serie */
.resumen-serie-detalle {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  font-size: 0.9rem;
  color: var(--text-color);
  flex-wrap: wrap;
}
.resumen-serie-detalle span:first-child {
  color: var(--text-secondary-color);
  flex-shrink: 0;
}
/* Soluci√≥n: A√±adimos "span" para aumentar la especificidad */
.resumen-serie-detalle span .fallo-tag {
    background-color: var(--primary-color);
    color: #fff; 
    font-size: 0.75rem;
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    font-weight: bold;
    margin-left: 0.5rem;
    white-space: nowrap;
}

/* Nota de la serie */
.resumen-serie-nota {
  font-size: 0.85rem;
  color: var(--text-secondary-color);
  margin: 0.3rem 0 0 0.5rem;
  padding-top: 0.3rem;
  word-break: break-word;
}

/* Mensaje de vac√≠o */
.resumen-vacio {
  text-align: center;
  color: var(--text-secondary-color);
  font-style: italic;
  padding: 1rem 0;
}

--- RegistrarSerieModal.js ---

// ---- frontend/src/components/RegistrarSerieModal.js (CORREGIDO - Funci√≥n a√±adida) ----

import React, { useState, useEffect } from 'react';
import './RegistrarSerieModal.css';

// --- Funci√≥n de formateo V6.0 (Usa SIEMPRE el objetivo original para el texto) ---
const formatObjetivoText = (objOriginal, tipo) => {
  // Asegurarse de que objOriginal no sea undefined o null
  if (!objOriginal) return "Objetivo no definido";
  if (tipo === 'cardio') {
    const metricas = [];
    if (objOriginal.tiempo_min_objetivo != null) metricas.push(`${objOriginal.tiempo_min_objetivo} min`);
    if (objOriginal.distancia_km_objetivo != null) metricas.push(`${objOriginal.distancia_km_objetivo} km`);
    if (metricas.length === 0) return "Objetivo: Registrar cardio";
    // Une con " y " o ", "
    if (metricas.length > 2) {
        return `Objetivo: ${metricas.slice(0, -1).join(', ')} y ${metricas.slice(-1)}`;
    } else {
        return `Objetivo: ${metricas.join(' y ')}`;
    }
  }

  // L√≥gica Fuerza V6.0 (usa objOriginal)
  let repStr = "";
  if (objOriginal.tipo_rep_objetivo === 'fallo') {
    repStr = "Al Fallo";
  } else if (objOriginal.tipo_rep_objetivo === 'rango') {
    repStr = `${objOriginal.reps_min_objetivo ?? '?'} - ${objOriginal.reps_max_objetivo ?? '?'} reps`; // Usamos guion
  } else { // 'fijo'
    repStr = `${objOriginal.reps_min_objetivo ?? '?'} reps`;
  }

  let pesoStr = objOriginal.peso_kg_objetivo != null ? ` con ${objOriginal.peso_kg_objetivo} kg` : '';
  return `Objetivo: ${repStr}${pesoStr}`;
};

// --- ¬°¬°NUEVO!! Definici√≥n de formatObjetivoNatural ---
const formatObjetivoNatural = (obj, tipo) => {
  if (!obj) return ''; // Seguridad

  if (tipo === 'cardio') {
    const metricas = [];
    if (obj.tiempo_min_objetivo) metricas.push(`${obj.tiempo_min_objetivo} min`);
    if (obj.distancia_km_objetivo) metricas.push(`${obj.distancia_km_objetivo} km`);

    // Une con " y " o ", " seg√∫n cu√°ntos elementos haya
    if (metricas.length > 2) {
        // (Esta l√≥gica ya no es necesaria con 2 campos, pero no hace da√±o)
        return metricas.slice(0, -1).join(', ') + ' y ' + metricas.slice(-1);
    } else {
        return metricas.join(' y ');
    }
  }

  // L√≥gica Fuerza V6.0 (Lenguaje Natural)
  let textoPrincipal = "";
  if (obj.tipo_rep_objetivo === 'fallo') {
    textoPrincipal = "Al Fallo";
  } else if (obj.tipo_rep_objetivo === 'rango') {
    textoPrincipal = `${obj.reps_min_objetivo || '?'}-${obj.reps_max_objetivo || '?'} reps`;
  } else { // 'fijo'
    textoPrincipal = `${obj.reps_min_objetivo || '?'} reps`;
  }

  // A√±adir peso con "con"
  if (obj.peso_kg_objetivo != null) {
    textoPrincipal += ` con ${obj.peso_kg_objetivo} kg`;
  }

  // A√±adir descanso (lo dejamos entre par√©ntesis como antes, es claro)
  if (obj.descanso_seg_post != null) {
    textoPrincipal += ` (${obj.descanso_seg_post}s)`;
  }

  return textoPrincipal;
};
// --- FIN NUEVO ---


// --- Funci√≥n para formatear el Tooltip (m√°s detallado) ---
const formatTooltip = (objetivo, serieReal, tipo) => {
    // La llamada a formatObjetivoNatural ahora funciona porque est√° definida arriba
    let tooltip = `Objetivo: ${formatObjetivoNatural(objetivo, tipo)}`;
    if (serieReal) {
        tooltip += "\n---\nRealizado:";
        if (tipo === 'cardio') {
            if (serieReal.tiempo_min_realizado != null) tooltip += ` ${serieReal.tiempo_min_realizado} min`;
            if (serieReal.distancia_km_realizada != null) {
                tooltip += (serieReal.tiempo_min_realizado != null) ?
                ` y ${serieReal.distancia_km_realizada} km` : ` ${serieReal.distancia_km_realizada} km`;
            }
        } else { // Fuerza
            tooltip += ` ${serieReal.repeticiones_realizadas ?? '?'} reps`;
            if (serieReal.fue_al_fallo) tooltip += ` (¬°Al Fallo!)`;
            if (serieReal.peso_kg_usado != null) tooltip += ` con ${serieReal.peso_kg_usado} kg`;
        }
        if (serieReal.notas_serie) tooltip += `\nNotas: ${serieReal.notas_serie}`;
    }
    return tooltip;
};

function RegistrarSerieModal({ isOpen, onClose, datosSerie, onGuardar }) {
  // ... (Resto del componente sin cambios) ...
  // Estados
  const [reps, setReps] = useState('');
  const [peso, setPeso] = useState('');
  const [fueAlFallo, setFueAlFallo] = useState(false);
  const [tiempo, setTiempo] = useState('');
  const [dist, setDist] = useState('');
  const [apiError, setApiError] = useState(null);
  const [objetivoTexto, setObjetivoTexto] = useState("Objetivo:");
  const [notas, setNotas] = useState('');
  const MAX_NOTAS_LENGTH = 1000;

  // useEffect para cargar datos
  useEffect(() => {
    if (isOpen && datosSerie && datosSerie.objetivoOriginal) {
      const { objetivoOriginal, datosGuardados, tipo } = datosSerie;
      setObjetivoTexto(formatObjetivoText(objetivoOriginal, tipo));
      const fuenteDatosInputs = datosGuardados || objetivoOriginal;
      if(tipo === 'cardio') {
        setTiempo(fuenteDatosInputs.tiempo_min_realizado ?? fuenteDatosInputs.tiempo_min_objetivo ?? '');
        setDist(fuenteDatosInputs.distancia_km_realizada ?? fuenteDatosInputs.distancia_km_objetivo ?? '');
        setReps(''); setPeso(''); setFueAlFallo(false);
      } else {
        setReps(String(fuenteDatosInputs.repeticiones_realizadas ?? objetivoOriginal.reps_min_objetivo ?? ''));
        setPeso(String(fuenteDatosInputs.peso_kg_usado ?? objetivoOriginal.peso_kg_objetivo ?? ''));
        setFueAlFallo(fuenteDatosInputs.fue_al_fallo ?? (objetivoOriginal.tipo_rep_objetivo === 'fallo'));
        setTiempo(''); setDist('');
      }
      setNotas(datosGuardados?.notas_serie || datosSerie.notas || '');
      setApiError(null);
    } else if (!isOpen) {
       setReps(''); setPeso(''); setFueAlFallo(false);
       setTiempo(''); setDist('');
       setNotas(''); setApiError(null); setObjetivoTexto("Objetivo:");
    }
  }, [isOpen, datosSerie]);

  // Handler del Submit
  const handleSubmit = (e) => {
    e.preventDefault();
    setApiError(null);
    if (!datosSerie) return;
    const { tipo } = datosSerie;
    let datosFinales = { notas };
    if (tipo === 'cardio') {
      if (!tiempo && !dist) {
        setApiError("Debes registrar al menos un valor cardio."); return;
      }
      datosFinales = { ...datosFinales, tiempo: tiempo || null, dist: dist || null };
    } else {
      const repsNum = parseFloat(reps);
      if (isNaN(repsNum) || repsNum < 0) {
        setApiError("Las repeticiones deben ser un n√∫mero v√°lido (0 o m√°s)."); return;
      }
      const pesoNum = parseFloat(peso);
      if (peso !== '' && peso !== null && (isNaN(pesoNum) || pesoNum < 0)) {
        setApiError("El peso no puede ser negativo."); return;
      }
      datosFinales = {
        ...datosFinales,
        reps: parseInt(reps, 10),
        fue_al_fallo: fueAlFallo,
        peso: (peso === '' || peso === null) ? null : parseFloat(peso)
      };
    }
    onGuardar(datosFinales);
  };

  // Handler para notas
  const handleNotasChange = (e) => {
    if (e.target.value.length <= MAX_NOTAS_LENGTH) {
      setNotas(e.target.value);
    }
  };

  if (!isOpen || !datosSerie) { return null; }
  const ejercicio = datosSerie.ejercicio || { nombre_ejercicio: "Ejercicio desconocido" };
  const numSerie = datosSerie.numSerie;
  const tipo = datosSerie.tipo;

  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        <div className="modal-header">
          <h3>{ejercicio.nombre_ejercicio} - Serie {numSerie}</h3>
          <button className="modal-close-btn" onClick={onClose}>&times;</button>
        </div>
        <form className="modal-form" onSubmit={handleSubmit}>
          <p className="objetivo-texto">{objetivoTexto}</p>
          {apiError && <div className="message" style={{marginBottom: '1rem'}}>{apiError}</div>}
          {tipo === 'cardio' ? (
            <div className="form-grid-registro" style={{gridTemplateColumns: '1fr 1fr'}}>
               <div className="form-group-small">
                <label>Tiempo (min)</label>
                <input type="number" min="0" value={tiempo} onChange={(e) => setTiempo(e.target.value)} placeholder="0" />
               </div>
              <div className="form-group-small">
                <label>Distancia (km)</label>
                <input type="number" step="0.1" min="0" value={dist} onChange={(e) => setDist(e.target.value)} placeholder="0.0"/>
              </div>
            </div>
          ) : (
            <>
              <div className="form-grid-registro">
                <div className="form-group-small">
                  <label>Reps Realizadas</label>
                  <input type="number" min="0" value={reps} onChange={(e) => setReps(e.target.value)} required placeholder="0"/>
                </div>
                <div className="form-group-small">
                  <label>Peso Usado (kg)</label>
                  <input type="number" step="0.5" min="0" value={peso} onChange={(e) => setPeso(e.target.value)} placeholder="0.0"/>
                </div>
              </div>
              <div className="form-group-checkbox">
                 <input type="checkbox" id={`fallo_check_${numSerie}`} checked={fueAlFallo} onChange={(e) => setFueAlFallo(e.target.checked)} />
                 <label htmlFor={`fallo_check_${numSerie}`}>Marcar como serie al fallo</label>
              </div>
            </>
          )}
          <div className="form-group-small" style={{marginTop: '1rem'}}>
            <label htmlFor={`notas_serie_${numSerie}`}>Notas (opcional)</label>
            <textarea
              id={`notas_serie_${numSerie}`}
              value={notas}
              onChange={handleNotasChange}
              placeholder="Ej: Buenas sensaciones..."
              rows="3"
              maxLength={MAX_NOTAS_LENGTH}
            />
            <small style={{ textAlign: 'right', color: 'var(--text-secondary-color)', marginTop: '0.25rem' }}>
              {notas.length} / {MAX_NOTAS_LENGTH}
            </small>
          </div>
          <div className="modal-footer">
             <button type="submit" className="transparent-btn">Guardar Serie</button>
          </div>
        </form>
      </div>
    </div>
  );
}

export default RegistrarSerieModal;

--- ResumenFinalModal.js ---

// ---- frontend/src/components/ResumenFinalModal.js (CORREGIDO - Funci√≥n a√±adida) ----

import React, { useState } from 'react';
import './RegistrarSerieModal.css'; // Mantenemos el CSS compartido

// --- ¬°¬°NUEVO!! Definici√≥n de formatObjetivoNatural ---
// (Copiada de WorkoutSession.js o RegistrarSerieModal.js)
const formatObjetivoNatural = (obj, tipo) => {
  if (!obj) return ''; // Seguridad

  if (tipo === 'cardio') {
    const metricas = [];
    if (obj.tiempo_min_objetivo) metricas.push(`${obj.tiempo_min_objetivo} min`);
    if (obj.distancia_km_objetivo) metricas.push(`${obj.distancia_km_objetivo} km`);

    if (metricas.length > 2) {
        return metricas.slice(0, -1).join(', ') + ' y ' + metricas.slice(-1);
    } else {
        return metricas.join(' y ');
    }
  }

  // L√≥gica Fuerza V6.0 (Lenguaje Natural)
  let textoPrincipal = "";
  if (obj.tipo_rep_objetivo === 'fallo') {
    textoPrincipal = "Al Fallo";
  } else if (obj.tipo_rep_objetivo === 'rango') {
    textoPrincipal = `${obj.reps_min_objetivo || '?'}-${obj.reps_max_objetivo || '?'} reps`;
  } else { // 'fijo'
    textoPrincipal = `${obj.reps_min_objetivo || '?'} reps`;
  }

  if (obj.peso_kg_objetivo != null) {
    textoPrincipal += ` con ${obj.peso_kg_objetivo} kg`;
  }

  if (obj.descanso_seg_post != null) {
    textoPrincipal += ` (${obj.descanso_seg_post}s)`;
  }

  return textoPrincipal;
};
// --- FIN NUEVO ---


function ResumenFinalModal({ isOpen, onClose, onConfirm, isFinishing, resumenDatos }) {

  // ESTADO Y CONSTANTE PARA NOTAS
  const [notas, setNotas] = useState('');
  const MAX_NOTAS_LENGTH = 1000;

  const handleSubmit = (e) => {
    e.preventDefault();
    onConfirm(notas);
  };

  // Handler para notas
  const handleNotasChange = (e) => {
    if (e.target.value.length <= MAX_NOTAS_LENGTH) {
      setNotas(e.target.value);
    }
  };

  if (!isOpen) {
    return null;
  }

  const hayResumen = Array.isArray(resumenDatos) && resumenDatos.length > 0;

  return (
    <div className="modal-backdrop" onClick={onClose}>
      <div className="modal-content" style={{ maxHeight: '80vh' }} onClick={(e) => e.stopPropagation()}>

        <div className="modal-header">
          <h3>Finalizar Entrenamiento</h3>
          <button className="modal-close-btn" onClick={onClose} disabled={isFinishing}>
            &times;
          </button>
        </div>

        <form className="modal-form" style={{ display: 'flex', flexDirection: 'column', flexGrow: 1, overflow: 'hidden' }} onSubmit={handleSubmit}>

          <div className="resumen-container">
            <h4>Resumen del Entrenamiento:</h4>

            {hayResumen ? (
              // MAP EXTERIOR: EJERCICIOS
              resumenDatos.map((ejercicio) => (
                <div className="resumen-ejercicio-grupo" key={ejercicio.nombre}>
                  <div className="resumen-ejercicio-header">
                    <strong>{ejercicio.nombre}</strong>
                  </div>

                  {/* MAP INTERIOR: SERIES */}
                  <ul className="resumen-series-lista">
                    {ejercicio.series.map((serie, index) => (
                      <li key={`${serie.num_serie}_${index}`}>
                        <div className="resumen-serie-detalle">
                          <span>Serie {serie.num_serie}:</span>
                          {ejercicio.tipo === 'cardio' ?
                          (
                            <>
                              {serie.tiempo_min_realizado != null && (
                                <span>{serie.tiempo_min_realizado} min</span>
                              )}
                              {serie.distancia_km_realizada != null && (
                                <span>{serie.distancia_km_realizada} km</span>
                              )}
                            </>
                          ) : (
                            <>
                              <span>
                                {serie.repeticiones_realizadas} reps
                                {serie.fue_al_fallo && <span className="fallo-tag">AL FALLO</span>}
                              </span>
                              {serie.peso_kg_usado != null && (
                                <span>{serie.peso_kg_usado} kg</span>
                              )}
                            </>
                          )}
                        </div>
                        {serie.notas_serie && (
                          <p className="resumen-serie-nota">
                            üìù {serie.notas_serie}
                          </p>
                        )}
                       </li>
                    ))}
                  </ul>
                </div>
              ))
            ) : (
              <p className="resumen-vacio">No has completado ninguna serie en esta sesi√≥n.</p>
            )}
          </div>

          {/* Textarea y Contador */}
          <div className="form-group-small" style={{ marginTop: '1rem' }}>
            <label htmlFor="notas_sesion">Notas de la Sesi√≥n (opcional)</label>
            <textarea
              id="notas_sesion"
              value={notas}
              onChange={handleNotasChange}
              placeholder="Ej: Me he sentido fuerte hoy..."
              rows="3"
              disabled={isFinishing}
              style={{ minHeight: '60px' }}
              maxLength={MAX_NOTAS_LENGTH}
            ></textarea>
            <small style={{ textAlign: 'right', color: 'var(--text-secondary-color)', marginTop: '0.25rem' }}>
              {notas.length} / {MAX_NOTAS_LENGTH}
            </small>
          </div>

          <div className="modal-footer">
            <button type="submit" className="transparent-btn" disabled={isFinishing}>
              {isFinishing ? 'Guardando...' : 'Confirmar y Guardar'}
            </button>
          </div>
        </form>

      </div>
    </div>
  );
}

export default ResumenFinalModal;

--- RutinaDetalle.css ---

/* ---- frontend/src/RutinaDetalle.css (LIMPIO Y CORREGIDO) ---- */

/* Estilos generales .rutina-detalle-container, .btn-volver */
.rutina-detalle-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 1200px;
  margin: 0 auto;
}
.rutina-detalle-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
}
.rutina-detalle-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 2rem;
}
.btn-volver {
  background: none;
  border: 1px solid var(--input-border-color);
  color: var(--text-secondary-color);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  font-family: var(--font-family);
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}
.btn-volver:hover {
  background-color: var(--input-bg-color);
  color: var(--text-color);
}

/* Contenedor de la cabecera (Modo Vista) */
.rutina-header-view {
  position: relative;
  padding-right: 50px; /* Deja espacio para el bot√≥n de l√°piz */
  margin-bottom: 1rem; /* Separaci√≥n antes del siguiente form */
}

/* Bot√≥n de L√°piz para Editar Info */
.btn-edit-info {
  position: absolute;
  top: 0;
  right: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: none;
  border: none;
  color: var(--text-secondary-color);
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}
.btn-edit-info:hover {
  background-color: var(--input-bg-color);
  color: var(--primary-color);
}

/* Formulario de Edici√≥n INLINE */
.form-editar-rutina-inline {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--box-shadow);
}
.form-editar-rutina-inline h3 {
  margin-top: 0;
  margin-bottom: 1.5rem;
  color: var(--text-color);
}

/* Mensaje de √©xito (verde/azul) */
.message.success {
  background-color: rgba(26, 115, 232, 0.1);
  color: #8ab4f8; /* Un azul claro */
  border: 1px solid #8ab4f8;
  margin-bottom: 1rem;
}

/* Acciones del formulario inline */
.form-actions-rutina-inline {
  display: flex;
  justify-content: space-between;
  align-items: center; /* Asegura alineaci√≥n vertical */
  gap: 1rem;
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--input-border-color);
}
.form-actions-rutina-inline-right {
  display: flex;
  align-items: center; /* Asegura alineaci√≥n vertical */
  gap: 1rem;
}

/* Bot√≥n de Borrar inline */
.btn-delete-rutina-inline {
  height: 40px;
  border-radius: 999px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
  padding: 0 1.5rem;
  background-color: rgba(217, 48, 37, 0.1);
  color: #d93025;
  border: 2px solid #d93025;
}
.btn-delete-rutina-inline:hover {
  background-color: #d93025;
  color: #fff;
}

/* Bot√≥n Cancelar inline (gris) */
.btn-cancel-inline {
  height: 48px; /* ¬°¬°CAMBIO!! Era 40px, ahora 48px para alinear */
  border-radius: 999px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
  padding: 0 1.5rem;
  background-color: var(--input-bg-color);
  color: var(--text-secondary-color);
}
.btn-cancel-inline:hover {
  background-color: var(--input-border-color);
  color: var(--text-color);
}

/* Bot√≥n Guardar inline (transparente) */
.transparent-btn-inline {
  height: 40px;
  border-radius: 999px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  padding: 0 1.5rem;
  background: transparent;
  color: var(--text-color);
  border: 4px solid transparent;
  background-image: linear-gradient(var(--surface-color), var(--surface-color)),
    var(--gradient);
  background-origin: border-box;
  background-clip: padding-box, border-box;
}
.transparent-btn-inline:hover {
  transform: scale(1.03);
}

/* Formulario de Agregar Ejercicio */
.form-agregar-ejercicio {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--box-shadow);
}
.form-agregar-ejercicio h3 {
  margin-top: 0;
  margin-bottom: 1.5rem;
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 1rem;
  align-items: flex-start;
}
.form-group-select,
.form-group-small {
  display: flex;
  flex-direction: column;
}
.form-group-select {
  grid-column: span 2;
}
.form-group-select label,
.form-group-small label {
  display: block;
  font-weight: 700;
  color: var(--text-secondary-color);
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

/* --- ¬°NUEVO! Contenedor para Input de Color + Bot√≥n "Quitar" --- */
.color-input-container {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

/* Estilo espec√≠fico para el input[type="color"] dentro de este layout */
.color-input-container input[type="color"] {
  flex-grow: 1; /* Permite que crezca para llenar el espacio */
  height: 48px;
  padding: 0.3rem; /* Padding peque√±o para el color picker */
  min-width: 80px; /* ¬°CLAVE! Evita que colapse en m√≥vil */
  box-sizing: border-box; /* Asegura que padding est√© incluido en la altura */
}

/* Estilo espec√≠fico para el bot√≥n "Quitar" dentro de este layout */
.color-input-container .btn-cancel-inline {
  flex-shrink: 0; /* Evita que el bot√≥n se encoja */
  /* La altura de 48px ya la hemos corregido arriba */
}
/* --- FIN NUEVO --- */

.form-group-select select,
.form-group-small input,
.form-group-small select {
  width: 100%;
  height: 48px;
  padding: 0 0.8rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  box-sizing: border-box;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.form-group-select select:focus,
.form-group-small input:focus,
.form-group-small select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(0, 170, 255, 0.2);
}
.input-disabled {
  background-color: var(--input-border-color);
  color: var(--text-secondary-color);
  cursor: not-allowed;
}
.select-ejercicio-btn {
  width: 100%;
  height: 48px;
  padding: 0 0.8rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  box-sizing: border-box;
  transition: border-color 0.3s, box-shadow 0.3s;
  text-align: left;
  cursor: pointer;
  color: var(--text-secondary-color);
}
.select-ejercicio-btn:hover {
  border-color: var(--primary-color);
}
.form-rep-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 0.5rem;
  align-items: flex-start;
}
.lista-series-preview {
  display: flex;
  flex-direction: column;
  gap: 0;
  max-height: 180px;
  overflow-y: auto;
  padding: 0;
  background-color: transparent;
  border-radius: 0;
  border: none;
}
.serie-preview-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.95rem;
  padding: 0.75rem 0.5rem;
  background-color: transparent;
  border-radius: 0;
  border-bottom: 1px solid var(--input-border-color);
}
.serie-preview-item:last-child {
  border-bottom: none;
}
.serie-preview-item span {
  color: var(--text-color);
}
.serie-preview-item span strong {
  color: var(--text-color);
}
.form-actions-right {
  display: flex;
  justify-content: flex-end;
  gap: 1rem;
  margin-top: 1.5rem;
  grid-column: 1 / -1;
}
.form-actions-right .btn-add-serie {
  background: var(--gradient);
  color: #fff;
  height: 48px;
  border-radius: 999px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: auto;
  flex-shrink: 0;
  padding-left: 1.8rem;
  padding-right: 1.8rem;
}
.btn-add-serie:hover {
  transform: scale(1.03);
  opacity: 0.9;
}

.form-actions-right .transparent-btn {
  height: 48px;
  font-size: 1rem;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: auto;
  flex-shrink: 0;
  padding-left: 1.8rem;
  padding-right: 1.8rem;
}

/* Lista de Ejercicios */
.lista-ejercicios h3 {
  border-bottom: 1px solid var(--input-border-color);
  padding-bottom: 0.5rem;
  margin-top: 2.5rem; /* Separaci√≥n del form de arriba */
}
.table-container {
  overflow-x: auto;
}
.lista-ejercicios table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
.lista-ejercicios th,
.lista-ejercicios td {
  padding: 0.8rem 1rem;
  text-align: left;
  border-bottom: 1px solid var(--input-border-color);
  vertical-align: middle;
}
.lista-ejercicios th {
  color: var(--text-secondary-color);
  font-size: 0.9rem;
  text-transform: uppercase;
}
.lista-ejercicios td {
  color: var(--text-color);
  font-size: 1rem;
}
.lista-ejercicios tr:last-child td {
  border-bottom: none;
}
.cell-objetivos ul {
  margin: 0;
  padding-left: 1.2rem;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}
.cell-objetivos li {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
}
.cell-objetivos li strong {
  color: var(--text-color);
}
.cell-objetivos li span {
  white-space: nowrap;
}
.acciones-tabla {
  display: flex;
  gap: 0.5rem;
}
.btn-edit-small,
.btn-delete-small {
  padding: 0.3rem 0.6rem;
  font-size: 0.8rem;
  border-radius: 6px;
  cursor: pointer;
  font-family: var(--font-family);
  font-weight: 700;
  border: none;
  transition: all 0.2s ease;
}
.btn-edit-small {
  background-color: var(--input-bg-color);
  color: var(--text-secondary-color);
}
.btn-edit-small:hover {
  background-color: var(--input-border-color);
  color: var(--text-color);
}
.btn-delete-small {
  background-color: rgba(217, 48, 37, 0.1);
  color: #d93025;
}
.btn-delete-small:hover {
  background-color: #d93025;
  color: #fff;
}

/* Scrollbar para Modales */
.modal-list {
  scrollbar-width: thin;
  scrollbar-color: var(--input-border-color) var(--input-bg-color);
}
.modal-list::-webkit-scrollbar {
  width: 10px;
}
.modal-list::-webkit-scrollbar-track {
  background: var(--input-bg-color);
  border-radius: 5px;
}
.modal-list::-webkit-scrollbar-thumb {
  background-color: var(--input-border-color);
  border-radius: 5px;
  border: 2px solid var(--input-bg-color);
}
.modal-list::-webkit-scrollbar-thumb:hover {
  background-color: var(--text-secondary-color);
}

/* --- NUEVO: Contador de Caracteres --- */
.char-counter {
  display: block; /* Para que ocupe su propia l√≠nea */
  text-align: right; /* Alinea a la derecha */
  font-size: 0.8rem; /* Peque√±o */
  color: var(--text-secondary-color); /* Color sutil */
  padding-right: 0.2rem; /* Ligero padding */
}

/* Media Queries */
@media (max-width: 600px) {
  /* Ajuste para el header inline */
  .rutina-header-view {
    padding-right: 45px;
  }
  .btn-edit-info {
    width: 36px;
    height: 36px;
    font-size: 1.3rem;
  }
  .form-actions-rutina-inline {
    flex-direction: column;
    align-items: stretch; /* Ocupa todo el ancho */
    gap: 0.75rem; /* Menos espacio */
  }
  .form-actions-rutina-inline-right {
    flex-direction: column;
    gap: 0.75rem; /* Menos espacio */
  }

  /* ESTA REGLA ES AHORA M√ÅS ESPEC√çFICA */
  .form-actions-rutina-inline .btn-delete-rutina-inline,
  .form-actions-rutina-inline .btn-cancel-inline,
  .form-actions-rutina-inline .transparent-btn-inline {
    width: 100%; /* Botones ocupan todo el ancho */
  }

  /* Estilos antiguos de media query */
  .modal-filters {
    flex-direction: column;
  }
  .form-actions-right {
    flex-direction: column;
    align-items: stretch;
  }
  .form-actions-right .btn-add-serie,
  .form-actions-right .transparent-btn {
    width: 100%;
    max-width: none;
    flex-shrink: 1;
  }
  .form-rep-grid {
    grid-template-columns: 1fr 1fr;
  }
  .form-rep-grid .form-group-small:first-child {
    grid-column: 1 / -1;
  }

  /* ESTA REGLA APILA EL FORMULARIO DE EDICI√ìN */
  .form-editar-rutina-inline .form-grid {
    grid-template-columns: 1fr; /* Apila todo en una sola columna */
  }
}

--- RutinaDetalle.js ---

// ---- frontend/src/RutinaDetalle.js (CORREGIDO - Persistencia de inputs y validaci√≥n) ----

import React, { useState, useEffect, useRef } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import './RutinaDetalle.css';
import SelectorEjerciciosModal from './components/SelectorEjerciciosModal';
import EditarEjercicioModal from './components/EditarEjercicioModal';
import ConfirmarBorradoModal from './components/ConfirmarBorradoModal';
import ConfirmarBorrarEjercicioModal from './components/ConfirmarBorrarEjercicioModal';
import iconoCrear from './assets/crear-ejercicios.png';
import GuiaModal from './components/GuiaModal';

// --- Helper de Perfil.js: Bloquea teclas (e, +, -, etc.) ---
const handleNumericKeyDown = (e, allowDecimal = false) => {
  // Teclas siempre permitidas
  if ([8, 9, 37, 39, 46, 35, 36].includes(e.keyCode)) {
    return;
  }
  // Bloquear 'e', '+', '-'
  if (['e', 'E', '+', '-'].includes(e.key)) {
    e.preventDefault();
    return;
  }
  // Si NO se permite decimal, bloquear '.' y ','
  if (!allowDecimal && ['.', ','].includes(e.key)) {
    e.preventDefault();
    return;
  }
};

/**
 * Componente interno para el formulario de *creaci√≥n* de series de Fuerza.
 */
const FormularioFuerza = ({
  objetivos,
  setObjetivos,
  // Estados
  tipoRep, setTipoRep,
  repsMin,
  repsMax,
  peso,
  descanso,
  // Handler
  onFormChange
}) => {

  // Borra una serie de la lista temporal de 'objetivosParaAgregar'
  const handleRemoveSerie = (num_serie) => {
    setObjetivos(objetivos.filter(s => s.num_serie !== num_serie).map((s, i) => ({ ...s, num_serie: i + 1 })));
  };

  // Formatea la previsualizaci√≥n de la serie en la lista temporal
  const formatPreviewObjetivo = (obj) => {
    let repStr = "";
    if (obj.tipo_rep_objetivo === 'fallo') {
      repStr = `Al Fallo (~${obj.reps_min_objetivo || '?'}r)`;
    } else if (obj.tipo_rep_objetivo === 'rango') {
      repStr = `${obj.reps_min_objetivo || '?'}-${obj.reps_max_objetivo || '?'} reps`;
    } else {
      repStr = `${obj.reps_min_objetivo || '?'} reps`;
    }
    let pesoStr = obj.peso_kg_objetivo ?
      ` con ${obj.peso_kg_objetivo}kg` : '';
    let descansoStr = obj.descanso_seg_post ?
      ` (${obj.descanso_seg_post}s)` : '';
    return `${repStr}${pesoStr}${descansoStr}`;
  };

  return (
    <div style={{ gridColumn: '1 / -1' }}>
      {/* Lista de previsualizaci√≥n de series a√±adidas */}
      <div className="lista-series-preview">
        {objetivos.length === 0 ? (
          <p className="subtitle" style={{ margin: 0, fontSize: '0.9rem', textAlign: 'center' }}>A√±ade tu primera serie...</p>
        ) : (
          objetivos.map(s => (
            <div key={s.num_serie} className="serie-preview-item">
              <span><strong>Serie {s.num_serie}:</strong> {formatPreviewObjetivo(s)}</span>
              <button type="button" className="btn-delete-small" onClick={() => handleRemoveSerie(s.num_serie)} aria-label={`Borrar serie ${s.num_serie}`}>Borrar</button>
            </div>
          ))
        )}
      </div>

      {/* Inputs para a√±adir la SIGUIENTE serie */}
      <div className="form-grid" style={{ borderTop: '1px solid var(--input-border-color)', paddingTop: '1rem', marginTop: '1rem' }}>
        <div className="form-rep-grid" style={{ gridColumn: 'span 3' }}>
          <div className="form-group-small">
            <label htmlFor={`tipo-rep-input-${objetivos.length + 1}`}>Tipo Reps</label>
            <select id={`tipo-rep-input-${objetivos.length + 1}`} value={tipoRep} onChange={(e) => setTipoRep(e.target.value)}>
              <option value="fijo">Fijo</option>
              <option value="rango">Rango</option>
              <option value="fallo">Al fallo</option>
            </select>
          </div>
          <div className="form-group-small">
            <label htmlFor={`reps-input-${objetivos.length + 1}`}>
              {tipoRep === 'rango' ? 'Reps M√≠n' : (tipoRep === 'fallo' ? 'Reps Aprox.' : 'Reps')}
            </label>
            <input
              id={`reps-input-${objetivos.length + 1}`}
              type="number" // Mantenemos number por el teclado m√≥vil
              min={tipoRep === 'fallo' ? "0" : "1"}
              value={repsMin}
              placeholder={tipoRep === 'fallo' ? "Obligatorio" : "Obligatorio"}
              // --- ¬°CAMBIO! Quitamos 'required' ---
              name="repsMin"
              onChange={onFormChange}
              onKeyDown={(e) => handleNumericKeyDown(e, false)} // No decimales
            />
          </div>
          {tipoRep === 'rango' && (
            <div className="form-group-small">
              <label htmlFor={`reps-max-input-${objetivos.length + 1}`}>Reps M√°x</label>
              <input
                id={`reps-max-input-${objetivos.length + 1}`}
                type="number"
                min={(parseInt(repsMin, 10) || 0) + 1}
                value={repsMax}
                placeholder="Obligatorio"
                // --- ¬°CAMBIO! Quitamos 'required' ---
                name="repsMax"
                onChange={onFormChange}
                onKeyDown={(e) => handleNumericKeyDown(e, false)} // No decimales
              />
            </div>
          )}
        </div>
        <div className="form-group-small">
          <label htmlFor={`peso-input-${objetivos.length + 1}`}>Peso (kg)</label>
          <input
            id={`peso-input-${objetivos.length + 1}`}
            type="number" // Mantenemos number
            step="0.01" // Permitimos decimales
            min="0"
            value={peso}
            placeholder="Obligatorio"
            // --- ¬°CAMBIO! Quitamos 'required' ---
            name="peso"
            onChange={onFormChange}
            onKeyDown={(e) => handleNumericKeyDown(e, true)} // S√ç decimales
          />
        </div>
        <div className="form-group-small">
          <label htmlFor={`descanso-input-${objetivos.length + 1}`}>Descanso (s)</label>
          <input
            id={`descanso-input-${objetivos.length + 1}`}
            type="number"
            min="0"
            value={descanso}
            placeholder="Opcional"
            name="descanso"
            onChange={onFormChange}
            onKeyDown={(e) => handleNumericKeyDown(e, false)} // No decimales
          />
        </div>
      </div>
    </div>
  );
};

/**
 * Componente interno para el formulario de *creaci√≥n* de intervalos de Cardio.
 */
const FormularioCardio = ({
  objetivos,
  setObjetivos,
  // Estados
  tiempo,
  distancia,
  descanso,
  // Handler
  onFormChange
}) => {

  // Borra un intervalo de la lista temporal
  const handleRemoveIntervalo = (num_serie) => {
    setObjetivos(objetivos.filter(s => s.num_serie !== num_serie).map((s, i) => ({ ...s, num_serie: i + 1 })));
  };

  // Formatea la previsualizaci√≥n del intervalo
  const formatPreviewIntervalo = (obj) => {
    const partes = [];
    if (obj.tiempo_min_objetivo) partes.push(`${obj.tiempo_min_objetivo} min`);
    if (obj.distancia_km_objetivo) partes.push(`${obj.distancia_km_objetivo} km`);
    let texto = partes.join(' / ');
    if (obj.descanso_seg_post) texto += ` (${obj.descanso_seg_post}s descanso)`;
    return texto || "Intervalo vac√≠o";
  };

  return (
    <div style={{ gridColumn: '1 / -1' }}>
      {/* Lista de previsualizaci√≥n de intervalos a√±adidos */}
      <div className="lista-series-preview">
        {objetivos.length === 0 ? (
          <p className="subtitle" style={{ margin: 0, fontSize: '0.9rem', textAlign: 'center' }}>A√±ade tu primer intervalo...</p>
        ) : (
          objetivos.map(s => (
            <div key={s.num_serie} className="serie-preview-item">
              <span><strong>Intervalo {s.num_serie}:</strong> {formatPreviewIntervalo(s)}</span>
              <button type="button" className="btn-delete-small" onClick={() => handleRemoveIntervalo(s.num_serie)} aria-label={`Borrar intervalo ${s.num_serie}`}>Borrar</button>
            </div>
          ))
        )}
      </div>

      {/* Inputs para a√±adir el SIGUIENTE intervalo */}
      <div className="form-grid" style={{ borderTop: '1px solid var(--input-border-color)', paddingTop: '1rem', marginTop: '1rem', alignItems: 'end' }}>
        <div className="form-group-small">
          <label htmlFor={`tiempo-input-${objetivos.length + 1}`}>Tiempo (Min)</label>
          <input
            id={`tiempo-input-${objetivos.length + 1}`}
            type="number"
            min="1"
            step="1"
            value={tiempo}
            placeholder="Obligatorio"
            // --- ¬°CAMBIO! Quitamos 'required' ---
            name="tiempoCardio"
            onChange={onFormChange}
            onKeyDown={(e) => handleNumericKeyDown(e, false)} // No decimales
          />
        </div>
        <div className="form-group-small">
          <label htmlFor={`distancia-input-${objetivos.length + 1}`}>Distancia (km)</label>
          <input
            id={`distancia-input-${objetivos.length + 1}`}
            type="number"
            min="0.1"
            step="0.01" // Permitimos 2 decimales
            value={distancia}
            placeholder="Obligatorio"
            // --- ¬°CAMBIO! Quitamos 'required' ---
            name="distanciaCardio"
            onChange={onFormChange}
            onKeyDown={(e) => handleNumericKeyDown(e, true)} // S√ç decimales
          />
        </div>
        <div className="form-group-small">
          <label htmlFor={`descanso-cardio-input-${objetivos.length + 1}`}>Descanso (s)</label>
          <input
            id={`descanso-cardio-input-${objetivos.length + 1}`}
            type="number"
            min="0"
            value={descanso}
            placeholder="Opcional"
            name="descansoCardio"
            onChange={onFormChange}
            onKeyDown={(e) => handleNumericKeyDown(e, false)} // No decimales
          />
        </div>
      </div>
    </div>
  );
};

/**
 * Funci√≥n helper para formatear el objetivo (serie/intervalo)
 * para mostrar en la *tabla* principal de ejercicios guardados.
 */
const formatObjetivoTabla = (obj, tipo) => {
  if (tipo === 'cardio') {
    const metricas = [];
    if (obj.tiempo_min_objetivo) metricas.push(`${obj.tiempo_min_objetivo} min`);
    if (obj.distancia_km_objetivo) metricas.push(`${obj.distancia_km_objetivo} km`);
    let texto = metricas.join(' / ');
    if (obj.descanso_seg_post) texto += ` (${obj.descanso_seg_post}s)`;
    return <span><strong>Int. {obj.num_serie}:</strong> {texto || "Objetivo no especificado"}</span>;
  }
  // Fuerza
  let repStr = "";
  if (obj.tipo_rep_objetivo === 'fallo') {
    repStr = `Al Fallo (~${obj.reps_min_objetivo || '?'}r)`;
  } else if (obj.tipo_rep_objetivo === 'rango') {
    repStr = `${obj.reps_min_objetivo || '?'}-${obj.reps_max_objetivo || '?'}r`;
  } else {
    repStr = `${obj.reps_min_objetivo || '?'}r`;
  }
  return (
    <span>
      <strong>S{obj.num_serie}:</strong> {repStr}
      {obj.peso_kg_objetivo != null ? ` con ${String(obj.peso_kg_objetivo)}kg` : ''}
      {obj.descanso_seg_post != null ? ` (${String(obj.descanso_seg_post)}s)` : ''}
    </span>
  );
};

/**
 * Componente principal de la p√°gina de detalles de una rutina.
 */
function RutinaDetalle() {

  const { id: rutinaId } = useParams();
  const navigate = useNavigate();
  // Estados generales de datos
  const [rutinaInfo, setRutinaInfo] = useState(null);
  const [ejerciciosEnRutina, setEjerciciosEnRutina] = useState([]);
  const [ejerciciosMaestra, setEjerciciosMaestra] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [successMsg, setSuccessMsg] = useState(null);
  const [exerciseSuccessMsg, setExerciseSuccessMsg] = useState(null);

  // Estados de Modales
  const [isSelectorModalOpen, setIsSelectorModalOpen] = useState(false);
  const [ejercicioParaEditar, setEjercicioParaEditar] = useState(null);
  const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [showGuiaRutina, setShowGuiaRutina] = useState(false);

  // Estados Formulario "A√±adir Ejercicio"
  const [ejercicioSeleccionado, setEjercicioSeleccionado] = useState(null);
  const [objetivosParaAgregar, setObjetivosParaAgregar] = useState([]);
  const [apiErrorFormAgregar, setApiErrorFormAgregar] = useState(null);

  // Estados para inputs CONTROLADOS
  // Estados Inputs Fuerza (para a√±adir)
  const [tipoRepState, setTipoRepState] = useState("rango");
  const [repsMinState, setRepsMinState] = useState("");
  const [repsMaxState, setRepsMaxState] = useState("");
  const [pesoState, setPesoState] = useState("");
  const [descansoState, setDescansoState] = useState("");
  // Estados Inputs Cardio (para a√±adir)
  const [tiempoCardioState, setTiempoCardioState] = useState("");
  const [distanciaCardioState, setDistanciaCardioState] = useState("");
  const [descansoCardioState, setDescansoCardioState] = useState("");


  // Estados Formulario "Editar Rutina Info"
  const [editedName, setEditedName] = useState('');
  const [editedDays, setEditedDays] = useState('');
  const [isEditingInfo, setIsEditingInfo] = useState(false);
  const [apiErrorFormEditar, setApiErrorFormEditar] = useState(null);
  const [editedOrden, setEditedOrden] = useState(0);
  const [editedColor, setEditedColor] = useState("");

  // Constantes y Refs
  const MAX_TITULO_LENGTH = 38;
  const MAX_DIAS_LENGTH = 60;
  const successTimeoutRef = useRef(null);
  const exerciseSuccessTimeoutRef = useRef(null);

  // Estados Modal "Borrar Ejercicio"
  const [ejercicioAEliminar, setEjercicioAEliminar] = useState(null);
  const [isConfirmarBorrarEjercicioOpen, setIsConfirmarBorrarEjercicioOpen] = useState(false);
  const [isDeletingEjercicio, setIsDeletingEjercicio] = useState(false);


  // Handler de validaci√≥n para el formulario "A√±adir"
  const handleAddFormChange = (e) => {
    const { name, value } = e.target;

    // Reglas de Regex
    const max3Int = /^\d{0,3}$/; // M√°x 3 d√≠gitos enteros
    const max4Int = /^\d{0,4}$/; // M√°x 4 d√≠gitos enteros
    const decimal_5_2 = /^(|\d{1,3}([.,]\d{0,2})?)$/; // M√°x 999.99 (6 chars total)

    // Limpiar mensajes de error al escribir
    setApiErrorFormAgregar(null);

    switch (name) {
      // --- FUERZA ---
      case 'repsMin':
        if (max3Int.test(value)) {
          setRepsMinState(value);
        }
        break;
      case 'repsMax':
        if (max3Int.test(value)) {
          setRepsMaxState(value);
        }
        break;
      case 'peso':
        if (decimal_5_2.test(value) && value.length <= 6) {
          // Estandariza la coma a un punto
          setPesoState(value.replace(',', '.'));
        }
        break;
      case 'descanso':
        if (max4Int.test(value)) {
          setDescansoState(value);
        }
        break;

      // --- CARDIO ---
      case 'tiempoCardio':
        if (max4Int.test(value)) {
          setTiempoCardioState(value);
        }
        break;
      case 'distanciaCardio':
        if (decimal_5_2.test(value) && value.length <= 6) {
          setDistanciaCardioState(value.replace(',', '.'));
        }
        break;
      case 'descansoCardio':
        if (max4Int.test(value)) {
          setDescansoCardioState(value);
        }
        break;
      default:
        // Fallback por si acaso
        break;
    }
  };


  /**
   * Llama a la API para marcar una gu√≠a tutorial como vista por el usuario.
   */
  const marcarGuiaComoVista = async (nombreGuia) => {
    const token = localStorage.getItem('movium_token');
    if (!token) return;
    try {
      await fetch('http://localhost/programacion/TFG/movium/backend/api/marcar_guia_vista.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ guia_vista: nombreGuia })
      });
    } catch (error) {
      console.error("Error al marcar la gu√≠a como vista:", error);
    }
  };

  // Resetea los inputs del formulario de Fuerza
  const resetFuerzaInputs = () => {
    setTipoRepState("rango"); setRepsMinState("");
    setRepsMaxState(""); setPesoState("");
    setDescansoState("");
  };

  // Resetea los inputs del formulario de Cardio
  const resetCardioInputs = () => {
    setTiempoCardioState("");
    setDistanciaCardioState(""); setDescansoCardioState("");
  };

  // Muestra un mensaje temporal de √©xito (para rutina o para ejercicio)
  const showTemporaryMessage = (message, type = 'exercise', duration = 3000) => {
    setApiErrorFormAgregar(null);
    setApiErrorFormEditar(null);
    if (type === 'rutina') {
      setSuccessMsg(message);
      if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);
      successTimeoutRef.current = setTimeout(() => { setSuccessMsg(null); successTimeoutRef.current = null; }, duration);
    } else {
      setExerciseSuccessMsg(message);
      if (exerciseSuccessTimeoutRef.current) clearTimeout(exerciseSuccessTimeoutRef.current);
      exerciseSuccessTimeoutRef.current = setTimeout(() => { setExerciseSuccessMsg(null); exerciseSuccessTimeoutRef.current = null; }, duration);
    }
  };

  // Limpieza de timeouts al desmontar el componente
  useEffect(() => {
    return () => {
      if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);
      if (exerciseSuccessTimeoutRef.current) clearTimeout(exerciseSuccessTimeoutRef.current);
    };
  }, []);

  // Efecto para cargar toda la informaci√≥n de la rutina
  useEffect(() => {
    const cargarDatosRutina = async () => {
      setLoading(true); setError(null); setApiErrorFormAgregar(null); setApiErrorFormEditar(null);
      setSuccessMsg(null); setExerciseSuccessMsg(null);
      if (successTimeoutRef.current) clearTimeout(successTimeoutRef.current);
      if (exerciseSuccessTimeoutRef.current) clearTimeout(exerciseSuccessTimeoutRef.current);
      const token = localStorage.getItem('movium_token'); if (!token) { setError("Autenticaci√≥n requerida."); setLoading(false); return; }
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };

      try {
        // Peticiones en paralelo
        const resInfo = fetch(`http://localhost/programacion/TFG/movium/backend/api/get_rutina_info.php?id=${rutinaId}`, { headers });
        const resEjerciciosGuardados = fetch(`http://localhost/programacion/TFG/movium/backend/api/get_ejercicios_de_rutina.php?id=${rutinaId}`, { headers });
        const resMaestra = fetch(`http://localhost/programacion/TFG/movium/backend/api/get_ejercicios_maestra.php`, { headers });

        const [info, ejerciciosGuardados, maestra] = await Promise.all([resInfo, resEjerciciosGuardados, resMaestra]);

        const dataInfo = await info.json();
        if (!info.ok) throw new Error(dataInfo.mensaje || "Error info rutina");

        const dataEjerciciosGuardados = await ejerciciosGuardados.json();
        if (!ejerciciosGuardados.ok) throw new Error(dataEjerciciosGuardados.mensaje || "Error ejercicios guardados");

        const dataMaestra = await maestra.json();
        if (!maestra.ok) throw new Error(dataMaestra.mensaje || "Error maestra");

        setRutinaInfo(dataInfo);
        setEjerciciosEnRutina(dataEjerciciosGuardados);
        setEjerciciosMaestra(dataMaestra);
        // Inicializar estados de edici√≥n con los datos cargados
        setEditedName(dataInfo.nombre);
        setEditedDays(dataInfo.dias_semana || '');
        setEditedOrden(dataInfo.orden || 0);
        setEditedColor(dataInfo.color_tag || "");

      } catch (err) { setError(err.message); }
      finally { setLoading(false); }
    };
    cargarDatosRutina();
  }, [rutinaId]);

  // Efecto para mostrar la gu√≠a de rutina
  useEffect(() => {
    if (loading || error) return;

    try {
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      if (storedUser && !storedUser.ha_visto_guia_rutina && storedUser.ha_visto_guia_inicio) {
        const timer = setTimeout(() => {
          setShowGuiaRutina(true);
        }, 500);
        return () => clearTimeout(timer);
      }
    } catch (e) {
      console.error("Error al leer datos de usuario para la gu√≠a:", e);
    }
  }, [loading, error]);

  // Cierra el modal de gu√≠a de rutina y marca como vista
  const handleCerrarGuiaRutina = () => {
    try {
      marcarGuiaComoVista('rutina');
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      if (storedUser) {
        const updatedUser = { ...storedUser, ha_visto_guia_rutina: true };
        localStorage.setItem('movium_user', JSON.stringify(updatedUser));
      }
      setShowGuiaRutina(false);
    } catch (e) {
      console.error("Error al cerrar la gu√≠a de rutina:", e);
      setShowGuiaRutina(false);
    }
  };

  // Env√≠a los datos actualizados de la rutina a la API.
  const handleUpdateRutinaInfo = async (e) => {
    e.preventDefault();
    setApiErrorFormEditar(null);
    setSuccessMsg(null); setExerciseSuccessMsg(null);
    const token = localStorage.getItem('movium_token');

    const body = {
      id: rutinaId,
      nombre: editedName,
      dias_semana: editedDays,
      orden: editedOrden,
      color_tag: editedColor
    };

    try {
      const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/update_rutina.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(body)
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.mensaje || 'Error al actualizar la rutina.');
      }

      setRutinaInfo(prevInfo => ({
        ...prevInfo,
        ...data.rutina_info
      }));
      setEditedName(data.rutina_info.nombre);
      setEditedDays(data.rutina_info.dias_semana || '');
      setEditedOrden(data.rutina_info.orden);
      setEditedColor(data.rutina_info.color_tag || "");

      showTemporaryMessage("Rutina actualizada con √©xito.", 'rutina');
      setIsEditingInfo(false);
    } catch (err) { setApiErrorFormEditar(err.message); }
  };

  // Abre el modal de confirmaci√≥n para borrar la rutina.
  const handleDeleteRutina = () => { setIsDeleteModalOpen(true); };

  // Confirma y ejecuta el borrado de la rutina completa.
  const handleConfirmDelete = async () => {
    setApiErrorFormEditar(null); setIsDeleting(true);
    const token = localStorage.getItem('movium_token');
    try {
      const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/delete_rutina.php', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ id: rutinaId }) });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.mensaje || 'Error al eliminar la rutina.');
      }
      setIsDeleteModalOpen(false);
      setIsDeleting(false);
      setIsEditingInfo(false);
      navigate('/');
    } catch (err) {
      setApiErrorFormEditar(err.message);
      setIsDeleteModalOpen(false);
      setIsDeleting(false);
    }
  };

  // Cancela el modo de edici√≥n de la info de la rutina y resetea los valores.
  const handleCancelEditInfo = () => {
    setIsEditingInfo(false);
    setEditedName(rutinaInfo.nombre);
    setEditedDays(rutinaInfo.dias_semana || '');
    setEditedOrden(rutinaInfo.orden || 0);
    setEditedColor(rutinaInfo.color_tag || "");
    setApiErrorFormEditar(null);
    setSuccessMsg(null);
    setExerciseSuccessMsg(null);
  };

  // Callback del modal SelectorEjerciciosModal.
  const handleSelectEjercicio = (ej) => {
    setEjercicioSeleccionado(ej);
    setObjetivosParaAgregar([]);
    setApiErrorFormAgregar(null);
    setIsSelectorModalOpen(false);
    resetFuerzaInputs();
    resetCardioInputs();
    setSuccessMsg(null);
    setExerciseSuccessMsg(null);
  };

  // Valida y obtiene los datos de la serie de fuerza de los inputs.
  const getCurrentSerieData = () => {
    setApiErrorFormAgregar(null);
    let reps_min = null; let reps_max = null;

    if (!repsMinState) {
      setApiErrorFormAgregar("El campo 'Reps' (o 'Reps M√≠n') es obligatorio.");
      return null;
    }

    if (tipoRepState === 'fijo' || tipoRepState === 'fallo') {
      const repsParsed = parseInt(repsMinState, 10);
      if (isNaN(repsParsed) || (tipoRepState === 'fijo' && repsParsed < 1) || (tipoRepState === 'fallo' && repsParsed < 0)) {
        setApiErrorFormAgregar(`Valor inv√°lido para '${tipoRepState === 'fallo' ? 'Reps Aprox.' : 'Reps'}' (>= ${tipoRepState === 'fallo' ? 0 : 1}).`);
        return null;
      }
      reps_min = (tipoRepState === 'fallo' && repsMinState === '') ? null : repsParsed;

    } else if (tipoRepState === 'rango') {
      if (!repsMaxState) {
        setApiErrorFormAgregar("El campo 'Reps M√°x' es obligatorio para el tipo Rango.");
        return null;
      }
      const minParsed = parseInt(repsMinState, 10);
      const maxParsed = parseInt(repsMaxState, 10);
      if (isNaN(minParsed) || isNaN(maxParsed) || minParsed < 1 || maxParsed < minParsed) {
        setApiErrorFormAgregar("Las Repeticiones M√°ximas deber ser mayores o iguales que las M√≠nimas");
        return null;
      }
      reps_min = minParsed; reps_max = maxParsed;
    }

    if (!pesoState) {
      setApiErrorFormAgregar("El campo 'Peso' es obligatorio.");
      return null;
    }
    const pesoNum = parseFloat(pesoState);
    if (isNaN(pesoNum) || pesoNum < 0) {
      setApiErrorFormAgregar("El peso debe ser un n√∫mero v√°lido (>= 0).");
      return null;
    }

    const descansoNum = parseInt(descansoState, 10);
    if (descansoState && (isNaN(descansoNum) || descansoNum < 0)) {
      setApiErrorFormAgregar("El descanso debe ser un n√∫mero v√°lido (>= 0) o dejarse vac√≠o.");
      return null;
    }

    return {
      num_serie: objetivosParaAgregar.length + 1, tipo_rep_objetivo: tipoRepState,
      reps_min_objetivo: reps_min, reps_max_objetivo: reps_max,
      peso_kg_objetivo: pesoNum,
      descanso_seg_post: (descansoState && !isNaN(descansoNum)) ? descansoNum : null,
      tiempo_min_objetivo: null, distancia_km_objetivo: null
    };
  };

  // A√±ade la serie validada a la lista temporal 'objetivosParaAgregar'.
  const handleAddSerieToList = () => {
    const serieData = getCurrentSerieData();
    if (serieData) {
      setObjetivosParaAgregar(prev => [...prev, serieData]);
      // --- ¬°CAMBIO! No reseteamos los inputs ---
      // resetFuerzaInputs(); 
    }
  };

  // Valida y obtiene los datos del intervalo de cardio de los inputs.
  const getCurrentIntervaloData = () => {
    setApiErrorFormAgregar(null);
    if (!tiempoCardioState) {
      setApiErrorFormAgregar("El campo 'Tiempo' es obligatorio.");
      return null;
    }
    const tiempoNum = parseInt(tiempoCardioState, 10);
    if (isNaN(tiempoNum) || tiempoNum <= 0) {
      setApiErrorFormAgregar("El Tiempo debe ser un n√∫mero v√°lido mayor que 0.");
      return null;
    }

    if (!distanciaCardioState) {
      setApiErrorFormAgregar("El campo 'Distancia' es obligatorio.");
      return null;
    }
    const distNum = parseFloat(distanciaCardioState);
    if (isNaN(distNum) || distNum <= 0) {
      setApiErrorFormAgregar("La Distancia debe ser un n√∫mero v√°lido mayor que 0.");
      return null;
    }

    const descansoNum = parseInt(descansoCardioState, 10);
    if (descansoCardioState && (isNaN(descansoNum) || descansoNum < 0)) {
      setApiErrorFormAgregar("El descanso debe ser un n√∫mero v√°lido (>= 0) o dejarse vac√≠o.");
      return null;
    }

    return {
      num_serie: objetivosParaAgregar.length + 1, tipo_rep_objetivo: 'fijo',
      reps_min_objetivo: null, reps_max_objetivo: null, peso_kg_objetivo: null,
      tiempo_min_objetivo: tiempoNum, distancia_km_objetivo: distNum,
      descanso_seg_post: (descansoCardioState && !isNaN(descansoNum)) ? descansoNum : null
    };
  };

  // A√±ade el intervalo validado a la lista temporal 'objetivosParaAgregar'.
  const handleAddIntervaloToList = () => {
    const intervaloData = getCurrentIntervaloData();
    if (intervaloData) {
      setObjetivosParaAgregar(prev => [...prev, intervaloData]);
      // --- ¬°CAMBIO! No reseteamos los inputs ---
      // resetCardioInputs();
    }
  };

  // Env√≠a el nuevo ejercicio a la API para guardarlo.
  const handleAgregarEjercicio = async (e) => {
    e.preventDefault();
    setApiErrorFormAgregar(null);
    setSuccessMsg(null); setExerciseSuccessMsg(null);
    const token = localStorage.getItem('movium_token');
    if (!ejercicioSeleccionado) { setApiErrorFormAgregar("Selecciona un ejercicio."); return; }

    const objetivosFinales = objetivosParaAgregar;

    if (objetivosFinales.length === 0) {
      setApiErrorFormAgregar(`A√±ade al menos un${ejercicioSeleccionado.tipo === 'cardio' ? ' intervalo' : 'a serie'} antes de guardar.`);
      return;
    }

    const nuevoEjercicioRutina = { rutina_id: rutinaId, ejercicio_id: ejercicioSeleccionado.id, objetivos: objetivosFinales };
    try {
      const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/add_ejercicio_a_rutina.php', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(nuevoEjercicioRutina) });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.mensaje || 'Error al a√±adir el ejercicio a la rutina.');
      }

      setEjerciciosEnRutina(prev => [...prev, data.ejercicio_agregado]);
      setEjercicioSeleccionado(null);
      setObjetivosParaAgregar([]);
      resetFuerzaInputs();
      resetCardioInputs();
      showTemporaryMessage("Ejercicio a√±adido con √©xito.", 'exercise');
    } catch (err) { setApiErrorFormAgregar(`Error al guardar: ${err.message}`); }
  };

  // Abre el modal para confirmar el borrado de un ejercicio
  const handleBorrarEjercicio = (ejercicio) => {
    setApiErrorFormAgregar(null);
    setSuccessMsg(null);
    setExerciseSuccessMsg(null);
    setEjercicioAEliminar({ id: ejercicio.id, nombre: ejercicio.nombre_ejercicio });
    setIsConfirmarBorrarEjercicioOpen(true);
  };

  // Confirma y ejecuta el borrado del ejercicio de la rutina.
  const handleConfirmarBorrarEjercicio = async () => {
    if (!ejercicioAEliminar) return;
    setApiErrorFormAgregar(null);
    setIsDeletingEjercicio(true);
    const token = localStorage.getItem('movium_token');
    try {
      const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/delete_ejercicio_de_rutina.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ id: ejercicioAEliminar.id })
      });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.mensaje || 'Error al borrar el ejercicio');
      }
      setEjerciciosEnRutina(data.ejercicios_actualizados);
      showTemporaryMessage("Ejercicio borrado.", 'exercise');
    } catch (err) {
      setApiErrorFormAgregar(err.message);
    } finally {
      setIsConfirmarBorrarEjercicioOpen(false);
      setIsDeletingEjercicio(false);
      setEjercicioAEliminar(null);
    }
  };

  // Callback del modal EditarEjercicioModal.
  const handleGuardarCambios = async (datosEjercicio, setModalError) => {
    const token = localStorage.getItem('movium_token');
    setSuccessMsg(null); setExerciseSuccessMsg(null);
    try {
      const response = await fetch('http://localhost/programacion/TFG/movium/backend/api/update_ejercicio_en_rutina.php', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(datosEjercicio) });
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.mensaje || 'Error al guardar cambios');
      }

      setEjerciciosEnRutina(data.ejercicios_actualizados);
      setEjercicioParaEditar(null); // Cierra el modal
      showTemporaryMessage("Ejercicio actualizado.", 'exercise');
    } catch (err) { setModalError(err.message); } // Muestra el error DENTRO del modal
  };

  // Renderizado de Carga
  if (loading) return <div className="rutina-detalle-container"><p className="subtitle">Cargando...</p></div>;

  // Renderizado de Error
  if (error) return (<div className="rutina-detalle-container"><button className="btn-volver" onClick={() => navigate('/')}>&larr; Volver</button><div className="message">{error}</div></div>);

  // Renderizado de Rutina no encontrada
  if (!rutinaInfo) return <div className="rutina-detalle-container"><p className="subtitle">Rutina no encontrada.</p></div>;

  // Renderizado Principal
  return (
    <>
      <div className="rutina-detalle-container">

        <button className="btn-volver" onClick={() => navigate('/')}>&larr; Volver</button>

        {/* --- Cabecera (Modo Vista o Modo Edici√≥n) --- */}
        {!isEditingInfo ? (
          // Modo Vista
          <div style={{ position: 'relative', marginBottom: '1rem' }}>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
              <img src={iconoCrear} alt="" width="64" height="64" /> <h2>{rutinaInfo.nombre}</h2>
            </div>
            <p className="subtitle" style={{ textAlign: 'center' }}>{rutinaInfo.dias_semana || "A√±ade o edita los ejercicios para este d√≠a."}</p>
            <button className="btn-edit-info" style={{ top: '0', right: '0' }} onClick={() => { setIsEditingInfo(true); setSuccessMsg(null); setExerciseSuccessMsg(null); setApiErrorFormEditar(null); }} title="Editar nombre y d√≠as">‚úèÔ∏è</button>

            {successMsg && !apiErrorFormEditar && <div className="message success" style={{ marginTop: '1rem' }}>{successMsg}</div>}
          </div>
        ) : (
          // Modo Edici√≥n (Formulario para info de la rutina)
          <form className="form-editar-rutina-inline" onSubmit={handleUpdateRutinaInfo}>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '1.5rem', gap: '10px' }}>
              <img src={iconoCrear} alt="" width="64" height="64" /> <h3>Configuraci√≥n de la Rutina</h3>
            </div>
            {apiErrorFormEditar && <div className="message">{apiErrorFormEditar}</div>}

            <div className="form-grid">
              <div className="form-group-small" style={{ gridColumn: 'span 2' }}>
                <label htmlFor="editedName">Nombre</label>
                <input type="text" id="editedName" value={editedName} onChange={(e) => { setEditedName(e.target.value); setSuccessMsg(null); }} required maxLength={MAX_TITULO_LENGTH} />
                <small className="char-counter">
                  {editedName.length} / {MAX_TITULO_LENGTH}
                </small>
              </div>
              <div className="form-group-small" style={{ gridColumn: 'span 2' }}>
                <label htmlFor="editedDays">D√≠as / Descripci√≥n</label>
                <input type="text" id="editedDays" value={editedDays} onChange={(e) => { setEditedDays(e.target.value); setSuccessMsg(null); }} placeholder="Ej: Lunes, Jueves" maxLength={MAX_DIAS_LENGTH} />
                <small className="char-counter">
                  {editedDays.length} / {MAX_DIAS_LENGTH}
                </small>
              </div>

              {/* Selector para el orden */}
              <div className="form-group-small">
                <label htmlFor="editedOrden">Orden en Inicio</label>
                <select
                  id="editedOrden"
                  value={editedOrden}
                  onChange={(e) => setEditedOrden(e.target.value)}
                  required
                >
                  {rutinaInfo && rutinaInfo.max_orden_disponible &&
                    Array.from({ length: rutinaInfo.max_orden_disponible }, (_, i) => i + 1)
                      .map(numero => (
                        <option key={numero} value={numero}>
                          {numero}
                        </option>
                      ))
                  }
                  {(!rutinaInfo || !rutinaInfo.max_orden_disponible) && (
                    <option value={editedOrden || 1}>{editedOrden || 1}</option>
                  )}
                </select>
              </div>

              {/* Selector de color */}
              <div className="form-group-small">
                <label htmlFor="editedColor">Color de Tarjeta</label>
                <div className="color-input-container">
                  <input
                    type="color"
                    id="editedColor"
                    value={editedColor || "#000000"}
                    onChange={(e) => setEditedColor(e.target.value)}
                  />
                  <button
                    type="button"
                    className="btn-cancel-inline"
                    onClick={() => setEditedColor("")}
                    title="Quitar color"
                  >
                    Quitar
                  </button>
                </div>
              </div>
            </div>

            {/* Acciones del formulario de edici√≥n de rutina */}
            <div className="form-actions-rutina-inline">
              <button type="button" className="btn-delete-rutina-inline" onClick={handleDeleteRutina}>Eliminar Rutina</button>
              <div className="form-actions-rutina-inline-right">
                <button type="button" className="btn-cancel-inline" onClick={handleCancelEditInfo}>Cancelar</button>
                <button type="submit" className="transparent-btn-inline">Guardar</button>
              </div>
            </div>
          </form>
        )}

        {/* --- Formulario de A√±adir Ejercicio --- */}
        <form className="form-agregar-ejercicio" onSubmit={handleAgregarEjercicio}>
          <h3>A√±adir Ejercicio</h3>
          <div className="form-grid">
            <div className="form-group-select" style={{ gridColumn: '1 / -1' }}>
              <label>Ejercicio</label>
              <button
                type="button"
                className="select-ejercicio-btn"
                onClick={() => setIsSelectorModalOpen(true)}
              >
                {ejercicioSeleccionado
                  ? `${ejercicioSeleccionado.nombre} (${ejercicioSeleccionado.tipo})`
                  : "-- Selecciona --"}
              </button>
            </div>

            {/* Renderiza el formulario de Fuerza o Cardio seg√∫n el ejercicio seleccionado */}
            {!ejercicioSeleccionado ?
              (
                <p className="subtitle" style={{ gridColumn: '1 / -1', textAlign: 'center' }}>Selecciona un ejercicio para a√±adir series o intervalos.</p>
              ) : ejercicioSeleccionado.tipo === 'cardio' ?
                (
                  <FormularioCardio
                    objetivos={objetivosParaAgregar} setObjetivos={setObjetivosParaAgregar}
                    tiempo={tiempoCardioState}
                    distancia={distanciaCardioState}
                    descanso={descansoCardioState}
                    onFormChange={handleAddFormChange} // <-- Pasa el handler
                  />
                ) : (
                  <FormularioFuerza
                    objetivos={objetivosParaAgregar} setObjetivos={setObjetivosParaAgregar}
                    tipoRep={tipoRepState} setTipoRep={setTipoRepState}
                    repsMin={repsMinState}
                    repsMax={repsMaxState}
                    peso={pesoState}
                    descanso={descansoState}
                    onFormChange={handleAddFormChange} // <-- Pasa el handler
                  />
                )}
          </div>

          {/* Botones de acci√≥n para a√±adir series/intervalos y guardar el ejercicio completo */}
          {ejercicioSeleccionado && (
            <div className="form-actions-right">
              {objetivosParaAgregar.length > 0 && (
                <button type="submit" className="transparent-btn">
                  Guardar Ejercicio en Rutina
                  {` (${objetivosParaAgregar.length} ${objetivosParaAgregar.length > 1
                    ? (ejercicioSeleccionado.tipo === 'cardio' ? 'intervalos' : 'series')
                    : (ejercicioSeleccionado.tipo === 'cardio' ? 'intervalo' : 'serie')})`}
                </button>
              )}
              <button
                type="button"
                onClick={ejercicioSeleccionado.tipo === 'cardio'
                  ? handleAddIntervaloToList
                  : handleAddSerieToList}
                className="btn-add-serie"
              >
                {ejercicioSeleccionado.tipo === 'cardio'
                  ? 'A√±adir Intervalo'
                  : 'A√±adir Serie'}
              </button>
            </div>
          )}
        </form>

        {/* --- Bloque de Mensajes (Errores o √âxito) --- */}
        <div style={{ marginTop: '1rem', marginBottom: '1rem' }}>
          {apiErrorFormAgregar && <div className="message">{apiErrorFormAgregar}</div>}
          {exerciseSuccessMsg && !isEditingInfo && <div className="message success">{exerciseSuccessMsg}</div>}
        </div>

        {/* --- Lista de Ejercicios Guardados en la Rutina --- */}
        <div className="lista-ejercicios">
          <h3>Ejercicios en esta Rutina</h3>
          {ejerciciosEnRutina.length === 0 ?
            (
              <p className="no-rutinas-msg">A√∫n no has a√±adido ejercicios.</p>
            ) : (
              <div className="table-container">
                <table>
                  <thead><tr><th>Orden</th><th>Ejercicio</th><th>Detalle</th><th>Acciones</th></tr></thead>
                  <tbody>
                    {/* Ordena los ejercicios por su campo 'orden' antes de mapearlos */}
                    {ejerciciosEnRutina.sort((a, b) => a.orden - b.orden).map(ej => (
                      <tr key={ej.id}>
                        <td>{ej.orden}</td>
                        <td><strong>{ej.nombre_ejercicio}</strong> <small>({ej.tipo})</small></td>
                        <td className="cell-objetivos">
                          {ej.objetivos.length === 0 ? <small>Sin objetivos</small> : (
                            <ul>
                              {/* Ordena las series/intervalos por su 'num_serie' */}
                              {ej.objetivos.sort((a, b) => a.num_serie - b.num_serie).map(obj => (
                                <li key={obj.id || obj.num_serie}>
                                  {formatObjetivoTabla(obj, ej.tipo)}
                                </li>
                              ))}
                            </ul>)}
                        </td>
                        <td>
                          <div className="acciones-tabla">
                            <button className="btn-edit-small" onClick={() => {
                              setEjercicioParaEditar(ej);
                              setSuccessMsg(null); setExerciseSuccessMsg(null); setApiErrorFormAgregar(null);
                            }}>Editar</button>
                            <button className="btn-delete-small" onClick={() => handleBorrarEjercicio(ej)}>Borrar</button>
                          </div>
                        </td>
                      </tr>))}
                  </tbody>
                </table>
              </div>
            )}
        </div>

      </div> {/* Fin rutina-detalle-container */}

      {/* --- Modales --- */}
      <SelectorEjerciciosModal
        isOpen={isSelectorModalOpen}
        onClose={() => {
          setIsSelectorModalOpen(false);
          setSuccessMsg(null); setExerciseSuccessMsg(null);
        }}
        listaEjercicios={ejerciciosMaestra}
        onEjercicioSelect={handleSelectEjercicio}
      />

      <EditarEjercicioModal
        isOpen={ejercicioParaEditar !== null}
        onClose={() => {
          setEjercicioParaEditar(null);
          setApiErrorFormAgregar(null); setSuccessMsg(null); setExerciseSuccessMsg(null);
        }}
        ejercicio={ejercicioParaEditar}
        onGuardar={handleGuardarCambios}
        // Pasa el n√∫mero total de ejercicios (para el selector de orden)
        maxOrden={ejerciciosEnRutina.length}
      />

      <ConfirmarBorradoModal
        isOpen={isDeleteModalOpen}
        onClose={() => setIsDeleteModalOpen(false)}
        onConfirm={handleConfirmDelete}
        rutinaNombre={rutinaInfo ? rutinaInfo.nombre : ""}
        isDeleting={isDeleting}
      />

      <ConfirmarBorrarEjercicioModal
        isOpen={isConfirmarBorrarEjercicioOpen}
        onClose={() => {
          setIsConfirmarBorrarEjercicioOpen(false);
          setEjercicioAEliminar(null);
        }}
        onConfirm={handleConfirmarBorrarEjercicio}
        ejercicioNombre={ejercicioAEliminar ? ejercicioAEliminar.nombre : ""}
        isDeleting={isDeletingEjercicio}
      />

      {/* Modal de Gu√≠a/Tutorial para esta p√°gina */}
      <GuiaModal
        isOpen={showGuiaRutina}
        onClose={handleCerrarGuiaRutina}
        titulo="¬°A√±ade tu primer ejercicio!"
      >
        <p>¬°Genial! Ya tienes tu rutina. Ahora pulsa <strong>"A√±adir Ejercicio"</strong> para empezar.</p>
        <p><strong>1. Selecciona un Ejercicio:</strong> Elige de la lista (ej: "Press de Banca").</p>
        <p><strong>2. Define tus Series:</strong> Si es un ejercicio de fuerza, a√±ade tus series (ej: 3 series de 10 repeticiones con 50kg).</p>
        <p><strong>3. Define tus Intervalos:</strong> Si es cardio, a√±ade el tiempo y distancia (ej: 20 minutos / 3 km).</p>
        <p><strong>4. Guarda el Ejercicio:</strong> El ejercicio aparecer√° en la tabla de abajo.</p>
        <p><strong>¬°Truco extra!</strong> En el l√°piz (‚úèÔ∏è) que hay arriba, puedes <strong>asignarle un color a tu rutina</strong>. As√≠ tu inicio ser√° m√°s visual, adem√°s, ese color aparecer√° en el calendario para que sepas qu√© entrenaste de un vistazo.</p>
        <br />
        <p>¬°No te preocupes! Puedes <strong>editar</strong> o <strong>borrar</strong> cualquier ejercicio cuando quieras usando los botones de la tabla.</p>
      </GuiaModal>
    </>
  );
}

export default RutinaDetalle;

--- RutinaProgreso.css ---

/* ---- frontend/src/RutinaProgreso.css (Reescrito con ajuste m√≥vil para gr√°fica) ---- */

.progreso-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 900px;
  margin: 0 auto;
}

.progreso-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
}

.progreso-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 2rem;
}

.btn-volver {
  background: none;
  border: 1px solid var(--input-border-color);
  color: var(--text-secondary-color);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  font-family: var(--font-family);
  transition: all 0.3s ease;
  margin-bottom: 1.5rem;
}

.btn-volver:hover {
  background-color: var(--input-bg-color);
  color: var(--text-color);
}

/* --- Contenedor de la Gr√°fica (Con aspect-ratio CSS) --- */
.chart-container-progreso {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
  margin-bottom: 2.5rem;
  position: relative;
  width: 100%;
  box-sizing: border-box;
  overflow: hidden;

  /* Proporci√≥n por defecto para escritorio (ancha) */
  aspect-ratio: 2 / 1;
}

/* Regla para el canvas */
.chart-container-progreso canvas {
  display: block;
  max-width: 100%;
  height: auto;
  /* El canvas deber√≠a ajustarse autom√°ticamente al contenedor con aspect-ratio */
}

/* --- Historial de Sesiones (Sin cambios respecto a tu √∫ltima versi√≥n) --- */
.historial-titulo {
  color: var(--text-color);
  border-bottom: 1px solid var(--input-border-color);
  padding-bottom: 0.5rem;
  margin-bottom: 1.5rem;
  margin-top: 2.5rem;
}

.historial-container {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.sesion-card {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
}

.sesion-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.5rem 1rem;
  padding-bottom: 1rem;
  margin-bottom: 1rem;
  border-bottom: 1px solid var(--input-border-color);
}

.sesion-header strong {
  font-size: 1.25rem;
  color: var(--primary-color);
  flex-shrink: 0;
}

.sesion-totales {
  display: flex;
  gap: 0.75rem;
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  flex-grow: 1;
  justify-content: center;
  flex-wrap: wrap;
  padding: 0 0.5rem;
}

.sesion-totales span {
  white-space: nowrap;
}

.sesion-nota {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  cursor: help;
  flex-shrink: 0;
}

.ejercicios-container {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.ejercicio-grupo {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.ejercicio-grupo > strong {
  font-size: 1.05rem;
  color: var(--text-color);
  font-weight: 700;
}

.ejercicio-grupo ul {
  list-style: none;
  padding-left: 1rem;
  margin: 0;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.serie-item {
  display: flex;
  justify-content: space-between;
  gap: 0.75rem;
  font-size: 0.95rem;
  color: var(--text-secondary-color);
  align-items: baseline;
}

.serie-item span:first-child {
  color: var(--text-color);
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 40px;
}

.serie-item span:nth-child(2) {
  text-align: right;
  flex-grow: 1;
}

.serie-nota-historial {
  color: var(--text-secondary-color);
  font-size: 0.85rem;
  cursor: help;
  margin-left: 0.5rem;
  flex-shrink: 0;
}

.fallo-tag {
  background-color: var(--primary-color);
  color: #fff;
  font-size: 0.7rem;
  padding: 0.1rem 0.3rem;
  border-radius: 4px;
  font-weight: bold;
  margin-left: 0.4rem;
  white-space: nowrap;
  vertical-align: middle;
}

/* --- Mensaje Sin Datos (sin cambios) --- */
.no-data-msg {
  text-align: center;
  color: var(--text-secondary-color);
  font-style: italic;
  padding: 2rem;
  background-color: var(--surface-color);
  border: 1px dashed var(--input-border-color);
  border-radius: 12px;
}

/* --- Bot√≥n Cargar M√°s (sin cambios) --- */
.btn-cargar-mas {
  display: block;
  margin: 2rem auto 0;
  padding: 0.75rem 1.5rem;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--text-secondary-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 999px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
}

.btn-cargar-mas:hover:not(:disabled) {
  background-color: var(--input-border-color);
  color: var(--text-color);
}

.btn-cargar-mas:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* --- Media Query para M√≥viles (MODIFICADO) --- */
@media (max-width: 600px) {
  .progreso-container {
    padding: 1.5rem;
  }

  /* Ajustar proporci√≥n en m√≥vil para M√ÅS ALTURA */
  .chart-container-progreso {
     padding: 1rem;
     /* Mantenemos 1/1, parece una buena proporci√≥n para m√≥vil */
     aspect-ratio: 1 / 1;
     /* Ya no necesitamos min-height aqu√≠ */
  }

  /* Ajustes para el historial en m√≥vil (sin cambios) */
  .sesion-header {
    flex-direction: column;
    align-items: flex-start;
  }
  .sesion-totales {
    justify-content: flex-start;
    padding: 0;
    margin-top: 0.25rem;
  }
  .serie-item {
    flex-wrap: wrap;
  }
  .serie-item span:nth-child(2) {
    text-align: left;
  }
}

--- RutinaProgreso.js ---

// ---- frontend/src/RutinaProgreso.js (Click para Notas + Duraci√≥n + Modal Fix) ----

import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import './RutinaProgreso.css'; // Aseg√∫rate que la ruta al CSS es correcta
import { Line } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
} from 'chart.js';
import iconoEstadisticas from './assets/estadisticas.png';

// Registrar los componentes necesarios de Chart.js
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend
);

// --- Constantes ---
const ITEMS_PER_PAGE = 10;

// --- Funciones Helper ---
const formatFecha = (fechaISO) => {
  if (!fechaISO) return '';
  return new Date(fechaISO).toLocaleDateString('es-ES', {
    day: '2-digit', month: '2-digit', year: 'numeric'
  });
};

const formatDuracion = (duracionSql) => {
    if (!duracionSql || duracionSql === '00:00:00') return null;
    const partes = duracionSql.split(':');
    const horas = parseInt(partes[0], 10);
    const minutos = parseInt(partes[1], 10);

    let resultado = '';
    if (horas > 0) {
        resultado += `${horas}h `;
    }
    if (minutos > 0 || horas === 0) {
        resultado += `${minutos}m`;
    }
    return resultado.trim();
};

// --- *** Componente Modal Simple para Notas (CORREGIDO) *** ---
const NotaModal = ({ nota, onClose }) => {
    // **No renderizar si no hay nota o si onClose no es una funci√≥n (seguridad)**
    if (!nota || typeof onClose !== 'function') return null;

    // Estilos inline b√°sicos para el modal
    const backdropStyle = {
        position: 'fixed', top: 0, left: 0, width: '100%', height: '100%',
        backgroundColor: 'rgba(0, 0, 0, 0.7)', // Fondo m√°s oscuro
        display: 'flex',
        alignItems: 'center', justifyContent: 'center', zIndex: 1100,
        animation: 'fadeInModal 0.2s ease-out' // Animaci√≥n suave
    };
    const contentStyle = {
        backgroundColor: 'var(--surface-color)', padding: '1.5rem', borderRadius: '12px', // Bordes m√°s redondeados
        maxWidth: '450px', // Un poco m√°s ancho si es necesario
        width: '90%',       // Asegura margen en los lados
        maxHeight: '70vh', // Limita la altura
        overflowY: 'auto',  // Scroll si el contenido es largo
        border: '1px solid var(--input-border-color)', position: 'relative',
        fontSize: '1rem', // Tama√±o de fuente base
        lineHeight: '1.6',
        boxSizing: 'border-box', // Importante para que el padding no sume al width
        animation: 'slideInModal 0.2s ease-out' // Animaci√≥n de entrada
    };
    const closeButtonStyle = {
        position: 'absolute', top: '0.75rem', right: '0.75rem', // Ajuste posici√≥n
        background: 'none',
        border: 'none', fontSize: '1.8rem', // Tama√±o adecuado
        color: 'var(--text-secondary-color)', cursor: 'pointer',
        lineHeight: 1, // Evita espacio extra vertical
        padding: '0.2rem' // √Årea clicable un poco mayor
    };
     const closeButtonHoverStyle = { // Estilo para hover (simulado aqu√≠, mejor con CSS)
        color: 'var(--text-color)',
    };
    const notaTextStyle = {
        whiteSpace: 'pre-wrap',
        wordBreak: 'break-word',
        marginTop: '0.5rem', // Menos espacio arriba
        marginBottom: '0', // Sin espacio extra abajo
        color: 'var(--text-color)'
    };

    // Keyframes para las animaciones (se podr√≠an poner en CSS global)
    const keyframesStyle = `
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInModal { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    `;

    return (
        <>
            <style>{keyframesStyle}</style> {/* Inyecta los keyframes */}
            {/* **Backdrop llama a onClose al hacer clic** */}
            <div style={backdropStyle} onClick={onClose}>
                {/* **Contenido detiene la propagaci√≥n para no cerrar al hacer clic dentro** */}
                <div style={contentStyle} onClick={(e) => e.stopPropagation()}>
                    {/* **Bot√≥n llama a onClose al hacer clic** */}
                    <button
                        style={closeButtonStyle}
                        onClick={onClose}
                        onMouseEnter={(e) => e.currentTarget.style.color = closeButtonHoverStyle.color} // Simula hover
                        onMouseLeave={(e) => e.currentTarget.style.color = closeButtonStyle.color} // Restaura color
                        aria-label="Cerrar nota" // Accesibilidad
                    >
                        &times;
                    </button>
                    <h4 style={{marginTop: 0, marginBottom: '1rem', color: 'var(--primary-color)'}}>Nota:</h4>
                    <p style={notaTextStyle}>{nota}</p>
                </div>
            </div>
        </>
    );
};
// --- *** FIN Componente Modal *** ---


// --- Componente Principal ---
function RutinaProgreso() {
  const { id: rutinaId } = useParams();
  const navigate = useNavigate();
  // --- Estados ---
  const [loading, setLoading] = useState(true);
  const [loadingMore, setLoadingMore] = useState(false);
  const [error, setError] = useState(null);
  const [rutinaNombre, setRutinaNombre] = useState('');
  const [datosGrafica, setDatosGrafica] = useState([]);
  const [datosHistorial, setDatosHistorial] = useState([]);
  const [currentPage, setCurrentPage] = useState(1);
  const [totalSesiones, setTotalSesiones] = useState(0);
  const [isMobile, setIsMobile] = useState(window.innerWidth < 600);
  const [isNotaModalOpen, setIsNotaModalOpen] = useState(false);
  const [notaParaMostrar, setNotaParaMostrar] = useState('');

  // --- Efecto para actualizar isMobile ---
  useEffect(() => {
    const handleResize = () => {
      setIsMobile(window.innerWidth < 600);
    };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  // --- Cargar Datos ---
  const cargarProgreso = useCallback(async (pageToLoad) => {
    const isInitialLoad = pageToLoad === 1;
    if (isInitialLoad) { setLoading(true); } else { setLoadingMore(true); }
    setError(null);
    const token = localStorage.getItem('movium_token');
    if (!token) { setError("Error de autenticaci√≥n."); setLoading(false); setLoadingMore(false); return; }

    try {
      const res = await fetch(`http://localhost/programacion/TFG/movium/backend/api/get_progreso_rutina.php?id=${rutinaId}&page=${pageToLoad}`, { headers: { 'Authorization': `Bearer ${token}` } });
      const data = await res.json();
      if (!res.ok) { throw new Error(data.mensaje || "Error al cargar el progreso."); }

      if (isInitialLoad) {
        setRutinaNombre(data.rutina_info?.nombre || 'Progreso de Rutina');
        setDatosGrafica(data.grafica || []);
        setDatosHistorial(data.historial || []);
        setTotalSesiones(data.total_sesiones || 0);
        setCurrentPage(1);
      } else {
        setDatosHistorial(prev => [...prev, ...(data.historial || [])]);
        setCurrentPage(pageToLoad);
      }
    } catch (err) { setError(err.message); }
    finally { if (isInitialLoad) { setLoading(false); } else { setLoadingMore(false); } }
  }, [rutinaId]);

  // --- Efecto Inicial ---
  useEffect(() => { cargarProgreso(1); }, [cargarProgreso]);

  // --- Handler Cargar M√°s ---
  const handleLoadMore = () => { if (!loadingMore && datosHistorial.length < totalSesiones) { cargarProgreso(currentPage + 1); } };

  // --- Handler para mostrar notas ---
  const handleMostrarNota = (notaTexto) => {
      if(notaTexto){
        setNotaParaMostrar(notaTexto);
        setIsNotaModalOpen(true);
      }
  };

  // --- *** NUEVO: Handler para cerrar el modal de notas *** ---
  const handleCloseNotaModal = () => {
      setIsNotaModalOpen(false);
      // Opcional: limpiar la nota despu√©s de cerrar para evitar mostrarla brevemente la pr√≥xima vez
      // setNotaParaMostrar('');
  };
  // --- *** FIN NUEVO HANDLER *** ---

  // --- Preparaci√≥n Gr√°ficas ---
  const { labels, datosGraficaFiltrados } = useMemo(() => {
    const limiteDatos = isMobile && datosGrafica.length > 20 ? 20 : datosGrafica.length;
    const datosFiltrados = datosGrafica.slice(-limiteDatos);
    const labelsFiltrados = datosFiltrados.map(d => `S${d.sesion_num}`);
    return { labels: labelsFiltrados, datosGraficaFiltrados: datosFiltrados };
  }, [datosGrafica, isMobile]);

  const getCommonChartOptions = useCallback((titleText) => ({
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
        labels: {
          usePointStyle: true,
          pointStyle: 'circle',
          padding: 20,
          color: '#CCCCCC',
          font: { size: 11 },
        }
      },
      title: {
        display: true,
        text: `${titleText} (√öltimas ${datosGraficaFiltrados.length} Sesiones)`
      }
    },
    scales: {
      x: {
        ticks: {
          autoSkip: true,
          maxTicksLimit: isMobile ? 6 : 20,
          maxRotation: isMobile ? 90 : 0,
          minRotation: isMobile ? 45 : 0,
          font: { size: isMobile ? 9 : 11 }
        }
      },
      yVolumen: { display: false },
      yReps: { display: false },
      yTiempo: { display: false },
      yDistancia: { display: false },
      yVelocidad: { display: false }
    }
  }), [isMobile, datosGraficaFiltrados.length]);

  const hayDatosFuerza = useMemo(() => datosGraficaFiltrados.some(d => parseFloat(d.volumen_fuerza) > 0 || parseFloat(d.reps_totales_fuerza) > 0), [datosGraficaFiltrados]);
  const hayDatosCardio = useMemo(() => datosGraficaFiltrados.some(d => parseFloat(d.tiempo_cardio) > 0 || parseFloat(d.distancia_cardio) > 0), [datosGraficaFiltrados]);

  // Opciones Gr√°fica Fuerza
  const { chartDataFuerza, chartOptionsFuerza } = useMemo(() => {
    const datasets = [
      { label: 'Volumen (kg)', data: datosGraficaFiltrados.map(d => d.volumen_fuerza), borderColor: 'rgb(255, 99, 132)', tension: 0.1, yAxisID: 'yVolumen', pointStyle: 'circle', pointRadius: 3, pointHoverRadius: 5 },
      { label: 'Reps', data: datosGraficaFiltrados.map(d => d.reps_totales_fuerza), borderColor: 'rgb(54, 162, 235)', tension: 0.1, yAxisID: 'yReps', pointStyle: 'circle', pointRadius: 3, pointHoverRadius: 5 }
    ];
    const options = {
        ...getCommonChartOptions('Evoluci√≥n de Fuerza'),
        scales: {
            ...getCommonChartOptions('Evoluci√≥n de Fuerza').scales,
            yVolumen: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Volumen (kg)' }, beginAtZero: true },
            yReps: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Reps' }, grid: { drawOnChartArea: false }, beginAtZero: true }
        }
    };
    return { chartDataFuerza: { labels, datasets }, chartOptionsFuerza: options };
  }, [datosGraficaFiltrados, labels, getCommonChartOptions]);

  // Opciones Gr√°fica Cardio
  const { chartDataCardio, chartOptionsCardio } = useMemo(() => {
    const datasets = [
      { label: 'Tiempo (min)', data: datosGraficaFiltrados.map(d => d.tiempo_cardio), borderColor: 'rgb(46, 204, 113)', tension: 0.1, yAxisID: 'yTiempo', pointStyle: 'circle', pointRadius: 3, pointHoverRadius: 5 },
      { label: 'Distancia (km)', data: datosGraficaFiltrados.map(d => d.distancia_cardio), borderColor: 'rgb(153, 102, 255)', tension: 0.1, yAxisID: 'yDistancia', pointStyle: 'circle', pointRadius: 3, pointHoverRadius: 5 },
      { label: 'Velocidad (km/h)', data: datosGraficaFiltrados.map(d => d.velocidad_media_kmh > 0 ? parseFloat(d.velocidad_media_kmh).toFixed(1) : null), borderColor: 'rgb(255, 159, 64)', tension: 0.1, yAxisID: 'yVelocidad', pointStyle: 'circle', pointRadius: 3, pointHoverRadius: 5 }
    ];
    const options = {
        ...getCommonChartOptions('Evoluci√≥n de Cardio'),
        scales: {
            ...getCommonChartOptions('Evoluci√≥n de Cardio').scales,
            yTiempo: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Tiempo (min)' }, beginAtZero: true },
            yDistancia: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Distancia (km)' }, grid: { drawOnChartArea: false }, beginAtZero: true },
            yVelocidad: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Velocidad (km/h)' }, grid: { drawOnChartArea: false }, beginAtZero: true }
        }
    };
    return { chartDataCardio: { labels, datasets }, chartOptionsCardio: options };
  }, [datosGraficaFiltrados, labels, getCommonChartOptions]);

  // --- Renderizado ---
  if (loading) { return <div className="progreso-container"><p className="subtitle">Cargando progreso...</p></div>; }
  if (error && datosHistorial.length === 0) { return (<div className="progreso-container"><button className="btn-volver" onClick={() => navigate('/')}>&larr; Volver</button><div className="message">{error}</div></div>); }

  return (
    <> {/* Fragmento para envolver el modal */}
      <div className="progreso-container">
        <button className="btn-volver" onClick={() => navigate('/')}>&larr; Volver al Inicio</button>

        {/* --- Cabecera --- */}
        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
          <img src={iconoEstadisticas} alt="" width="64" height="64" />
          <h2>{rutinaNombre}</h2>
        </div>
        <p className="subtitle" style={{ textAlign: 'center' }}>
           Tu evoluci√≥n y el historial de sesiones para esta rutina.
        </p>
        {error && !loading && <div className="message" style={{marginBottom: '1.5rem'}}>{error}</div>}

        {/* Gr√°ficas */}
        {hayDatosFuerza && ( <div className="chart-container-progreso"> <Line options={chartOptionsFuerza} data={chartDataFuerza} /> </div> )}
        {hayDatosCardio && ( <div className="chart-container-progreso"> <Line options={chartOptionsCardio} data={chartDataCardio} /> </div> )}
        {!loading && !hayDatosFuerza && !hayDatosCardio && !error && ( <p className="no-data-msg">No hay datos suficientes para mostrar gr√°ficas.</p> )}

        {/* Historial */}
        <h3 className="historial-titulo">Historial de Sesiones ({totalSesiones} en total)</h3>
        <div className="historial-container">
          {datosHistorial.length > 0 ? (
            datosHistorial.map(sesion => {
              const duracionFormateada = formatDuracion(sesion.duracion);
              return (
                <div key={sesion.sesion_id} className="sesion-card">
                  <div className="sesion-header">
                    <strong>{formatFecha(sesion.fecha_inicio)}</strong>
                    <div className="sesion-totales">
                         {duracionFormateada && ( <span>üïí {duracionFormateada}</span> )}
                         {sesion.total_volumen_fuerza > 0 && ( <span>üèãÔ∏è {Math.round(sesion.total_volumen_fuerza)} kg</span> )}
                         {sesion.total_tiempo_cardio > 0 && ( <span>‚è±Ô∏è {sesion.total_tiempo_cardio} min</span> )}
                         {sesion.total_distancia_cardio > 0 && ( <span>üìç {sesion.total_distancia_cardio.toFixed(1)} km</span> )}
                    </div>
                    {/* *** MODIFICACI√ìN: onClick para nota de sesi√≥n *** */}
                    {sesion.notas_sesion && (
                      <span
                        className="sesion-nota"
                        onClick={() => handleMostrarNota(sesion.notas_sesion)}
                        style={{ cursor: 'pointer' }}
                        role="button"
                        aria-label="Ver nota de la sesi√≥n"
                       >
                         üìù
                       </span>
                     )}
                    {/* *** FIN MODIFICACI√ìN *** */}
                  </div>
                  <div className="ejercicios-container">
                    {sesion.ejercicios.map(ejercicio => (
                      <div key={ejercicio.orden + '_' + ejercicio.nombre_ejercicio} className="ejercicio-grupo">
                        <strong>{ejercicio.nombre_ejercicio}</strong>
                        <ul>
                          {ejercicio.series.map((serie, index) => (
                            <li key={index} className="serie-item">
                              <span>S{serie.num_serie}:</span>
                              {ejercicio.tipo_ejercicio === 'cardio' ? (
                                <span>
                                  {(serie.tiempo_min_realizado != null && serie.tiempo_min_realizado > 0) ? `${serie.tiempo_min_realizado} min` : ''}
                                  {(serie.distancia_km_realizada != null && serie.distancia_km_realizada > 0) ? ` ${ (serie.tiempo_min_realizado != null && serie.tiempo_min_realizado > 0) ? 'üìç' : '' } ${serie.distancia_km_realizada} km` : ''}
                                  {!(serie.tiempo_min_realizado > 0) && !(serie.distancia_km_realizada > 0) && '-'}
                                </span>
                              ) : (
                                <span>
                                  {serie.repeticiones_realizadas ?? '-'} reps
                                  {serie.peso_kg_usado != null && ` x ${serie.peso_kg_usado} kg`}
                                  {serie.fue_al_fallo && <span className="fallo-tag" title="Al fallo">F</span>}
                                </span>
                              )}
                              {/* *** MODIFICACI√ìN: onClick para nota de serie *** */}
                              {serie.notas_serie && (
                                <span
                                  className="serie-nota-historial"
                                  onClick={() => handleMostrarNota(serie.notas_serie)}
                                  style={{ cursor: 'pointer' }}
                                  role="button"
                                  aria-label={`Ver nota de la serie ${serie.num_serie}`}
                                 >
                                   üìù
                                 </span>
                               )}
                              {/* *** FIN MODIFICACI√ìN *** */}
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                </div>
              );
            }) // Fin map datosHistorial
          ) : (
            !loading && !error && <p className="no-data-msg">No has completado ninguna sesi√≥n para esta rutina todav√≠a.</p>
          )}
        </div>

        {/* Bot√≥n "Cargar M√°s" */}
        {datosHistorial.length < totalSesiones && (
          <button className="btn-cargar-mas" onClick={handleLoadMore} disabled={loadingMore}>
            {loadingMore ? 'Cargando...' : 'Cargar sesiones anteriores'}
          </button>
        )}
      </div>

      {/* *** MODAL DE NOTAS RENDERIZADO CONDICIONALMENTE *** */}
      {isNotaModalOpen && (
          <NotaModal
              nota={notaParaMostrar}
              onClose={handleCloseNotaModal} // Usa la nueva funci√≥n para cerrar
          />
      )}
      {/* *** FIN MODAL *** */}
    </>
  );
}

export default RutinaProgreso;

--- search_usuarios.php ---

<?php
// ---- backend/api/search_usuarios.php (CORREGIDO) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: GET");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;

if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) { 
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die();
    }
} else { 
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die();
}

// --- PASO 2: Obtener Query de B√∫squeda (Sin cambios) ---
$query_str = $_GET['query'] ?? '';
$mi_id = $usuario_id;

// --- PASO 3: L√≥gica de B√∫squeda (¬°MODIFICADA!) ---
$database = new Database();
$db = $database->getConnection();

try {
    // Esta consulta busca usuarios (u)
    // Y hace un LEFT JOIN con 'amistades' (a) para ver si existe
    // una fila donde (a.usuario_id = mi_id) y (a.amigo_id = u.id)
    $query = "SELECT 
                u.id, 
                u.nombre_usuario,
                (a.amigo_id IS NOT NULL) AS son_amigos 
              FROM 
                usuarios u
              LEFT JOIN 
                amistades a ON u.id = a.amigo_id AND a.usuario_id = :mi_id
              WHERE 
                /* --- ¬°CAMBIO AQU√ç! --- */
                /* Convertimos ambos lados a min√∫sculas antes de comparar */
                LOWER(u.nombre_usuario) LIKE LOWER(:query_str) 
                /* --- FIN DEL CAMBIO --- */
                AND u.id != :mi_id 
              LIMIT 20";
              
    $stmt = $db->prepare($query);
    
    // El bindValue sigue siendo el mismo, con los %
    $stmt->bindValue(':query_str', '%' . htmlspecialchars(strip_tags($query_str)) . '%');
    $stmt->bindParam(':mi_id', $mi_id, PDO::PARAM_INT);
    $stmt->execute();

    $usuarios = $stmt->fetchAll(PDO::FETCH_ASSOC);

    // Convertimos 'son_amigos' a booleano (Sin cambios)
    foreach ($usuarios as $key => $user) {
        $usuarios[$key]['son_amigos'] = (bool)$user['son_amigos'];
    }

    http_response_code(200);
    echo json_encode($usuarios);

} catch (Exception $e) {
    http_response_code(500);
    echo json_encode(array(
        "mensaje" => "Error al buscar usuarios.",
        "error" => $e->getMessage()
    ));
}
?>

--- SelectorEjerciciosModal.css ---

/* ---- frontend/src/components/SelectorEjerciciosModal.css (CORREGIDO) ---- */

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 70vh; /* L√≠mite de altura */
  box-shadow: var(--box-shadow);
  display: flex;
  flex-direction: column;
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--input-border-color);
}

.modal-header h3 {
  margin: 0;
  font-size: 1.25rem;
}

.modal-close-btn {
  background: none;
  border: none;
  font-size: 2rem;
  color: var(--text-secondary-color);
  cursor: pointer;
  line-height: 1;
  padding: 0;
}
.modal-close-btn:hover {
  color: var(--text-color);
}

.modal-filters {
  display: flex;
  gap: 1rem;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid var(--input-border-color);
}

.modal-search {
  flex: 2;
  height: 48px;
  padding: 0 0.8rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
}
.modal-group-select {
  flex: 1;
  height: 48px;
  padding: 0 0.8rem;
  font-size: 1rem;
  font-family: var(--font-family);
  color: var(--text-color);
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
}

.modal-list {
  flex: 1; /* Ocupa el resto del espacio */
  overflow-y: auto; /* ¬°Scroll si hay muchos! */
  min-height: 0;
  padding: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.modal-list-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: 1rem;
  background-color: var(--input-bg-color);
  border: 1px solid var(--input-border-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: var(--font-family);
  text-align: left;
}
.modal-list-item:hover {
  background-color: var(--input-border-color);
  border-color: var(--primary-color);
  transform: scale(1.02);
}
.modal-list-item strong {
  font-size: 1rem;
  color: var(--text-color);
}
.modal-list-item span {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  background-color: var(--bg-color);
  padding: 0.2rem 0.5rem;
  border-radius: 6px;
}

.modal-no-results {
  padding: 2rem;
  text-align: center;
  color: var(--text-secondary-color);
}


/* --- Media Query para M√≥vil (CORREGIDA) --- */
@media (max-width: 600px) { /* O el breakpoint que uses */

  .modal-filters {
    flex-direction: column;
    /* --- ¬°CAMBIO AQU√ç! --- */
    /* Le devolvemos un espacio vertical (gap) */
    gap: 0.75rem; /* (Antes era 0rem) */
  }

  .modal-search,
  .modal-group-select {
    width: 100%; /* FORZAMOS a que ocupen todo el ancho disponible */
    flex: none; /* Anula las propiedades flex de escritorio */
  }

}

--- SelectorEjerciciosModal.js ---

// ---- frontend/src/components/SelectorEjerciciosModal.js (NUEVO ARCHIVO) ----

import React, { useState, useMemo } from 'react';
import './SelectorEjerciciosModal.css'; // <-- Crearemos este CSS

function SelectorEjerciciosModal({ 
  isOpen, 
  onClose, 
  listaEjercicios, 
  onEjercicioSelect 
}) {

  // 1. ESTADOS
  const [filtroNombre, setFiltroNombre] = useState("");
  const [filtroGrupo, setFiltroGrupo] = useState("Todos");

  // 2. L√ìGICA DE FILTRADO
  
  // Obtenemos la lista de grupos musculares √∫nicos (esto solo se calcula una vez)
  const gruposMusculares = useMemo(() => {
    const grupos = new Set(listaEjercicios.map(ej => ej.grupo_muscular));
    return ["Todos", ...grupos];
  }, [listaEjercicios]);

  // Filtramos la lista de ejercicios bas√°ndonos en los estados
  const listaFiltrada = useMemo(() => {
    return listaEjercicios.filter(ej => {
      // 1. Filtro por Grupo
      const pasaFiltroGrupo = (filtroGrupo === "Todos") || (ej.grupo_muscular === filtroGrupo);
      
      // 2. Filtro por Nombre
      const pasaFiltroNombre = ej.nombre.toLowerCase().includes(filtroNombre.toLowerCase());
      
      return pasaFiltroGrupo && pasaFiltroNombre;
    });
  }, [listaEjercicios, filtroNombre, filtroGrupo]);

  // 3. HANDLERS
  const handleSelect = (ejercicio) => {
    onEjercicioSelect(ejercicio); // Devuelve el ejercicio seleccionado
    onClose(); // Cierra el modal
  };

  // Si no est√° abierto, no renderiza nada
  if (!isOpen) {
    return null;
  }

  // 4. RENDERIZADO
  return (
    // Fondo oscuro
    <div className="modal-backdrop" onClick={onClose}>
      
      {/* Contenido del Modal (stopPropagation para evitar que se cierre al hacer clic dentro) */}
      <div className="modal-content" onClick={(e) => e.stopPropagation()}>
        
        {/* Encabezado y Bot√≥n de Cerrar */}
        <div className="modal-header">
          <h3>Seleccionar Ejercicio</h3>
          <button className="modal-close-btn" onClick={onClose}>&times;</button>
        </div>
        
        {/* Filtros */}
        <div className="modal-filters">
          <input 
            type="search" 
            placeholder="Buscar por nombre..." 
            className="modal-search"
            value={filtroNombre}
            onChange={(e) => setFiltroNombre(e.target.value)}
          />
          <select 
            className="modal-group-select"
            value={filtroGrupo}
            onChange={(e) => setFiltroGrupo(e.target.value)}
          >
            {gruposMusculares.map(grupo => (
              <option key={grupo} value={grupo}>{grupo || "Sin Grupo"}</option>
            ))}
          </select>
        </div>
        
        {/* Lista de Ejercicios */}
        <div className="modal-list">
          {listaFiltrada.length > 0 ? (
            listaFiltrada.map(ej => (
              <button 
                key={ej.id} 
                className="modal-list-item"
                onClick={() => handleSelect(ej)}
              >
                <strong>{ej.nombre}</strong>
                <span>{ej.grupo_muscular}</span>
              </button>
            ))
          ) : (
            <p className="modal-no-results">No se encontraron ejercicios.</p>
          )}
        </div>
        
      </div>
    </div>
  );
}

export default SelectorEjerciciosModal;

--- Sidebar.css ---

/* ---- frontend/src/components/Sidebar.css ---- */
.app-sidebar {
  grid-area: sidebar;
  background-color: var(--surface-color);
  border-right: 1px solid var(--input-border-color);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  box-sizing: border-box;

  /* --- MODIFICADO --- 
     Estilos para la animaci√≥n de colapso */
  transition: padding 0.3s ease-in-out, border 0.3s ease-in-out;
  overflow: hidden;
  white-space: nowrap;
}

/* --- NUEVO --- 
   Define el estado CERRADO del sidebar */
.app-layout.sidebar-closed .app-sidebar {
  padding: 0;
  border-right: none;
}

.sidebar-header {
  text-align: center;
  padding: 1rem 0;
  margin-bottom: 1rem;
}

.sidebar-icon {
  width: 60px;
  height: 60px;
}

.sidebar-nav {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.nav-link {
  display: block;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 700;
  color: var(--text-secondary-color);
  transition: all 0.3s ease;
}

.nav-link:hover {
  background-color: var(--input-bg-color);
  color: var(--text-color);
}

.nav-link.active {
  background-color: var(--primary-color);
  color: #fff;
}

/* Estilos para el footer del sidebar */
.sidebar-footer {
  padding-top: 1rem;
  border-top: 1px solid var(--input-border-color);

  /* --- NUEVO --- 
     La transici√≥n tambi√©n debe aplicarse aqu√≠ */
  transition: border-top 0.3s ease-in-out;
}

/* --- NUEVO --- 
   Oculta el borde superior del footer cuando est√° cerrado */
.app-layout.sidebar-closed .sidebar-footer {
  border-top: 1px solid transparent;
}


.sidebar-logout-btn {
  width: 100%;
  box-sizing: border-box;
}

--- Sidebar.js ---

// ---- frontend/src/components/Sidebar.js (CORREGIDO) ----
import React from 'react';
import './Sidebar.css';
import moviumIcon from '../assets/movium-icono.png';
// 1. Importar useLocation adem√°s de NavLink
import { NavLink, useLocation } from 'react-router-dom';
// 

function Sidebar() {
  // 2. Obtener el objeto location actual
  const location = useLocation();

  // --- L√≥gica de Logout (Sin cambios) ---
  const handleLogout = () => {
    localStorage.removeItem('movium_token');
    window.location.reload();
  };

  // --- ¬°¬°FUNCI√ìN CORREGIDA!! ---
  const isInicioActive = () => {
    const { pathname } = location;
    // A√±adimos la comprobaci√≥n para '/rutina/'
    return pathname === '/' || 
           pathname.startsWith('/rutina/') || 
           pathname.startsWith('/sesion/') || 
           pathname.startsWith('/progreso/');
  };
  // --- ¬°¬°FIN CORRECCI√ìN!! ---

  return (
    <aside className="app-sidebar">

      <div>
        <div className="sidebar-header">
          <img src={moviumIcon} alt="Movium Icon" className="sidebar-icon" />
        </div>
        <nav className="sidebar-nav">
          <NavLink
            to="/"
            className={() =>
               // Ahora llamar√° a la funci√≥n corregida
               `nav-link ${isInicioActive() ? 'active' : ''}`
            }
          >
            Inicio
          </NavLink>
          <NavLink to="/estadisticas" className="nav-link">
            R√©cords
          </NavLink>
          <NavLink to="/comunidad" className="nav-link">
            Comunidad
          </NavLink>
          <NavLink to="/ayuda" className="nav-link">
            Ayuda
          </NavLink>
          <NavLink to="/perfil" className="nav-link">
            Perfil
          </NavLink>
        </nav>
      </div>

      <div className="sidebar-footer">
        <button onClick={handleLogout} className="sidebar-logout-btn transparent-btn">
          Cerrar Sesi√≥n
        </button>
      </div>

    </aside>
  );
}

export default Sidebar;

--- update_ejercicio_en_rutina.php ---

<?php
// ---- backend/api/update_ejercicio_en_rutina.php (REESCRITO V6.0) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null; 
if ($authHeader) { $arr = explode(" ", $authHeader); $jwt = $arr[1] ?? null; }
if ($jwt) {
    try { $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256')); $usuario_id = $decoded->data->id; } 
    catch (Exception $e) { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido.")); die(); }
} else { http_response_code(401); echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token.")); die(); }

// --- PASO 2: Obtener datos JSON (Sin cambios) ---
$data = json_decode(file_get_contents("php://input"));
if (empty($data->id) || !isset($data->orden) || !isset($data->objetivos) || !is_array($data->objetivos)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos. Se requiere 'id' (del ejercicio), 'orden' y un array 'objetivos'."));
    die();
}

$ejercicio_rutina_id = $data->id;
$nuevo_orden = (int)$data->orden;
$objetivos = $data->objetivos; // El array de objetivos actualizado

// --- PASO 3: L√≥gica de Actualizaci√≥n V6.0 (CON TRANSACCI√ìN) ---
$database = new Database();
$db = $database->getConnection();

try {
    $db->beginTransaction();

    // 1. (SEGURIDAD) Verificar propiedad (Sin cambios)
    $query_info = "SELECT 
                     re.rutina_id, re.orden 
                   FROM rutina_ejercicios re
                   JOIN rutinas ru ON re.rutina_id = ru.id
                   WHERE re.id = :ejercicio_rutina_id AND ru.usuario_id = :usuario_id
                   LIMIT 1";
    $stmt_info = $db->prepare($query_info);
    $stmt_info->bindParam(":ejercicio_rutina_id", $ejercicio_rutina_id, PDO::PARAM_INT);
    $stmt_info->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_info->execute();
    $info = $stmt_info->fetch(PDO::FETCH_ASSOC);
    if (!$info) {
        throw new Exception("Ejercicio no encontrado o no te pertenece.", 404);
    }
    
    $rutina_id = $info['rutina_id'];
    $antiguo_orden = (int)$info['orden'];

    // 2. L√≥gica de Reordenaci√≥n (Push/Pull) (Sin cambios)
    if ($nuevo_orden != $antiguo_orden) {
        $query_max = "SELECT MAX(orden) as max_orden FROM rutina_ejercicios WHERE rutina_id = :rutina_id";
        $stmt_max = $db->prepare($query_max);
        $stmt_max->bindParam(":rutina_id", $rutina_id);
        $stmt_max->execute();
        $max_orden = (int)$stmt_max->fetch(PDO::FETCH_ASSOC)['max_orden'];
        
        if ($nuevo_orden > $max_orden) { $nuevo_orden = $max_orden; }
        if ($nuevo_orden < 1) { $nuevo_orden = 1; }

        if ($nuevo_orden < $antiguo_orden) {
            $query_shift = "UPDATE rutina_ejercicios SET orden = orden + 1 
                            WHERE rutina_id = :rutina_id AND orden >= :nuevo_orden AND orden < :antiguo_orden";
        } else {
            $query_shift = "UPDATE rutina_ejercicios SET orden = orden - 1 
                            WHERE rutina_id = :rutina_id AND orden > :antiguo_orden AND orden <= :nuevo_orden";
        }
        $stmt_shift = $db->prepare($query_shift);
        $stmt_shift->bindParam(":rutina_id", $rutina_id);
        $stmt_shift->bindParam(":nuevo_orden", $nuevo_orden);
        $stmt_shift->bindParam(":antiguo_orden", $antiguo_orden);
        $stmt_shift->execute();
    }

    // 3. ACTUALIZAR el orden del ejercicio padre (Sin cambios)
    $query_update_padre = "UPDATE rutina_ejercicios SET orden = :orden WHERE id = :id";
    $stmt_update_padre = $db->prepare($query_update_padre);
    $stmt_update_padre->bindParam(":orden", $nuevo_orden);
    $stmt_update_padre->bindParam(":id", $ejercicio_rutina_id);
    $stmt_update_padre->execute();

    // 4. ---- L√ìGICA V6.0: Borrar y Re-insertar objetivos ----
    
    // 4a. Borrar TODOS los objetivos hijos ANTIGUOS
    $query_delete_hijos = "DELETE FROM rutina_objetivos WHERE rutina_ejercicio_id = :re_id";
    $stmt_delete_hijos = $db->prepare($query_delete_hijos);
    $stmt_delete_hijos->bindParam(":re_id", $ejercicio_rutina_id);
    $stmt_delete_hijos->execute();

    // 4b. Re-insertar TODOS los objetivos hijos NUEVOS (¬°¬°CAMBIOS V6.0 AQU√ç!!)
    if (count($objetivos) > 0) {
        // ¬°Consulta actualizada a V6.0!
        $query_hijo = "INSERT INTO rutina_objetivos 
                        (rutina_ejercicio_id, num_serie, 
                         /* --- CAMPOS V6.0 --- */
                         tipo_rep_objetivo, reps_min_objetivo, reps_max_objetivo, 
                         /* ----------------- */
                         peso_kg_objetivo, 
                         tiempo_min_objetivo, distancia_km_objetivo,
                         descanso_seg_post) 
                       VALUES 
                        (:re_id, :num_serie, 
                         /* --- PARAMS V6.0 --- */
                         :tipo_rep, :reps_min, :reps_max, 
                         /* ----------------- */
                         :peso, :tiempo, :dist, :desc)";
        
        $stmt_hijo = $db->prepare($query_hijo);
        
        foreach ($objetivos as $obj) {
            // Asumimos que $obj es un stdClass (de json_decode)
            $stmt_hijo->bindValue(":re_id", $ejercicio_rutina_id);
            $stmt_hijo->bindValue(":num_serie", $obj->num_serie ?? 1);
            
            // --- ¬°CAMBIOS V6.0 AQU√ç! ---
            $stmt_hijo->bindValue(":tipo_rep", $obj->tipo_rep_objetivo ?? 'fijo');
            $stmt_hijo->bindValue(":reps_min", $obj->reps_min_objetivo ?? null);
            $stmt_hijo->bindValue(":reps_max", $obj->reps_max_objetivo ?? null);
            
            $stmt_hijo->bindValue(":peso", $obj->peso_kg_objetivo ?? null);
            $stmt_hijo->bindValue(":tiempo", $obj->tiempo_min_objetivo ?? null);
            $stmt_hijo->bindValue(":dist", $obj->distancia_km_objetivo ?? null);
            $stmt_hijo->bindValue(":desc", $obj->descanso_seg_post ?? null);
            
            $stmt_hijo->execute();
        }
    }
    // ---- Fin L√≥gica V6.0 ----

    // 5. Confirmar la transacci√≥n
    $db->commit();

    // 6. DEVOLVER LA LISTA ACTUALIZADA (¬°¬°CAMBIOS V6.0 AQU√ç!!)
    // (Usamos la misma l√≥gica V6.0 de `get_ejercicios_de_rutina.php`)
    
    // Consulta 1 (Padres)
    $query_ejercicios = "SELECT re.id, re.ejercicio_id, re.orden,
                                ej.nombre as nombre_ejercicio, ej.grupo_muscular, ej.tipo
                         FROM rutina_ejercicios re
                         JOIN ejercicios ej ON re.ejercicio_id = ej.id
                         WHERE re.rutina_id = :rutina_id
                         ORDER BY re.orden ASC";
    $stmt_ejercicios = $db->prepare($query_ejercicios);
    $stmt_ejercicios->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_ejercicios->execute();
    $ejercicios_actualizados = $stmt_ejercicios->fetchAll(PDO::FETCH_ASSOC);
    
    if (count($ejercicios_actualizados) > 0) {
        $rutina_ejercicio_ids = array_map(function($ej) { return $ej['id']; }, $ejercicios_actualizados);
        $placeholders = str_repeat('?,', count($rutina_ejercicio_ids) - 1) . '?';
        
        // Consulta 2 (Hijos) - ¬°Consulta V6.0!
        $query_objetivos = "SELECT id, rutina_ejercicio_id, num_serie, 
                                   tipo_rep_objetivo, reps_min_objetivo, reps_max_objetivo,
                                   peso_kg_objetivo, tiempo_min_objetivo, 
                                   distancia_km_objetivo,
                                   descanso_seg_post
                            FROM rutina_objetivos
                            WHERE rutina_ejercicio_id IN ($placeholders)
                            ORDER BY num_serie ASC";
        
        $stmt_objetivos = $db->prepare($query_objetivos);
        $stmt_objetivos->execute($rutina_ejercicio_ids);
        $objetivos_db = $stmt_objetivos->fetchAll(PDO::FETCH_ASSOC);

        // Combinar (Sin cambios)
        $objetivos_map = [];
        foreach ($objetivos_db as $obj_db) {
            $objetivos_map[$obj_db['rutina_ejercicio_id']][] = $obj_db;
        }
        foreach ($ejercicios_actualizados as $i => $ej) {
            $ej_id = $ej['id'];
            $ejercicios_actualizados[$i]['objetivos'] = $objetivos_map[$ej_id] ?? [];
        }
    }

    http_response_code(200);
    echo json_encode(array(
        "mensaje" => "Ejercicio actualizado y rutina reordenada.",
        "ejercicios_actualizados" => $ejercicios_actualizados
    ));

} catch (Exception $e) {
    $db->rollBack();
    $codigo = $e->getCode() == 404 ? 404 : 500;
    http_response_code($codigo);
    echo json_encode(array(
        "mensaje" => "Error al actualizar el ejercicio.",
        "error" => $e->getMessage()
    ));
}
?>

--- update_perfil.php ---

<?php
// ---- backend/api/update_perfil.php (CON VALIDACI√ìN DE ALTURA/PESO MEJORADA) ----

// --- Configuraci√≥n de Cabeceras ---
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

// --- Manejo de Solicitud OPTIONS (Preflight) ---
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit(); 
}

// --- Dependencias ---
require_once '../config/database.php';
require_once '../vendor/autoload.php'; 

// --- Namespaces ---
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- Constantes ---
define("JWT_SECRET_KEY", "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±"); 

// ==================================================================
// PASO 1: Validaci√≥n de Token JWT y Obtenci√≥n de ID de Usuario
// (Sin cambios)
// ==================================================================
$usuario_id = null;
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null; 

if ($authHeader) {
    $parts = explode(" ", $authHeader);
    if (count($parts) === 2 && $parts[0] === 'Bearer') {
        $jwt = $parts[1];
    }
}

if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key(JWT_SECRET_KEY, 'HS256'));
        $usuario_id = $decoded->data->id ?? null;
        if (!$usuario_id) {
             throw new Exception("ID de usuario no encontrado en el token.");
        }
    } catch (Exception $e) {
        http_response_code(401); // Unauthorized
        echo json_encode(["mensaje" => "Acceso denegado: Token inv√°lido o expirado.", "error_detalle" => $e->getMessage()]);
        exit();
    }
} else {
    http_response_code(401); // Unauthorized
    echo json_encode(["mensaje" => "Acceso denegado: No se proporcion√≥ token."]);
    exit();
}

// ==================================================================
// PASO 2: Obtener y Validar Datos de Entrada (JSON)
// ==================================================================
$data = json_decode(file_get_contents("php://input"));

if ($data === null && json_last_error() !== JSON_ERROR_NONE) {
    http_response_code(400); // Bad Request
    echo json_encode(["mensaje" => "Error al decodificar los datos JSON de entrada."]);
    exit();
}

// Extraer datos
$correo = trim($data->correo_electronico ?? '');
$nombre_real = trim($data->nombre_real ?? '');
$apellidos = trim($data->apellidos ?? '');
$fecha_nac = $data->fecha_nacimiento ?? null; 
$altura = $data->altura_cm ?? null;
$peso = $data->peso_kg ?? null;
$telefono = trim($data->telefono ?? '');
$direccion = trim($data->direccion ?? '');

// --- Validaci√≥n de Reglas de Negocio (¬°MODIFICADA!) ---
$errores_validacion = [];

// --- ¬°CAMBIOS AQU√ç! ---
// Altura: si se proporciona, debe ser num√©rico entre 50 y 300, entero y m√°x 3 d√≠gitos
if ($altura !== null && $altura !== "") {
    if (!is_numeric($altura) || $altura < 50 || $altura > 300) {
        $errores_validacion[] = "La altura debe ser un n√∫mero entre 50 y 300 cm.";
    }
    // Validar que es entero (no tiene decimales)
    if (filter_var($altura, FILTER_VALIDATE_INT) === false) {
         $errores_validacion[] = "La altura debe ser un n√∫mero entero (sin decimales).";
    }
    // Validar longitud
    if (strlen((string)$altura) > 3) {
         $errores_validacion[] = "La altura no puede tener m√°s de 3 d√≠gitos.";
    }
}

// Peso: si se proporciona, debe ser num√©rico entre 30 y 300, y m√°x 6 caracteres
if ($peso !== null && $peso !== "") {
    if (!is_numeric($peso) || $peso < 30 || $peso > 300) {
        $errores_validacion[] = "El peso debe ser un n√∫mero entre 30 y 300 kg.";
    }
    // Validar longitud total (ej: "123.45" tiene 6 caracteres)
    if (strlen((string)$peso) > 6) { 
         $errores_validacion[] = "El peso excede el formato (m√°x 6 caracteres, ej: 123.45).";
    }
    // Validar que no tenga m√°s de 2 decimales (para DECIMAL(5,2))
    $partes_peso = explode('.', (string)$peso);
    if (isset($partes_peso[1]) && strlen($partes_peso[1]) > 2) {
        $errores_validacion[] = "El peso no puede tener m√°s de 2 decimales.";
    }
}
// --- FIN DE CAMBIOS ---

// Fecha Nacimiento: (sin cambios)
if ($fecha_nac !== null && $fecha_nac !== "") {
    try {
        $fechaNacimientoObj = new DateTime($fecha_nac);
        $hoy = new DateTime();
        if ($fechaNacimientoObj->format('Y-m-d') > $hoy->format('Y-m-d')) {
            $errores_validacion[] = "La fecha de nacimiento no puede ser en el futuro.";
        }
    } catch (Exception $e) {
        // No hacer nada si el formato es inv√°lido, ya que no es obligatorio
    }
}
// Correo: (sin cambios)
if ($correo !== null && $correo !== "" && !filter_var($correo, FILTER_VALIDATE_EMAIL)) {
     $errores_validacion[] = "El formato del correo electr√≥nico no es v√°lido.";
}
// Tel√©fono: (sin cambios)
if ($telefono !== null && $telefono !== "" && (strlen($telefono) < 9 || strlen($telefono) > 15 || !ctype_digit($telefono) )) {
    $errores_validacion[] = "El tel√©fono debe tener entre 9 y 15 d√≠gitos num√©ricos.";
}
// Longitud de texto: (sin cambios)
if (mb_strlen($nombre_real, 'UTF-8') > 100) { $errores_validacion[] = "El nombre no puede exceder los 100 caracteres."; }
if (mb_strlen($apellidos, 'UTF-8') > 150) { $errores_validacion[] = "Los apellidos no pueden exceder los 150 caracteres."; }
if (mb_strlen($direccion, 'UTF-8') > 255) { $errores_validacion[] = "La direcci√≥n no puede exceder los 255 caracteres."; }

// Si hubo errores de validaci√≥n, devolverlos
if (!empty($errores_validacion)) {
    http_response_code(400); // Bad Request
    // Devolvemos el primer error encontrado (usando array_unique por si se repiten)
    echo json_encode(["mensaje" => array_values(array_unique($errores_validacion))[0]]);
    exit();
}

// ==================================================================
// PASO 3: L√≥gica de Actualizaci√≥n en Base de Datos
// (Sin cambios)
// ==================================================================
$db = null; 

try {
    $database = new Database();
    $db = $database->getConnection();
    if (!$db) {
         throw new Exception("No se pudo conectar a la base de datos.", 503); // Service Unavailable
    }

    // --- Comprobaci√≥n de Correo Duplicado (ANTES de la transacci√≥n) ---
    if ($correo !== null && $correo !== "") {
        $check_email_query = "SELECT id FROM usuarios WHERE correo_electronico = :correo AND id != :usuario_id LIMIT 1";
        $check_email_stmt = $db->prepare($check_email_query);
        $check_email_stmt->bindParam(':correo', $correo, PDO::PARAM_STR);
        $check_email_stmt->bindParam(':usuario_id', $usuario_id, PDO::PARAM_INT);
        $check_email_stmt->execute();
        if ($check_email_stmt->rowCount() > 0) {
            http_response_code(409); // Conflict
            echo json_encode(["mensaje" => "Ese correo electr√≥nico ya est√° en uso por otro usuario."]);
            exit(); 
        }
    }

    // --- Inicio de la Transacci√≥n ---
    $db->beginTransaction();
    
    // 1. Actualizar 'usuarios' (correo electr√≥nico)
    if (isset($data->correo_electronico)) { 
        $query_user = "UPDATE usuarios SET correo_electronico = :correo WHERE id = :usuario_id";
        $stmt_user = $db->prepare($query_user);
        $stmt_user->bindValue(":correo", ($correo === "" ? null : $correo), PDO::PARAM_STR | PDO::PARAM_NULL);
        $stmt_user->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
        if (!$stmt_user->execute()) {
             throw new Exception("Error al actualizar la tabla de usuarios: " . implode(" - ", $stmt_user->errorInfo()), 500);
        }
    }

    // 2. Insertar o Actualizar 'perfiles' (Usando ON DUPLICATE KEY UPDATE)
    $query_profile = "
        INSERT INTO perfiles (
            usuario_id, nombre_real, apellidos, fecha_nacimiento,
            altura_cm, peso_kg, telefono, direccion
        ) VALUES (
            :usuario_id, :nombre_real, :apellidos, :fecha_nac,
            :altura, :peso, :telefono, :direccion
        )
        ON DUPLICATE KEY UPDATE
            nombre_real = VALUES(nombre_real),
            apellidos = VALUES(apellidos),
            fecha_nacimiento = VALUES(fecha_nacimiento),
            altura_cm = VALUES(altura_cm),
            peso_kg = VALUES(peso_kg),
            telefono = VALUES(telefono),
            direccion = VALUES(direccion)
    ";
    $stmt_profile = $db->prepare($query_profile);

    // Bindear todos los par√°metros
    $stmt_profile->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_profile->bindValue(":nombre_real", ($nombre_real === "" ? null : $nombre_real), PDO::PARAM_STR | PDO::PARAM_NULL);
    $stmt_profile->bindValue(":apellidos", ($apellidos === "" ? null : $apellidos), PDO::PARAM_STR | PDO::PARAM_NULL);
    $stmt_profile->bindValue(":fecha_nac", ($fecha_nac === "" || $fecha_nac === null ? null : $fecha_nac), PDO::PARAM_STR | PDO::PARAM_NULL);
    $stmt_profile->bindValue(":altura", ($altura === "" || $altura === null ? null : $altura), PDO::PARAM_INT | PDO::PARAM_NULL); 
    $stmt_profile->bindValue(":peso", ($peso === "" || $peso === null ? null : $peso), PDO::PARAM_STR | PDO::PARAM_NULL); 
    $stmt_profile->bindValue(":telefono", ($telefono === "" ? null : $telefono), PDO::PARAM_STR | PDO::PARAM_NULL);
    $stmt_profile->bindValue(":direccion", ($direccion === "" ? null : $direccion), PDO::PARAM_STR | PDO::PARAM_NULL);

    if (!$stmt_profile->execute()) {
        throw new Exception("Error al insertar/actualizar la tabla de perfiles: " . implode(" - ", $stmt_profile->errorInfo()), 500);
    }

    // --- Confirmar Transacci√≥n ---
    $db->commit();
    
    // --- Respuesta Exitosa ---
    http_response_code(200); // OK
    echo json_encode(["mensaje" => "Perfil actualizado con √©xito."]);

} catch (Exception $e) {
    // --- Manejo de Errores ---
    if ($db && $db->inTransaction()) {
        $db->rollBack();
    }
    $codigoError = (is_numeric($e->getCode()) && $e->getCode() >= 400 && $e->getCode() < 600) ? $e->getCode() : 500;
    http_response_code($codigoError);
    echo json_encode([
        "mensaje" => "Error al actualizar el perfil.",
        "error_detalle" => $e->getMessage()
    ]);
} finally {
    // --- Limpieza ---
    $db = null;
}
?>

--- update_rutina.php ---

<?php
// ---- backend/api/update_rutina.php (MODIFICADO para 'orden' y 'color_tag' CON REORDENACI√ìN) ----

header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

require_once '../config/database.php';
require_once '../vendor/autoload.php';
use \Firebase\JWT\JWT;
use \Firebase\JWT\Key;

// --- PASO 1: Validaci√≥n de Token (Sin cambios) ---
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;
$usuario_id = null;
if ($authHeader) {
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}
if ($jwt) {
    try {
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));
        $usuario_id = $decoded->data->id;
    } catch (Exception $e) {
        http_response_code(401);
        echo json_encode(array("mensaje" => "Acceso denegado. Token inv√°lido."));
        die();
    }
} else {
    http_response_code(401);
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
    die();
}

// --- Constantes (Sin cambios) ---
define("MAX_NOMBRE_RUTINA_LENGTH", 38);
define("MAX_DIAS_SEMANA_LENGTH", 60);

// --- PASO 2: Obtener datos JSON (Sin cambios) ---
$data = json_decode(file_get_contents("php://input"));
if (empty($data->id) || !isset($data->nombre)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "Datos incompletos. Se requiere 'id' y 'nombre'."));
    die();
}

$rutina_id = $data->id;
$nombre = trim($data->nombre);
$dias_semana = isset($data->dias_semana) ? trim($data->dias_semana) : null;
$nuevo_orden = isset($data->orden) ? (int)$data->orden : 0;
$color_tag = isset($data->color_tag) ? trim($data->color_tag) : null;

// --- VALIDACIONES (Sin cambios) ---
if (mb_strlen($nombre, 'UTF-8') === 0) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "El nombre de la rutina no puede estar vac√≠o."));
    die();
}
if (mb_strlen($nombre, 'UTF-8') > MAX_NOMBRE_RUTINA_LENGTH) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "El nombre no puede exceder los " . MAX_NOMBRE_RUTINA_LENGTH . " caracteres."));
    die();
}
if ($dias_semana !== null && mb_strlen($dias_semana, 'UTF-8') > MAX_DIAS_SEMANA_LENGTH) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "La descripci√≥n/d√≠as no puede exceder los " . MAX_DIAS_SEMANA_LENGTH . " caracteres."));
    die();
}
if ($color_tag !== null && $color_tag !== "" && !preg_match('/^#[a-fA-F0-9]{6}$/', $color_tag)) {
    http_response_code(400);
    echo json_encode(array("mensaje" => "El formato de color no es v√°lido. Debe ser un c√≥digo HEX (ej: #FF5733)."));
    die();
}

// ==================================================================
// --- PASO 3: L√≥gica de Actualizaci√≥n (¬°MODIFICADA CON TRANSACCI√ìN!) ---
// ==================================================================
$database = new Database();
$db = $database->getConnection();

try {
    // ¬°¬°NUEVO!! Iniciar Transacci√≥n
    $db->beginTransaction();

    // 1. OBTENER ORDEN ANTIGUO Y VALIDAR PROPIEDAD
    // (L√≥gica adaptada de update_ejercicio_en_rutina.php)
    $query_info = "SELECT orden FROM rutinas 
                   WHERE id = :rutina_id AND usuario_id = :usuario_id
                   LIMIT 1";
    $stmt_info = $db->prepare($query_info);
    $stmt_info->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_info->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
    $stmt_info->execute();
    $info = $stmt_info->fetch(PDO::FETCH_ASSOC);

    if (!$info) {
        throw new Exception("Rutina no encontrada o no te pertenece.", 404);
    }
    $antiguo_orden = (int)$info['orden'];

    // 2. L√ìGICA DE REORDENACI√ìN (PUSH/PULL)
    // (L√≥gica adaptada de update_ejercicio_en_rutina.php)
    if ($nuevo_orden != $antiguo_orden) {
        
        // Aseguramos que el nuevo orden est√© dentro de los l√≠mites
        $query_max = "SELECT MAX(orden) as max_orden FROM rutinas WHERE usuario_id = :usuario_id";
        $stmt_max = $db->prepare($query_max);
        $stmt_max->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
        $stmt_max->execute();
        $max_orden = (int)$stmt_max->fetch(PDO::FETCH_ASSOC)['max_orden'];
        
        if ($nuevo_orden > $max_orden) { $nuevo_orden = $max_orden; }
        if ($nuevo_orden < 1) { $nuevo_orden = 1; }

        // Dependiendo de si movemos hacia arriba o abajo, "empujamos" o "tiramos"
        if ($nuevo_orden < $antiguo_orden) {
            // "Push" (Mover 5 a 2 -> 2,3,4 se vuelven 3,4,5)
            $query_shift = "UPDATE rutinas SET orden = orden + 1 
                            WHERE usuario_id = :usuario_id AND orden >= :nuevo_orden AND orden < :antiguo_orden";
        } else {
            // "Pull" (Mover 2 a 5 -> 3,4,5 se vuelven 2,3,4)
            $query_shift = "UPDATE rutinas SET orden = orden - 1 
                            WHERE usuario_id = :usuario_id AND orden > :antiguo_orden AND orden <= :nuevo_orden";
        }
        
        $stmt_shift = $db->prepare($query_shift);
        $stmt_shift->bindParam(":usuario_id", $usuario_id, PDO::PARAM_INT);
        $stmt_shift->bindParam(":nuevo_orden", $nuevo_orden, PDO::PARAM_INT);
        $stmt_shift->bindParam(":antiguo_orden", $antiguo_orden, PDO::PARAM_INT);
        $stmt_shift->execute();
    }

    // 3. ACTUALIZAR LA RUTINA OBJETIVO
    // (Esta es la consulta original que ten√≠as)
    $query_update = "UPDATE rutinas
                     SET 
                       nombre = :nombre, 
                       dias_semana = :dias_semana,
                       orden = :orden,
                       color_tag = :color_tag
                     WHERE 
                       id = :rutina_id AND usuario_id = :usuario_id_main";
    
    $stmt_update = $db->prepare($query_update);

    $stmt_update->bindParam(":nombre", $nombre);
    $stmt_update->bindParam(":dias_semana", $dias_semana);
    $stmt_update->bindParam(":orden", $nuevo_orden, PDO::PARAM_INT); // Usamos el $nuevo_orden (ya validado)
    $stmt_update->bindValue(":color_tag", ($color_tag === "" ? null : $color_tag), PDO::PARAM_STR | PDO::PARAM_NULL);
    $stmt_update->bindParam(":rutina_id", $rutina_id, PDO::PARAM_INT);
    $stmt_update->bindParam(":usuario_id_main", $usuario_id, PDO::PARAM_INT);

    // 4. EJECUTAR Y CONFIRMAR
    if ($stmt_update->execute()) {
        
        // ¬°¬°NUEVO!! Confirmar la transacci√≥n
        $db->commit();
        
        http_response_code(200);
        echo json_encode(array(
            "mensaje" => "Rutina actualizada.",
            "rutina_info" => array(
                "id" => $rutina_id,
                "nombre" => $nombre,
                "dias_semana" => $dias_semana,
                "orden" => $nuevo_orden, // Devolvemos el orden final
                "color_tag" => ($color_tag === "" ? null : $color_tag) // Devolvemos null si estaba vac√≠o
            )
        ));
    } else {
        throw new Exception("Error en la base de datos durante la actualizaci√≥n final.");
    }

} catch (Exception $e) {
    // ¬°¬°NUEVO!! Revertir en caso de error
    if ($db && $db->inTransaction()) {
        $db->rollBack();
    }
    
    $codigo = $e->getCode() == 404 ? 404 : 500;
    http_response_code($codigo);
    echo json_encode(array(
        "mensaje" => "Error al actualizar la rutina.",
        "error" => $e->getMessage()
    ));
}
?>

--- UsuarioCard.css ---

/* ---- frontend/src/components/UsuarioCard.css (NUEVO ARCHIVO) ---- */

.usuario-card {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  gap: 1rem;
  transition: all 0.3s ease;
}

.usuario-card:hover {
  transform: translateY(-4px);
  border-color: var(--primary-color);
}

.usuario-info {
  text-align: center;
}

.usuario-info strong {
  display: block;
  font-size: 1.25rem;
  color: var(--text-color);
  word-break: break-word;
}

.usuario-info span {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
}

.usuario-actions {
  display: flex;
  gap: 0.75rem;
}

/* Botones gen√©ricos (reutilizamos clases de Dashboard) */
.btn-card-action {
  flex: 1;
  height: 40px;
  border-radius: 999px;
  font-size: 0.9rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
}

/* Bot√≥n A√±adir/Ver (Verde/Azul) */
.btn-card-add {
  background: var(--gradient);
  color: #fff;
}

/* Bot√≥n Eliminar (Gris) */
.btn-card-delete {
  background-color: var(--input-bg-color);
  color: var(--text-secondary-color);
}
.btn-card-delete:hover {
  background-color: var(--input-border-color);
  color: var(--text-color);
}

/* Bot√≥n Eliminar (Rojo - para 'Mis Amigos') */
.btn-card-unfriend {
  background-color: rgba(217, 48, 37, 0.1);
  color: #d93025;
  border: 1px solid #d93025;
}
.btn-card-unfriend:hover {
  background-color: #d93025;
  color: #fff;
}

--- UsuarioCard.js ---

// ---- frontend/src/components/UsuarioCard.js (CORREGIDO) ----

import React from 'react';
import './UsuarioCard.css';

function UsuarioCard({ usuario, tipo, onAddAmigo, onDeleteAmigo, onVerPRs }) {
  
  const { id, nombre_usuario, son_amigos, solicitante_id } = usuario;

  // --- ¬°CORRECCI√ìN DE L√ìGICA AQU√ç! ---
  // 'id' es el ID del amigo (ej: 10)
  // 'solicitante_id' es qui√©n inici√≥ la amistad (ej: 5 si fui yo, 10 si fue √©l)
  // Si son iguales, significa que √©l inici√≥ la amistad ("Te a√±adi√≥").
  const teAnadioEl = (solicitante_id === id);

  return (
    <div className="usuario-card">
      <div className="usuario-info">
        <strong>{nombre_usuario}</strong>
        {tipo === 'amigo' && (
          // Usamos la l√≥gica corregida
          <span>{teAnadioEl ? 'Te a√±adi√≥' : 'A√±adido por ti'}</span>
        )}
      </div>
      
      <div className="usuario-actions">
        {tipo === 'amigo' ? (
          <>
            <button 
              className="btn-card-action btn-card-delete" // Bot√≥n gris
              onClick={onVerPRs}
            >
              Ver PRs
            </button>
            <button 
              className="btn-card-action btn-card-unfriend" // Bot√≥n rojo
              onClick={onDeleteAmigo}
            >
              Eliminar
            </button>
          </>
        ) : (
          // tipo === 'busqueda'
          son_amigos ? (
            <button 
              className="btn-card-action btn-card-delete" // Bot√≥n gris
              onClick={onDeleteAmigo}
            >
              Eliminar Amigo
            </button>
          ) : (
            <button 
              className="btn-card-action btn-card-add" // Bot√≥n azul/verde
              onClick={onAddAmigo}
            >
              A√±adir Amigo
            </button>
          )
        )}
      </div>
    </div>
  );
}

export default UsuarioCard;

--- validar_token.php ---

<?php
// ---- backend/api/validar_token.php ----

// Cabeceras CORS
header("Access-Control-Allow-Origin: *");
header("Content-Type: application/json; charset=UTF-8");
header("Access-Control-Allow-Methods: POST"); // O GET, seg√∫n c√≥mo decidas enviarlo
header("Access-Control-Allow-Headers: Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");

require_once '../config/database.php';
require_once '../vendor/autoload.php';

use \Firebase\JWT\JWT;
use \Firebase\JWT\Key; // IMPORTANTE: Necesario para la v6+ de firebase/jwt

// Tu clave secreta (debe ser LA MISMA que en login.php)
$secret_key = "k#f9JLz@p7W!bN8^vG2*qR5sT&eD4hX%uY1aC6oP3zM0xQ√±";

// 1. Obtener el token del header de Autorizaci√≥n
$jwt = null;
$authHeader = $_SERVER['HTTP_AUTHORIZATION'] ?? null;

if ($authHeader) {
    // El header suele ser "Bearer <token>"
    // Necesitamos extraer solo el <token>
    $arr = explode(" ", $authHeader);
    $jwt = $arr[1] ?? null;
}

if ($jwt) {
    try {
        // 2. Decodificar el token
        // NOTA: Usamos 'new Key()' para la versi√≥n 6+ de la librer√≠a.
        $decoded = JWT::decode($jwt, new Key($secret_key, 'HS256'));

        // 3. Si tiene √©xito, el token es v√°lido
        http_response_code(200);
        echo json_encode(array(
            "mensaje" => "Acceso concedido.",
            "data" => $decoded->data // Enviamos los datos del usuario (id, nombre_usuario)
        ));

    } catch (Exception $e) {
        // 4. Si falla (expirado, firma incorrecta, etc.)
        http_response_code(401); // Unauthorized
        echo json_encode(array(
            "mensaje" => "Acceso denegado. Token inv√°lido o expirado.",
            "error" => $e->getMessage()
        ));
    }
} else {
    // 5. Si no se proporcion√≥ ning√∫n token
    http_response_code(401); // Unauthorized
    echo json_encode(array("mensaje" => "Acceso denegado. No se proporcion√≥ token."));
}
?>

--- WorkoutSession.css ---

/* ---- frontend/src/WorkoutSession.css (Con crono sticky) ---- */

/* ====================================================== */
/* 1. CONTENEDOR PRINCIPAL Y CABECERA */
/* ====================================================== */

.workout-session-container {
  padding: 2rem;
  animation: fadeIn 0.5s ease-in-out;
  max-width: 800px;
  margin: 0 auto;
}

/* T√≠tulos y subt√≠tulo */
.workout-session-container h2 {
  font-size: 2rem;
  color: var(--text-color);
  margin-bottom: 0.5rem;
}
.workout-session-container .subtitle {
  font-size: 1.1rem;
  color: var(--text-secondary-color);
  margin-bottom: 2rem;
}

/* Bot√≥n Volver */
.btn-volver {
  background: none;
  border: 1px solid var(--input-border-color);
  color: var(--text-secondary-color);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.9rem;
  font-family: var(--font-family);
  transition: all 0.3s ease;
  margin-bottom: 1rem;
}
.btn-volver:hover {
  background-color: var(--input-bg-color);
  color: var(--text-color);
}

/* --- MODIFICADO: Estilo para el Cron√≥metro (Panel) --- */
.cronometro-sesion {
  /* --- ¬°NUEVOS CAMBIOS AQU√ç! --- */
  position: sticky;
  /* Se 'pegar√°' al hacer scroll */
  top: 1rem;
  /* Distancia del borde superior del √°rea de scroll (le damos 1rem de aire) */
  z-index: 100;
  /* Asegura que est√© por encima de las tarjetas de ejercicio */
  /* --- FIN DE CAMBIOS --- */

  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  background-color: var(--input-bg-color);
  /* Fondo sutil (importante para que sea opaco) */
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 0.75rem 1.5rem;
  max-width: 300px;
  margin: 0 auto 2rem auto;
  /* Mantenemos el centrado y margen inferior */
  box-shadow: var(--box-shadow);
}

.cronometro-icono {
  width: 32px;
  height: 32px;
  opacity: 0.7;
}

.cronometro-sesion span {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--text-color);
  letter-spacing: 2px;
  font-family: monospace;
  line-height: 1;
}

/* ====================================================== */
/* 2. LAYOUT DE EJERCICIOS Y SERIES */
/* ====================================================== */

/* Contenedor de la lista de ejercicios */
.ejercicios-lista-sesion {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  margin-bottom: 2rem;
}

/* Tarjeta individual de ejercicio */
.ejercicio-card-sesion {
  background-color: var(--surface-color);
  border: 1px solid var(--input-border-color);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--box-shadow);
}

.ejercicio-card-sesion h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 1.25rem;
  color: var(--text-color);
  border-bottom: 1px solid var(--input-border-color);
  padding-bottom: 0.75rem;
}

/* Contenedor de la lista de series (dentro de la tarjeta) */
.series-lista-vertical {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-top: 1rem;
}

/* Mensaje si no hay series */
.no-series-msg {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  text-align: center;
  padding: 1rem 0;
}

/* ====================================================== */
/* 3. FILA DE SERIE INDIVIDUAL (P√çLDORA) */
/* ====================================================== */

.serie-fila {
  display: flex;
  align-items: center;
  padding: 0.5rem 0.6rem 0.5rem 1rem;
  background-color: var(--input-bg-color);
  border: 2px solid var(--input-border-color);
  border-radius: 999px;
  transition: all 0.2s ease;
  cursor: default;
  gap: 1rem;
}

/* Info (N√∫mero y Texto) */
.serie-info-principal {
  display: flex;
  align-items: baseline;
  gap: 0.75rem;
  flex-grow: 1;
  min-width: 0;
  /* Permite encoger */
}

.serie-numero {
  font-weight: bold;
  color: var(--text-secondary-color);
  font-size: 1rem;
  transition: color 0.2s ease;
}

.serie-objetivo-texto {
  font-size: 0.9rem;
  color: var(--text-secondary-color);
  white-space: normal;
  /* Permite salto de l√≠nea */
  transition: color 0.2s ease;
  word-break: break-word;
  /* Evita desbordamiento */
}

/* Acciones (Botones) */
.serie-acciones-fila {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-shrink: 0;
  /* Evita que los botones se encojan */
}

/* Bot√≥n Check (C√≠rculo) */
.btn-check-serie {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: 2px solid var(--input-border-color);
  background-color: transparent;
  color: var(--text-secondary-color);
  font-size: 1.3rem;
  font-weight: bold;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.btn-check-serie:hover:not(.completed) {
  border-color: var(--primary-color);
  background-color: rgba(0, 170, 255, 0.1);
  color: var(--primary-color);
}

.btn-check-serie.completed {
  background-color: var(--primary-color);
  border-color: var(--primary-color);
  color: var(--surface-color);
}

.btn-check-serie.completed:hover {
  opacity: 0.85;
}

/* Bot√≥n Editar (L√°piz) */
.btn-edit-serie-fila {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background-color: transparent;
  color: var(--text-secondary-color);
  font-size: 1.1rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.btn-edit-serie-fila:hover {
  background-color: var(--input-border-color);
  color: var(--text-color);
}

/* Fila completada (Efecto Borde Degradado) */
.serie-fila.completed {
  border: 2px solid transparent;
  background-image: linear-gradient(var(--surface-color), var(--surface-color)), var(--gradient);
  background-origin: border-box;
  background-clip: padding-box, border-box;
  box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
}

.serie-fila.completed .serie-numero {
  color: var(--primary-color);
}

.serie-fila.completed .serie-objetivo-texto {
  color: var(--text-color);
}

.serie-fila.completed .btn-edit-serie-fila {
  color: var(--text-color);
}

.serie-fila.completed .btn-edit-serie-fila:hover {
  background-color: var(--input-bg-color);
}


/* ====================================================== */
/* 4. BOT√ìN DE FINALIZAR */
/* ====================================================== */

.btn-finalizar {
  width: 100%;
  max-width: 300px;
  margin: 2.5rem auto 0;
  display: block;
  height: 48px;
  border-radius: 999px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-family: var(--font-family);
  border: none;
  background: var(--gradient);
  color: #fff;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn-finalizar:hover {
  transform: scale(1.03);
  opacity: 0.9;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

.btn-finalizar:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

/* ====================================================== */
/* 5. MEDIA QUERIES (M√ìVIL) */
/* ====================================================== */

@media (max-width: 600px) {
  /* Cron√≥metro */
  .cronometro-sesion {
    max-width: 250px;
    gap: 0.75rem;
    padding: 0.5rem 1rem;
    /* Hacemos que el sticky est√© un poco m√°s pegado arriba en m√≥vil */
    top: 0.5rem; 
  }

  .cronometro-sesion span {
    font-size: 2rem;
  }

  .cronometro-icono {
    width: 28px;
    height: 28px;
  }

  /* Ajusta la alineaci√≥n de la fila de serie si el texto ocupa varias l√≠neas */
  .serie-fila {
    align-items: flex-start;
    /* Alinea botones arriba */
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
  }

  .serie-info-principal {
    gap: 0.5rem;
  }

  /* Botones de fila */
  .btn-check-serie,
  .btn-edit-serie-fila {
    width: 32px;
    height: 32px;
  }

  .btn-check-serie {
    font-size: 1.2rem;
  }

  .btn-edit-serie-fila {
    font-size: 1.1rem;
  }
}

--- WorkoutSession.js ---

// ---- frontend/src/WorkoutSession.js (CON CRON√ìMETRO MEJORADO Y CONDICIONAL) ----

import React, { useEffect, useState, useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import './WorkoutSession.css';
import RegistrarSerieModal from './components/RegistrarSerieModal';
import ResumenFinalModal from './components/ResumenFinalModal';
import iconoEntrenar from './assets/entrenar.png';
import GuiaModal from './components/GuiaModal';
import iconoReloj from './assets/reloj.png';
import ConfirmarSalirModal from './components/ConfirmarSalirModal';

// --- Funci√≥n de formateo V6.0 (Lenguaje Natural) ---
const formatObjetivoNatural = (obj, tipo) => {
  if (!obj) return ''; // Seguridad

  if (tipo === 'cardio') {
    const metricas = [];
    if (obj.tiempo_min_objetivo) metricas.push(`${obj.tiempo_min_objetivo} min`);
    if (obj.distancia_km_objetivo) metricas.push(`${obj.distancia_km_objetivo} km`);

    if (metricas.length > 2) {
      return metricas.slice(0, -1).join(', ') + ' y ' + metricas.slice(-1);
    } else {
      return metricas.join(' y ');
    }
  }

  let textoPrincipal = "";
  if (obj.tipo_rep_objetivo === 'fallo') {
    textoPrincipal = "Al Fallo";
  } else if (obj.tipo_rep_objetivo === 'rango') {
    textoPrincipal = `${obj.reps_min_objetivo || '?'}-${obj.reps_max_objetivo || '?'} reps`;
  } else { // 'fijo'
    textoPrincipal = `${obj.reps_min_objetivo || '?'} reps`;
  }

  if (obj.peso_kg_objetivo != null) {
    textoPrincipal += ` con ${obj.peso_kg_objetivo} kg`;
  }

  if (obj.descanso_seg_post != null) {
    textoPrincipal += ` (${obj.descanso_seg_post}s)`;
  }

  return textoPrincipal;
};
// --- Funci√≥n para formatear el Tooltip (m√°s detallado) ---
const formatTooltip = (objetivo, serieReal, tipo) => {
  let tooltip = `Objetivo: ${formatObjetivoNatural(objetivo, tipo)}`;
  if (serieReal) {
    tooltip += "\n---\nRealizado:";
    if (tipo === 'cardio') {
      if (serieReal.tiempo_min_realizado != null) tooltip += ` ${serieReal.tiempo_min_realizado} min`;
      if (serieReal.distancia_km_realizada != null) {
        tooltip += (serieReal.tiempo_min_realizado != null) ?
` y ${serieReal.distancia_km_realizada} km` : ` ${serieReal.distancia_km_realizada} km`;
      }
    } else { // Fuerza
      // --- ¬°CORRECCI√ìN DE TYPO! ---
      tooltip += ` ${serieReal.repeticiones_realizadas ??
'?'} reps`;
      // --- FIN CORRECI√ìN ---
      if (serieReal.fue_al_fallo) tooltip += ` (¬°Al Fallo!)`;
      if (serieReal.peso_kg_usado != null) tooltip += ` con ${serieReal.peso_kg_usado} kg`;
    }
    if (serieReal.notas_serie) tooltip += `\nNotas: ${serieReal.notas_serie}`;
  }
  return tooltip;
};

// --- Funci√≥n para formatear el cron√≥metro ---
const formatTiempo = (totalSegundos) => {
  const horas = Math.floor(totalSegundos / 3600);
  const minutos = Math.floor((totalSegundos % 3600) / 60);
  const segundos = totalSegundos % 60;
  // padStart(2, '0') asegura que 1 se vea como "01"
  const hStr = String(horas).padStart(2, '0');
  const mStr = String(minutos).padStart(2, '0');
  const sStr = String(segundos).padStart(2, '0');
  if (horas > 0) {
    // Si llevas m√°s de 1 hora
    return `${hStr}:${mStr}:${sStr}`;
  } else {
    // Si llevas menos de 1 hora
    return `${mStr}:${sStr}`;
  }
};
// --- HELPER PARA MARCAR GU√çA (COPIADO) ---
const marcarGuiaComoVista = async (nombreGuia) => {
  const token = localStorage.getItem('movium_token');
  if (!token) return;
  try {
    await fetch('http://localhost/programacion/TFG/movium/backend/api/marcar_guia_vista.php', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ guia_vista: nombreGuia })
    });
  } catch (error) {
    console.error("Error al marcar la gu√≠a como vista:", error);
  }
};

function WorkoutSession() {
  const { id: rutinaId } = useParams();
  const navigate = useNavigate();
  const [rutinaNombre, setRutinaNombre] = useState('');
  const [ejerciciosPlanificados, setEjerciciosPlanificados] = useState([]);
  const [progresoSeries, setProgresoSeries] = useState({});
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [isFinishing, setIsFinishing] = useState(false);
  const [serieParaRegistrar, setSerieParaRegistrar] = useState(null);
  const [isResumenOpen, setIsResumenOpen] = useState(false);
  const [horaInicioSesion, setHoraInicioSesion] = useState(null);
  // --- Estados para Crono y Gu√≠a ---
  const [tiempoTranscurrido, setTiempoTranscurrido] = useState(0);
  const [showGuiaEntreno, setShowGuiaEntreno] = useState(false);

  // --- Estado para el modal de salida ---
  const [isConfirmarSalirOpen, setIsConfirmarSalirOpen] = useState(false);

  // Efecto Carga (Guarda hora de inicio)
  useEffect(() => {
    setHoraInicioSesion(new Date()); 

    const cargarDatosSesion = async () => {
      setLoading(true); setError(null);
      const token = localStorage.getItem('movium_token');
      if (!token) { setError("Error de autenticaci√≥n."); setLoading(false); return; }
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
      try {
        const resInfo = fetch(`http://localhost/programacion/TFG/movium/backend/api/get_rutina_info.php?id=${rutinaId}`, { headers });
        const resEjercicios = fetch(`http://localhost/programacion/TFG/movium/backend/api/get_ejercicios_de_rutina.php?id=${rutinaId}`, { headers });

        const [infoResponse, ejerciciosResponse] = await Promise.all([resInfo, resEjercicios]);
        const dataInfo = await infoResponse.json();
        if (!infoResponse.ok) throw new Error(dataInfo.mensaje || "Error info rutina.");
        const dataEjercicios = await ejerciciosResponse.json();
        if (!ejerciciosResponse.ok) throw new Error(dataEjercicios.mensaje || "Error ejercicios rutina.");

        setRutinaNombre(dataInfo.nombre);
        setEjerciciosPlanificados(dataEjercicios);
      } catch (err) { setError(err.message); } finally { setLoading(false); }
    };
    cargarDatosSesion();
  }, [rutinaId]);

  // --- useEffect para el cron√≥metro ---
  useEffect(() => {
    if (!horaInicioSesion) return;

    const intervalId = setInterval(() => {
      const ahora = new Date();
      const segundos = Math.floor((ahora - horaInicioSesion) 
/ 1000);
      setTiempoTranscurrido(segundos);
    }, 1000);

    return () => clearInterval(intervalId);

  }, [horaInicioSesion]);

  // --- USEEFFECT PARA LA GU√çA ---
  useEffect(() => {
    if (loading || error) return; 
    try {
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      
      if (storedUser && !storedUser.ha_visto_guia_entreno && storedUser.ha_visto_guia_rutina) {
        
        const timer = setTimeout(() => {
          setShowGuiaEntreno(true);
        }, 500); // medio segundo
        
        return () => clearTimeout(timer);
      }
    } catch (e) {
      console.error("Error al leer datos de usuario para la gu√≠a de Entreno:", e);
    }
  }, [loading, error]);
  
  // L√≥gica Resumen
  const resumenWorkout = useMemo(() => {
    if (!ejerciciosPlanificados || ejerciciosPlanificados.length === 0) return [];
    const seriesCompletadas = Object.values(progresoSeries).filter(Boolean);
    if (seriesCompletadas.length === 0) return [];
    const ejerciciosAgrupados = {};
    for (const serie of seriesCompletadas) {
      if (!serie.ejercicio_id) continue;
      const id = serie.ejercicio_id;
      if (!ejerciciosAgrupados[id]) { ejerciciosAgrupados[id] = []; }
      ejerciciosAgrupados[id].push(serie);
    }

    const resultadoFinal = [];
    for (const ejPlanificado of ejerciciosPlanificados) {
      const id = ejPlanificado.ejercicio_id;
      if (ejerciciosAgrupados[id]) {
        const seriesOrdenadas = ejerciciosAgrupados[id].sort((a, b) => a.num_serie - b.num_serie);
        resultadoFinal.push({
          nombre: ejPlanificado.nombre_ejercicio,
          tipo: ejPlanificado.tipo,
          series: seriesOrdenadas
        });
      }
    }
    return resultadoFinal;
  }, [progresoSeries, ejerciciosPlanificados]);

  // --- HANDLER CERRAR GU√çA ---
  const handleCerrarGuiaEntreno = () => {
    try {
      marcarGuiaComoVista('entreno');
      const storedUser = JSON.parse(localStorage.getItem('movium_user'));
      if (storedUser) {
        const updatedUser = { ...storedUser, ha_visto_guia_entreno: true };
        localStorage.setItem('movium_user', JSON.stringify(updatedUser));
      }
      setShowGuiaEntreno(false);
    } catch (e) {
      console.error("Error al cerrar la gu√≠a de Entreno:", e);
      setShowGuiaEntreno(false);
    }
  };

  // Handlers
  const handleToggleSerie = (ej, objetivo) => {
    const key = `${ej.id}_${objetivo.num_serie}`;
    setProgresoSeries(prev => {
      const newState = { ...prev };
      if (newState[key]) {
        delete newState[key];
      } else {
        let repsRealizadasDefault = null;
        let fueAlFalloDefault = false;
        if (ej.tipo !== 'cardio') {
          if (objetivo.tipo_rep_objetivo === 'fallo') {
            fueAlFalloDefault = true;
            repsRealizadasDefault = null;
          } else {
            fueAlFalloDefault = false;
            repsRealizadasDefault = objetivo.reps_min_objetivo || null;
          }
        }
        newState[key] = {
          ejercicio_id: ej.ejercicio_id,
          orden_ejercicio_rutina: ej.orden || 1,
          num_serie: objetivo.num_serie,
          repeticiones_realizadas: repsRealizadasDefault,
          fue_al_fallo: fueAlFalloDefault,
          peso_kg_usado: objetivo.peso_kg_objetivo || null,
          tiempo_min_realizado: objetivo.tiempo_min_objetivo || null,
          distancia_km_realizada: objetivo.distancia_km_objetivo || null,
          notas_serie: null
        };
      }
      return newState;
    });
  };

  const handleEditSerieClick = (ej, objetivoOriginal) => {
    const key = `${ej.id}_${objetivoOriginal.num_serie}`;
    const datosActuales = progresoSeries[key];
    setSerieParaRegistrar({
      ejercicio: ej,
      tipo: ej.tipo,
      objetivoOriginal: objetivoOriginal,
      datosGuardados: datosActuales,
      numSerie: objetivoOriginal.num_serie,
      key: key,
      notas: datosActuales?.notas_serie || ''
    });
  };

  const handleGuardarSerie = (datosReales) => {
    if (!serieParaRegistrar) return;
    const { ejercicio, numSerie, key } = serieParaRegistrar;
    const { notas, ...datosDeLaSerie } = datosReales;
    const datosParaEstado = {
      ejercicio_id: ejercicio.ejercicio_id,
      orden_ejercicio_rutina: ejercicio.orden || 1,
      num_serie: numSerie,
      repeticiones_realizadas: datosDeLaSerie.reps,
      fue_al_fallo: datosDeLaSerie.fue_al_fallo,
      peso_kg_usado: datosDeLaSerie.peso,
      tiempo_min_realizado: datosDeLaSerie.tiempo,
      distancia_km_realizada: datosDeLaSerie.dist,
      notas_serie: notas || null
    };
    setProgresoSeries(prev => ({ ...prev, [key]: datosParaEstado }));
    setSerieParaRegistrar(null);
  };

  const handleFinalizarClick = () => {
    setError(null);
    const seriesCompletadas = Object.values(progresoSeries).filter(Boolean);
    if (seriesCompletadas.length === 0) {
      // ESTE es el error que quieres mover
      setError("No puedes finalizar un entrenamiento sin haber completado al menos una serie.");
      return; 
    }
    setIsResumenOpen(true);
  };

  const handleConfirmarFinalizar = async (notasDeLaSesion) => {
    setIsFinishing(true); setError(null);
    const seriesCompletadas = Object.values(progresoSeries).filter(Boolean);
    const token = localStorage.getItem('movium_token');
    if (!token) {
      setError("Error de autenticaci√≥n. Por favor, inicia sesi√≥n de nuevo.");
      setIsFinishing(false);
      setIsResumenOpen(false);
      return;
    }

    const datosAEnviar = {
      rutina_id: parseInt(rutinaId, 10),
      series: seriesCompletadas,
      notas_sesion: notasDeLaSesion,
      fecha_inicio: horaInicioSesion
    };
    try {
      const res = await fetch(`http://localhost/programacion/TFG/movium/backend/api/finalizar_entrenamiento.php`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify(datosAEnviar)
       });
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.mensaje || "Error al guardar el entrenamiento.");
      }
      setIsResumenOpen(false);
      navigate('/');
    } catch (err) {
      setError(err.message);
      setIsResumenOpen(false);
    } finally {
      setIsFinishing(false);
    }
  };

  // --- Handlers para el bot√≥n "Volver" ---
  const handleVolverClick = () => {
    if (Object.keys(progresoSeries).length > 0 && !isFinishing) {
      setIsConfirmarSalirOpen(true);
    } else if (!isFinishing) {
      navigate('/');
    }
  };

  const handleConfirmarSalir = () => {
    setIsConfirmarSalirOpen(false);
    navigate('/');
  };
  
  // Renderizado
  if (loading) return <div className="workout-session-container"><p className="subtitle">Cargando sesi√≥n...</p></div>;
  if (error && !loading && ejerciciosPlanificados.length === 0) {
    return (
      <div className="workout-session-container">
        <button className="btn-volver" onClick={() => navigate('/')}>&larr; Volver</button>
        <div className="message" style={{ marginTop: '1rem' }}>{error}</div>
      </div>
    );
  }

  return (
    <>
      <div className="workout-session-container">
        
        <button 
          className="btn-volver" 
          onClick={handleVolverClick}
          disabled={isFinishing}
        >
          &larr; Salir sin guardar
        </button>

        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', marginBottom: '0.5rem', gap: '10px' }}>
          <img src={iconoEntrenar} alt="" width="64" height="64" />
          <h2>{rutinaNombre}</h2>
         </div>
        <p className="subtitle" style={{ textAlign: 'center' }}>
          Marca las series completadas y edita si es necesario.
        </p>

        {/* --- CRON√ìMETRO --- */}
        {ejerciciosPlanificados.length > 0 && (
          <div className="cronometro-sesion" title="Tiempo de entrenamiento">
            <img src={iconoReloj} alt="" className="cronometro-icono" />
            <span>{formatTiempo(tiempoTranscurrido)}</span>
          </div>
        )}

        {/* --- BLOQUE DE ERROR (MOVIMOS EL OTRO AQU√ç) --- */}
        {/* {error && <div className="message" style={{ marginTop: '0', marginBottom: '1rem' }}>{error}</div>} */} {/* <-- ELIMINADO DE AQU√ç */}

        <div className="ejercicios-lista-sesion">
          {ejerciciosPlanificados.length === 0 ?
(
            <p>Esta rutina no tiene ejercicios definidos.</p>
          ) : (
            ejerciciosPlanificados.map((ej, index) => (
              <div key={ej.id} className="ejercicio-card-sesion">
                <h3>{index + 1}. {ej.nombre_ejercicio}</h3>

                <div className="series-lista-vertical">
    
                   {!ej.objetivos || ej.objetivos.length === 0 ? (
                    <p className="no-series-msg">No hay objetivos definidos.</p>
                  ) : (
                    ej.objetivos.map((objetivo) => {
              
                       const serieNum = objetivo.num_serie;
                      const key = `${ej.id}_${serieNum}`;
                      const serieReal = progresoSeries[key];
                      const isCompleted = !!serieReal;

              
                       const tooltipText = formatTooltip(objetivo, serieReal, ej.tipo);
                      const textoVisible = formatObjetivoNatural(objetivo, ej.tipo);
                      return (
                        <div
              
                           key={key}
                          className={`serie-fila ${isCompleted ?
 'completed' : ''}`}
                          title={tooltipText}
                        >
                          <div className="serie-info-principal">
                     
                             <span className="serie-numero">S{serieNum}:</span>
                            <span className="serie-objetivo-texto">{textoVisible}</span>
                          </div>
                          <div className="serie-acciones-fila">
          
                             <button
                              className={`btn-check-serie ${isCompleted ?
 'completed' : ''}`}
                              onClick={() => handleToggleSerie(ej, objetivo)}
                              disabled={isFinishing}
                              aria-label={isCompleted ?
 'Desmarcar serie como completada' : 'Marcar serie como completada'}
                            >
                              {isCompleted ?
 '‚úì' : ''}
                            </button>
                            <button
                              className="btn-edit-serie-fila"
            
                               onClick={() => handleEditSerieClick(ej, objetivo)}
                              disabled={isFinishing}
                              aria-label="Editar detalles de la serie"
               
                             >
                              ‚úèÔ∏è
                            </button>
                          </div>
   
                         </div>
                      );
})
                  )}
                </div>
              </div>
            ))
          )}
        </div>

        {/* --- ZONA DE ERROR MOVIDA --- */}
        {/* Aqu√≠ es donde aparecer√° el error "No puedes finalizar..." */}
        <div style={{ marginTop: '1.5rem', marginBottom: '1rem' }}>
          {error && <div className="message">{error}</div>}
        </div>
        {/* --- FIN ZONA DE ERROR --- */}


        {ejerciciosPlanificados.length > 0 && (
          
           <button className="btn-start btn-finalizar" onClick={handleFinalizarClick} disabled={isFinishing}>
            {isFinishing ? 'Guardando...' : 'Finalizar Entrenamiento'}
          </button>
        )}
      </div>

      {/* Modales */}
      <RegistrarSerieModal
        isOpen={serieParaRegistrar !== null}
        onClose={() => setSerieParaRegistrar(null)}
        datosSerie={serieParaRegistrar}
        onGuardar={handleGuardarSerie}
     
       />
      <ResumenFinalModal
        isOpen={isResumenOpen}
        onClose={() => { if (!isFinishing) setIsResumenOpen(false); }}
        onConfirm={handleConfirmarFinalizar}
        isFinishing={isFinishing}
        resumenDatos={resumenWorkout}
      />
      
      <ConfirmarSalirModal
        isOpen={isConfirmarSalirOpen}
        onClose={() => setIsConfirmarSalirOpen(false)}
        onConfirm={handleConfirmarSalir}
      />

      {/* Modal de Gu√≠a (existente) */}
      <GuiaModal
        isOpen={showGuiaEntreno}
        onClose={handleCerrarGuiaEntreno}
        titulo="¬°A registrar!"
      >
        <p>¬°Aqu√≠ es donde la magia ocurre! Para cada serie de tu plan:</p>
        <ul style={{ marginTop: '0.5rem', marginBottom: '1rem', paddingLeft: '1.2rem' }}>
          <li style={{ marginBottom: '0.5rem' }}>
            Haz clic en el <strong>c√≠rculo (‚úì)</strong> para marcarla como completada <strong>exactamente como la planeaste</strong>.
          </li>
          <li>
            Haz clic en el <strong>l√°piz (‚úèÔ∏è)</strong> si necesitas <strong>ajustar lo que hiciste en realidad</strong> (cambiar el peso, las repeticiones, o a√±adir una nota).
          </li>
        </ul>
        <p>¬°Es normal no rendir siempre igual! Registrar tus datos reales es clave para medir tu progreso.</p>
      </GuiaModal>
    </>
  );
}

export default WorkoutSession;

